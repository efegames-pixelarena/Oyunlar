<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber-Stack | Pixel Arena</title>
    <style>
        :root {
            --primary: #4fd1ff;
            --accent: #ff8a00;
            --bg: #03050a;
            --success: #00ffa3;
        }

        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Inter', sans-serif; overflow: hidden;
            display: flex; align-items: center; justify-content: center; height: 100vh;
        }

        #game-container { position: relative; width: 100%; height: 100%; max-width: 500px; }

        canvas { display: block; width: 100%; height: 100%; }

        .ui {
            position: absolute; top: 40px; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 10;
        }

        #score { font-size: 80px; font-weight: 900; color: white; opacity: 0.3; }

        .msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; width: 80%; display: block;
        }

        h1 { font-size: 24px; letter-spacing: 5px; color: var(--primary); text-transform: uppercase; }
        p { color: #94a3b8; font-size: 14px; margin-bottom: 20px; }

        .btn-start {
            padding: 15px 40px; border-radius: 12px; background: var(--primary);
            color: #000; border: none; font-weight: 900; cursor: pointer;
            text-transform: uppercase; pointer-events: auto;
        }

        #restart-screen { display: none; }
    </style>
</head>
<body onclick="handleAction()">

    <div id="game-container">
        <div class="ui">
            <div id="score">0</div>
        </div>

        <div id="start-screen" class="msg">
            <h1>CYBER STACK</h1>
            <p>Kuleyi yükseltmek için tam zamanında tıkla!</p>
            <button class="btn-start">BAŞLAT</button>
        </div>

        <div id="restart-screen" class="msg">
            <h1 style="color:var(--accent)">GAME OVER</h1>
            <p id="final-score-msg">Skor: 0</p>
            <button class="btn-start">TEKRAR DENE</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // OYUN AYARLARI
    let scene, camera, renderer;
    let stack = [];
    const boxHeight = 1;
    const originalBoxSize = 3;
    let gameStarted = false;
    let gameOver = false;
    let score = 0;
    let speed = 0.15;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x03050a);

        // Kamera
        const aspect = window.innerWidth / window.innerHeight;
        const d = 5;
        camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 0.1, 1000);
        camera.position.set(4, 4, 4);
        camera.lookAt(0, 0, 0);

        // Renderer
        const canvas = document.getElementById('gameCanvas');
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // Işıklandırma
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
        dirLight.position.set(10, 20, 0);
        scene.add(dirLight);

        resetGame();
        animate();
    }

    function resetGame() {
        // Temizlik
        stack.forEach(obj => scene.remove(obj.mesh));
        stack = [];
        score = 0;
        speed = 0.15;
        gameOver = false;
        document.getElementById('score').innerText = score;

        // Temel Blok
        addLayer(0, 0, originalBoxSize, originalBoxSize);
        // Hareketli İlk Blok
        addLayer(0, 0, originalBoxSize, originalBoxSize, 'x');
    }

    function addLayer(x, z, width, depth, direction) {
        const y = boxHeight * stack.length;
        const color = new THREE.Color(`hsl(${180 + stack.length * 4}, 100%, 50%)`); // Neon Mavi Tonları
        
        const geometry = new THREE.BoxGeometry(width, boxHeight, depth);
        const material = new THREE.MeshPhongMaterial({ 
            color, 
            emissive: color,
            emissiveIntensity: 0.2
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(x, y, z);
        scene.add(mesh);

        stack.push({ mesh, width, depth, direction });
    }

    function handleAction() {
        if (!gameStarted) {
            startGame();
            return;
        }
        if (gameOver) {
            restartGame();
            return;
        }

        const top = stack[stack.length - 1];
        const prev = stack[stack.length - 2];
        const direction = top.direction;

        let delta, size;
        if (direction === 'x') {
            delta = top.mesh.position.x - prev.mesh.position.x;
            size = top.width;
        } else {
            delta = top.mesh.position.z - prev.mesh.position.z;
            size = top.depth;
        }

        const overlap = size - Math.abs(delta);

        if (overlap > 0) {
            // Başarılı Yerleştirme
            const newWidth = direction === 'x' ? overlap : top.width;
            const newDepth = direction === 'z' ? overlap : top.depth;
            const newX = direction === 'x' ? prev.mesh.position.x + delta / 2 : top.mesh.position.x;
            const newZ = direction === 'z' ? prev.mesh.position.z + delta / 2 : top.mesh.position.z;

            top.width = newWidth;
            top.depth = newDepth;
            top.mesh.scale.set(newWidth / (direction === 'x' ? size : newWidth), 1, newDepth / (direction === 'z' ? size : newDepth));
            top.mesh.position.set(newX, top.mesh.position.y, newZ);

            score++;
            document.getElementById('score').innerText = score;
            speed += 0.005;

            addLayer(newX, newZ, newWidth, newDepth, direction === 'x' ? 'z' : 'x');
            
            // Kamera Yükselt
            camera.position.y += boxHeight;
        } else {
            endGame();
        }
    }

    function animate() {
        requestAnimationFrame(animate);

        if (gameStarted && !gameOver) {
            const top = stack[stack.length - 1];
            if (top.direction === 'x') {
                top.mesh.position.x += speed;
                if (top.mesh.position.x > 5) top.mesh.position.x = -5;
            } else {
                top.mesh.position.z += speed;
                if (top.mesh.position.z > 5) top.mesh.position.z = -5;
            }
        }
        renderer.render(scene, camera);
    }

    function startGame() {
        gameStarted = true;
        document.getElementById('start-screen').style.display = 'none';
    }

    function endGame() {
        gameOver = true;
        document.getElementById('restart-screen').style.display = 'block';
        document.getElementById('final-score-msg').innerText = "Skor: " + score;
        
        // BURADA FIREBASE SKOR KAYDETME YAPABİLİRSİN
        // updateDoc(doc(db, "users", uid), { balance: increment(score * 10) });
    }

    function restartGame() {
        document.getElementById('restart-screen').style.display = 'none';
        camera.position.set(4, 4, 4);
        resetGame();
    }

    init();
</script>
</body>
</html>

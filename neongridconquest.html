<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Grid Conquest | PixelArena</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020205;
            --p1: #00ff41; /* Matrix YeÅŸili */
            --p2: #ff00f7; /* Cyber Neon Pembe */
            --cell-bg: #0a0a15;
            --border: #1a1a2e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Share Tech Mono', monospace; }
        
        body { 
            background: var(--bg); color: white; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }

        /* Taktiksel Ãœst Panel */
        .hud {
            width: 100%; padding: 20px; display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, #050510, transparent);
            border-bottom: 1px solid var(--border); z-index: 10;
        }

        .player-status { display: flex; flex-direction: column; gap: 5px; }
        .p1-side { color: var(--p1); text-shadow: 0 0 10px var(--p1); }
        .p2-side { color: var(--p2); text-shadow: 0 0 10px var(--p2); text-align: right; }

        .score-num { font-family: 'Syncopate', sans-serif; font-size: 24px; }
        
        .timer-box {
            position: absolute; left: 50%; transform: translateX(-50%);
            background: var(--border); padding: 10px 20px; border-radius: 0 0 15px 15px;
            font-size: 20px; border: 1px solid var(--p1); box-shadow: 0 0 15px rgba(0,255,65,0.2);
        }

        /* ðŸŸ¢ Oyun AlanÄ± - Grid */
        .grid-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            perspective: 1000px; width: 100%;
        }

        #conquestGrid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            width: 90vw;
            max-width: 450px;
            padding: 15px;
            background: rgba(26, 26, 46, 0.5);
            border: 2px solid var(--border);
            border-radius: 10px;
            transform: rotateX(10deg);
        }

        .cell {
            aspect-ratio: 1/1;
            background: var(--cell-bg);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
        }

        .cell::after {
            content: ""; position: absolute; inset: 0;
            opacity: 0; transition: 0.3s;
        }

        .cell.p1 { background: var(--p1); box-shadow: 0 0 15px var(--p1); border: none; }
        .cell.p2 { background: var(--p2); box-shadow: 0 0 15px var(--p2); border: none; }

        /* Lobi ModalÄ± */
        .overlay {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; gap: 20px;
        }

        .neon-btn {
            padding: 15px 40px; background: transparent; border: 2px solid var(--p1);
            color: var(--p1); font-family: 'Syncopate'; cursor: pointer;
            transition: 0.3s; text-transform: uppercase;
        }
        .neon-btn:hover { background: var(--p1); color: black; box-shadow: 0 0 20px var(--p1); }

        .room-item {
            width: 80%; max-width: 300px; padding: 15px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="lobby" class="overlay">
        <h1 style="font-family:'Syncopate'; color:var(--p1); letter-spacing:5px;">CONQUEST</h1>
        <div id="roomList" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="neon-btn" onclick="createArena()">Oda OluÅŸtur</button>
    </div>

    <div class="hud">
        <div class="player-status p1-side">
            <span id="p1Name">USER_1</span>
            <div class="score-num" id="p1Score">0</div>
        </div>
        <div class="timer-box" id="timer">60</div>
        <div class="player-status p2-side">
            <span id="p2Name">USER_2</span>
            <div class="score-num" id="p2Score">0</div>
        </div>
    </div>

    <div class="grid-container">
        <div id="conquestGrid"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain: "emirhan-site.firebaseapp.com",
        projectId: "emirhan-site",
        storageBucket: "emirhan-site.firebasestorage.app",
        messagingSenderId: "668871888390",
        appId: "1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let uid, myRole, currentRoomId;
    const gridEl = document.getElementById('conquestGrid');

    onAuthStateChanged(auth, async (user) => {
        if (!user) { signInAnonymously(auth); return; }
        uid = user.uid;
        listenRooms();
    });

    // IzgarayÄ± BaÅŸlat (6x6)
    for (let i = 0; i < 36; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.onclick = () => claimCell(i);
        gridEl.appendChild(cell);
    }

    function listenRooms() {
        onSnapshot(collection(db, "conquest_rooms"), (snap) => {
            const list = document.getElementById('roomList');
            list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(!data.p2) {
                    const item = document.createElement('div');
                    item.className = 'room-item';
                    item.innerHTML = `<span>Arena #${d.id.slice(0,4)}</span> <button onclick="joinArena('${d.id}')">GÄ°R</button>`;
                    list.appendChild(item);
                }
            });
        });
    }

    window.createArena = async () => {
        const id = "room_" + Math.random().toString(36).substr(2, 9);
        currentRoomId = id;
        myRole = 'p1';
        await setDoc(doc(db, "conquest_rooms", id), {
            p1: uid, p2: null, cells: {}, timer: 60, status: 'waiting'
        });
        startListener(id);
    };

    window.joinArena = async (id) => {
        currentRoomId = id;
        myRole = 'p2';
        await updateDoc(doc(db, "conquest_rooms", id), { p2: uid, status: 'playing' });
        startListener(id);
    };

    function startListener(id) {
        document.getElementById('lobby').style.display = 'none';
        onSnapshot(doc(db, "conquest_rooms", id), (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            renderGrid(data.cells);
            document.getElementById('timer').innerText = data.timer;
            
            // Host zamanÄ± yÃ¶netsin
            if(myRole === 'p1' && data.status === 'playing') {
                runTimer(id, data.timer);
            }
        });
    }

    async function claimCell(index) {
        const ref = doc(db, "conquest_rooms", currentRoomId);
        const updates = {};
        updates[`cells.${index}`] = myRole;
        await updateDoc(ref, updates);
    }

    function renderGrid(cells) {
        let s1 = 0, s2 = 0;
        const allCells = document.querySelectorAll('.cell');
        allCells.forEach((c, i) => {
            c.className = 'cell';
            if(cells[i]) {
                c.classList.add(cells[i]);
                cells[i] === 'p1' ? s1++ : s2++;
            }
        });
        document.getElementById('p1Score').innerText = s1;
        document.getElementById('p2Score').innerText = s2;
    }

    let timerRunning = false;
    function runTimer(id, current) {
        if(timerRunning || current <= 0) return;
        timerRunning = true;
        const intv = setInterval(async () => {
            const snap = await getDoc(doc(db, "conquest_rooms", id));
            const time = snap.data().timer - 1;
            if(time <= 0) {
                clearInterval(intv);
                await updateDoc(doc(db, "conquest_rooms", id), { timer: 0, status: 'finished' });
                alert("SÃ¼re Doldu!");
            } else {
                await updateDoc(doc(db, "conquest_rooms", id), { timer: time });
            }
        }, 1000);
    }

</script>
</body>
</html>

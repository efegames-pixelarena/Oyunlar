<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena BlackJack 3D</title>

<style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
    
    body {
        height:100vh; width: 100vw; overflow:hidden;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%),
                    linear-gradient(135deg, #073d1c 0%, #0a5d2a 50%, #063d1c 100%);
        color:white; touch-action:manipulation; display: flex; flex-direction: column;
    }

    .top-bar {
        position:fixed; top:0; width:100%; height:60px;
        display:flex; align-items:center; justify-content:space-between;
        padding:0 12px; background: rgba(10, 15, 30, 0.9);
        backdrop-filter: blur(10px); border-bottom: 1px solid #1e2642; z-index:100;
    }

    .brand {
        font-size:16px; font-weight:900; background:linear-gradient(90deg,#4fd1ff,#fff);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        letter-spacing: 1px;
    }

    .nav-box { 
        padding:6px 10px; border-radius:10px; font-weight:700; font-size:11px; 
        min-width:85px; text-align:center;
    }
    .balance-box { background:#1a2248; border: 1px solid #4fd1ff44; color: #4fd1ff; }
    .bet-box { background:linear-gradient(90deg,#ff8a00,#ff5f00); color:#000; }

    .game-container { 
        flex: 1; display: flex; flex-direction: column; justify-content: space-between; 
        padding: 75px 0 20px 0;
        perspective: 1000px; /* 3D Derinlik */
    }

    .area { width: 100%; text-align: center; }
    .score-badge { background: rgba(0,0,0,0.6); color: #ffd700; padding: 4px 15px; border-radius: 20px; font-size: 14px; border: 1px solid rgba(255,215,0,0.3); display: inline-block; margin: 10px 0; }

    /* --- 3D KART TASARIMI VE ANİMASYONU --- */
    .cards-wrapper { 
        display: flex; justify-content: center; gap: 10px; min-height: 110px; 
        padding: 0 20px;
    }

    .card-container {
        width: 70px; height: 100px;
        position: relative;
        transform-style: preserve-3d;
        /* Başlangıç pozisyonu: Ekranın sağ dışı ve havada */
        transform: translate(200px, -100px) rotateZ(45deg) scale(0.5);
        opacity: 0;
        transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.3s;
    }

    .card-container.deal {
        transform: translate(0, 0) rotateZ(0deg) scale(1);
        opacity: 1;
    }

    .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden;
        border-radius: 6px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .card-front { transform: rotateY(180deg); background: white; }
    .card-back { background: url('https://deckofcardsapi.com/static/img/back.png') no-repeat center/cover; }

    .card-container.flipped {
        transform: translate(0, 0) rotateY(180deg) scale(1);
    }

    #message { font-size: 20px; font-weight: 900; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.8); height: 35px; }

    .controls { display: none; gap: 15px; justify-content: center; margin-bottom: 10px; }
    .btn { padding: 12px 25px; border-radius: 10px; border: none; font-weight: 800; font-size: 15px; color: white; cursor: pointer; transition: 0.1s; }
    #hit { background: #2ecc71; box-shadow: 0 4px #27ae60; }
    #stand { background: #e74c3c; box-shadow: 0 4px #c0392b; }
    .btn:active { transform: translateY(2px); box-shadow: 0 2px #27ae60; }

    .chips-area { display: flex; justify-content: center; gap: 10px; padding-bottom: 40px; align-items: center; }
    .chip {
        width: 58px; height: 58px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: 900; font-size: 14px; border: 2px dashed rgba(255,255,255,0.4);
        box-shadow: 0 5px 15px rgba(0,0,0,0.4); cursor: pointer;
    }
    .c250 { background: #fff; color: #000; }
    .c500 { background: #27ae60; color: #fff; }
    .c1k { background: #e74c3c; color: #fff; }
    .c2k { background: #000; color: #fff; border-color: #ffd700; }
    .disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">BlackJack 3D</div>
    <div class="right-menu" style="display:flex; gap:5px; align-items:center;">
        <div class="nav-box balance-box">₺<span id="balance">0</span></div>
        <div class="nav-box bet-box">₺<span id="bet">0</span></div>
        <a href="index.html" style="background:#e74c3c; padding:6px 10px; border-radius:10px; font-size:11px; font-weight:800; color:white; text-decoration:none;">GERİ</a>
    </div>
</div>

<div class="game-container">
    <div class="area">
        <div class="score-badge">Kasa: <span id="dealerScore">0</span></div>
        <div id="dealerCards" class="cards-wrapper"></div>
    </div>

    <div class="area">
        <div id="message">BAHİS YAPIN</div>
        <div class="controls" id="controls">
            <button id="hit" class="btn">ÇEK</button>
            <button id="stand" class="btn">KAL</button>
        </div>
    </div>

    <div class="area">
        <div id="playerCards" class="cards-wrapper"></div>
        <div class="score-badge">Sen: <span id="playerScore">0</span></div>
    </div>

    <div class="chips-area" id="chipsArea">
        <div onclick="cancelBet()" style="background:#c0392b; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:800; cursor:pointer;">İPTAL</div>
        <div class="chip c250" onclick="addBet(250)">250</div>
        <div class="chip c500" onclick="addBet(500)">500</div>
        <div class="chip c1k" onclick="addBet(1000)">1K</div>
        <div class="chip c2k" onclick="addBet(2000)">2K</div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let audioCtx = null, balance = 0, bet = 0, userRef = null;
let gameState = "loading", deck = [], player = [], dealer = [], dealerHidden = true;

// --- PROFESYONEL SES MOTORU ---
function playSound(type) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    const now = audioCtx.currentTime;

    if (type === 'card') {
        // Kart fırlatma rüzgarı (White Noise + Filtre)
        const bufSize = audioCtx.sampleRate * 0.15;
        const buffer = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
        
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(2000, now);
        filter.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.1, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        
        noise.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
        noise.start();
    }
    
    if (type === 'flip') {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(400, now);
        o.frequency.exponentialRampToValueAtTime(800, now + 0.05);
        g.gain.setValueAtTime(0.05, now);
        g.gain.linearRampToValueAtTime(0, now + 0.05);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(now + 0.05);
    }

    if (type === 'chip') {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(180, now);
        g.gain.setValueAtTime(0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(now + 0.1);
    }
    
    if (type === 'win') {
        [523, 659, 783].forEach((f, i) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(f, now + i*0.1);
            g.gain.setValueAtTime(0.1, now + i*0.1);
            g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.3);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(now + i*0.1); o.stop(now + i*0.1 + 0.3);
        });
    }
}

onAuthStateChanged(auth, user => {
    if(!user) return;
    userRef = doc(db, "users", user.uid);
    onSnapshot(userRef, snap => {
        balance = snap.data().balance || 0;
        document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
        if(gameState === "loading") gameState = "betting";
    });
});

window.addBet = (amount) => {
    if(gameState !== "betting" || balance < amount) return;
    playSound('chip');
    bet += amount; balance -= amount;
    document.getElementById("bet").innerText = bet.toLocaleString('tr-TR');
    document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
    if(bet >= 250) startCountdown();
};

window.cancelBet = () => {
    if(gameState !== "betting" || bet === 0) return;
    balance += bet; bet = 0;
    document.getElementById("bet").innerText = 0;
    document.getElementById("balance").innerText = balance.toLocaleString('tr-TR');
};

let countdownInterval;
function startCountdown() {
    if(countdownInterval) return;
    let s = 5;
    document.getElementById("message").innerText = "BAŞLIYOR: " + s;
    countdownInterval = setInterval(() => {
        s--;
        if(s > 0) {
            document.getElementById("message").innerText = "BAŞLIYOR: " + s;
        } else {
            clearInterval(countdownInterval);
            countdownInterval = null;
            startGame();
        }
    }, 1000);
}

async function startGame(){
    gameState = "playing";
    document.getElementById("chipsArea").classList.add("disabled");
    document.getElementById("dealerCards").innerHTML = "";
    document.getElementById("playerCards").innerHTML = "";
    player = []; dealer = []; dealerHidden = true;
    createDeck();
    await updateDoc(userRef, { balance: balance });

    // İlk dağıtım
    await draw(player, "playerCards"); await delay(400);
    await draw(dealer, "dealerCards"); await delay(400);
    await draw(player, "playerCards"); await delay(400);
    await draw(dealer, "dealerCards", true);

    if(total(player) === 21) { 
        document.getElementById("message").innerText = "BLACKJACK!"; 
        await delay(1000);
        dealerTurn(true); 
    } else { 
        document.getElementById("message").innerText = "";
        document.getElementById("controls").style.display = "flex"; 
    }
}

async function draw(hand, divId, isHidden=false){
    playSound('card');
    const card = deck.pop();
    hand.push(card);
    
    const container = document.createElement("div");
    container.className = "card-container";
    container.innerHTML = `
        <div class="card-face card-front" style="background: url('https://deckofcardsapi.com/static/img/${cardVal(card.value)}${card.suit}.png') center/cover"></div>
        <div class="card-face card-back"></div>
    `;
    
    document.getElementById(divId).appendChild(container);
    
    // Animasyonu tetikle
    setTimeout(() => {
        container.classList.add("deal");
        if(!isHidden) {
            setTimeout(() => {
                container.classList.add("flipped");
                playSound('flip');
                updateScores();
            }, 300);
        }
    }, 50);
}

function cardVal(v){ let m = {1:"A", 10:"0", 11:"J", 12:"Q", 13:"K"}; return m[v] || v; }

function createDeck(){
    const s=["H","D","C","S"], v=[1,2,3,4,5,6,7,8,9,10,11,12,13];
    deck = []; s.forEach(x => v.forEach(y => deck.push({suit:x, value:y})));
    deck.sort(() => Math.random() - 0.5);
}

function total(h){
    let t=0, a=0;
    h.forEach(c => { let v = c.value > 10 ? 10 : (c.value === 1 ? 11 : c.value); if(v===11) a++; t += v; });
    while(t > 21 && a > 0){ t -= 10; a--; }
    return t;
}

function updateScores(){
    document.getElementById("playerScore").innerText = total(player);
    if(dealerHidden && dealer.length > 0) {
        let first = dealer[0].value > 10 ? 10 : (dealer[0].value === 1 ? 11 : dealer[0].value);
        document.getElementById("dealerScore").innerText = first;
    } else {
        document.getElementById("dealerScore").innerText = total(dealer);
    }
}

document.getElementById("hit").onclick = async () => {
    document.getElementById("controls").style.display = "none";
    await draw(player, "playerCards");
    if(total(player) > 21) {
        dealerTurn();
    } else { 
        document.getElementById("controls").style.display = "flex"; 
    }
};

document.getElementById("stand").onclick = () => {
    document.getElementById("controls").style.display = "none";
    dealerTurn();
};

async function dealerTurn(isBlackjack = false){
    dealerHidden = false;
    const cards = document.getElementById("dealerCards").querySelectorAll('.card-container');
    if(cards[1]) {
        cards[1].classList.add("flipped");
        playSound('flip');
    }
    updateScores();
    await delay(800);

    if(!isBlackjack && total(player) <= 21){ 
        while(total(dealer) < 17){ 
            await draw(dealer, "dealerCards"); 
            await delay(800); 
        } 
    }
    endGame();
}

async function endGame(){
    let p=total(player), d=total(dealer), m=0, txt="";
    if(p>21) { txt="PATLADIN!"; }
    else if(d>21 || p>d) { 
        txt="KAZANDIN!"; m = (p===21 && player.length===2) ? 2.5 : 2; 
        playSound('win');
    }
    else if(d>p) { txt="KASA KAZANDI"; }
    else { txt="BERABERE"; m=1; }
    
    if(m>0) await updateDoc(userRef, { balance: increment(Math.floor(bet*m)) });
    document.getElementById("message").innerText = txt;
    await delay(3000);
    
    document.getElementById("message").innerText = "BAHİS YAPIN";
    document.getElementById("bet").innerText = 0;
    bet = 0;
    gameState = "betting";
    document.getElementById("chipsArea").classList.remove("disabled");
}

function delay(ms){ return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>

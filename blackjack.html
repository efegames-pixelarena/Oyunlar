<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Blackjack</title>

<style>
body{
background:#0f172a;
color:white;
font-family:Arial;
margin:0;
text-align:center;
}

.topbar{
background:#111827;
padding:15px;
display:flex;
justify-content:space-between;
font-size:18px;
}

.game{
margin-top:25px;
}

.cards{
display:flex;
justify-content:center;
gap:10px;
margin:15px 0;
}

.card{
width:70px;
height:100px;
background:white;
color:black;
border-radius:8px;
display:flex;
align-items:center;
justify-content:center;
font-weight:bold;
font-size:20px;
}

.red{color:red;}
.back{background:#374151;}

button{
padding:10px 20px;
margin:5px;
border:none;
border-radius:6px;
cursor:pointer;
font-size:16px;
}

.bet-btn{background:#2563eb;color:white;}
.ctrl-btn{background:#16a34a;color:white;}
#controls{display:none;}
</style>
</head>

<body>

<div class="topbar">
<div>Bakiye: ₺<span id="balance">0</span></div>
<div>Bahis: ₺<span id="bet">0</span></div>
</div>

<div class="game">

<h2>Krupi̇ye</h2>
<div id="dealerCards" class="cards"></div>
<div>Skor: <span id="dealerScore">0</span></div>

<h2>Oyuncu</h2>
<div id="playerCards" class="cards"></div>
<div>Skor: <span id="playerScore">0</span></div>

<h3 id="message">Yükleniyor...</h3>

<div>
<button class="bet-btn" onclick="addBet(100)">100₺</button>
<button class="bet-btn" onclick="addBet(500)">500₺</button>
<button class="bet-btn" onclick="addBet(1000)">1000₺</button>
</div>

<div id="controls">
<button id="hit" class="ctrl-btn">HIT</button>
<button id="stand" class="ctrl-btn">STAND</button>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,getDoc,updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"API_KEY",
authDomain:"PROJECT.firebaseapp.com",
projectId:"PROJECT",
storageBucket:"PROJECT.appspot.com",
messagingSenderId:"XXXX",
appId:"XXXX"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let balance=0;
let bet=0;
let userRef=null;

let betTimer=null;
let decisionTimer=null;

let deck=[],player=[],dealer=[],hiddenCard=null;
let gameState="loading";

const balanceEl=document.getElementById("balance");
const betEl=document.getElementById("bet");
const messageEl=document.getElementById("message");
const playerCardsEl=document.getElementById("playerCards");
const dealerCardsEl=document.getElementById("dealerCards");
const playerScoreEl=document.getElementById("playerScore");
const dealerScoreEl=document.getElementById("dealerScore");
const controls=document.getElementById("controls");

onAuthStateChanged(auth, async user=>{
if(!user){
messageEl.innerText="Giriş Yapmalısın";
return;
}
userRef=doc(db,"users",user.uid);
const snap=await getDoc(userRef);

if(!snap.exists()||snap.data().balance==null){
messageEl.innerText="Balance Yok";
return;
}

balance=snap.data().balance;
updateUI();
messageEl.innerText="Bahis Yapın";
gameState="betting";
});

function updateUI(){
balanceEl.innerText=balance;
betEl.innerText=bet;
playerScoreEl.innerText=getTotal(player);
dealerScoreEl.innerText=(gameState==="playing")?getCardValue(dealer[0]||{value:0}):getTotal(dealer);
}

function createDeck(){
deck=[];
for(let s of ["♥","♦","♣","♠"]){
for(let v=1;v<=13;v++){
deck.push({suit:s,value:v});
}}
deck.sort(()=>Math.random()-0.5);
}

function getCardValue(c){
if(c.value>10)return 10;
if(c.value===1)return 11;
return c.value;
}

function getTotal(hand){
let total=0,aces=0;
for(let c of hand){
let val=getCardValue(c);
total+=val;
if(c.value===1)aces++;
}
while(total>21&&aces>0){
total-=10;
aces--;
}
return total;
}

function renderCard(c){
let d=document.createElement("div");
d.className="card "+((c.suit==="♥"||c.suit==="♦")?"red":"");
let v=c.value===1?"A":c.value===11?"J":c.value===12?"Q":c.value===13?"K":c.value;
d.innerText=v+c.suit;
return d;
}

function renderBack(){
let d=document.createElement("div");
d.className="card back";
return d;
}

window.addBet=async function(amount){
if(gameState!=="betting")return;
if(balance<amount)return;

balance-=amount;
bet+=amount;
await updateDoc(userRef,{balance});
updateUI();

if(!betTimer)startBetTimer();
};

function startBetTimer(){
let time=5;
messageEl.innerText="Bahisler Kapanıyor: "+time;

betTimer=setInterval(()=>{
time--;
if(time<=0){
clearInterval(betTimer);
betTimer=null;
messageEl.innerText="";
if(bet>0)startGame();
}else{
messageEl.innerText="Bahisler Kapanıyor: "+time;
}
},1000);
}

function startGame(){
gameState="dealing";
createDeck();
player=[];dealer=[];
playerCardsEl.innerHTML="";
dealerCardsEl.innerHTML="";

setTimeout(()=>{
deal("player");
deal("dealer");
deal("player");

hiddenCard=deck.pop();
dealer.push(hiddenCard);

dealerCardsEl.appendChild(renderCard(dealer[0]));
dealerCardsEl.appendChild(renderBack());

gameState="playing";
controls.style.display="block";
startDecisionTimer();
updateUI();
},3000);
}

function deal(target){
let c=deck.pop();
if(target==="player"){
player.push(c);
playerCardsEl.appendChild(renderCard(c));
}else{
dealer.push(c);
dealerCardsEl.appendChild(renderCard(c));
}
updateUI();
}

function startDecisionTimer(){
let time=10;
messageEl.innerText="Karar Süresi: "+time;

decisionTimer=setInterval(()=>{
time--;
if(time<=0){
clearInterval(decisionTimer);
stand();
}else{
messageEl.innerText="Karar Süresi: "+time;
}
},1000);
}

document.getElementById("hit").onclick=()=>{
if(gameState!=="playing")return;
deal("player");
if(getTotal(player)>21)finish("lose");
};

document.getElementById("stand").onclick=stand;

async function stand(){
if(gameState!=="playing")return;
clearInterval(decisionTimer);
controls.style.display="none";

dealerCardsEl.children[1].remove();
dealerCardsEl.appendChild(renderCard(hiddenCard));

while(getTotal(dealer)<17){
deal("dealer");
}

let p=getTotal(player);
let d=getTotal(dealer);

if(d>21||p>d){
balance+=bet*2;
await updateDoc(userRef,{balance});
}
else if(p===d){
balance+=bet;
await updateDoc(userRef,{balance});
}

finish();
}

function finish(){
bet=0;
updateUI();

setTimeout(()=>{
player=[];dealer=[];
playerCardsEl.innerHTML="";
dealerCardsEl.innerHTML="";
messageEl.innerText="Bahis Yapın";
gameState="betting";
updateUI();
},3000);
}

</script>

</body>
</html>

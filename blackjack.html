<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Live Casino Blackjack Elite</title>
</head>
<body>

<div>
Bakiye: â‚º<span id="liveBalance">0</span> |
Bahis: â‚º<span id="bet">0</span>
<button onclick="toggleSound()">ðŸ”Š</button>
</div>

<button id="dealBtn" disabled onclick="startRound()">DaÄŸÄ±t</button>
<button id="hitBtn" disabled onclick="hit()">Hit</button>
<button id="standBtn" disabled onclick="stand()">Stand</button>

<script type="module">

import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  updateDoc, 
  onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = getApp();
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let bet = 0;

const dealBtn = document.getElementById("dealBtn");
const hitBtn = document.getElementById("hitBtn");
const standBtn = document.getElementById("standBtn");
const betSpan = document.getElementById("bet");
const balanceSpan = document.getElementById("liveBalance");

/* ðŸ”¥ SADECE OKU â€” KULLANICI OLUÅžTURMA YOK */
onAuthStateChanged(auth, (user) => {

  if (!user) {
    alert("Oturum yok");
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  const userRef = doc(db, "users", user.uid);

  // ðŸ”¥ CANLI BAKÄ°YE
  onSnapshot(userRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      balanceSpan.innerText = data.balance || 0;
    }
  });
});

/* ðŸ”¥ BAKÄ°YE DÃœÅž */
async function oynaVeBakiyedenDus(miktar) {

  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) return false;

  let bal = snap.data().balance || 0;

  if (bal < miktar) {
    alert("Yetersiz bakiye");
    return false;
  }

  await updateDoc(userRef, {
    balance: bal - miktar
  });

  return true;
}

/* ðŸ”¥ BAKÄ°YE ARTIR */
async function bakiyeArttir(miktar) {

  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) return;

  let bal = snap.data().balance || 0;

  await updateDoc(userRef, {
    balance: bal + miktar
  });
}

/* ðŸŽ® BASÄ°T BLACKJACK MANTIÄžI */

window.placeBet = async function(amount){
  const izin = await oynaVeBakiyedenDus(amount);
  if(!izin) return;
  bet += amount;
  betSpan.innerText = bet;
  dealBtn.disabled = false;
}

window.startRound = function(){
  if(bet <= 0) return alert("Bahis koymalÄ±sÄ±n.");
  hitBtn.disabled = false;
  standBtn.disabled = false;
  dealBtn.disabled = true;
}

window.hit = function(){
  if(Math.random() > 0.7){
    stand();
  }
}

window.stand = async function(){

  if(Math.random() > 0.5){
    await bakiyeArttir(bet * 2);
  }

  bet = 0;
  betSpan.innerText = 0;

  hitBtn.disabled = true;
  standBtn.disabled = true;
}

</script>

</body>
</html>

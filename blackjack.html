<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack</title>
<style>
body{
  background:#0b3d2e;
  color:white;
  font-family:Arial;
  text-align:center;
}
.topbar{
  padding:15px;
  font-size:18px;
}
button{
  padding:10px 20px;
  margin:5px;
  border:none;
  border-radius:8px;
  font-size:16px;
}
.betBtn{
  border-radius:50%;
  width:60px;
  height:60px;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="topbar">
Bakiye: â‚º<span id="liveBalance">0</span> |
Bahis: â‚º<span id="bet">0</span>
</div>

<div>
<button id="dealBtn" disabled>DaÄŸÄ±t</button>
<button id="hitBtn" disabled>Hit</button>
<button id="standBtn" disabled>Stand</button>
</div>

<br><br>

<div>
<button class="betBtn" onclick="placeBet(20)">20</button>
<button class="betBtn" onclick="placeBet(50)">50</button>
<button class="betBtn" onclick="placeBet(100)">100</button>
<button class="betBtn" onclick="placeBet(500)">500</button>
<button class="betBtn" onclick="placeBet(1000)">1K</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* âœ… GERÃ‡EK CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain: "emirhan-site.firebaseapp.com",
  projectId: "emirhan-site",
  storageBucket: "emirhan-site.firebasestorage.app",
  messagingSenderId: "668871888390",
  appId: "1:668871888390:web:76568bda84cb1641f7bd87",
  measurementId: "G-96ZVZX3DWH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let bet = 0;
let unsubscribe = null;

const balanceSpan = document.getElementById("liveBalance");
const betSpan = document.getElementById("bet");
const dealBtn = document.getElementById("dealBtn");
const hitBtn = document.getElementById("hitBtn");
const standBtn = document.getElementById("standBtn");

/* ðŸ” AUTH KONTROL */
onAuthStateChanged(auth, (user) => {

  if (!user) {
    alert("GiriÅŸ yapmalÄ±sÄ±n");
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  const userRef = doc(db, "users", user.uid);

  if (unsubscribe) unsubscribe();

  /* ðŸ’° CANLI BAKÄ°YE */
  unsubscribe = onSnapshot(userRef, (snap) => {
    if (snap.exists()) {
      const balance = snap.data().balance ?? 0;
      balanceSpan.innerText = balance.toLocaleString("tr-TR");
    }
  });

});

/* ðŸ’¸ BAKÄ°YE DÃœÅž */
async function bakiyeDus(miktar) {

  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) return false;

  let bal = snap.data().balance ?? 0;

  if (bal < miktar) {
    alert("Yetersiz bakiye!");
    return false;
  }

  await updateDoc(userRef, {
    balance: bal - miktar
  });

  return true;
}

/* ðŸ’µ BAKÄ°YE ARTIR */
async function bakiyeArttir(miktar) {

  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) return;

  let bal = snap.data().balance ?? 0;

  await updateDoc(userRef, {
    balance: bal + miktar
  });
}

/* ðŸŽ¯ BAHÄ°S */
window.placeBet = async function(amount) {

  const izin = await bakiyeDus(amount);
  if (!izin) return;

  bet += amount;
  betSpan.innerText = bet.toLocaleString("tr-TR");
  dealBtn.disabled = false;
};

/* ðŸŽ® ROUND BAÅžLAT */
dealBtn.onclick = function(){

  if (bet <= 0) {
    alert("Bahis koymalÄ±sÄ±n.");
    return;
  }

  hitBtn.disabled = false;
  standBtn.disabled = false;
  dealBtn.disabled = true;
};

/* ðŸŽ® HIT */
hitBtn.onclick = function(){
  if (Math.random() > 0.7) {
    standBtn.click();
  }
};

/* ðŸŽ® STAND */
standBtn.onclick = async function(){

  if (Math.random() > 0.5) {
    await bakiyeArttir(bet * 2);
  }

  bet = 0;
  betSpan.innerText = 0;

  hitBtn.disabled = true;
  standBtn.disabled = true;
};

</script>

</body>
</html>

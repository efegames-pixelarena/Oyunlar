<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkyCrash V1</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>

<style>
/* CSS AYNEN KORUNDU */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
html,body{height:100%;overflow:hidden;background:#070b18;}
body{display:flex;flex-direction:column;height:100dvh;}
.top{height:90px;background:linear-gradient(180deg,#1b2247,#0e1330);display:flex;justify-content:space-between;align-items:flex-start;padding:15px 20px 0 20px;border-bottom:1px solid #2a356b;position:relative;}
.logo{font-size:20px;font-weight:bold;color:#fff;letter-spacing:2px;}
.balanceBox{background:rgba(255,255,255,0.05);padding:6px 14px;border-radius:20px;border:1px solid rgba(0,255,255,0.3);color:#00eaff;font-weight:bold;box-shadow:0 0 12px rgba(0,255,255,0.5);}
.historyBar{position:absolute;bottom:8px;left:0;width:100%;display:flex;gap:10px;padding:0 15px;font-size:13px;}
.historyItem{padding:3px 8px;border-radius:10px;background:rgba(0,255,200,0.1);color:#00eaff;}
.historyCrash{background:rgba(255,0,60,0.2);color:#ff2a4d;}
.main{flex:1;position:relative;overflow:hidden;}
.graphArea{width:100%;height:100%;position:relative;background:radial-gradient(circle at center,#16204a,#070b18 70%);}
.multiplier{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:70px;font-weight:bold;color:#00eaff;text-shadow:0 0 25px #00eaff;}
.plane{position:absolute;width:40px;height:40px;fill:#00eaff;}
.bottom{height:130px;background:#121833;display:flex;justify-content:center;align-items:center;gap:15px;}
.betBox{background:#1a2248;padding:12px;border-radius:10px;width:45%;max-width:200px;display:flex;flex-direction:column;gap:6px;}
.betBox input{padding:8px;border:none;border-radius:6px;text-align:center;font-weight:bold;}
.betBox button{padding:10px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;background:#6c5ce7;color:white;}
.cancel{background:#ff2a4d !important;}
.cashout{background:#00eaff !important;color:#000 !important;}
.winAnim{animation:winFlash 0.6s ease;}
.loseAnim{animation:loseFlash 0.6s ease;}
@keyframes winFlash{0%{background:#00eaff;}100%{background:#1a2248;}}
@keyframes loseFlash{0%{background:#ff2a4d;}100%{background:#1a2248;}}
</style>
</head>
<body>

<div class="top">
<div class="logo">SKYCRASH</div>
<div class="balanceBox">Bakiye: <span id="balance">0</span> TRY</div>
<div class="historyBar" id="historyBar"></div>
</div>

<div class="main">
<div class="graphArea">
<div class="multiplier" id="multiplier">1.00x</div>
<svg class="plane" id="plane" viewBox="0 0 24 24">
<path d="M2 16l20-5-20-5v4l15 1-15 1z"/>
</svg>
</div>
</div>

<div class="bottom">
<div class="betBox">
<input type="number" id="bet1" value="100">
<button id="btn1">Bahis Yap</button>
</div>
<div class="betBox">
<input type="number" id="bet2" value="200">
<button id="btn2">Bahis Yap</button>
</div>
</div>

<script type="module">

/* ================= FIREBASE CONFIG ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "CONFIG",
  authDomain: "CONFIG",
  projectId: "CONFIG",
  storageBucket: "CONFIG",
  messagingSenderId: "CONFIG",
  appId: "CONFIG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= GLOBAL ROUND ================= */

const roundRef = doc(db,"crash","currentRound");

let isHost=false;
let multiplier=1;
let phase="betting";
let crashPoint=0;
let balance=0;
let uid=null;
let animation;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async(user)=>{
if(!user) return;
uid=user.uid;
listenBalance();
checkRound();
});

function listenBalance(){
const userRef=doc(db,"users",uid);
onSnapshot(userRef,(snap)=>{
if(snap.exists()){
balance=snap.data().balance || 0;
document.getElementById("balance").innerText=balance.toFixed(2);
}
});
}

/* ================= HOST LOGIC ================= */

async function checkRound(){
const snap=await getDoc(roundRef);
if(!snap.exists()){
isHost=true;
createRound();
}else{
listenRound();
}
}

async function createRound(){
crashPoint=(1/(1-Math.random()))*0.97;
await setDoc(roundRef,{
phase:"betting",
multiplier:1,
crashPoint:crashPoint,
timestamp:Date.now()
});
listenRound();
setTimeout(()=>startFlight(),5000);
}

function listenRound(){
onSnapshot(roundRef,(snap)=>{
if(!snap.exists()) return;
const data=snap.data();
phase=data.phase;
multiplier=data.multiplier;
crashPoint=data.crashPoint;
document.getElementById("multiplier").innerText=multiplier.toFixed(2)+"x";
if(phase==="crashed"){
triggerLocalCrash();
}
});
}

/* ================= FLIGHT ================= */

function startFlight(){
if(!isHost) return;
updateDoc(roundRef,{phase:"flying"});
let last=performance.now();

function animate(time){
let delta=(time-last)/1000;
last=time;
multiplier+=0.12*delta*multiplier;
updateDoc(roundRef,{multiplier:multiplier});
if(multiplier>=crashPoint){
updateDoc(roundRef,{phase:"crashed"});
setTimeout(createRound,4000);
return;
}
animation=requestAnimationFrame(animate);
}
animation=requestAnimationFrame(animate);
}

/* ================= CRASH ================= */

function triggerLocalCrash(){
document.body.classList.add("loseAnim");
setTimeout(()=>document.body.classList.remove("loseAnim"),600);
}

/* ================= BET ================= */

function handleBet(btnId,inputId,index){
let btn=document.getElementById(btnId);
let input=document.getElementById(inputId);
btn.onclick=async function(){
let amount=parseFloat(input.value);
if(amount<=0 || balance<amount) return;
balance-=amount;
await updateDoc(doc(db,"users",uid),{balance:balance});
btn.disabled=true;
};
}

handleBet("btn1","bet1",1);
handleBet("btn2","bet2",2);

</script>
</body>
</html>

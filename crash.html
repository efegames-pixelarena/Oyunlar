<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PixelArena SkyCrash PRO</title>
    <style>
        /* TEMEL SIFIRLAMA VE YAPI */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background: #05070f; color: white; height: 100vh; overflow: hidden; }

        /* ÜST BAR (SENİN TASARIMIN) */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; background: rgba(10, 15, 30, 0.95);
            backdrop-filter: blur(15px); border-bottom: 1px solid #1e2642; z-index: 1000;
        }
        .brand { font-size: 18px; font-weight: 900; background: linear-gradient(90deg, #4fd1ff, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .right-menu { display: flex; gap: 8px; align-items: center; }
        .nav-box { padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 13px; min-width: 90px; text-align: center; }
        .balance-box { background: rgba(79, 209, 255, 0.1); border: 1px solid #4fd1ff44; color: #4fd1ff; }
        .bet-box { background: linear-gradient(90deg, #ff8a00, #ff5f00); color: #000; }
        .back-btn { background: #d63031; color: white; padding: 8px 15px; border-radius: 10px; font-weight: 800; font-size: 12px; border: none; cursor: pointer; }

        /* GEÇMİŞ ÇARPANLAR */
        .history {
            position: fixed; top: 60px; width: 100%; height: 40px;
            display: flex; align-items: center; gap: 8px; padding: 0 15px;
            background: rgba(5, 7, 15, 0.8); overflow-x: auto; scrollbar-width: none; z-index: 900;
        }
        .history::-webkit-scrollbar { display: none; }
        .history span { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; white-space: nowrap; transition: 0.3s; }

        /* OYUN ALANI (CANVAS) */
        .game-container { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 220px); z-index: 1; }
        canvas { width: 100%; height: 100%; }

        /* MERKEZİ ÇARPAN EKRANI */
        .multiplier-display {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 10;
        }
        .x-value { font-size: 85px; font-weight: 900; color: #fff; text-shadow: 0 0 50px rgba(255, 255, 255, 0.2); transition: transform 0.1s; }
        .status-text { font-size: 20px; font-weight: 800; color: #4fd1ff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        
        /* PATLAMA EFEKTİ */
        .crashed-text { color: #ff2a4d !important; animation: crash-shake 0.4s infinite; }
        @keyframes crash-shake {
            0% { transform: translate(0,0); } 20% { transform: translate(-5px, 5px); } 40% { transform: translate(-5px, -5px); }
            60% { transform: translate(5px, 5px); } 80% { transform: translate(5px, -5px); } 100% { transform: translate(0,0); }
        }

        /* ALT KONTROL PANELİ */
        .bottom-panel {
            position: fixed; bottom: 0; width: 100%; height: 220px;
            background: #0a0f1e; border-top: 2px solid #1e2642;
            display: flex; justify-content: center; align-items: center; gap: 15px; padding: 15px; z-index: 1000;
        }
        .bet-card {
            background: #161d36; flex: 1; max-width: 200px; height: 100%;
            border-radius: 20px; padding: 15px; display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #1e2642;
        }
        .bet-card input {
            width: 100%; background: #050811; border: 2px solid #273c8f; border-radius: 12px;
            color: white; padding: 12px; text-align: center; font-size: 18px; font-weight: 800; outline: none;
        }
        .bet-card input:disabled { opacity: 0.5; border-color: #111; }
        
        .auto-row { display: flex; justify-content: space-between; align-items: center; background: #0d1326; padding: 8px 12px; border-radius: 10px; }
        .auto-row span { font-size: 11px; font-weight: 800; color: #4fd1ff; }

        /* TOGGLE SWITCH */
        .switch { position: relative; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #273c8f; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00b894; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* BUTONLAR */
        .main-btn {
            flex-grow: 1; border: none; border-radius: 12px; color: white; font-weight: 900;
            font-size: 16px; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn-bet { background: #5743d6; box-shadow: 0 4px 0 #3a2db0; }
        .btn-bet:active { transform: translateY(2px); box-shadow: none; }
        .btn-cancel { background: #d63031; box-shadow: 0 4px 0 #a51e1e; }
        .btn-cashout { background: #00b894; box-shadow: 0 4px 0 #008d71; }
        .main-btn:disabled { background: #2d3436; box-shadow: none; opacity: 0.6; cursor: not-allowed; }

        /* MOBİL UYUMLULUK */
        @media (max-width: 400px) {
            .x-value { font-size: 60px; }
            .bet-card { padding: 10px; }
            .main-btn { font-size: 13px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="brand">SKYCRASH PRO</div>
    <div class="right-menu">
        <div class="nav-box balance-box">₺<span id="balance">0</span></div>
        <div class="nav-box bet-box">B: ₺<span id="betTotal">0</span></div>
        <button class="back-btn" onclick="window.history.back()">GERİ</button>
    </div>
</div>

<div class="history" id="history"></div>

<div class="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="multiplier-display">
        <div class="status-text" id="statusText">YENİ TUR BEKLENİYOR</div>
        <div class="x-value" id="multiplier">1.00x</div>
    </div>
</div>

<div class="bottom-panel">
    <div class="bet-card">
        <input type="number" id="betInput1" value="100" min="1">
        <div class="auto-row">
            <span>OTO BAHİS</span>
            <label class="switch"><input type="checkbox" id="autoSwitch1"><span class="slider"></span></label>
        </div>
        <button id="btn1" class="main-btn btn-bet">BAHİS YAP</button>
    </div>

    <div class="bet-card">
        <input type="number" id="betInput2" value="200" min="1">
        <div class="auto-row">
            <span>OTO BAHİS</span>
            <label class="switch"><input type="checkbox" id="autoSwitch2"><span class="slider"></span></label>
        </div>
        <button id="btn2" class="main-btn btn-bet">BAHİS YAP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GAME ENGINE VARIABLES ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const multEl = document.getElementById('multiplier');
    const statusEl = document.getElementById('statusText');
    const balEl = document.getElementById('balance');
    const betTotalEl = document.getElementById('betTotal');

    let userRef = null, balance = 0;
    let phase = "WAITING"; // WAITING, COUNTDOWN, FLYING, CRASHED
    let multiplier = 1.00;
    let crashPoint = 0;
    let startTime = 0;
    let activeBet1 = 0, activeBet2 = 0;
    let auto1 = false, auto2 = false;

    // --- CANVAS ANIMATION SYSTEM ---
    let width, height;
    let particles = [];
    function resize() {
        width = canvas.width = canvas.offsetWidth;
        height = canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Particle {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2;
            this.speed = Math.random() * 2 + 1;
        }
        update(m) {
            this.x -= this.speed * m;
            this.y += this.speed * 0.5 * m;
            if (this.x < 0) this.x = width;
            if (this.y > height) this.y = 0;
        }
        draw() {
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    for(let i=0; i<100; i++) particles.push(new Particle());

    function animate() {
        ctx.clearRect(0, 0, width, height);
        
        // Background Grid
        ctx.strokeStyle = "rgba(79, 209, 255, 0.05)";
        ctx.lineWidth = 1;
        const spacing = 50;
        const shift = (multiplier * 20) % spacing;
        for(let x = width; x > 0; x -= spacing) {
            ctx.beginPath(); ctx.moveTo(x - shift, 0); ctx.lineTo(x - shift, height); ctx.stroke();
        }
        for(let y = 0; y < height; y += spacing) {
            ctx.beginPath(); ctx.moveTo(0, y + (shift/2)); ctx.lineTo(width, y + (shift/2)); ctx.stroke();
        }

        // Particles
        particles.forEach(p => {
            p.update(phase === "FLYING" ? multiplier : 0.5);
            p.draw();
        });

        // Flying Line
        if(phase === "FLYING") {
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#4fd1ff";
            ctx.strokeStyle = "#4fd1ff";
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(0, height);
            ctx.quadraticCurveTo(width/2, height, width * 0.8, height * 0.2);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        requestAnimationFrame(animate);
    }
    animate();

    // --- LOGIC ---
    onAuthStateChanged(auth, user => {
        if(user) {
            userRef = doc(db, "users", user.uid);
            onSnapshot(userRef, snap => {
                if(snap.exists()) {
                    balance = snap.data().balance || 0;
                    balEl.innerText = balance.toLocaleString('tr-TR');
                }
            });
            startNewRound();
        }
    });

    function getCrashPoint() {
        const r = Math.random();
        if (r < 0.05) return 1.00; // House edge
        return (0.98 / (1 - r)).toFixed(2);
    }

    function startNewRound() {
        phase = "COUNTDOWN";
        multiplier = 1.00;
        multEl.classList.remove('crashed-text');
        statusEl.innerText = "BAHİSLER ALINIYOR";
        
        // Reset Inputs
        document.getElementById('betInput1').disabled = false;
        document.getElementById('betInput2').disabled = false;

        // Auto Bets
        if(auto1) handleBet(1, true);
        if(auto2) handleBet(2, true);

        let count = 5;
        const timer = setInterval(() => {
            multEl.innerText = count + "s";
            if(count <= 0) {
                clearInterval(timer);
                launch();
            }
            count--;
        }, 1000);
        updateUI();
    }

    function launch() {
        phase = "FLYING";
        statusEl.innerText = "";
        document.getElementById('betInput1').disabled = true;
        document.getElementById('betInput2').disabled = true;
        startTime = Date.now();
        crashPoint = parseFloat(getCrashPoint());
        tick();
    }

    function tick() {
        if(phase !== "FLYING") return;

        const elapsed = (Date.now() - startTime) / 1000;
        // Profesyonel İvme Formülü: Hızlanarak artar
        multiplier = Math.pow(1.09, elapsed + Math.pow(elapsed, 1.2) * 0.1);
        
        if(multiplier >= crashPoint) {
            doCrash();
        } else {
            multEl.innerText = multiplier.toFixed(2) + "x";
            // Dinamik Ölçekleme Hissiyatı
            const scale = 1 + (Math.floor(multiplier) * 0.01);
            multEl.style.transform = `scale(${Math.min(scale, 1.5)})`;
            
            updateUI();
            requestAnimationFrame(tick);
        }
    }

    function doCrash() {
        phase = "CRASHED";
        multEl.classList.add('crashed-text');
        multEl.innerText = multiplier.toFixed(2) + "x";
        statusEl.innerText = "PATLADI! UZAKLAŞ!!!";
        
        addHistory(multiplier);
        activeBet1 = 0; activeBet2 = 0;
        updateUI();
        
        setTimeout(startNewRound, 4000);
    }

    async function handleBet(box, isAuto = false) {
        if(!userRef) return;
        const input = document.getElementById('betInput'+box);
        const amount = Math.floor(parseInt(input.value)) || 0;
        let currentActive = (box === 1) ? activeBet1 : activeBet2;

        if(phase === "COUNTDOWN" && currentActive === 0) {
            if(balance >= amount && amount > 0) {
                await updateDoc(userRef, { balance: increment(-amount) });
                if(box === 1) activeBet1 = amount; else activeBet2 = amount;
            }
        } 
        else if(phase === "COUNTDOWN" && currentActive > 0 && !isAuto) {
            await updateDoc(userRef, { balance: increment(currentActive) });
            if(box === 1) activeBet1 = 0; else activeBet2 = 0;
        }
        else if(phase === "FLYING" && currentActive > 0) {
            const win = Math.floor(currentActive * multiplier);
            await updateDoc(userRef, { balance: increment(win) });
            if(box === 1) activeBet1 = 0; else activeBet2 = 0;
        }
        updateUI();
    }

    function updateUI() {
        const btn1 = document.getElementById('btn1');
        const btn2 = document.getElementById('btn2');

        const refreshBtn = (btn, active) => {
            if(phase === "COUNTDOWN") {
                btn.disabled = false;
                btn.innerText = active > 0 ? "İPTAL" : "BAHİS YAP";
                btn.className = active > 0 ? "main-btn btn-cancel" : "main-btn btn-bet";
            } else if(phase === "FLYING" && active > 0) {
                btn.disabled = false;
                btn.innerText = `ÇEK ₺${Math.floor(active * multiplier)}`;
                btn.className = "main-btn btn-cashout";
            } else {
                btn.disabled = true;
                btn.innerText = active > 0 ? "UÇUYOR..." : "BEKLENİYOR";
                btn.className = "main-btn";
            }
        };

        refreshBtn(btn1, activeBet1);
        refreshBtn(btn2, activeBet2);
        betTotalEl.innerText = (activeBet1 + activeBet2).toLocaleString('tr-TR');
    }

    function addHistory(val) {
        const span = document.createElement('span');
        span.innerText = parseFloat(val).toFixed(2) + "x";
        span.style.color = val < 2 ? "#ff2a4d" : (val < 10 ? "#4fd1ff" : "#f1c40f");
        span.style.background = "rgba(255,255,255,0.05)";
        const container = document.getElementById('history');
        container.prepend(span);
        if(container.children.length > 15) container.lastChild.remove();
    }

    // Event Listeners
    document.getElementById('btn1').onclick = () => handleBet(1);
    document.getElementById('btn2').onclick = () => handleBet(2);
    document.getElementById('autoSwitch1').onchange = (e) => auto1 = e.target.checked;
    document.getElementById('autoSwitch2').onchange = (e) => auto2 = e.target.checked;

</script>
</body>
</html>

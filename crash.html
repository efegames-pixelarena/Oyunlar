<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PixelArena SkyCrash PRO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background: #05070f; color: white; height: 100vh; overflow: hidden; }

        /* ÜST BAR - KORUNAN TASARIM */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; background: rgba(10, 15, 30, 0.95);
            backdrop-filter: blur(15px); border-bottom: 1px solid #1e2642; z-index: 1000;
        }
        .brand { font-size: 16px; font-weight: 900; background: linear-gradient(90deg, #4fd1ff, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .right-menu { display: flex; gap: 6px; align-items: center; }
        .nav-box { padding: 6px 10px; border-radius: 10px; font-weight: 700; font-size: 11px; min-width: 85px; text-align: center; }
        .balance-box { background: #1a2248; border: 1px solid #4fd1ff44; color: #4fd1ff; }
        .bet-box { background: linear-gradient(90deg, #ff8a00, #ff5f00); color: #000; }
        .back-btn { background: #d63031; color: white; padding: 6px 12px; border-radius: 10px; font-weight: 800; font-size: 11px; border: none; cursor: pointer; }

        /* GEÇMİŞ */
        .history {
            position: fixed; top: 60px; width: 100%; height: 38px;
            display: flex; align-items: center; gap: 6px; padding: 0 10px;
            background: rgba(13, 19, 38, 0.8); overflow-x: auto; scrollbar-width: none; z-index: 900;
        }
        .history span { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; white-space: nowrap; }

        /* OYUN ALANI */
        .game-container { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 240px); z-index: 1; }
        canvas { width: 100%; height: 100%; display: block; }

        /* MERKEZİ EKRAN */
        .multiplier-display {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 10; width: 100%;
        }
        .x-value { font-size: 75px; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(255, 255, 255, 0.2); }
        .status-text { font-size: 18px; font-weight: 800; color: #4fd1ff; margin-bottom: 5px; letter-spacing: 1px; }
        .crashed-text { color: #ff2a4d !important; animation: shake 0.3s infinite; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, -1px); } 100% { transform: translate(1px, 1px); }
        }

        /* ALT PANEL - TAŞMA DÜZENLENMİŞ */
        .bottom-panel {
            position: fixed; bottom: 0; width: 100%; height: 240px;
            background: #0a0f1e; border-top: 1px solid #1e2642;
            display: flex; justify-content: center; align-items: center; gap: 10px; padding: 0 10px; z-index: 1000;
        }
        .bet-card {
            background: #161d36; flex: 1; max-width: 185px; height: 210px;
            border-radius: 15px; padding: 12px; display: flex; flex-direction: column; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .bet-card input {
            width: 100%; background: #050811; border: 1px solid #273c8f; border-radius: 8px;
            color: white; padding: 10px; text-align: center; font-size: 16px; font-weight: 700; outline: none;
        }
        .bet-card input:disabled { opacity: 0.4; }
        
        .auto-row { display: flex; justify-content: space-between; align-items: center; background: #0d1326; padding: 6px 10px; border-radius: 8px; }
        .auto-row span { font-size: 10px; font-weight: 800; color: #4fd1ff; }

        .switch { position: relative; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #273c8f; transition: .3s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #00b894; }
        input:checked + .slider:before { transform: translateX(16px); }

        .main-btn {
            width: 100%; flex-grow: 1; border: none; border-radius: 10px; color: white; font-weight: 800;
            font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .btn-bet { background: #5743d6; }
        .btn-cancel { background: #d63031; }
        .btn-cashout { background: #00b894; }
        .main-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="brand">SkyCrash</div>
    <div class="right-menu">
        <div class="nav-box balance-box">₺<span id="balance">0</span></div>
        <div class="nav-box bet-box">B: ₺<span id="betTotal">0</span></div>
        <button class="back-btn" onclick="window.history.back()">GERİ</button>
    </div>
</div>

<div class="history" id="history"></div>

<div class="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="multiplier-display">
        <div class="status-text" id="statusText">BAĞLANILIYOR...</div>
        <div class="x-value" id="multiplier">1.00x</div>
    </div>
</div>

<div class="bottom-panel">
    <div class="bet-card">
        <input type="number" id="betInput1" value="100">
        <div class="auto-row">
            <span>OTO BAHİS</span>
            <label class="switch"><input type="checkbox" id="autoSwitch1"><span class="slider"></span></label>
        </div>
        <button id="btn1" class="main-btn btn-bet">BAHİS YAP</button>
    </div>

    <div class="bet-card">
        <input type="number" id="betInput2" value="200">
        <div class="auto-row">
            <span>OTO BAHİS</span>
            <label class="switch"><input type="checkbox" id="autoSwitch2"><span class="slider"></span></label>
        </div>
        <button id="btn2" class="main-btn btn-bet">BAHİS YAP</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- SES SİSTEMİ ---
    let audioCtx = null;
    const initAudio = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    };

    function playSfx(type) {
        initAudio();
        const now = audioCtx.currentTime;
        if(type==='countdown') {
            const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(600, now); g.gain.setValueAtTime(0.05, now);
            g.gain.exponentialRampToValueAtTime(0.01, now+0.1); osc.start(); osc.stop(now+0.1);
        }
        if(type==='bet') { 
            const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(440, now); g.gain.setValueAtTime(0.1, now);
            g.gain.exponentialRampToValueAtTime(0.01, now+0.1); osc.start(); osc.stop(now+0.1); 
        }
        if(type==='cash') {
            const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1600, now+0.3);
            g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now+0.3); osc.start(); osc.stop(now+0.3); 
        }
        if(type==='crash') {
            const bufferSize = audioCtx.sampleRate * 0.5;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, now); filter.frequency.exponentialRampToValueAtTime(40, now + 0.5);
            const g = audioCtx.createGain(); g.gain.setValueAtTime(0.4, now);
            g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            noise.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
            noise.start(); noise.stop(now + 0.5);
        }
    }

    // --- MOTOR ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const multEl = document.getElementById('multiplier');
    const statusEl = document.getElementById('statusText');
    const balEl = document.getElementById('balance');
    const betTotalEl = document.getElementById('betTotal');

    let userRef = null, balance = 0, phase = "WAITING";
    let multiplier = 1.00, crashPoint = 0, startTime = 0;
    let activeBet1 = 0, activeBet2 = 0, auto1 = false, auto2 = false;

    let width, height;
    function resize() {
        width = canvas.width = canvas.offsetWidth;
        height = canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resize); resize();

    function draw() {
        ctx.fillStyle = "#03050a"; ctx.fillRect(0,0,width,height);
        // Grid ve yıldız çizimleri (Basitleştirilmiş PRO motoru)
        ctx.strokeStyle = "rgba(79, 209, 255, 0.05)";
        let step = 50;
        let shift = (multiplier * 20) % step;
        for(let x=width; x>0; x-=step) { ctx.beginPath(); ctx.moveTo(x-shift,0); ctx.lineTo(x-shift,height); ctx.stroke(); }
        
        if(phase === "FLYING") {
            ctx.strokeStyle = "#4fd1ff"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, height);
            ctx.quadraticCurveTo(width/2, height, width*0.8, height*0.3); ctx.stroke();
        }
        requestAnimationFrame(draw);
    }
    draw();

    onAuthStateChanged(auth, user => {
        if(user) {
            userRef = doc(db, "users", user.uid);
            onSnapshot(userRef, snap => { if(snap.exists()) { balance = snap.data().balance || 0; balEl.innerText = balance.toLocaleString('tr-TR'); }});
            startNewRound();
        }
    });

    function startNewRound() {
        phase = "COUNTDOWN"; multiplier = 1.00;
        multEl.classList.remove('crashed-text');
        statusEl.innerText = "YENİ TUR";
        document.getElementById('betInput1').disabled = false;
        document.getElementById('betInput2').disabled = false;
        if(auto1) handleBet(1, true); if(auto2) handleBet(2, true);
        
        let count = 5;
        const timer = setInterval(() => {
            multEl.innerText = count + "s";
            if(count > 0) playSfx('countdown');
            if(count <= 0) { clearInterval(timer); launch(); }
            count--;
        }, 1000);
        updateUI();
    }

    function launch() {
        phase = "FLYING"; statusEl.innerText = "";
        document.getElementById('betInput1').disabled = true;
        document.getElementById('betInput2').disabled = true;
        startTime = Date.now();
        crashPoint = parseFloat((Math.random() < 0.03 ? 1.00 : (0.97 / (1 - Math.random()))).toFixed(2));
        tick();
    }

    function tick() {
        if(phase !== "FLYING") return;
        const elapsed = (Date.now() - startTime) / 1000;
        multiplier = Math.pow(1.08, elapsed + Math.pow(elapsed, 1.1) * 0.1);
        if(multiplier >= crashPoint) { doCrash(); } 
        else { multEl.innerText = multiplier.toFixed(2) + "x"; updateUI(); requestAnimationFrame(tick); }
    }

    function doCrash() {
        phase = "CRASHED"; playSfx('crash');
        multEl.classList.add('crashed-text');
        multEl.innerText = multiplier.toFixed(2) + "x";
        statusEl.innerText = "UZAKLAŞ !!!";
        addHistory(multiplier);
        activeBet1 = 0; activeBet2 = 0;
        updateUI();
        setTimeout(startNewRound, 3000);
    }

    async function handleBet(box, isAuto = false) {
        initAudio(); if(!userRef) return;
        const input = document.getElementById('betInput'+box);
        const amount = Math.floor(parseInt(input.value)) || 0;
        let currentActive = (box === 1) ? activeBet1 : activeBet2;

        if(phase === "COUNTDOWN" && currentActive === 0 && balance >= amount && amount > 0) {
            await updateDoc(userRef, { balance: increment(-amount) });
            if(box === 1) activeBet1 = amount; else activeBet2 = amount;
            if(!isAuto) playSfx('bet');
        } 
        else if(phase === "COUNTDOWN" && currentActive > 0 && !isAuto) {
            await updateDoc(userRef, { balance: increment(currentActive) });
            if(box === 1) activeBet1 = 0; else activeBet2 = 0;
        }
        else if(phase === "FLYING" && currentActive > 0) {
            const win = Math.floor(currentActive * multiplier);
            await updateDoc(userRef, { balance: increment(win) });
            if(box === 1) activeBet1 = 0; else activeBet2 = 0;
            playSfx('cash');
        }
        updateUI();
    }

    function updateUI() {
        const u = (id, active) => {
            const b = document.getElementById(id);
            if(phase === "COUNTDOWN") {
                b.disabled = false; b.innerText = active > 0 ? "İPTAL" : "BAHİS YAP";
                b.className = active > 0 ? "main-btn btn-cancel" : "main-btn btn-bet";
            } else if(phase === "FLYING" && active > 0) {
                b.disabled = false; b.innerText = `ÇEK ₺${Math.floor(active * multiplier)}`;
                b.className = "main-btn btn-cashout";
            } else { b.disabled = true; b.innerText = active > 0 ? "UÇUYOR" : "BEKLE"; b.className = "main-btn"; }
        };
        u('btn1', activeBet1); u('btn2', activeBet2);
        betTotalEl.innerText = (activeBet1 + activeBet2).toLocaleString('tr-TR');
    }

    function addHistory(val) {
        const span = document.createElement('span');
        span.innerText = val.toFixed(2) + "x";
        span.style.background = val < 2 ? "#ff2a4d" : "#00b894";
        const h = document.getElementById('history'); h.prepend(span);
        if(h.children.length > 20) h.lastChild.remove();
    }

    document.getElementById('btn1').onclick = () => handleBet(1);
    document.getElementById('btn2').onclick = () => handleBet(2);
    document.getElementById('autoSwitch1').onchange = (e) => auto1 = e.target.checked;
    document.getElementById('autoSwitch2').onchange = (e) => auto2 = e.target.checked;
    document.addEventListener('touchstart', initAudio, { once: true });
</script>
</body>
</html>

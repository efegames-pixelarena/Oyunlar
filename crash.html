<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, increment, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userRef = null, balance = 0, activeBet1 = 0, activeBet2 = 0;
let gameData = { phase: "waiting", multiplier: 1, countdown: 0, startTime: 0, crashPoint: 0 };
let loopLock = false; // Çakışmayı önlemek için kilit

const canvas = document.getElementById("graph"), ctx = canvas.getContext("2d");
const multEl = document.getElementById("multiplier");
function resize() { canvas.width = window.innerWidth; canvas.height = canvas.offsetHeight; }
window.addEventListener("resize", resize); resize();

let stars = Array.from({length: 80}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2 }));

// --- GÖRSEL MOTOR ---
function render() {
    ctx.fillStyle = "#03050a"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "white";
    stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, 7); ctx.fill(); s.x -= (gameData.phase === "flying" ? gameData.multiplier * 0.5 : 0.2); if(s.x<0) s.x=canvas.width; });

    if(gameData.phase === "flying") {
        const elapsed = (Date.now() - gameData.startTime) / 1000;
        const currentM = Math.pow(1.08, elapsed); 
        
        if (currentM < gameData.crashPoint) {
            gameData.multiplier = currentM;
            multEl.className = "multiplier big";
            multEl.innerText = gameData.multiplier.toFixed(2) + "x";
        } else {
            // Patlama anı (Sadece yerel görsel)
            gameData.phase = "crashed";
            multEl.className = "multiplier big crashed";
            multEl.innerText = gameData.crashPoint.toFixed(2) + "x";
            addHistory(gameData.crashPoint);
            activeBet1 = 0; activeBet2 = 0;
            
            // DÖNGÜYÜ BAŞLAT: Tur bittiğinde otomatik sıfırla
            autoRestartCycle();
        }
    } else if(gameData.phase === "betting") {
        multEl.className = "multiplier small";
        multEl.innerText = "UÇUŞA " + gameData.countdown + "s";
    }
    updateButtons();
    requestAnimationFrame(render);
}
render();

// --- OTOMATİK DÖNGÜ YÖNETİMİ ---
async function autoRestartCycle() {
    if(loopLock) return;
    loopLock = true;

    // 3 saniye patlama ekranında bekle
    setTimeout(async () => {
        const gRef = doc(db, "games", "current");
        
        // Transaction kullanarak sadece tek bir cihazın turu başlatmasını sağlıyoruz
        try {
            await runTransaction(db, async (transaction) => {
                const sfDoc = await transaction.get(gRef);
                if (sfDoc.data().phase === "flying" || sfDoc.data().phase === "betting") return;

                // YENİ X HESAPLAMA (Tamamen Rastgele)
                const r = Math.random();
                let nextCrash = 1.00;
                if(r < 0.05) nextCrash = 1.00; // %5 ihtimalle anında patlar
                else if(r < 0.7) nextCrash = 1.1 + (Math.random() * 2.5); // %65 orta
                else if(r < 0.95) nextCrash = 3.5 + (Math.random() * 8); // %25 yüksek
                else nextCrash = 12 + (Math.random() * 15); // %5 efsanevi (25x+)

                transaction.update(gRef, { 
                    phase: "betting", 
                    countdown: 5, 
                    crashPoint: nextCrash, 
                    lastActive: Date.now() 
                });
            });

            // Geri sayımı yönet
            startCountdown(gRef);
        } catch (e) { console.log("Döngü zaten başka cihaz tarafından başlatıldı."); }
        
        loopLock = false;
    }, 3000);
}

async function startCountdown(gRef) {
    let count = 5;
    const timer = setInterval(async () => {
        count--;
        if(count <= 0) {
            clearInterval(timer);
            await updateDoc(gRef, { phase: "flying", startTime: Date.now(), lastActive: Date.now() });
        } else {
            await updateDoc(gRef, { countdown: count, lastActive: Date.now() });
        }
    }, 1000);
}

// --- VERİ TAKİBİ ---
onAuthStateChanged(auth, user => {
    if(!user) return;
    userRef = doc(db, "users", user.uid);
    onSnapshot(userRef, s => { if(s.exists()){ balance=s.data().balance; document.getElementById("balance").innerText=balance.toLocaleString(); }});

    onSnapshot(doc(db, "games", "current"), s => {
        const d = s.data();
        gameData.phase = d.phase;
        gameData.countdown = d.countdown;
        gameData.crashPoint = d.crashPoint;
        gameData.startTime = d.startTime;

        // EĞER OYUN HERHANGİ BİR SEBEPLE DURURSA (SİSTEM ASILI KALIRSA)
        if(d.phase === "crashed" && !loopLock) autoRestartCycle();
    });
});

// --- DİĞER FONKSİYONLAR (BAHİS, BUTONLAR) ---
async function handleBet(box) {
    let amt = Math.floor(document.getElementById("betInput"+box).value);
    let cur = (box === 1) ? activeBet1 : activeBet2;
    if(gameData.phase === "betting" && cur === 0 && balance >= amt) {
        await updateDoc(userRef, { balance: increment(-amt) });
        if(box===1) activeBet1=amt; else activeBet2=amt;
    } else if(gameData.phase === "flying" && cur > 0) {
        await updateDoc(userRef, { balance: increment(Math.floor(cur * gameData.multiplier)) });
        if(box===1) activeBet1=0; else activeBet2=0;
    }
}

function addHistory(v) {
    const b = document.getElementById("historyBar");
    const i = document.createElement("div");
    i.className = "history-item";
    i.style.color = v < 2 ? "#ff2a4d" : "#4fd1ff";
    i.innerText = v.toFixed(2) + "x";
    b.prepend(i); if(b.children.length > 10) b.lastChild.remove();
}

function updateButtons() {
    const u = (id, act) => {
        const b = document.getElementById(id);
        if(gameData.phase === "betting") {
            b.disabled = false; b.innerText = act > 0 ? "İPTAL" : "BAHİS YAP";
        } else if(gameData.phase === "flying" && act > 0) {
            b.disabled = false; b.innerText = "ÇEK ₺" + Math.floor(act * gameData.multiplier);
            b.className = "cashout";
        } else {
            b.disabled = true; b.innerText = "BEKLENİYOR"; b.className = "";
        }
    };
    u("btn1", activeBet1); u("btn2", activeBet2);
}
document.getElementById("btn1").onclick = () => handleBet(1);
document.getElementById("btn2").onclick = () => handleBet(2);
</script>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>SkyCrash Fix</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{height:100%;overflow:hidden;font-family:sans-serif;background:#03050a;color:white;}
        .top-bar{position:fixed;top:0;width:100%;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:rgba(10,15,30,0.9);z-index:100;}
        .nav-box{padding:6px 10px;border-radius:10px;background:#1a2248;color:#4fd1ff;}
        .main{position:absolute;top:60px;bottom:180px;width:100%;display:flex;justify-content:center;align-items:center;}
        canvas{position:absolute;width:100%;height:100%;}
        .multiplier{font-size:75px;font-weight:900;z-index:10;text-align:center;}
        .multiplier.small{font-size:24px;color:#4fd1ff;}
        .multiplier.crashed{color:#ff2a4d;}
        .bottom{position:absolute;bottom:0;width:100%;height:180px;background:#0a0f1e;display:flex;justify-content:center;align-items:center;gap:10px;padding:15px;border-top:1px solid #1e2642;}
        .betBox{background:#161d36;padding:12px;border-radius:15px;flex:1;display:flex;flex-direction:column;gap:8px;}
        .betBox button{padding:14px;border:none;border-radius:10px;font-weight:bold;background:#5743d6;color:white;}
        .betBox button:disabled{opacity:0.3;}
    </style>
</head>
<body>

<div class="top-bar">
    <div style="font-weight:900;">SKYCRASH PRO</div>
    <div class="nav-box">₺<span id="balance">0</span></div>
</div>

<div class="main">
    <canvas id="graph"></canvas>
    <div class="multiplier" id="multiplier">BAĞLANIYOR...</div>
</div>

<div class="bottom">
    <div class="betBox"><input type="number" id="betInput1" value="100" style="width:100%;padding:10px;border-radius:5px;"><button id="btn1">BAHİS YAP</button></div>
    <div class="betBox"><input type="number" id="betInput2" value="200" style="width:100%;padding:10px;border-radius:5px;"><button id="btn2">BAHİS YAP</button></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, increment, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userRef = null, balance = 0;
let gameData = { phase: "waiting", multiplier: 1, countdown: 0, crashPoint: 0 };
let loopLock = false;

// --- GİRİŞ VE VERİ TAKİBİ ---
signInAnonymously(auth).then(() => {
    onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        userRef = doc(db, "users", user.uid);
        
        // Kullanıcı yoksa oluştur
        const uSnap = await getDoc(userRef);
        if(!uSnap.exists()) await setDoc(userRef, { balance: 10000 });

        onSnapshot(userRef, s => {
            if(s.exists()){ 
                balance = s.data().balance;
                document.getElementById("balance").innerText = balance.toLocaleString();
            }
        });

        // Oyun Durumu Takibi
        onSnapshot(doc(db, "games", "current"), s => {
            if(!s.exists()) return;
            const d = s.data();
            gameData = d;
            updateUI();
            
            // Eğer oyun crashed ise ve döngü kilitli değilse yeni turu başlat
            if(d.phase === "crashed" && !loopLock) autoRestart();
        });
    });
});

function updateUI() {
    const multEl = document.getElementById("multiplier");
    if(gameData.phase === "betting") {
        multEl.className = "multiplier small";
        multEl.innerText = "BAHİSLER ALINIYOR\n" + gameData.countdown + "s";
    } else if(gameData.phase === "flying") {
        multEl.className = "multiplier";
        multEl.innerText = gameData.multiplier.toFixed(2) + "x";
    } else if(gameData.phase === "crashed") {
        multEl.className = "multiplier crashed";
        multEl.innerText = gameData.crashPoint.toFixed(2) + "x\nPATLADI!";
    }
}

// --- OTOMATİK DÖNGÜ (HATAYI ÇÖZEN KISIM) ---
async function autoRestart() {
    loopLock = true;
    setTimeout(async () => {
        const gRef = doc(db, "games", "current");
        try {
            await runTransaction(db, async (transaction) => {
                const sfDoc = await transaction.get(gRef);
                if (sfDoc.data().phase !== "crashed") return;

                // Yeni X hesapla
                const r = Math.random();
                let nextX = r < 0.05 ? 1.00 : (1 / (1 - Math.random())).toFixed(2);
                if(nextX > 1000000) nextX = 1000000;

                transaction.update(gRef, { 
                    phase: "betting", 
                    countdown: 5, 
                    multiplier: 1.00,
                    crashPoint: parseFloat(nextX)
                });
            });
            
            // Geri sayımı başlat
            let c = 5;
            const cd = setInterval(async () => {
                c--;
                if(c <= 0) {
                    clearInterval(cd);
                    await updateDoc(gRef, { phase: "flying", startTime: Date.now() });
                    startFlying();
                } else {
                    await updateDoc(gRef, { countdown: c });
                }
            }, 1000);

        } catch (e) { console.error(e); }
        loopLock = false;
    }, 3000);
}

// --- UÇUŞ SİMÜLASYONU ---
function startFlying() {
    const gRef = doc(db, "games", "current");
    const interval = setInterval(async () => {
        const snap = await getDoc(gRef);
        const data = snap.data();
        
        if(data.phase !== "flying") {
            clearInterval(interval);
            return;
        }

        const elapsed = (Date.now() - data.startTime) / 1000;
        const newMult = Math.pow(1.08, elapsed);

        if(newMult >= data.crashPoint) {
            clearInterval(interval);
            await updateDoc(gRef, { phase: "crashed", multiplier: data.crashPoint });
        } else {
            await updateDoc(gRef, { multiplier: newMult });
        }
    }, 100);
}

// Canvas ve Yıldızlar (Görsel)
const stars = Array.from({length: 50}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2 }));
function animate() {
    ctx.fillStyle = "#03050a"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "white";
    stars.forEach(s => {
        ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill();
        s.x -= (gameData.phase === "flying" ? gameData.multiplier * 0.5 : 0.2);
        if(s.x < 0) s.x = canvas.width;
    });
    requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>

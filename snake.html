<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena Snake.io Multiplayer</title>
<style>
body, html { margin:0; padding:0; overflow:hidden; font-family:sans-serif; background:#1e1e1e; }
canvas { display:block; }
#scoreboard {
  position:fixed; top:10px; right:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:10px; border-radius:8px;
  font-size:14px; max-height:90vh; overflow-y:auto;
}
#totalScore {
  position:fixed; top:10px; left:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:10px; border-radius:8px;
  font-size:16px;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="scoreboard"></div>
<div id="totalScore">Score: 0 | Online: 0</div>
<audio id="eatSound" src="https://freesound.org/data/previews/342/342756_3248244-lq.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  databaseURL:"https://emirhan-site-default-rtdb.firebaseio.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.appspot.com",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let W = window.innerWidth, H = window.innerHeight;
canvas.width = W; canvas.height = H;

const MAP_SIZE = 100000;
const MAX_FOODS = 500;
let players = {}, foods = [];
let inputDir = {x:0,y:0};
const eatSound = document.getElementById("eatSound");
const scoreboard = document.getElementById("scoreboard");
const totalScoreEl = document.getElementById("totalScore");
let roomId = null;

let mySnake = { body:[], x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, speed:6, maxSpeed:12, score:0, color:"#ffff00" };

canvas.addEventListener("touchstart", handleTouch);
canvas.addEventListener("touchmove", handleTouch);
function handleTouch(e){
  e.preventDefault();
  let touch = e.touches[0];
  let dx = touch.clientX - W/2;
  let dy = touch.clientY - H/2;
  let len = Math.sqrt(dx*dx + dy*dy);
  inputDir.x = dx/len; inputDir.y = dy/len;
}

async function joinRoom(uid, username){
  const roomsRef = ref(db, 'rooms');
  const snapshot = await get(roomsRef);
  let rooms = snapshot.val() || {};
  let joined = false;
  for(let rid in rooms){
    if(Object.keys(rooms[rid].players||{}).length < 150){
      roomId = rid;
      const playerRef = ref(db, `rooms/${rid}/players/${uid}`);
      set(playerRef, { username, x:mySnake.x, y:mySnake.y, score:0, alive:true });
      onDisconnect(playerRef).remove();
      joined = true;
      break;
    }
  }
  if(!joined){
    roomId = 'room_' + Date.now();
    const roomRef = ref(db, `rooms/${roomId}`);
    set(roomRef, { players: {[uid]: {username, x:mySnake.x, y:mySnake.y, score:0, alive:true} } });
    const playerRef = ref(db, `rooms/${roomId}/players/${uid}`);
    onDisconnect(playerRef).remove();
  }
}

onAuthStateChanged(auth, async user=>{
  if(!user) location.href="index.html";
  const uid = user.uid;
  const username = user.displayName || "Oyuncu";

  mySnake.body.push({x:mySnake.x, y:mySnake.y});
  await joinRoom(uid, username);

  const playersRef = ref(db, `rooms/${roomId}/players`);
  onValue(playersRef, snap=>{
    players = snap.val() || {};
    updateScoreboard();
  });

  for(let i=0;i<MAX_FOODS;i++) foods.push(randomFood());

  requestAnimationFrame(gameLoop);
});

function gameLoop(){
  updateMySnake();
  checkCollisions();
  render();
  requestAnimationFrame(gameLoop);
}

function updateMySnake(){
  if(inputDir.x!==0||inputDir.y!==0){
    mySnake.x += inputDir.x*mySnake.speed;
    mySnake.y += inputDir.y*mySnake.speed;
    mySnake.x = Math.max(0, Math.min(MAP_SIZE, mySnake.x));
    mySnake.y = Math.max(0, Math.min(MAP_SIZE, mySnake.y));
    mySnake.body.unshift({x:mySnake.x,y:mySnake.y});
    if(mySnake.body.length>10+mySnake.score/5) mySnake.body.pop();
  }
  if(roomId) update(ref(db, `rooms/${roomId}/players/${auth.currentUser.uid}`), { x:mySnake.x, y:mySnake.y, score:mySnake.score });
}

function checkCollisions(){
  foods.forEach((f)=>{
    if(distance(f, mySnake.body[0])<15){
      mySnake.score += (f.type==="red"?30:10);
      eatSound.currentTime=0; eatSound.play();
      setTimeout(()=>{ foods.push(f); }, 30000);
      foods = foods.filter(x=>x!==f);
    }
  });
}

function render(){
  ctx.fillStyle="#1e1e1e";
  ctx.fillRect(0,0,W,H);

  const camX = mySnake.x - W/2;
  const camY = mySnake.y - H/2;

  foods.forEach(f=>{
    if(Math.abs(f.x-mySnake.x)<W && Math.abs(f.y-mySnake.y)<H){
      ctx.font="24px Arial";
      ctx.fillText(f.type==="red"?"ðŸŽ":"ðŸ", f.x-camX, f.y-camY);
    }
  });

  let onlineCount = 0;
  for(let id in players){
    const p = players[id];
    if(Math.abs(p.x-mySnake.x)<W && Math.abs(p.y-mySnake.y)<H){
      drawSnake(p, camX, camY, id===auth.currentUser.uid?mySnake.color:"#00ffff");
    }
    if(players[id].alive) onlineCount++;
  }

  drawSnake(mySnake, camX, camY, mySnake.color);

  totalScoreEl.innerText = `Score: ${Math.floor(mySnake.score)} | Online: ${onlineCount}`;
  updateScoreboard();
}

function drawSnake(snake, camX, camY, color){
  if(!snake.body) return;
  snake.body.forEach((seg,i)=>{
    let alpha = 1 - i/snake.body.length;
    ctx.beginPath();
    ctx.arc(seg.x-camX, seg.y-camY, 12*(1-alpha*0.5), 0, Math.PI*2);
    ctx.fillStyle = i===0 ? color : `rgba(255,255,0,${alpha})`;
    ctx.fill();
  });
}

function randomFood(){ return { x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, type:Math.random()<0.1?"red":"green" }; }
function distance(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

function updateScoreboard(){
  let arr=[];
  for(let id in players) arr.push({name:players[id].username, score:players[id].score});
  arr.sort((a,b)=>b.score-b.score);
  arr = arr.slice(0,10);
  scoreboard.innerHTML = arr.map(p=>`${p.name}: ${Math.floor(p.score)}`).join("<br>");
}
</script>
</body>
</html>

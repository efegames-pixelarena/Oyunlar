<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pixel Arena Snake Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P', monospace;}
body{overflow:hidden;background:#7c8f00;display:flex;flex-direction:column;height:100vh;touch-action:manipulation;color:#0f380f;}
.top-bar{
height:55px;width:100%;display:flex;justify-content:space-between;align-items:center;padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);color:white;
}
.brand{font-weight:800;background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 3s linear infinite;}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;}
.nav-box{padding:6px 12px;border-radius:14px;font-weight:700;font-size:13px;background:#273c8f;text-align:center;}
.btn-logout{padding:6px 12px;border-radius:12px;border:none;background:#ff3b3b;color:white;font-weight:700;cursor:pointer;}
#scoreboard{display:flex;justify-content:space-between;padding:6px 16px;margin-top:4px;font-size:14px;}
#gameWrapper{flex:1;display:flex;justify-content:center;align-items:center;position:relative;}
canvas{background:#9bbc0f;image-rendering:pixelated;}
.gameover{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(139,172,15,0.95);display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:16px;color:#0f380f;display:none;text-align:center;}
button{padding:12px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:linear-gradient(90deg,#ffb300,#ff5500);margin-top:10px;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">Pixel Arena Snake Battle</div>
<div class="right-menu">
<div class="nav-box" id="playerName">...</div>
<div class="nav-box" id="opponentName">Rakip...</div>
<div class="btn-logout" id="logoutBtn">√áƒ±kƒ±≈ü</div>
</div>
</div>

<div id="scoreboard">
<div>Sen: <span id="playerScore">0</span></div>
<div>Rakip: <span id="opponentScore">0</span></div>
</div>

<div id="gameWrapper">
<canvas id="game" width="500" height="500"></canvas>
<div class="gameover" id="gameover">GAME OVER</div>
<div id="matchMessage" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:30px;color:#0f380f;text-align:center;">Ma√ß Bul</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, roomId, unsubscribe;
let playerSnake=[], opponentSnake=[], direction="RIGHT", opponentDirection="LEFT";
let playerScore=0, opponentScore=0;
const box=20, canvas=document.getElementById("game"), ctx=canvas.getContext("2d");
const foodEmojis=["üçè","üçé","üçê","üçã","üçå","üçâ","üçä","ü•ù","üåΩ"];
let food={x:0,y:0,type:"üçè"}, tapLock=false;

document.getElementById("logoutBtn").onclick=async()=>{
    if(roomId) await updateDoc(doc(db,"rooms",roomId),{state:"ended"});
    await signOut(auth);
    location.href="index.html";
};

onAuthStateChanged(auth, async(user)=>{
    if(!user) location.href="index.html";
    uid=user.uid;
    username="Oyuncu"+uid.substring(0,4);
    document.getElementById("playerName").innerText=username;
    findOrCreateRoom();
});

async function findOrCreateRoom(){
    const roomsRef = doc(db,"rooms","snake-room");
    const snap = await roomsRef.get();
    if(!snap.exists()){
        await setDoc(roomsRef,{
            player1:uid, player1Name:username,
            player2:null, player2Name:null,
            state:"waiting",
            player1Snake:[{x:100,y:100}], player2Snake:[{x:400,y:400}],
            direction:"RIGHT", opponentDirection:"LEFT",
            food:randomFood(),
            player1Score:0, player2Score:0
        });
    }
    roomId="snake-room";
    listenRoom();
}

function listenRoom(){
    if(unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(doc(db,"rooms",roomId), snap=>{
        const d = snap.data();
        if(!d) return;

        // E≈üle≈üme
        if(d.state==="waiting" && uid!==d.player1 && !d.player2){
            updateDoc(doc(db,"rooms",roomId),{player2:uid, player2Name:username, state:"countdown", startAt:Date.now()+5000});
        }

        // 5 Saniye Bekleme
        if(d.state==="countdown"){
            document.getElementById("matchMessage").innerText="Ba≈ülƒ±yor... 5";
            setTimeout(()=>updateDoc(doc(db,"rooms",roomId),{state:"active"}),5000);
        }

        // Oyun aktif
        if(d.state==="active"){
            document.getElementById("matchMessage").style.display="none";
            playerSnake = uid===d.player1 ? d.player1Snake : d.player2Snake;
            opponentSnake = uid===d.player1 ? d.player2Snake : d.player1Snake;
            direction = d.direction;
            opponentDirection = d.opponentDirection;
            food=d.food;
            playerScore = uid===d.player1 ? d.player1Score : d.player2Score;
            opponentScore = uid===d.player1 ? d.player2Score : d.player1Score;
            document.getElementById("playerScore").innerText=playerScore;
            document.getElementById("opponentScore").innerText=opponentScore;
            document.getElementById("opponentName").innerText=uid===d.player1 ? d.player2Name||"Rakip" : d.player1Name||"Rakip";
            drawGame();
        }

        if(d.state==="ended"){
            document.getElementById("gameover").style.display="flex";
        }
    });
}

function randomFood(){
    let isRed = Math.random()<0.05; // nadir
    return {x:Math.floor(Math.random()*(canvas.width/box))*box, y:Math.floor(Math.random()*(canvas.height/box))*box, type:isRed?"üçé":foodEmojis[Math.floor(Math.random()*foodEmojis.length)]};
}

function drawGame(){
    ctx.fillStyle="#9bbc0f";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    playerSnake.forEach(s=>{ctx.fillStyle="#0066ff"; ctx.fillRect(s.x,s.y,box,box);});
    opponentSnake.forEach(s=>{ctx.fillStyle="#ff0000"; ctx.fillRect(s.x,s.y,box,box);});

    ctx.font="20px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText(food.type, food.x+box/2, food.y+box/2);
}

// Hareket ve yemek kontrol√º
document.addEventListener("keydown", async(e)=>{
    if(!roomId) return;
    if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
    if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
    if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
    if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";

    await runTransaction(db, async(t)=>{
        const ref=doc(db,"rooms",roomId);
        const snap=await t.get(ref);
        if(!snap.exists()) return;
        let d = snap.data();
        let snake = uid===d.player1 ? [...d.player1Snake] : [...d.player2Snake];
        let head = {...snake[0]};
        if(direction==="UP") head.y-=box;
        if(direction==="DOWN") head.y+=box;
        if(direction==="LEFT") head.x-=box;
        if(direction==="RIGHT") head.x+=box;
        snake.unshift(head);

        // Yem yeme
        let ate=false;
        if(head.x===d.food.x && head.y===d.food.y){
            ate=true;
            let scoreAdd = d.food.type==="üçé"?30:10;
            if(uid===d.player1) d.player1Score += scoreAdd; else d.player2Score += scoreAdd;
            d.food = randomFood();
        } else { snake.pop(); }

        // √áarpƒ±≈üma veya sƒ±nƒ±r
        if(head.x<0||head.y<0||head.x>=canvas.width||head.y>=canvas.height||snake.slice(1).some(s=>s.x===head.x && s.y===head.y)){
            d.state="ended";
        }

        if(uid===d.player1){
            t.update(ref,{player1Snake:snake,direction,food:d.food,player1Score:d.player1Score,state:d.state});
        } else {
            t.update(ref,{player2Snake:snake,direction:direction===d.direction?direction:"LEFT",food:d.food,player2Score:d.player2Score,state:d.state});
        }
    });
});
</script>
</body>
</html>

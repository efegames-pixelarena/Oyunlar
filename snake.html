<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Snake Duel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
background-size:600% 600%;
animation:bg 4s infinite alternate ease-in-out;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
touch-action:manipulation;
}
@keyframes bg{0%{background-position:0% 50%}100%{background-position:100% 50%}}

/* TOP BAR */
.top-bar{
position:fixed;
top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}
.brand{
font-size:18px;font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;min-width:95px;text-align:center;background:#273c8f;}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}

/* GAME SCREEN */
#game{
flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:10px;
}
#matchMessage{font-size:clamp(32px,10vw,60px);margin-top:20px;font-weight:800;}
#scoreboard{margin-top:55px;width:100%;display:flex;justify-content:space-between;padding:6px 16px;font-weight:bold;font-size:16px;}
canvas{background:#9bbc0f;image-rendering:pixelated;}
button{padding:12px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:linear-gradient(90deg,#ffb300,#ff5500);margin-top:10px;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">Snake Duel</div>
<div class="right-menu">
<div class="nav-box" id="playerName">...</div>
<div class="nav-box" id="opponentName">Rakip...</div>
<button class="btn logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
</div>
</div>

<div id="scoreboard">
<div>Sen: <span id="playerScore">0</span></div>
<div>Rakip: <span id="opponentScore">0</span></div>
</div>

<div id="game">
<div id="matchMessage">Ma√ß Bul / Oda Kur</div>
<button id="findBtn">Ma√ß Bul</button>
<div class="lobby" id="lobbyBox">
<input id="roomCodeInput" placeholder="Oda Kodu">
<button id="createRoomBtn">Oda Kur</button>
<button id="joinCodeBtn">Katƒ±l</button>
</div>
<canvas id="gameCanvas" width="500" height="500"></canvas>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, runTransaction, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, roomId, unsubscribe;
let playerSnake=[], opponentSnake=[], direction="RIGHT", opponentDirection="LEFT";
let playerScore=0, opponentScore=0;
const box=20, canvas=document.getElementById("gameCanvas"), ctx=canvas.getContext("2d");
const foodEmojis=["üçè","üçé"];
let food={x:0,y:0,type:"üçè"};
const matchMessage=document.getElementById("matchMessage");

document.getElementById("logoutBtn").onclick=async()=>{
if(roomId) await updateDoc(doc(db,"rooms",roomId),{state:"ended"});
await signOut(auth);
location.href="index.html";
};

onAuthStateChanged(auth, async(user)=>{
if(!user) location.href="index.html";
uid=user.uid;
username="Oyuncu"+uid.substring(0,4);
document.getElementById("playerName").innerText=username;
});

async function findMatch(){
matchMessage.innerText="Rakip Aranƒ±yor...";
document.getElementById("findBtn").style.display="none";
document.getElementById("lobbyBox").style.display="none";

// Arama ve e≈üle≈üme
const q = query(collection(db,"rooms"),where("state","==","waiting"));
const snap = await getDocs(q);
let joined=false;
for(const r of snap.docs){
const d=r.data();
if(d.player1!==uid && !d.player2){
roomId=r.id;
await updateDoc(doc(db,"rooms",roomId),{player2:uid, player2Name:username, state:"countdown", startAt:Date.now()+5000});
joined=true; break;
}
}
if(!joined){
const newRoom = doc(collection(db,"rooms"));
roomId=newRoom.id;
await setDoc(newRoom,{
player1:uid, player1Name:username, player2:null, player2Name:null,
player1Snake:[{x:100,y:100}], player2Snake:[{x:400,y:400}],
direction:"RIGHT", opponentDirection:"LEFT",
food:randomFood(),
player1Score:0, player2Score:0,
state:"waiting", createdAt:serverTimestamp()
});
}
listenRoom();
}

document.getElementById("findBtn").onclick=findMatch;

function listenRoom(){
if(unsubscribe) unsubscribe();
unsubscribe = onSnapshot(doc(db,"rooms",roomId), snap=>{
const d = snap.data();
if(!d) return;

// E≈üle≈üme
if(d.state==="waiting" && uid!==d.player1 && !d.player2){
updateDoc(doc(db,"rooms",roomId),{player2:uid, player2Name:username, state:"countdown", startAt:Date.now()+5000});
}

// 5 saniye bekleme
if(d.state==="countdown"){
matchMessage.innerText="Ba≈ülƒ±yor... 5";
setTimeout(()=>updateDoc(doc(db,"rooms",roomId),{state:"active"}),5000);
}

// Oyun aktif
if(d.state==="active"){
matchMessage.style.display="none";
playerSnake = uid===d.player1 ? d.player1Snake : d.player2Snake;
opponentSnake = uid===d.player1 ? d.player2Snake : d.player1Snake;
direction = d.direction;
opponentDirection = d.opponentDirection;
food=d.food;
playerScore = uid===d.player1 ? d.player1Score : d.player2Score;
opponentScore = uid===d.player1 ? d.player2Score : d.player1Score;
document.getElementById("playerScore").innerText=playerScore;
document.getElementById("opponentScore").innerText=opponentScore;
drawGame();
}
if(d.state==="ended"){matchMessage.innerText="Rakip Oyundan √áƒ±ktƒ± / Oyun Bitti";}
});
}

function randomFood(){
let isRed = Math.random()<0.05;
return {x:Math.floor(Math.random()*(canvas.width/box))*box, y:Math.floor(Math.random()*(canvas.height/box))*box, type:isRed?"üçé":"üçè"};
}

function drawGame(){
ctx.fillStyle="#9bbc0f"; ctx.fillRect(0,0,canvas.width,canvas.height);
playerSnake.forEach(s=>{ctx.fillStyle="#0066ff"; ctx.fillRect(s.x,s.y,box,box);});
opponentSnake.forEach(s=>{ctx.fillStyle="#ff0000"; ctx.fillRect(s.x,s.y,box,box);});
ctx.font="20px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
ctx.fillText(food.type, food.x+box/2, food.y+box/2);
}

// Yƒ±lan hareketi ve yemek
document.addEventListener("keydown", async(e)=>{
if(!roomId) return;
if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";

await runTransaction(db, async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;
let d = snap.data();
let snake = uid===d.player1 ? [...d.player1Snake] : [...d.player2Snake];
let head = {...snake[0]};
if(direction==="UP") head.y-=box;
if(direction==="DOWN") head.y+=box;
if(direction==="LEFT") head.x-=box;
if(direction==="RIGHT") head.x+=box;
snake.unshift(head);

let ate=false;
if(head.x===d.food.x && head.y===d.food.y){
ate=true;
let scoreAdd = d.food.type==="üçé"?30:10;
if(uid===d.player1) d.player1Score += scoreAdd; else d.player2Score += scoreAdd;
d.food = randomFood();
}else{snake.pop();}

// √áarpƒ±≈üma veya sƒ±nƒ±r
if(head.x<0||head.y<0||head.x>=canvas.width||head.y>=canvas.height||snake.slice(1).some(s=>s.x===head.x && s.y===head.y)){
d.state="ended";
}

if(uid===d.player1){
t.update(ref,{player1Snake:snake,direction,food:d.food,player1Score:d.player1Score,state:d.state});
}else{
t.update(ref,{player2Snake:snake,direction:direction===d.direction?direction:"LEFT",food:d.food,player2Score:d.player2Score,state:d.state});
}
});
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena Snake Ranked 1v1</title>

<style>
body{
margin:0;
background:#7c8f00;
font-family:monospace;
text-align:center;
color:black;
}
canvas{
background:#9bbc0f;
margin-top:15px;
}
#info{margin-top:10px;font-weight:bold}
#timer{margin-top:5px}
button{
padding:8px 15px;
margin-top:10px;
border:none;
border-radius:6px;
font-weight:bold;
cursor:pointer;
}
</style>
</head>
<body>

<h2>üêç PixelArena Snake Ranked 1v1</h2>
<div id="info">Hazƒ±r</div>
<button id="findBtn">Ma√ß Bul</button>
<div id="timer"></div>
<canvas id="game" width="300" height="300"></canvas>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
collection, query, where, getDocs,
onSnapshot, increment, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid;
let roomId=null;
let unsubscribe=null;
let opponentId=null;

let gameStart=0;
let gameDuration=60000;
let isPlaying=false;

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const box=15;
const size=300;

let snake,dir,food,score;

/* AUTH */
onAuthStateChanged(auth,user=>{
if(!user){
alert("Giri≈ü gerekli");
return;
}
uid=user.uid;
});

/* MATCH FIND */
document.getElementById("findBtn").onclick=async()=>{
document.getElementById("info").innerText="Rakip aranƒ±yor...";
document.getElementById("findBtn").style.display="none";

const q=query(collection(db,"snakeRooms"),where("state","==","waiting"));
const snap=await getDocs(q);

let joined=false;

for(const r of snap.docs){
const d=r.data();
if(d.player1!==uid && !d.player2){
roomId=r.id;
await updateDoc(doc(db,"snakeRooms",roomId),{
player2:uid,
state:"matched"
});
joined=true;
break;
}
}

if(!joined){
const newRoom=doc(collection(db,"snakeRooms"));
roomId=newRoom.id;
await setDoc(newRoom,{
player1:uid,
player2:null,
score1:0,
score2:0,
state:"waiting",
createdAt:serverTimestamp()
});
}

listenRoom();
};

/* ROOM LISTENER */
function listenRoom(){
if(unsubscribe)unsubscribe();

unsubscribe=onSnapshot(doc(db,"snakeRooms",roomId),async(snap)=>{

if(!snap.exists()){
location.reload();
return;
}

const d=snap.data();

if(d.state==="matched"){
await updateDoc(doc(db,"snakeRooms",roomId),{
state:"playing",
startTime:Date.now()
});
}

if(d.state==="playing"){
opponentId = (uid===d.player1)? d.player2 : d.player1;
gameStart=d.startTime;
startGame();
}

if(d.state==="finished"){
finishLocal(d);
}

});
}

/* START GAME */
function startGame(){
snake=[{x:150,y:150}];
dir="RIGHT";
food=randomFood();
score=0;
isPlaying=true;
document.getElementById("info").innerText="Ma√ß Ba≈üladƒ±!";
requestAnimationFrame(loop);
}

function randomFood(){
return{
x:Math.floor(Math.random()*(size/box))*box,
y:Math.floor(Math.random()*(size/box))*box
};
}

function loop(){
if(!isPlaying) return;

update();
draw();

let timeLeft=Math.max(0,Math.floor((gameDuration-(Date.now()-gameStart))/1000));
document.getElementById("timer").innerText="S√ºre: "+timeLeft;

if(timeLeft<=0){
endGame();
return;
}

requestAnimationFrame(loop);
}

function update(){
let headX=snake[0].x;
let headY=snake[0].y;

if(dir==="UP")headY-=box;
if(dir==="DOWN")headY+=box;
if(dir==="LEFT")headX-=box;
if(dir==="RIGHT")headX+=box;

if(headX<0||headY<0||headX>=size||headY>=size||collision(headX,headY)){
isPlaying=false;
endGame();
return;
}

if(headX===food.x&&headY===food.y){
score++;
food=randomFood();
}else{
snake.pop();
}

snake.unshift({x:headX,y:headY});
}

function draw(){
ctx.fillStyle="#9bbc0f";
ctx.fillRect(0,0,size,size);

snake.forEach(s=>{
ctx.fillStyle="#0f380f";
ctx.fillRect(s.x,s.y,box,box);
});

ctx.fillText("üçé",food.x+5,food.y+12);
}

function collision(x,y){
return snake.some(s=>s.x===x&&s.y===y);
}

document.addEventListener("keydown",e=>{
if(e.key==="ArrowUp"&&dir!=="DOWN")dir="UP";
if(e.key==="ArrowDown"&&dir!=="UP")dir="DOWN";
if(e.key==="ArrowLeft"&&dir!=="RIGHT")dir="LEFT";
if(e.key==="ArrowRight"&&dir!=="LEFT")dir="RIGHT";
});

/* END GAME */
async function endGame(){
if(!roomId) return;

isPlaying=false;

const roomRef=doc(db,"snakeRooms",roomId);
const snap=await getDoc(roomRef);
if(!snap.exists()) return;

const d=snap.data();

if(uid===d.player1){
await updateDoc(roomRef,{score1:score});
}else{
await updateDoc(roomRef,{score2:score});
}

await updateDoc(roomRef,{state:"finished"});
}

/* FINISH LOCAL */
async function finishLocal(d){

let myScore = (uid===d.player1)? d.score1 : d.score2;
let oppScore = (uid===d.player1)? d.score2 : d.score1;

if(myScore>oppScore){
alert("Kazandƒ±n!");
await updateDoc(doc(db,"users",uid),{
elo:increment(25),
wins:increment(1),
totalGames:increment(1)
});
}else{
alert("Kaybettin!");
await updateDoc(doc(db,"users",uid),{
elo:increment(-20),
losses:increment(1),
totalGames:increment(1)
});
}

await deleteDoc(doc(db,"snakeRooms",roomId));
location.reload();
}

</script>
</body>
</html>

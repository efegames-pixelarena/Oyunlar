<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena Snake Battle</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
body{height:100vh;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
background:radial-gradient(circle at center, rgba(255,180,60,0.1) 0%, transparent 40%),linear-gradient(to bottom,#000 0%,#0b1330 100%);
color:white;touch-action:manipulation;display:flex;flex-direction:column;align-items:center;}

.top-bar{position:fixed;top:0;width:100%;height:55px;display:flex;align-items:center;justify-content:space-between;
padding:0 16px;background:linear-gradient(135deg,#1a2a6c,#16245c);box-shadow:0 4px 15px rgba(0,0,0,0.45);z-index:1000;}
.brand{font-size:18px;font-weight:800;background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 3s linear infinite;}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;min-width:95px;text-align:center;}
.balance-box{background:#273c8f;}

#gameArea{margin-top:70px;position:relative;}
canvas{background:#1b2a3a;display:block;border:3px solid #4fd1ff;}
.usernames{position:absolute;top:-25px;width:100%;display:flex;justify-content:space-between;font-weight:bold;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena Snake Battle</div>
<div class="right-menu">
<div class="nav-box balance-box">Bakiye: <span id="balance">0</span>â‚º</div>
</div>
</div>

<div id="gameArea">
<div class="usernames">
<span id="playerName">Sen</span>
<span id="opponentName">Rakip</span>
</div>
<canvas id="gameCanvas" width="600" height="600"></canvas>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,onSnapshot,updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Mevcut Firebase config
const firebaseConfig = {
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const box = 20;
const gridSize = 30; // 600 / 20 = 30 kutucuk
let playerID = null;
let playerName = "Sen";
let opponentName = "Rakip";

let snake = [], opponentSnake = [], direction = "RIGHT";
let food = {x:0,y:0,type:"ðŸ"};
let score = 0;

let emojis = ["ðŸ","ðŸŽ","ðŸ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸŠ","ðŸ¥","ðŸŒ½"];

let userRef = null;
let gameRef = doc(db,"snakeBattle","game");

function randomFood(){
    return {
        x: Math.floor(Math.random()*gridSize),
        y: Math.floor(Math.random()*gridSize),
        type: emojis[Math.floor(Math.random()*emojis.length)]
    }
}

function draw(){
    ctx.fillStyle="#1b2a3a";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    // Yem
    ctx.font="20px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(food.type, food.x*box+box/2, food.y*box+box/2);

    // Kendi yÄ±lan
    snake.forEach(s=>{ctx.fillStyle="blue"; ctx.fillRect(s.x*box,s.y*box,box,box);});
    // Rakip
    opponentSnake.forEach(s=>{ctx.fillStyle="red"; ctx.fillRect(s.x*box,s.y*box,box,box);});
}

function collision(x,y,snakeArr){
    return snakeArr.some(s=>s.x===x&&s.y===y);
}

function gameOver(){
    alert("Oyun Bitti! Skor: "+score);
    snake=[{x:5,y:5}];direction="RIGHT";score=0;
    updateDoc(userRef,{snake,score,direction});
}

// Oyuncu hareket
function setDir(dir){if(dir==="UP"&&direction!=="DOWN")direction="UP";
if(dir==="DOWN"&&direction!=="UP")direction="DOWN";
if(dir==="LEFT"&&direction!=="RIGHT")direction="LEFT";
if(dir==="RIGHT"&&direction!=="LEFT")direction="RIGHT";}

document.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowUp")setDir("UP");
    if(e.key==="ArrowDown")setDir("DOWN");
    if(e.key==="ArrowLeft")setDir("LEFT");
    if(e.key==="ArrowRight")setDir("RIGHT");
});

// Firebase auth
onAuthStateChanged(auth,user=>{
    if(!user){alert("GiriÅŸ yapmalÄ±sÄ±n");return;}
    playerID=user.uid;
    playerName=user.displayName||"Sen";
    document.getElementById("playerName").innerText=playerName;
    userRef = doc(db,"snakeBattle","players",playerID);
    
    // BaÅŸlangÄ±Ã§ durumu
    setDoc(userRef,{snake:[{x:5,y:5}],direction:"RIGHT",score:0,name:playerName});
    
    // Game collection snapshot
    onSnapshot(doc(db,"snakeBattle","game"),snap=>{
        if(snap.exists()){
            const data = snap.data();
            food=data.food||food;
            opponentSnake = data[playerID==="p1"?"p2":"p1"]?.snake||[];
            opponentName = data[playerID==="p1"?"p2":"p1"]?.name||"Rakip";
            document.getElementById("opponentName").innerText = opponentName;
        }
    });
    
    // Kendi konumunu sÃ¼rekli gÃ¶nder
    setInterval(async()=>{
        const head = snake[0];
        snake.unshift({...head});
        if(head.x===food.x && head.y===food.y){
            score++; food=randomFood();
        } else {snake.pop();}
        let headX=head.x, headY=head.y;
        if(direction==="UP")headY--; if(direction==="DOWN")headY++;
        if(direction==="LEFT")headX--; if(direction==="RIGHT")headX++;
        if(headX<0||headX>=gridSize||headY<0||headY>=gridSize||collision(headX,headY,snake)){
            gameOver(); return;
        }
        snake[0]={x:headX,y:headY};
        await updateDoc(userRef,{snake,direction,score});
    },200);

    // Ã‡izim
    function loop(){draw();requestAnimationFrame(loop);}
    loop();
});
</script>
</body>
</html>

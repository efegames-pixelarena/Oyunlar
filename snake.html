<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3310 Snake Multiplayer - Emirhan Efe</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#7c8f00;font-family:'Press Start 2P', monospace;display:flex;justify-content:center;align-items:center;}
.console{width:340px;height:480px;background:#8bac0f;border:14px solid #2f4f2f;box-shadow:0 0 40px black inset,0 0 30px black;padding:15px;display:flex;flex-direction:column;align-items:center;position:relative;}
.score{font-size:12px;color:#0f380f;margin-bottom:10px;}
.canvas-wrapper{position:relative;width:300px;height:300px;}
canvas{background:#9bbc0f;image-rendering:pixelated;display:block;}
.scanlines{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;background:repeating-linear-gradient(to bottom,rgba(0,0,0,0.05),rgba(0,0,0,0.05) 2px,transparent 2px,transparent 4px);}
.gameover{position:absolute;top:0;left:0;width:300px;height:300px;background:rgba(139,172,15,0.95);display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:12px;color:#0f380f;display:none;text-align:center;padding:20px;}
.controls{display:flex;gap:10px;justify-content:center;margin-top:20px;}
.btn{background:#2f4f2f;color:white;text-align:center;padding:15px;user-select:none;cursor:pointer;}
.countdown{position:absolute;top:120px;width:100%;text-align:center;font-size:32px;color:#0f380f;font-weight:bold;display:none;}
</style>
</head>
<body>
<div class="console">
  <div class="score">
    Skor: <span id="score">0</span> | High: <span id="high">0</span>
  </div>

  <div class="canvas-wrapper">
    <canvas id="game" width="300" height="300"></canvas>
    <div class="scanlines"></div>
    <div class="gameover" id="gameover">
      <div id="gameoverText">GAME OVER</div>
      <div id="retryBtn" class="btn">Yeniden Oyna</div>
    </div>
    <div class="countdown" id="countdown"></div>
  </div>

  <div class="controls" id="controls">
    <div class="btn" id="matchBtn">MaÃ§ Bul</div>
    <div class="btn" id="createBtn">Oda Kur</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  databaseURL:"https://emirhan-site-default-rtdb.firebaseio.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.appspot.com",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const rtdb = getDatabase(app);

/* ---------------- GAME VARIABLES ---------------- */
let playerId = null;
let snake = [{x:150,y:150}], direction = "RIGHT", score = 0;
let otherSnake = [], food, gameStarted = false;
let roomId = null;
const box = 15, size = 300;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const controlsDiv = document.getElementById("controls");
const matchBtn = document.getElementById("matchBtn");
const createBtn = document.getElementById("createBtn");
const countdownEl = document.getElementById("countdown");
const gameoverDiv = document.getElementById("gameover");
const retryBtn = document.getElementById("retryBtn");
const gameoverText = document.getElementById("gameoverText");

let lastMoveTime = 0;
let baseSpeed = 220, currentSpeed = 220, minSpeed = 80;

/* ---------------- AUTH ---------------- */
onAuthStateChanged(auth, user => {
  if(user) playerId = user.uid;
  else alert("GiriÅŸ yapÄ±nÄ±z!");
});

/* ---------------- BUTTON EVENTS ---------------- */
matchBtn.onclick = findMatch;
createBtn.onclick = createRoom;
retryBtn.onclick = ()=>{ location.reload(); };

/* ---------------- MULTIPLAYER FUNCTIONS ---------------- */
function createRoom(){
  roomId = "room_" + Math.random().toString(36).substring(2,8);
  joinRoom(roomId,true);
}

function findMatch(){
  controlsDiv.innerHTML = "Rakip Bekleniyor...";
  onValue(ref(rtdb,'snakeRoom/rooms'), snap=>{
    const rooms = snap.val() || {};
    for(const id in rooms){
      if(Object.keys(rooms[id].players).length === 1 && !rooms[id].players[playerId]){
        joinRoom(id,false);
        return;
      }
    }
    // yoksa kendi oda
    createRoom();
  }, {onlyOnce:true});
}

function joinRoom(rId,isCreator){
  roomId = rId;
  const roomRef = ref(rtdb,'snakeRoom/rooms/'+roomId);
  const playerRef = ref(rtdb,'snakeRoom/rooms/'+roomId+'/players/'+playerId);
  set(playerRef,{snake,dir:direction,score});
  onDisconnect(playerRef).remove();

  if(isCreator){
    set(roomRef,{players:{[playerId]:{snake,dir:direction,score}},food:randomFood()});
  }

  // diÄŸer oyuncuyu izle
  onValue(ref(rtdb,'snakeRoom/rooms/'+roomId+'/players'), snap=>{
    const data = snap.val() || {};
    otherSnake = [];
    for(const id in data){
      if(id!==playerId){
        otherSnake = data[id].snake;
      }
    }
    const playerCount = Object.keys(data).length;
    if(playerCount===2 && !gameStarted){
      countdownStart(10);
    }
  });

  // yiyeceÄŸi izle
  onValue(ref(rtdb,'snakeRoom/rooms/'+roomId+'/food'), snap=>{
    if(snap.exists()) food = snap.val();
    else {
      food = randomFood();
      set(ref(rtdb,'snakeRoom/rooms/'+roomId+'/food'), food);
    }
  });

  controlsDiv.style.display = "none"; // butonlarÄ± gizle
}

/* ---------------- COUNTDOWN ---------------- */
function countdownStart(seconds){
  countdownEl.style.display = "block";
  let s = seconds;
  countdownEl.innerText = s;
  const interval = setInterval(()=>{
    s--;
    countdownEl.innerText = s;
    if(s<=0){
      clearInterval(interval);
      countdownEl.style.display="none";
      gameStarted = true;
      requestAnimationFrame(gameLoop);
    }
  },1000);
}

/* ---------------- GAME LOOP ---------------- */
document.addEventListener("keydown", e=>{
  if(!gameStarted) return;
  if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
  if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
  if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
  if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";
});

function gameLoop(ts){
  if(!gameStarted) return;
  if(ts - lastMoveTime > currentSpeed){ update(); lastMoveTime=ts; }
  draw();
  requestAnimationFrame(gameLoop);
}

function update(){
  let headX=snake[0].x, headY=snake[0].y;
  if(direction==="UP") headY-=box;
  if(direction==="DOWN") headY+=box;
  if(direction==="LEFT") headX-=box;
  if(direction==="RIGHT") headX+=box;

  if(headX<0||headY<0||headX>=size||headY>=size||collision(headX,headY)||collisionOther(headX,headY)){
    gameOver();
    return;
  }

  if(headX===food.x && headY===food.y){
    score += food.type==="red"?3:1;
    food = randomFood();
    set(ref(rtdb,'snakeRoom/rooms/'+roomId+'/food'), food);
    updateSpeed();
  } else { snake.pop(); }

  snake.unshift({x:headX,y:headY});
  set(ref(rtdb,'snakeRoom/rooms/'+roomId+'/players/'+playerId), {snake,dir:direction,score});
}

function collision(x,y){ return snake.some(s=>s.x===x && s.y===y); }
function collisionOther(x,y){ return otherSnake.some(s=>s.x===x && s.y===y); }
function updateSpeed(){ currentSpeed = Math.max(minSpeed, baseSpeed - Math.floor(score/5)*15); }
function randomFood(){ return {x:Math.floor(Math.random()*20)*15, y:Math.floor(Math.random()*20)*15, type:Math.random()<0.15?"red":"green"}; }

function draw(){
  ctx.fillStyle="#9bbc0f";
  ctx.fillRect(0,0,size,size);
  snake.forEach(s=>{ ctx.fillStyle="#0f380f"; ctx.fillRect(s.x,s.y,box,box); });
  otherSnake.forEach(s=>{ ctx.fillStyle="#003300"; ctx.fillRect(s.x,s.y,box,box); });
  ctx.font="14px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(food?.type==="red"?"ðŸŽ":"ðŸ", food?.x+box/2, food?.y+box/2);
}

function gameOver(){
  gameStarted=false;
  gameoverDiv.style.display="flex";
  if(otherSnake.length>0) gameoverText.innerText="DiÄŸer Oyuncu KazandÄ±!";
  else gameoverText.innerText="YandÄ±n!";
}
</script>
</body>
</html>

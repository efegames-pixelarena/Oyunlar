<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena Snake Battle - Emirhan Efe</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
html,body{
margin:0;
padding:0;
height:100%;
overflow:hidden;
background:#7c8f00;
font-family:'Press Start 2P', monospace;
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;
}

.top-bar{
position:fixed;
top:0;
width:100%;
height:50px;
display:flex;
justify-content:space-between;
align-items:center;
padding:0 15px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
color:white;
font-weight:bold;
z-index:100;
}

.top-bar .player-name{color:#4fd1ff;}
.top-bar .opponent-name{color:#ff4f4f;}

.canvas-wrapper{
margin-top:60px;
position:relative;
}

canvas{
background:#9bbc0f;
image-rendering: pixelated;
display:block;
border:4px solid #2f4f2f;
}

.gameover{
position:absolute;
top:0;
left:0;
width:600px;
height:600px;
background:rgba(139,172,15,0.95);
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;
font-size:24px;
color:#0f380f;
display:none;
text-align:center;
padding:20px;
z-index:50;
}

.controls{
display:grid;
grid-template-columns:60px 60px 60px;
grid-gap:5px;
justify-content:center;
margin-top:15px;
}

.btn{
background:#2f4f2f;
color:white;
text-align:center;
padding:15px;
user-select:none;
cursor:pointer;
}
</style>
</head>
<body>

<div class="top-bar">
<span class="player-name" id="playerName">Sen</span>
<span class="opponent-name" id="opponentName">Rakip</span>
</div>

<div class="canvas-wrapper">
<canvas id="game" width="600" height="600"></canvas>
<div class="gameover" id="gameover">
GAME OVER<br><br>
Dokunarak Yeniden Ba≈üla
</div>
</div>

<div class="controls">
<div></div>
<div class="btn" onclick="setDir('UP')">‚Üë</div>
<div></div>
<div class="btn" onclick="setDir('LEFT')">‚Üê</div>
<div class="btn" onclick="setDir('DOWN')">‚Üì</div>
<div class="btn" onclick="setDir('RIGHT')">‚Üí</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,onSnapshot,updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const box = 20;
const gridSize = 30; // 600/20

let playerID = null;
let snake = [{x:5,y:5}], opponentSnake = [];
let direction = "RIGHT";
let food = {x:10,y:10,type:"üçè"};
let emojis = ["üçè","üçé","üçê","üçã","üçå","üçâ","üçä","ü•ù","üåΩ"];
let score = 0;

let userRef = null;
let gameRef = doc(db,"snakeBattle","game");

function randomFood(){
return {x: Math.floor(Math.random()*gridSize), y: Math.floor(Math.random()*gridSize), type: emojis[Math.floor(Math.random()*emojis.length)]};
}

function draw(){
ctx.fillStyle="#9bbc0f";
ctx.fillRect(0,0,canvas.width,canvas.height);

// Yem
ctx.font="20px Arial";
ctx.textAlign="center";
ctx.textBaseline="middle";
ctx.fillText(food.type, food.x*box + box/2, food.y*box + box/2);

// Kendi yƒ±lan
snake.forEach(s=>{ctx.fillStyle="blue"; ctx.fillRect(s.x*box,s.y*box,box,box);});
// Rakip yƒ±lan
opponentSnake.forEach(s=>{ctx.fillStyle="red"; ctx.fillRect(s.x*box,s.y*box,box,box);});
}

function collision(x,y,snakeArr){return snakeArr.some(s=>s.x===x&&s.y===y);}

function gameOver(){
document.getElementById("gameover").style.display="flex";
snake = [{x:5,y:5}]; direction="RIGHT"; score=0;
updateDoc(userRef,{snake,score,direction});
}

function setDir(dir){
if(dir==="UP" && direction!=="DOWN") direction="UP";
if(dir==="DOWN" && direction!=="UP") direction="DOWN";
if(dir==="LEFT" && direction!=="RIGHT") direction="LEFT";
if(dir==="RIGHT" && direction!=="LEFT") direction="RIGHT";
}

document.addEventListener("keydown",(e)=>{
if(e.key==="ArrowUp") setDir("UP");
if(e.key==="ArrowDown") setDir("DOWN");
if(e.key==="ArrowLeft") setDir("LEFT");
if(e.key==="ArrowRight") setDir("RIGHT");
});

// Firebase auth
onAuthStateChanged(auth,user=>{
if(!user){alert("Giri≈ü yapmalƒ±sƒ±n"); return;}
playerID = user.uid;
document.getElementById("playerName").innerText = user.displayName || "Sen";
userRef = doc(db,"snakeBattle","players",playerID);

setDoc(userRef,{snake,direction,score,name:user.displayName||"Sen"});

// Game snapshot
onSnapshot(gameRef, snap=>{
if(snap.exists()){
const data = snap.data();
food = data.food || food;
opponentSnake = data[playerID==="p1"?"p2":"p1"]?.snake || [];
document.getElementById("opponentName").innerText = data[playerID==="p1"?"p2":"p1"]?.name || "Rakip";
}
});

// Kendi konumunu Firebase'e g√∂nder
setInterval(async ()=>{
let headX=snake[0].x, headY=snake[0].y;
if(direction==="UP") headY--; if(direction==="DOWN") headY++;
if(direction==="LEFT") headX--; if(direction==="RIGHT") headX++;

if(headX<0 || headY<0 || headX>=gridSize || headY>=gridSize || collision(headX,headY,snake)){gameOver(); return;}
snake.unshift({x:headX,y:headY});

if(headX===food.x && headY===food.y){score++; food=randomFood();}
else{snake.pop();}

await updateDoc(userRef,{snake,direction,score});
await updateDoc(gameRef,{food});
},200);

function loop(){draw(); requestAnimationFrame(loop);}
loop();

document.getElementById("gameover").addEventListener("click",()=>{document.getElementById("gameover").style.display="none"; snake=[{x:5,y:5}]; direction="RIGHT"; score=0;});
});
</script>

</body>
</html>

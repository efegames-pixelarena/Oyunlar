<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena Snake.io Multiplayer</title>
<style>
body, html { margin:0; padding:0; overflow:hidden; font-family:sans-serif; background:#1e1e1e; }
canvas { display:block; }
#scoreboard {
  position:fixed; top:10px; right:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:10px; border-radius:8px;
  font-size:14px; max-height:90vh; overflow-y:auto;
  transition: all 0.5s;
}
#totalScore {
  position:fixed; top:10px; left:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:10px; border-radius:8px;
  font-size:16px;
  transition: all 0.5s;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="scoreboard"></div>
<div id="totalScore">Score: 0</div>
<audio id="eatSound" src="https://freesound.org/data/previews/342/342756_3248244-lq.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  databaseURL:"https://emirhan-site-default-rtdb.firebaseio.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.appspot.com",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ---------------- CANVAS ---------------- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let W = window.innerWidth, H = window.innerHeight;
canvas.width = W; canvas.height = H;

const MAP_SIZE = 10000; // Harita boyutu 10000x10000
const MAX_FOODS = 600; // Yemler daha bol
let players = {}, foods = [];
let bots = [];
let inputDir = {x:0,y:0};
const eatSound = document.getElementById("eatSound");
const scoreboard = document.getElementById("scoreboard");
const totalScoreEl = document.getElementById("totalScore");

/* ---------------- MY SNAKE ---------------- */
let mySnake = { body:[], x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, speed:2, score:0, color:"#ffff00", maxSpeed:12 };

/* ---------------- TOUCH ---------------- */
canvas.addEventListener("touchstart", handleTouch);
canvas.addEventListener("touchmove", handleTouch);
function handleTouch(e){
  e.preventDefault();
  let touch = e.touches[0];
  let dx = touch.clientX - W/2;
  let dy = touch.clientY - H/2;
  let len = Math.sqrt(dx*dx + dy*dy);
  inputDir.x = dx/len; inputDir.y = dy/len;
}

/* ---------------- START ---------------- */
onAuthStateChanged(auth, user=>{
  if(!user) location.href="index.html";
  const uid = user.uid;
  const username = user.displayName || "Oyuncu";

  mySnake.body = [{x:mySnake.x, y:mySnake.y}];
  const playerRef = ref(db, "players/" + uid);
  set(playerRef, { username, x:mySnake.x, y:mySnake.y, score:0, alive:true });
  onDisconnect(playerRef).remove();

  const playersRef = ref(db, "players");
  onValue(playersRef, snap=>{ players = snap.val() || {}; updateScoreboard(); });

  for(let i=0;i<MAX_FOODS;i++) foods.push(randomFood());
  requestAnimationFrame(gameLoop);
});

/* ---------------- GAME LOOP ---------------- */
function gameLoop(){
  // YÄ±lan yavaÅŸÃ§a hÄ±zlanÄ±yor
  if(mySnake.speed < mySnake.maxSpeed) mySnake.speed += 0.002;

  updateMySnake();
  updateBots();
  checkCollisions();
  render();
  requestAnimationFrame(gameLoop);
}

/* ---------------- FUNCTIONS ---------------- */
function updateMySnake(){
  if(inputDir.x!==0||inputDir.y!==0){
    mySnake.x += inputDir.x*mySnake.speed;
    mySnake.y += inputDir.y*mySnake.speed;
    mySnake.x = Math.max(0, Math.min(MAP_SIZE, mySnake.x));
    mySnake.y = Math.max(0, Math.min(MAP_SIZE, mySnake.y));
    mySnake.body.unshift({x:mySnake.x,y:mySnake.y});
    if(mySnake.body.length>10+mySnake.score/5) mySnake.body.pop();
  }
  update(ref(db, "players/"+auth.currentUser.uid), { x:mySnake.x, y:mySnake.y, score:mySnake.score });
}

function updateBots(){
  bots.forEach(bot=>{
    let target = foods[Math.floor(Math.random()*foods.length)];
    let dx = target.x - bot.x;
    let dy = target.y - bot.y;
    let len = Math.sqrt(dx*dx + dy*dy) || 1;
    bot.x += dx/len*bot.speed;
    bot.y += dy/len*bot.speed;
    bot.body.unshift({x:bot.x, y:bot.y});
    if(bot.body.length>10+bot.score/5) bot.body.pop();
    foods.forEach((f,i)=>{
      if(distance(f, bot.body[0])<15){ bot.score += (f.type==="red"?30:10); foods[i]=randomFood(); }
    });
  });
}

function checkCollisions(){
  foods.forEach((f,i)=>{
    if(distance(f, mySnake.body[0])<15){
      mySnake.score += (f.type==="red"?30:10);
      foods[i]=randomFood();
      eatSound.currentTime=0; eatSound.play();
    }
  });
}

function render(){
  ctx.clearRect(0,0,W,H);

  // Renkli Snake.io tarzÄ± arka plan
  let gradient = ctx.createLinearGradient(0,0,W,H);
  let hue1 = (Date.now()/50)%360;
  let hue2 = (Date.now()/80)%360;
  gradient.addColorStop(0, `hsl(${hue1},50%,10%)`);
  gradient.addColorStop(1, `hsl(${hue2},50%,20%)`);
  ctx.fillStyle = gradient;
  ctx.fillRect(0,0,W,H);

  // Grid
  ctx.strokeStyle="#2a2a2a"; ctx.lineWidth=1;
  for(let x=0;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y=0;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  let camX = mySnake.x - W/2;
  let camY = mySnake.y - H/2;

  // Map boundaries (yanÄ±p sÃ¶nen)
  let hue = (Date.now()/10)%360;
  ctx.strokeStyle=`hsl(${hue},80%,50%)`;
  ctx.lineWidth=16;
  ctx.strokeRect(-camX, -camY, MAP_SIZE, MAP_SIZE);

  // Yemler hÄ±zlÄ± spam
  foods.forEach(f=>{ ctx.font="24px Arial"; ctx.fillText(f.type==="red"?"ðŸŽ":"ðŸ", f.x-camX, f.y-camY); });

  // DiÄŸer oyuncular
  for(let id in players){ if(id!==auth.currentUser.uid) drawSnake(players[id], camX, camY, "#00ffff"); }

  // Ben
  drawSnake(mySnake, camX, camY, mySnake.color);

  // Skor Sol Ãœst Renkli animasyon
  let scoreHue = (Date.now()/5)%360;
  totalScoreEl.style.color = `hsl(${scoreHue},100%,50%)`;
  totalScoreEl.innerText = `Score: ${Math.floor(mySnake.score)}`;

  // Skor Tablosu SaÄŸ Ãœst CanlÄ±
  updateScoreboard();
}

function drawSnake(snake, camX, camY, color){
  snake.body.forEach((seg,i)=>{
    let alpha = 1 - i/snake.body.length;
    let radius = 12*(1-alpha*0.5);
    ctx.beginPath();
    ctx.arc(seg.x-camX, seg.y-camY, radius, 0, Math.PI*2);
    ctx.fillStyle = i===0 ? color : `rgba(255,255,0,${alpha})`;
    ctx.shadowColor="black"; ctx.shadowBlur=6;
    ctx.fill();
    ctx.shadowBlur=0;
  });
  let head = snake.body[0];
  if(head){
    ctx.fillStyle="black";
    ctx.beginPath();
    ctx.arc(head.x-camX+5, head.y-camY-3, 3,0,Math.PI*2);
    ctx.arc(head.x-camX-5, head.y-camY-3, 3,0,Math.PI*2);
    ctx.fill();
  }
}

function randomFood(){ return { x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, type:Math.random()<0.1?"red":"green" }; }
function distance(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

function updateScoreboard(){
  let arr=[];
  for(let id in players) arr.push({name:players[id].username, score:players[id].score});
  arr.sort((a,b)=>b.score-a.score);
  scoreboard.innerHTML = arr.map(p=>`${p.name}: ${Math.floor(p.score)}`).join("<br>");
}

/* ---------------- ORIENTATION LOCK ---------------- */
window.addEventListener("load", ()=>{
  if(window.screen.orientation && window.screen.orientation.lock){
    window.screen.orientation.lock('landscape').catch(()=>{});
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Duel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
  display:flex;flex-direction:column;height:100vh;overflow:hidden;
  background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
  background-size:600% 600%;animation:bg 10s ease infinite alternate;
  color:white;touch-action:manipulation;
}
@keyframes bg{0%{background-position:0 0;}100%{background-position:100% 100%;}}
.top-bar{
  position:fixed;top:0;width:100%;height:55px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;background:linear-gradient(135deg,#1a2a6c,#16245c);
  box-shadow:0 4px 15px rgba(0,0,0,0.45);z-index:1000;
}
.brand{
  font-size:18px;font-weight:800;
  background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
  background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;align-items:center;}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}
#gameScreen{
  flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:10px;
}
#matchMessage{font-size:clamp(32px,10vw,60px);margin-top:20px;font-weight:800;min-height:60px;}
.lobby{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
button{padding:12px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:linear-gradient(90deg,#ffb300,#ff5500);margin-top:10px;}
#scoreContainer{display:flex;justify-content:space-around;width:100%;margin-top:10px;font-weight:bold;font-size:16px;display:none;}
canvas{display:none;background:#9bbc0f;image-rendering:pixelated;margin-top:10px;border-radius:10px;}
</style>
</head>
<body>

<div class="top-bar">
  <div class="brand">Snake Duel</div>
  <div class="right-menu">
    <button class="btn logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
  </div>
</div>

<div id="gameScreen">
  <div id="matchMessage">Ma√ß Bul</div>
  <button id="findBtn">Ma√ß Bul</button>
  <div id="scoreContainer">
    <div>Sen: <span id="playerScore">0</span></div>
    <div>Rakip: <span id="opponentScore">0</span></div>
  </div>
  <canvas id="gameCanvas" width="300" height="300"></canvas>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, query, where, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.firebasestorage.app",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, roomId, unsubscribe, gameInterval;

/* DOM */
const matchMessage=document.getElementById("matchMessage");
const findBtn=document.getElementById("findBtn");
const scoreContainer=document.getElementById("scoreContainer");
const playerScoreEl=document.getElementById("playerScore");
const opponentScoreEl=document.getElementById("opponentScore");
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");

/* AUTH */
onAuthStateChanged(auth, async(user)=>{
  if(!user) location.href="index.html";
  uid=user.uid;
  const snap = await getDoc(doc(db,"users",uid));
  username = snap.data()?.username || "Oyuncu";
});

/* LOGOUT */
document.getElementById("logoutBtn").onclick=async()=>{
  if(roomId) await updateDoc(doc(db,"rooms",roomId),{state:"ended"});
  await signOut(auth);
  location.href="index.html";
};

/* ---------------- MATCH FIND ---------------- */
async function findMatch(){
  matchMessage.innerText = "Rakip Aranƒ±yor...";
  findBtn.style.display="none";
  scoreContainer.style.display="none";

  const q = query(collection(db,"rooms"), where("state","==","waiting"));
  const snap = await getDocs(q);
  let joined = false;

  for(const r of snap.docs){
    const d = r.data();
    if(d.player1!==uid && !d.player2){
      roomId = r.id;
      await updateDoc(doc(db,"rooms",roomId),{
        player2: uid,
        player2Name: username,
        state: "countdown",
        startAt: Date.now()+3000
      });
      joined = true;
      break;
    }
  }

  if(!joined){
    const newRoom = doc(collection(db,"rooms"));
    roomId = newRoom.id;
    await setDoc(newRoom,{
      player1: uid, player1Name: username,
      player2: null, player2Name: null,
      playerScore: 0, opponentScore: 0,
      state: "waiting",
      createdAt: serverTimestamp()
    });
  }

  listenRoom();
}

findBtn.onclick = findMatch;

/* ---------------- ROOM LISTENER ---------------- */
function listenRoom(){
  if(unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(doc(db,"rooms",roomId), async snap=>{
    const d = snap.data();
    if(!d) return;

    if(d.state==="waiting"){
      scoreContainer.style.display="none";
      matchMessage.innerText="Rakip Aranƒ±yor...";
      canvas.style.display="none";
    }

    if(d.state==="countdown"){
      scoreContainer.style.display="none";
      let diff = Math.ceil((d.startAt - Date.now())/1000); if(diff<0) diff=0;
      matchMessage.innerText = "Ba≈ülƒ±yor... "+diff;
      canvas.style.display="none";
    }

    if(d.state==="active"){
      scoreContainer.style.display="flex";
      canvas.style.display="block";
      matchMessage.style.display="none";
      startSnakeGame();
    }

    if(d.state==="ended"){
      clearInterval(gameInterval);
      canvas.style.display="none";
      scoreContainer.style.display="none";

      // Tekrar Oyna Butonu
      matchMessage.innerHTML = `Oyun Bitti!<br>‚åõÔ∏è <button id="replayBtn">Tekrar Oyna</button>`;
      const replayBtn = document.getElementById("replayBtn");
      replayBtn.onclick = ()=>{
        findBtn.style.display="inline-block";
        matchMessage.innerText="Ma√ß Bul";
        findMatch();
      };
    }
  });
}

/* ---------------- SNAKE GAME ---------------- */
let snake, direction, food, score;
let box = 15, size = 300;

function startSnakeGame(){
  snake=[{x:150,y:150}];
  direction="RIGHT"; score=0;
  food=randomFood();
  playerScoreEl.innerText=0; opponentScoreEl.innerText=0;

  document.addEventListener("keydown", e=>{
    if(e.key==="ArrowUp" && direction!=="DOWN") direction="UP";
    if(e.key==="ArrowDown" && direction!=="UP") direction="DOWN";
    if(e.key==="ArrowLeft" && direction!=="RIGHT") direction="LEFT";
    if(e.key==="ArrowRight" && direction!=="LEFT") direction="RIGHT";
  });

  if(gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(gameLoop,150);
}

function randomFood(){
  return { x: Math.floor(Math.random()*(size/box))*box, y: Math.floor(Math.random()*(size/box))*box, type: Math.random()<0.1?"red":"green" };
}

function endGame(){
  clearInterval(gameInterval);
  updateDoc(doc(db,"rooms",roomId),{state:"ended"});
}

function gameLoop(){
  let headX = snake[0].x, headY = snake[0].y;
  if(direction==="UP") headY-=box;
  if(direction==="DOWN") headY+=box;
  if(direction==="LEFT") headX-=box;
  if(direction==="RIGHT") headX+=box;

  if(headX<0 || headY<0 || headX>=size || headY>=size || snake.some(s=>s.x===headX && s.y===headY)){
    endGame();
    return;
  }

  if(headX===food.x && headY===food.y){
    score += food.type==="red"?30:10;
    playerScoreEl.innerText=score;
    food=randomFood();
  } else { snake.pop(); }

  snake.unshift({x:headX,y:headY});
  draw();
}

function draw(){
  ctx.fillStyle="#9bbc0f"; ctx.fillRect(0,0,size,size);
  snake.forEach(s=>{ctx.fillStyle="#0f380f"; ctx.fillRect(s.x,s.y,box,box);});
  ctx.font="14px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(food.type==="red"?"üçé":"üçè",food.x+box/2,food.y+box/2);
}
</script>
</body>
</html>

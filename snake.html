<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena Snake.io Multiplayer</title>
<style>
body, html { margin:0; padding:0; overflow:hidden; background:#1e1e1e; font-family:sans-serif; }
canvas { display:block; background:#1e1e1e; }
#scoreboard {
  position:fixed; top:10px; right:10px;
  color:white; background:rgba(0,0,0,0.6);
  padding:10px; border-radius:8px;
  font-size:14px; max-height:90vh; overflow-y:auto;
}
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="scoreboard"></div>
<audio id="eatSound" src="https://freesound.org/data/previews/342/342756_3248244-lq.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  databaseURL:"https://emirhan-site-default-rtdb.firebaseio.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.appspot.com",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ---------------- CANVAS ---------------- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let W = window.innerWidth, H = window.innerHeight;
canvas.width = W; canvas.height = H;

const MAP_SIZE = 5000;
const MAX_FOODS = 200;
let players = {}, foods = [];
let bots = [];
const scoreboard = document.getElementById("scoreboard");
let inputDir = {x:0,y:0};
const eatSound = document.getElementById("eatSound");

/* ---------------- MY SNAKE ---------------- */
let mySnake = { body:[], x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, speed:6, score:0, color:"#ffff00" };

/* ---------------- TOUCH CONTROLS ---------------- */
canvas.addEventListener("touchstart", handleTouch);
canvas.addEventListener("touchmove", handleTouch);
function handleTouch(e){
  e.preventDefault();
  let touch = e.touches[0];
  let dx = touch.clientX - W/2;
  let dy = touch.clientY - H/2;
  let len = Math.sqrt(dx*dx + dy*dy);
  inputDir.x = dx/len;
  inputDir.y = dy/len;
}

/* ---------------- START GAME ---------------- */
onAuthStateChanged(auth, user=>{
  if(!user) location.href="index.html";
  const uid = user.uid;
  const username = user.displayName || "Oyuncu";

  mySnake.body = [{x:mySnake.x, y:mySnake.y}];
  const playerRef = ref(db, "players/" + uid);
  set(playerRef, { username:username, x:mySnake.x, y:mySnake.y, score:0, alive:true });
  onDisconnect(playerRef).remove();

  const playersRef = ref(db, "players");
  onValue(playersRef, snap=>{ players = snap.val() || {}; updateScoreboard(); });

  for(let i=0;i<MAX_FOODS;i++) foods.push(randomFood());
  for(let i=0;i<5;i++) bots.push(randomBot());

  requestAnimationFrame(gameLoop);
});

/* ---------------- GAME LOOP ---------------- */
function gameLoop(){
  updateMySnake();
  updateBots();
  checkCollisions();
  render();
  requestAnimationFrame(gameLoop);
}

/* ---------------- FUNCTIONS ---------------- */
function updateMySnake(){
  if(inputDir.x!==0||inputDir.y!==0){
    mySnake.x += inputDir.x*mySnake.speed;
    mySnake.y += inputDir.y*mySnake.speed;
    // Duvar engeli
    mySnake.x = Math.max(0, Math.min(MAP_SIZE, mySnake.x));
    mySnake.y = Math.max(0, Math.min(MAP_SIZE, mySnake.y));
    mySnake.body.unshift({x:mySnake.x,y:mySnake.y});
    if(mySnake.body.length>10+mySnake.score/10) mySnake.body.pop();
  }
  update(ref(db, "players/"+auth.currentUser.uid), { x:mySnake.x, y:mySnake.y, score:mySnake.score });
}

function updateBots(){
  bots.forEach(bot=>{
    // Rastgele hedef yem
    let target = foods[Math.floor(Math.random()*foods.length)];
    let dx = target.x - bot.x;
    let dy = target.y - bot.y;
    let len = Math.sqrt(dx*dx + dy*dy) || 1;
    bot.x += dx/len*bot.speed;
    bot.y += dy/len*bot.speed;
    bot.body.unshift({x:bot.x, y:bot.y});
    if(bot.body.length>10+bot.score/10) bot.body.pop();

    // Yem yeme
    foods.forEach((f,i)=>{
      if(distance(f, bot.body[0])<15){
        bot.score += (f.type==="red"?30:10);
        foods[i]=randomFood();
      }
    });
  });
}

function checkCollisions(){
  foods.forEach((f,i)=>{
    if(distance(f, mySnake.body[0])<15){
      mySnake.score += (f.type==="red"?30:10);
      foods[i]=randomFood();
      eatSound.currentTime=0; eatSound.play();
    }
  });
}

function render(){
  ctx.clearRect(0,0,W,H);
  let camX = mySnake.x - W/2;
  let camY = mySnake.y - H/2;

  // Draw map boundaries
  ctx.strokeStyle="#555"; ctx.lineWidth=8;
  ctx.strokeRect(-camX, -camY, MAP_SIZE, MAP_SIZE);

  // Draw foods
  foods.forEach(f=>{
    ctx.font="20px Arial";
    ctx.fillText(f.type==="red"?"ðŸŽ":"ðŸ", f.x-camX, f.y-camY);
  });

  // Draw bots
  bots.forEach(bot=> drawSnake(bot, camX, camY, "#ff6600") );

  // Draw other players
  for(let id in players){
    if(id===auth.currentUser.uid) continue;
    let p = players[id];
    drawSnake(p, camX, camY, "#00ffff");
  }

  // Draw my snake
  drawSnake(mySnake, camX, camY, mySnake.color);
}

function drawSnake(snake, camX, camY, color){
  snake.body.forEach((seg,i)=>{
    let alpha = 1 - i/snake.body.length;
    let radius = 12*(1-alpha*0.5);
    ctx.beginPath();
    ctx.arc(seg.x-camX, seg.y-camY, radius, 0, Math.PI*2);
    ctx.fillStyle = i===0 ? color : `rgba(255,255,0,${alpha})`;
    ctx.shadowColor="black"; ctx.shadowBlur=6;
    ctx.fill();
    ctx.shadowBlur=0;
  });
  let head = snake.body[0];
  if(head){
    ctx.fillStyle="black";
    ctx.beginPath();
    ctx.arc(head.x-camX+5, head.y-camY-3, 3,0,Math.PI*2);
    ctx.arc(head.x-camX-5, head.y-camY-3, 3,0,Math.PI*2);
    ctx.fill();
  }
}

function randomFood(){ return { x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, type:Math.random()<0.1?"red":"green" }; }
function randomBot(){ return { body:[{x:Math.random()*MAP_SIZE,y:Math.random()*MAP_SIZE}], x:Math.random()*MAP_SIZE, y:Math.random()*MAP_SIZE, speed:3+Math.random()*3, score:0 }; }
function distance(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

function updateScoreboard(){
  let arr=[];
  for(let id in players) arr.push({name:players[id].username, score:players[id].score});
  bots.forEach((b,i)=> arr.push({name:"BOT"+(i+1), score:Math.floor(b.score)}));
  arr.sort((a,b)=>b.score-a.score);
  scoreboard.innerHTML = arr.map(p=>`${p.name}: ${Math.floor(p.score)}`).join("<br>");
}

/* ---------------- ORIENTATION LOCK ---------------- */
window.addEventListener("load", ()=>{
  if(window.screen.orientation && window.screen.orientation.lock){
    window.screen.orientation.lock('landscape').catch(()=>{});
  }
});
</script>
</body>
</html>

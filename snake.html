<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake.io Multiplayer</title>
<style>
body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
#gameCanvas { display:block; margin:0 auto; background:#1a1a1a; touch-action:none; }
#info { position:absolute; top:10px; left:10px; z-index:1000; color:white;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="info">Oyuncular: <span id="playerCount">0</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain: "emirhan-site.firebaseapp.com",
  projectId: "emirhan-site",
  storageBucket: "emirhan-site.firebasestorage.app",
  messagingSenderId: "668871888390",
  appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, playerData, roomRef;
let players = {}; // TÃ¼m oyuncularÄ±n bilgisi
let food = [];    // Yiyecekler
const MAX_PLAYERS = 150;
const MAP_WIDTH = 4000;
const MAP_HEIGHT = 4000;

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const VIEW_WIDTH = canvas.width;
const VIEW_HEIGHT = canvas.height;
let cameraX=0, cameraY=0;

let direction = {x:1, y:0}; // BaÅŸlangÄ±Ã§ yÃ¶n
let lastTouch = null;

// GiriÅŸ anonim
onAuthStateChanged(auth, async(user)=>{
    if(!user) {
        await signInAnonymously(auth);
        return;
    }
    uid = user.uid;
    await joinGame();
});

// Oyuna KatÄ±l
async function joinGame(){
    // Kendi yÄ±lanÄ±mÄ±z
    playerData = {
        snake: [{x: Math.random()*MAP_WIDTH, y: Math.random()*MAP_HEIGHT}],
        color: 'lime',
        score: 0,
        lastUpdate: serverTimestamp()
    };

    roomRef = doc(collection(db,"snakePlayers"), uid);
    await setDoc(roomRef, playerData);

    // Mevcut yiyecekleri oluÅŸtur
    for(let i=0;i<500;i++){
        food.push({
            id:'f'+i,
            x: Math.random()*MAP_WIDTH,
            y: Math.random()*MAP_HEIGHT,
            type: Math.random()<0.1?'red':'green'
        });
    }

    // OyuncularÄ± dinle
    onSnapshot(collection(db,"snakePlayers"), snap=>{
        players = {};
        snap.docs.forEach(doc=>{
            players[doc.id] = doc.data();
        });
    });

    // Input (klavye)
    window.addEventListener('keydown', e=>{
        if(e.key==='ArrowUp') direction={x:0,y:-1};
        if(e.key==='ArrowDown') direction={x:0,y:1};
        if(e.key==='ArrowLeft') direction={x:-1,y:0};
        if(e.key==='ArrowRight') direction={x:1,y:0};
    });

    // Mobil dokunmatik
    canvas.addEventListener('touchstart', e=>{
        lastTouch = e.touches[0];
    });
    canvas.addEventListener('touchmove', e=>{
        if(!lastTouch) return;
        const t = e.touches[0];
        const dx = t.clientX - lastTouch.clientX;
        const dy = t.clientY - lastTouch.clientY;
        if(Math.abs(dx)>Math.abs(dy)){
            direction.x = dx>0?1:-1; direction.y=0;
        } else {
            direction.y = dy>0?1:-1; direction.x=0;
        }
        lastTouch = t;
    });

    requestAnimationFrame(gameLoop);
}

// Hareket
function moveSnake(player, dir){
    let head = {...player.snake[0]};
    head.x += dir.x*5;
    head.y += dir.y*5;

    if(head.x<0) head.x=0;
    if(head.y<0) head.y=0;
    if(head.x>MAP_WIDTH) head.x=MAP_WIDTH;
    if(head.y>MAP_HEIGHT) head.y=MAP_HEIGHT;

    player.snake.unshift(head);
    player.snake.pop();
}

// Yiyecek yeme
function eatFood(player){
    let head = player.snake[0];
    for(let i=0;i<food.length;i++){
        let f = food[i];
        if(Math.abs(head.x-f.x)<10 && Math.abs(head.y-f.y)<10){
            player.snake.push({...player.snake[player.snake.length-1]});
            player.score += (f.type==='red'?5:1);
            food.splice(i,1);
            break;
        }
    }
}

// Oyun dÃ¶ngÃ¼sÃ¼
async function gameLoop(){
    // Kamera
    const player = players[uid];
    if(!player) return requestAnimationFrame(gameLoop);
    cameraX = player.snake[0].x - VIEW_WIDTH/2;
    cameraY = player.snake[0].y - VIEW_HEIGHT/2;

    // Kendi yÄ±lan hareketi
    moveSnake(player, direction);
    eatFood(player);

    // Firebase gÃ¼ncelle
    await updateDoc(roomRef, {
        snake: player.snake,
        score: player.score,
        lastUpdate: serverTimestamp()
    });

    // Temizle
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Yiyecekler
    for(let f of food){
        ctx.font="16px Arial";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(f.type==="red"?"ðŸŽ":"ðŸ", f.x - cameraX, f.y - cameraY);
    }

    // YÄ±lanlar
    for(let id in players){
        let p = players[id];
        ctx.fillStyle = p.color;
        for(let s of p.snake){
            ctx.fillRect(s.x - cameraX, s.y - cameraY, 10, 10);
        }
    }

    document.getElementById('playerCount').innerText = Object.keys(players).length;

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>

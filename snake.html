<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena Snake Ranked 1v1</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}

body{
height:100vh;
overflow:hidden;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
background:radial-gradient(circle at center, rgba(255,180,60,0.15) 0%, transparent 40%),
linear-gradient(to bottom,#000 0%,#000 46%,#ff7b00 47%,#0b5d2a 48%,#063d1c 100%);
color:white;
display:flex;
flex-direction:column;
}

/* TOP BAR */
.top-bar{
position:fixed;top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
z-index:100;
}

.brand{font-weight:800}

/* SCORE PANEL */
.scoreboard{
margin-top:55px;
display:flex;
justify-content:space-between;
padding:10px 20px;
font-weight:bold;
background:#111;
}

.game-wrapper{
flex:1;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
}

canvas{
background:#9bbc0f;
border-radius:8px;
box-shadow:0 10px 30px rgba(0,0,0,0.6);
}

button{padding:10px 20px;margin-top:10px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena Snake</div>
<div>Ranked 1v1</div>
</div>

<div class="scoreboard">
<div>
<div id="p1name">Player</div>
<div id="p1score">0</div>
</div>
<div>
<div id="p2name">Player2</div>
<div id="p2score">0</div>
</div>
</div>

<div class="game-wrapper">
<div id="info">Hazƒ±r</div>
<button id="findBtn">Ma√ß Bul</button>
<div id="timer"></div>
<canvas id="game"></canvas>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
collection, query, where, getDocs,
onSnapshot, increment, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={ /* SENƒ∞N CONFIG AYNI */ };
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,roomId=null,unsubscribe=null;
let opponentId=null;

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let size=600;
canvas.width=size;
canvas.height=size;

let box=size/30; // GENƒ∞≈û ALAN 30x30

let snake=[],opponentSnake=[];
let dir="RIGHT",oppDir="LEFT";
let food,score=0,oppScore=0;
let isPlaying=false;

onAuthStateChanged(auth,user=>{
if(!user){alert("Giri≈ü gerekli");return;}
uid=user.uid;
});

/* MATCH */
document.getElementById("findBtn").onclick=async()=>{
document.getElementById("info").innerText="Rakip aranƒ±yor...";
document.getElementById("findBtn").style.display="none";

const q=query(collection(db,"snakeRooms"),where("state","==","waiting"));
const snap=await getDocs(q);
let joined=false;

for(const r of snap.docs){
const d=r.data();
if(d.player1!==uid && !d.player2){
roomId=r.id;
await updateDoc(doc(db,"snakeRooms",roomId),{player2:uid,state:"matched"});
joined=true;break;
}}

if(!joined){
const newRoom=doc(collection(db,"snakeRooms"));
roomId=newRoom.id;
await setDoc(newRoom,{
player1:uid,player2:null,
score1:0,score2:0,
state:"waiting",
createdAt:serverTimestamp()
});
}
listenRoom();
};

function listenRoom(){
unsubscribe=onSnapshot(doc(db,"snakeRooms",roomId),snap=>{
const d=snap.data();
if(d.state==="matched"){
updateDoc(doc(db,"snakeRooms",roomId),{state:"playing"});
}
if(d.state==="playing"){
opponentId=(uid===d.player1)?d.player2:d.player1;
startGame();
}
if(d.snake1 && d.snake2){
if(uid===d.player1){
opponentSnake=d.snake2||[];
oppScore=d.score2||0;
}else{
opponentSnake=d.snake1||[];
oppScore=d.score1||0;
}
document.getElementById("p2score").innerText=oppScore;
}
});
}

function startGame(){
snake=[{x:5*box,y:15*box}];
opponentSnake=[{x:25*box,y:15*box}];
food=randomFood();
score=0;
oppScore=0;
isPlaying=true;
loop();
}

function randomFood(){
return{
x:Math.floor(Math.random()*30)*box,
y:Math.floor(Math.random()*30)*box
};
}

function loop(){
if(!isPlaying)return;
update();
draw();
setTimeout(loop,120);
}

async function update(){
let headX=snake[0].x;
let headY=snake[0].y;

if(dir==="UP")headY-=box;
if(dir==="DOWN")headY+=box;
if(dir==="LEFT")headX-=box;
if(dir==="RIGHT")headX+=box;

if(headX<0||headY<0||headX>=size||headY>=size){
explode(headX,headY);
endGame();
return;
}

if(headX===food.x&&headY===food.y){
score++;
food=randomFood();
}else{
snake.pop();
}

snake.unshift({x:headX,y:headY});

document.getElementById("p1score").innerText=score;

if(uid){
if(uid){
await updateDoc(doc(db,"snakeRooms",roomId),
uid===opponentId?
{snake2:snake,score2:score}:
{snake1:snake,score1:score});
}
}
}

function draw(){
ctx.fillStyle="#9bbc0f";
ctx.fillRect(0,0,size,size);

/* Player RED */
snake.forEach(s=>{
ctx.fillStyle="red";
ctx.fillRect(s.x,s.y,box,box);
});

/* Opponent BLUE */
opponentSnake.forEach(s=>{
ctx.fillStyle="blue";
ctx.fillRect(s.x,s.y,box,box);
});

ctx.font=box+"px Arial";
ctx.fillText("üçé",food.x,food.y+box);
}

/* PATLAMA */
function explode(x,y){
for(let i=0;i<15;i++){
ctx.fillStyle="orange";
ctx.fillRect(x+Math.random()*20-10,y+Math.random()*20-10,5,5);
}
}

document.addEventListener("keydown",e=>{
if(e.key==="ArrowUp"&&dir!=="DOWN")dir="UP";
if(e.key==="ArrowDown"&&dir!=="UP")dir="DOWN";
if(e.key==="ArrowLeft"&&dir!=="RIGHT")dir="LEFT";
if(e.key==="ArrowRight"&&dir!=="LEFT")dir="RIGHT";
});

async function endGame(){
isPlaying=false;
await updateDoc(doc(db,"snakeRooms",roomId),{state:"finished"});
}

</script>
</body>
</html>

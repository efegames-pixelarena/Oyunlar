<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Snake Duel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
  background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
  background-size:600% 600%;
  animation:bg 4s infinite alternate ease-in-out;
  color:white;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  height:100vh;
  touch-action:manipulation;
}
@keyframes bg{0%{background-position:0% 50%}100%{background-position:100% 50%;}}

/* TOP BAR */
.top-bar{
  position:fixed;
  top:0;width:100%;height:55px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;
  background:linear-gradient(135deg,#1a2a6c,#16245c);
  box-shadow:0 4px 15px rgba(0,0,0,0.45);
  z-index:1000;
}
.brand{
  font-size:18px;font-weight:800;
  background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
  background-size:200% auto;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;min-width:95px;text-align:center;background:#273c8f;}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}

/* GAME SCREEN */
#gameScreen{
  flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:10px;
}
#matchMessage{
  font-size:clamp(32px,10vw,60px);
  margin-top:20px;font-weight:800;min-height:60px;
}
.lobby{
  margin-top:15px;
  display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
}
input{padding:8px;border-radius:8px;border:none;}
button{
  padding:12px 20px;border:none;border-radius:10px;
  font-weight:bold;cursor:pointer;
  background:linear-gradient(90deg,#ffb300,#ff5500);
  margin-top:10px;
}
#scoreContainer{
  display:flex;
  justify-content:space-around;
  width:100%;
  margin-top:10px;
  font-weight:bold;font-size:16px;
  display:none;
}
canvas{
  display:none; background:#9bbc0f; image-rendering:pixelated; margin-top:10px;
}
</style>
</head>
<body>

<div class="top-bar">
  <div class="brand">Snake Duel</div>
  <div class="right-menu">
    <div class="nav-box" id="playerName">...</div>
    <div class="nav-box" id="opponentName">Rakip...</div>
    <button class="btn logout-btn" id="logoutBtn">Çıkış</button>
  </div>
</div>

<div id="gameScreen">
  <div id="matchMessage">Maç Bul / Oda Kur</div>

  <!-- LOBBY -->
  <button id="findBtn">Maç Bul</button>
  <div class="lobby" id="lobbyBox">
    <input id="roomCodeInput" placeholder="Oda Kodu">
    <button id="createRoomBtn">Oda Kur</button>
    <button id="joinCodeBtn">Katıl</button>
  </div>

  <!-- SCORE -->
  <div id="scoreContainer">
    <div>Sen: <span id="playerScore">0</span></div>
    <div>Rakip: <span id="opponentScore">0</span></div>
  </div>

  <canvas id="gameCanvas" width="500" height="500"></canvas>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, query, where, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.firebasestorage.app",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, roomId, unsubscribe;

/* DOM */
const matchMessage=document.getElementById("matchMessage");
const findBtn=document.getElementById("findBtn");
const lobbyBox=document.getElementById("lobbyBox");
const scoreContainer=document.getElementById("scoreContainer");
const playerScoreEl=document.getElementById("playerScore");
const opponentScoreEl=document.getElementById("opponentScore");
const playerNameEl=document.getElementById("playerName");
const opponentNameEl=document.getElementById("opponentName");
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");

/* AUTH */
onAuthStateChanged(auth, async(user)=>{
  if(!user) location.href="index.html";
  uid=user.uid;
  const snap = await getDoc(doc(db,"users",uid));
  username = snap.data()?.username || "Oyuncu";
  playerNameEl.innerText = username;
});

/* LOGOUT */
document.getElementById("logoutBtn").onclick=async()=>{
  if(roomId) await updateDoc(doc(db,"rooms",roomId),{state:"ended"});
  await signOut(auth);
  location.href="index.html";
};

/* FIND MATCH */
findBtn.onclick = async()=>{
  matchMessage.innerText = "Rakip Aranıyor...";
  findBtn.style.display="none";
  lobbyBox.style.display="none";
  scoreContainer.style.display="none";

  // Açık odaları kontrol et, kendi odasını atla
  const q = query(collection(db,"rooms"), where("state","==","waiting"));
  const snap = await getDocs(q);
  let joined = false;

  for(const r of snap.docs){
    const d = r.data();
    if(d.player1 !== uid && !d.player2){
      roomId = r.id;
      await updateDoc(doc(db,"rooms",roomId),{
        player2: uid,
        player2Name: username,
        state: "countdown",
        startAt: Date.now()+5000
      });
      joined = true;
      break;
    }
  }

  // Eğer uygun oda yoksa yeni oda aç
  if(!joined){
    const newRoom = doc(collection(db,"rooms"));
    roomId = newRoom.id;
    await setDoc(newRoom,{
      player1: uid, player1Name: username,
      player2: null, player2Name: null,
      player1Score: 0, player2Score: 0,
      state: "waiting",
      createdAt: serverTimestamp()
    });
  }

  listenRoom();
};

/* ROOM LISTENER */
function listenRoom(){
  if(unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(doc(db,"rooms",roomId), snap=>{
    const d = snap.data();
    if(!d) return;

    // Kullanıcı adları
    if(d.player1Name) playerNameEl.innerText = d.player1Name;
    if(d.player2Name && d.player2Name!==username) opponentNameEl.innerText = d.player2Name;

    // Rakip aranıyor
    if(d.state==="waiting"){
      scoreContainer.style.display="none";
      matchMessage.innerText="Rakip Aranıyor...";
      canvas.style.display="none";
    }

    // Countdown
    if(d.state==="countdown"){
      scoreContainer.style.display="none";
      let diff = Math.ceil((d.startAt - Date.now())/1000);
      if(diff<0) diff=0;
      matchMessage.innerText = "Başlıyor... "+diff;
      canvas.style.display="none";
    }

    // Oyun başlıyor
    if(d.state==="active"){
      scoreContainer.style.display="flex";
      canvas.style.display="block";
      matchMessage.style.display="none";
      startSnakeGame();
    }

    if(d.state==="ended"){
      matchMessage.innerText="Rakip Oyundan Çıktı / Oyun Bitti";
      scoreContainer.style.display="none";
      canvas.style.display="none";
    }
  });
}

/* Oyun - Basit başlangıç */
function startSnakeGame(){
  ctx.fillStyle="#9bbc0f";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#0f380f";
  ctx.font="20px Arial";
  ctx.textAlign="center";
  ctx.fillText("Oyun Başladı!", canvas.width/2, canvas.height/2);
}
</script>
</body>
</html>

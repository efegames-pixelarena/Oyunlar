<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake.io Multiplayer</title>
<style>
body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
#gameCanvas { display:block; margin:0 auto; background:#1a1a1a; touch-action:none; }
#scoreBoard {
  position:absolute; top:10px; right:10px; z-index:1000; color:white;
  background: rgba(0,0,0,0.5); padding:10px; border-radius:8px; max-height:90vh; overflow:auto;
}
#scoreBoard h3{margin:0 0 5px 0; font-size:14px;}
#scoreBoard div{font-size:12px;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="scoreBoard"><h3>Skor Tablosu</h3></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain: "emirhan-site.firebaseapp.com",
  projectId: "emirhan-site",
  storageBucket: "emirhan-site.firebasestorage.app",
  messagingSenderId: "668871888390",
  appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, playerData, roomRef;
let players = {}; // TÃ¼m oyuncularÄ±n bilgisi
let food = [];    // Yiyecekler
const MAX_PLAYERS = 150;
const MAP_WIDTH = 4000;
const MAP_HEIGHT = 4000;

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const VIEW_WIDTH = canvas.width;
const VIEW_HEIGHT = canvas.height;
let cameraX=0, cameraY=0;

let direction = {x:1, y:0}; // BaÅŸlangÄ±Ã§ yÃ¶n
let lastTouch = null;

const scoreBoard = document.getElementById("scoreBoard");

// GiriÅŸ anonim
onAuthStateChanged(auth, async(user)=>{
    if(!user) {
        await signInAnonymously(auth);
        return;
    }
    uid = user.uid;
    await joinGame();
});

// Oyuna KatÄ±l
async function joinGame(){
    // Kendi yÄ±lanÄ±mÄ±z
    playerData = {
        snake: [{x: Math.random()*MAP_WIDTH, y: Math.random()*MAP_HEIGHT}],
        color: 'lime',
        score: 0,
        username: 'Oyuncu_'+Math.floor(Math.random()*1000),
        alive: true,
        lastUpdate: serverTimestamp()
    };

    roomRef = doc(collection(db,"snakePlayers"), uid);
    await setDoc(roomRef, playerData);

    // Mevcut yiyecekleri oluÅŸtur
    if(food.length===0){
      for(let i=0;i<500;i++){
          food.push({
              id:'f'+i,
              x: Math.random()*MAP_WIDTH,
              y: Math.random()*MAP_HEIGHT,
              type: Math.random()<0.1?'red':'green'
          });
      }
    }

    // OyuncularÄ± dinle
    onSnapshot(collection(db,"snakePlayers"), snap=>{
        players = {};
        snap.docs.forEach(doc=>{
            players[doc.id] = doc.data();
        });
    });

    // Input (klavye)
    window.addEventListener('keydown', e=>{
        if(e.key==='ArrowUp') direction={x:0,y:-1};
        if(e.key==='ArrowDown') direction={x:0,y:1};
        if(e.key==='ArrowLeft') direction={x:-1,y:0};
        if(e.key==='ArrowRight') direction={x:1,y:0};
    });

    // Mobil dokunmatik
    canvas.addEventListener('touchstart', e=>{
        lastTouch = e.touches[0];
    });
    canvas.addEventListener('touchmove', e=>{
        if(!lastTouch) return;
        const t = e.touches[0];
        const dx = t.clientX - lastTouch.clientX;
        const dy = t.clientY - lastTouch.clientY;
        if(Math.abs(dx)>Math.abs(dy)){
            direction.x = dx>0?1:-1; direction.y=0;
        } else {
            direction.y = dy>0?1:-1; direction.x=0;
        }
        lastTouch = t;
    });

    requestAnimationFrame(gameLoop);
}

// Hareket
function moveSnake(player, dir){
    if(!player.alive) return;
    let head = {...player.snake[0]};
    head.x += dir.x*5;
    head.y += dir.y*5;

    // Harita sÄ±nÄ±rlarÄ±
    head.x = Math.max(0, Math.min(MAP_WIDTH, head.x));
    head.y = Math.max(0, Math.min(MAP_HEIGHT, head.y));

    player.snake.unshift(head);
    player.snake.pop();
}

// Yiyecek yeme
function eatFood(player){
    let head = player.snake[0];
    for(let i=0;i<food.length;i++){
        let f = food[i];
        if(Math.abs(head.x-f.x)<10 && Math.abs(head.y-f.y)<10){
            player.snake.push({...player.snake[player.snake.length-1]});
            player.score += (f.type==='red'?5:1);
            food.splice(i,1);
            break;
        }
    }
}

// Ã‡arpÄ±ÅŸma kontrolÃ¼
function checkCollisions(){
    const allPlayers = Object.values(players);
    for(let pId in players){
        let p = players[pId];
        if(!p.alive) continue;
        const head = p.snake[0];
        // Kendine Ã§arpma
        for(let i=1;i<p.snake.length;i++){
            if(distance(head, p.snake[i])<10){
                p.alive=false;
                break;
            }
        }
        // BaÅŸkalarÄ±na Ã§arpma
        for(let other of allPlayers){
            if(other===p || !other.alive) continue;
            for(let s of other.snake){
                if(distance(head, s)<10){
                    p.alive=false;
                    other.score += Math.floor(p.score/2); // otomatik skor
                    break;
                }
            }
        }
    }
}

// Mesafe hesaplama
function distance(a,b){
    return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
}

// Bot yÄ±lanlar
function botMovement(){
    for(let pId in players){
        let p = players[pId];
        if(!p.alive || !p.bot) continue;
        let head = p.snake[0];
        if(food.length===0) break;
        let target = food[Math.floor(Math.random()*food.length)];
        directionBot = {x: Math.sign(target.x-head.x), y: Math.sign(target.y-head.y)};
        moveSnake(p, directionBot);
        eatFood(p);
    }
}

// Oyun dÃ¶ngÃ¼sÃ¼
async function gameLoop(){
    // Kamera
    const player = players[uid];
    if(player){
        cameraX = player.snake[0].x - VIEW_WIDTH/2;
        cameraY = player.snake[0].y - VIEW_HEIGHT/2;
        moveSnake(player,direction);
        eatFood(player);
    }

    botMovement();
    checkCollisions();

    // Firebase gÃ¼ncelle
    for(let pId in players){
        let p = players[pId];
        await updateDoc(doc(db,"snakePlayers",pId), {
            snake: p.snake,
            score: p.score,
            alive: p.alive,
            lastUpdate: serverTimestamp()
        });
    }

    // Temizle
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Yiyecekler
    for(let f of food){
        ctx.font="16px Arial";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(f.type==="red"?"ðŸŽ":"ðŸ", f.x - cameraX, f.y - cameraY);
    }

    // YÄ±lanlar
    for(let pId in players){
        let p = players[pId];
        ctx.fillStyle = p.color || 'white';
        for(let s of p.snake){
            ctx.fillRect(s.x - cameraX, s.y - cameraY, 10, 10);
        }
    }

    // Skor tablosu
    let scoreHtml = '<h3>Skor Tablosu</h3>';
    const sorted = Object.values(players).sort((a,b)=>b.score - a.score);
    for(let p of sorted.slice(0,10)){
        scoreHtml += `<div>${p.username||'Bot'} : ${p.score}</div>`;
    }
    scoreBoard.innerHTML = scoreHtml;

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>

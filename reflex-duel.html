<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{
height:100vh;
overflow:hidden;
color:white;
display:flex;
flex-direction:column;
background:linear-gradient(-45deg,#0b0f1a,#10182a,#0b0f1a,#16223a);
background-size:400% 400%;
animation:bg 12s ease infinite;
}
@keyframes bg{
0%{background-position:0% 50%}
50%{background-position:100% 50%}
100%{background-position:0% 50%}
}
.topbar{
position:fixed;
top:0;
width:100%;
height:70px;
background:rgba(0,0,0,.6);
display:flex;
justify-content:space-between;
align-items:center;
padding:0 20px;
z-index:20;
}
.player{font-weight:bold}
.red{color:#ff4b4b}
.blue{color:#3fa9ff}
.middle{font-weight:bold}
.menu{
position:fixed;
top:25%;
left:50%;
transform:translateX(-50%);
z-index:10;
}
button{
padding:15px 30px;
border:none;
border-radius:10px;
cursor:pointer;
font-weight:bold;
margin:5px;
}
.hidden{display:none}
.center{
flex:1;
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;
margin-top:70px;
}
#countdown{
position:absolute;
font-size:120px;
font-weight:900;
opacity:0;
}
.tap-text{
font-size:70px;
font-weight:900;
}
@keyframes pop{
0%{transform:scale(.5);opacity:0}
50%{transform:scale(1.3);opacity:1}
100%{transform:scale(1)}
}
.countAnim{animation:pop .4s ease}
</style>
</head>
<body>

<div class="menu" id="menu">
<button id="findMatch">Maç Bul</button>
</div>

<div class="topbar hidden" id="topbar">
<div class="player red">
<div id="myName"></div>
<div>Skor: <span id="myScore">0</span></div>
</div>
<div class="middle">
<div id="roundInfo">Round 1 / 7</div>
</div>
<div class="player blue">
<div id="oppName"></div>
<div>Skor: <span id="oppScore">0</span></div>
</div>
</div>

<div class="center hidden" id="arena">
<div id="countdown"></div>
<div class="tap-text" id="mainText">Bekleniyor...</div>

<div id="finishButtons" class="hidden">
<button onclick="rematch()">Yeniden Oyna</button>
<button onclick="newMatch()">Yeni Kişi Bul</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc, onSnapshot,
serverTimestamp, collection, query, limit,
getDocs, deleteDoc, where, getDoc, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, onAuthStateChanged, signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid=null,username=null;
let roomId=null,isHost=false;
let roomUnsub=null,queueUnsub=null;
let gameLocked=false;

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){ await signInAnonymously(auth); return; }
uid=user.uid;

const ref=doc(db,"users",uid);
const snap=await getDoc(ref);
if(!snap.exists()){
username="Player_"+uid.slice(0,4);
await setDoc(ref,{username,createdAt:serverTimestamp()});
}else username=snap.data().username;
});

/* MATCHMAKING */
document.getElementById("findMatch").onclick=async()=>{
if(!uid)return alert("Bağlanıyor...");

document.getElementById("findMatch").disabled=true;

await cleanUp();

const q=await getDocs(
query(collection(db,"matchmakingQueue"),
where("uid","!=",uid),
limit(1))
);

if(!q.empty){
const opp=q.docs[0];
const oppUser=await getDoc(doc(db,"users",opp.data().uid));

roomId=crypto.randomUUID();
isHost=true;

await setDoc(doc(db,"rooms",roomId),{
player1:uid,
player2:opp.data().uid,
p1Name:username,
p2Name:oppUser.data().username,
p1:0,p2:0,
round:1,
state:"countdown",
count:3,
tapWinner:null,
createdAt:serverTimestamp()
});

await deleteDoc(doc(db,"matchmakingQueue",opp.id));

startGame();
listenRoom();
startCountdown();

}else{
await setDoc(doc(db,"matchmakingQueue",uid),{uid,createdAt:serverTimestamp()});
listenQueue();
alert("Rakip bekleniyor...");
}
};

function listenQueue(){
queueUnsub=onSnapshot(
query(collection(db,"rooms"),where("player2","==",uid)),
(s)=>{
if(!s.empty){
roomId=s.docs[0].id;
isHost=false;
queueUnsub();
startGame();
listenRoom();
}
});
}

function listenRoom(){
if(roomUnsub)roomUnsub();
roomUnsub=onSnapshot(doc(db,"rooms",roomId),(snap)=>{
if(!snap.exists()){ resetUI(); return; }
updateUI(snap.data());
});
}

async function startCountdown(){
if(!isHost)return;
let count=3;
const interval=setInterval(async()=>{
await updateDoc(doc(db,"rooms",roomId),{count});
count--;
if(count<0){
clearInterval(interval);
await updateDoc(doc(db,"rooms",roomId),{state:"active"});
}
},1000);
}

async function tap(){
if(gameLocked)return;
gameLocked=true;

const ref=doc(db,"rooms",roomId);
await runTransaction(db,async(t)=>{
const snap=await t.get(ref);
if(!snap.exists())return;
const d=snap.data();
if(d.state!=="active"||d.tapWinner)return;
t.update(ref,{tapWinner:uid});
});
setTimeout(()=>gameLocked=false,200);
}

function updateUI(d){
myName.innerText=uid===d.player1?d.p1Name:d.p2Name;
oppName.innerText=uid===d.player1?d.p2Name:d.p1Name;
myScore.innerText=uid===d.player1?d.p1:d.p2;
oppScore.innerText=uid===d.player1?d.p2:d.p1;
roundInfo.innerText="Round "+d.round+" / 7";

if(d.count!==undefined){
countdown.innerText=d.count>0?d.count:"GO!";
countdown.style.opacity=1;
countdown.classList.remove("countAnim");
void countdown.offsetWidth;
countdown.classList.add("countAnim");
setTimeout(()=>countdown.style.opacity=0,600);
}

if(d.tapWinner){
const win=d.tapWinner===uid;
mainText.innerText=win?"Kazandın!":"Kaybettin!";

if(isHost){
let p1=d.p1,p2=d.p2;
if(d.tapWinner===d.player1)p1++; else p2++;

if(p1===4||p2===4){
updateDoc(doc(db,"rooms",roomId),{state:"finished",p1,p2});
}else{
setTimeout(()=>{
updateDoc(doc(db,"rooms",roomId),{
p1,p2,
round:d.round+1,
state:"countdown",
count:3,
tapWinner:null
});
startCountdown();
},1000);
}
}
}

if(d.state==="finished"){
finishButtons.classList.remove("hidden");
}
}

function startGame(){
menu.style.display="none";
arena.classList.remove("hidden");
topbar.classList.remove("hidden");
mainText.innerText="Hazır...";
}

async function cleanUp(){
if(roomUnsub)roomUnsub();
if(queueUnsub)queueUnsub();
await deleteDoc(doc(db,"matchmakingQueue",uid)).catch(()=>{});
}

function resetUI(){
menu.style.display="block";
arena.classList.add("hidden");
topbar.classList.add("hidden");
document.getElementById("findMatch").disabled=false;
}

window.rematch=async()=>{
if(!isHost)return;
await updateDoc(doc(db,"rooms",roomId),{
p1:0,p2:0,round:1,state:"countdown",count:3,tapWinner:null
});
startCountdown();
finishButtons.classList.add("hidden");
};

window.newMatch=async()=>{
await cleanUp();
await deleteDoc(doc(db,"rooms",roomId)).catch(()=>{});
roomId=null;
resetUI();
};

document.addEventListener("touchstart",tap);
document.addEventListener("mousedown",tap);
document.addEventListener("keydown",e=>{if(e.code==="Space")tap()});
</script>
</body>
</html>

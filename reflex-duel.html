<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{
height:100vh;
overflow:hidden;
color:white;
display:flex;
flex-direction:column;
background:linear-gradient(-45deg,#0b0f1a,#10182a,#0b0f1a,#16223a);
background-size:400% 400%;
animation:bg 12s ease infinite;
}
@keyframes bg{
0%{background-position:0% 50%}
50%{background-position:100% 50%}
100%{background-position:0% 50%}
}
.menu{
position:absolute;
top:30%;
left:50%;
transform:translateX(-50%);
text-align:center;
}
input{
padding:10px;
margin:5px;
border-radius:8px;
border:none;
text-align:center;
}
button{
padding:12px 25px;
border:none;
border-radius:8px;
margin:5px;
font-weight:bold;
cursor:pointer;
}
.topbar{
position:fixed;
top:0;
width:100%;
height:60px;
background:rgba(0,0,0,.6);
display:flex;
justify-content:space-between;
align-items:center;
padding:0 15px;
}
.center{
flex:1;
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;
margin-top:60px;
}
#countdown{
font-size:100px;
font-weight:900;
opacity:0;
}
#mainText{
font-size:60px;
font-weight:900;
margin-top:20px;
text-align:center;
}
.hidden{display:none}
</style>
</head>
<body>

<div class="menu" id="menu">
<button id="findMatch">Maç Bul</button><br>
<button id="createRoom">Oda Kur</button><br>
<input id="roomInput" placeholder="Oda Kodu">
<button id="joinRoom">Odaya Gir</button>
<div id="statusText" style="margin-top:15px;font-weight:bold;"></div>
</div>

<div class="topbar hidden" id="topbar">
<div id="myInfo"></div>
<div id="roundInfo"></div>
<div id="oppInfo"></div>
</div>

<div class="center hidden" id="arena">
<div id="countdown"></div>
<div id="mainText">Hazır...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc, onSnapshot,
serverTimestamp, collection, query, limit,
getDocs, deleteDoc, getDoc, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, onAuthStateChanged, signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,username;
let roomId=null,isHost=false;
let unsub=null;
let audioCtx=null;
let lock=false;

/* AUDIO (iOS SAFE) */
function unlockAudio(){
if(!audioCtx){
audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
}
function beep(freq){
if(!audioCtx)return;
const o=audioCtx.createOscillator();
const g=audioCtx.createGain();
o.connect(g); g.connect(audioCtx.destination);
o.frequency.value=freq;
o.start();
g.gain.setValueAtTime(.25,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.25);
o.stop(audioCtx.currentTime+.25);
}

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){ await signInAnonymously(auth); return;}
uid=user.uid;
username="Player_"+uid.slice(0,4);

/* SAYFA AÇILDIĞINDA ESKİ QUEUE TEMİZLE */
await deleteDoc(doc(db,"matchQueue",uid)).catch(()=>{});
});

/* ROOM CODE */
function generateCode(){
return Math.random().toString(36).substring(2,8).toUpperCase();
}

/* ROOM CLEAN */
async function leaveRoom(){
if(unsub)unsub();
if(roomId){
await deleteDoc(doc(db,"rooms",roomId)).catch(()=>{});
}
roomId=null;
}

/* MATCHMAKING (SELF MATCH FIX) */
findMatch.onclick=async()=>{
unlockAudio();
statusText.innerText="Rakip Bekleniyor...";
await leaveRoom();

const queueRef=collection(db,"matchQueue");
const snap=await getDocs(query(queueRef,limit(10)));

let opponent=null;
snap.forEach(docSnap=>{
const data=docSnap.data();
if(data.uid!==uid && !opponent){
opponent=docSnap;
}
});

if(opponent){

await runTransaction(db,async(t)=>{
const fresh=await t.get(opponent.ref);
if(!fresh.exists())return;
if(fresh.data().uid===uid)return;

const code=generateCode();
roomId=code;
isHost=true;

t.set(doc(db,"rooms",code),{
player1:uid,
player2:fresh.data().uid,
round:1,
state:"countdown",
count:3,
winner:null,
createdAt:serverTimestamp()
});

t.delete(opponent.ref);
});

startGame();
listenRoom();
startCountdown();

}else{
await setDoc(doc(db,"matchQueue",uid),{
uid:uid,
createdAt:serverTimestamp()
});
}
};

/* CREATE ROOM */
createRoom.onclick=async()=>{
unlockAudio();
await leaveRoom();
const code=generateCode();
roomId=code;
isHost=true;

await setDoc(doc(db,"rooms",code),{
player1:uid,
player2:null,
round:1,
state:"waiting"
});

statusText.innerText="Oda Kodu: "+code;
};

/* JOIN ROOM */
joinRoom.onclick=async()=>{
unlockAudio();
const code=roomInput.value.trim().toUpperCase();
if(!code)return;

const ref=doc(db,"rooms",code);
const snap=await getDoc(ref);
if(!snap.exists()){
statusText.innerText="Oda Bulunamadı";
return;
}

await updateDoc(ref,{
player2:uid,
state:"countdown",
count:3
});

roomId=code;
isHost=false;
startGame();
listenRoom();
};

/* LISTEN ROOM */
function listenRoom(){
unsub=onSnapshot(doc(db,"rooms",roomId),(snap)=>{
if(!snap.exists()){reset();return;}
updateUI(snap.data());
});
}

/* COUNTDOWN */
async function startCountdown(){
if(!isHost)return;
let c=3;
const int=setInterval(async()=>{
await updateDoc(doc(db,"rooms",roomId),{count:c});
beep(600);
c--;
if(c<0){
clearInterval(int);
await updateDoc(doc(db,"rooms",roomId),{state:"active"});
beep(1200);
}
},1000);
}

/* TAP (ANTI CHEAT) */
async function tap(){
if(lock||!roomId)return;
lock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists())return;
const d=snap.data();
if(d.state!=="active"||d.winner)return;
t.update(ref,{winner:uid,state:"result"});
});

setTimeout(()=>lock=false,200);
}

/* UI */
function updateUI(d){
roundInfo.innerText="Round "+(d.round||1)+" / 7";
myInfo.innerText="Sen";
oppInfo.innerText="Rakip";

if(d.state==="waiting"){
mainText.innerText="Rakip Bekleniyor...";
}
if(d.state==="countdown"){
countdown.style.opacity=1;
countdown.innerText=d.count>0?d.count:"GO!";
}
if(d.state==="active"){
countdown.style.opacity=0;
mainText.innerText="TAP!";
}
if(d.state==="result"){
mainText.innerText=d.winner===uid?"Kazandın!":"Kaybettin!";
}
}

/* UI SWITCH */
function startGame(){
menu.classList.add("hidden");
arena.classList.remove("hidden");
topbar.classList.remove("hidden");
}
function reset(){
menu.classList.remove("hidden");
arena.classList.add("hidden");
topbar.classList.add("hidden");
statusText.innerText="";
roomId=null;
}

document.addEventListener("touchstart",tap);
document.addEventListener("mousedown",tap);
document.addEventListener("keydown",e=>{if(e.code==="Space")tap()});
</script>
</body>
</html>

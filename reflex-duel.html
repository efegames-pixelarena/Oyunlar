<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel | Elite</title>
<style>
:root { --p: #4fd1ff; --a: #ff8a00; --bg: #03050a; --b: #1e2642; --danger: #ff2a4d; --glass: rgba(15, 23, 42, 0.8); }
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color:transparent; }
body { background: radial-gradient(circle at top, #0f172a, #03050a); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

/* NAVBAR */
.top-bar { height: 65px; background: rgba(10,15,30,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid var(--b); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
.brand { font-weight: 900; background: linear-gradient(90deg, var(--p), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; font-size: 20px; }
.nav-box { padding: 8px 15px; border-radius: 12px; background: #1a2248; border: 1px solid rgba(79,209,255,0.2); color: var(--p); font-size: 11px; font-weight: 800; }

/* AYRIL BUTONU (GÃ–RSELDEKÄ° GÄ°BÄ°) */
#leaveBtn { background: var(--danger); border: none; color: white; padding: 10px 20px; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 12px; }

/* LOBBY */
#lobby { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
.lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.create-btn { padding: 14px 28px; background: var(--a); color: #000; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; transition: 0.3s; }

.room-card { 
    background: var(--glass); border: 1px solid var(--b); padding: 20px; border-radius: 22px; 
    margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
}

/* GAME ALANI (GÃ–RSEL ODAKLI) */
#game-view { display: none; flex: 1; flex-direction: column; }
.scoreboard { background: rgba(0,0,0,0.4); padding: 25px; border-bottom: 1px solid var(--b); display: flex; justify-content: space-between; font-weight: 900; }
.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
#bigText { font-size: 120px; font-weight: 900; text-shadow: 0 0 40px rgba(79, 209, 255, 0.6); }
#subText { font-size: 24px; font-weight: 800; color: var(--p); margin-top: 15px; letter-spacing: 3px; }

/* MODAL */
.modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:2000; }
.modal-content { background:#0f172a; padding:35px; border-radius:30px; width:90%; max-width:360px; text-align:center; }

.flash { background: white !important; }
.flash #bigText { color: black !important; text-shadow: none; }
.flash #subText { color: black !important; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">REFLEX DUEL</div>
    <div class="right-menu" style="display:flex; gap:10px; align-items: center;">
        <div class="nav-box" id="userBox">...</div>
        <button id="leaveBtn" style="display:none;">AYRIL</button>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--p)">Oda AyarlarÄ±</h2>
        <input type="text" id="roomPassInput" placeholder="Oda Åžifresi (Opsiyonel)" maxlength="8" style="width:100%; padding:15px; margin:20px 0; border-radius:10px; border:none; background:#1e2642; color:white; text-align:center;">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal()" style="flex:1; padding:15px; border-radius:10px; background:#444; border:none; color:white;">Ä°PTAL</button>
            <button id="confirmCreateBtn" style="flex:1; padding:15px; border-radius:10px; background:var(--p); border:none; color:black; font-weight:900;">KUR</button>
        </div>
    </div>
</div>

<div id="lobby">
    <div class="lobby-header">
        <h3>Aktif Odalar</h3>
        <button class="create-btn" onclick="openModal()">ODA KUR</button>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div id="p1Name">...</div>
        <div id="roundNum" style="color:var(--a)">RD 1</div>
        <div id="p2Name">...</div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText"></div>
        <div id="subText"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, tapLock = false;

window.openModal = () => document.getElementById("createModal").style.display = "flex";
window.closeModal = () => document.getElementById("createModal").style.display = "none";

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid));
    username = snap.exists() ? snap.data().username : "Player";
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

function listenLobby() {
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.forEach(d => {
            const data = d.data();
            const isFull = data.player1 && data.player2;
            const isLocked = data.password && data.password !== "";
            const div = document.createElement("div");
            div.className = "room-card";
            div.innerHTML = `
                <div class="room-info">
                    <h4>${isLocked ? 'ðŸ”’ ' : 'ðŸŽ® '}${data.player1Name}</h4>
                    <span>${isFull ? 'DOLU' : 'BEKLÄ°YOR'}</span>
                </div>
                <button class="join-btn" style="padding:10px 20px; border-radius:10px; border:none; background:var(--p); color:black; font-weight:900;" 
                ${isFull ? 'disabled' : ''} onclick="joinRoom('${d.id}', ${isLocked})">GÄ°R</button>
            `;
            list.appendChild(div);
        });
    });
}

document.getElementById("confirmCreateBtn").onclick = async () => {
    const pass = document.getElementById("roomPassInput").value;
    const newRoomRef = doc(collection(db, "rooms"));
    currentRoomId = newRoomRef.id;
    await setDoc(newRoomRef, {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, 
        password: pass, createdAt: serverTimestamp()
    });
    closeModal();
    enterRoom();
};

window.joinRoom = async (id, isLocked) => {
    if (isLocked) {
        const userPass = prompt("Åžifre:");
        const snap = await getDoc(doc(db, "rooms", id));
        if (snap.data().password !== userPass) { alert("HatalÄ±!"); return; }
    }
    currentRoomId = id;
    await updateDoc(doc(db, "rooms", id), { player2: uid, player2Name: username, state: "matched" });
    enterRoom();
};

function enterRoom() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    if (unsubRoom) unsubRoom();
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if (!snap.exists()) { location.reload(); return; }
        const d = snap.data();
        
        document.getElementById("p1Name").innerText = `${d.player1Name} (${d.score1})`;
        document.getElementById("p2Name").innerText = `${d.player2Name || '...'} (${d.score2})`;
        document.getElementById("roundNum").innerText = `RD ${d.round}`;

        // 1. BEKLEME VE EÅžLEÅžME
        if (d.state === "matched" && uid === d.host) {
            setTimeout(() => {
                updateDoc(doc(db, "rooms", currentRoomId), { 
                    state: "countdown", 
                    startAt: Date.now() + 5500 // 5 saniye geri sayÄ±m
                });
            }, 1000);
        }

        // 2. GERÄ° SAYIM (GÃ–RSELDEKÄ° DURUM)
        if (d.state === "countdown") {
            const diff = Math.ceil((d.startAt - Date.now()) / 1000);
            if (diff > 0) {
                document.getElementById("bigText").innerText = diff;
                document.getElementById("subText").innerText = "HAZIR OL";
                document.getElementById("arena").classList.remove("flash");
            } else {
                // SÃœRE BÄ°TTÄ°ÄžÄ°NDE SADECE HOST GÃœNCELLESÄ°N
                if (uid === d.host) {
                    updateDoc(doc(db, "rooms", currentRoomId), { 
                        state: "active", 
                        roundStart: serverTimestamp() 
                    });
                }
            }
        }

        // 3. AKTÄ°F OYUN
        if (d.state === "active") {
            document.getElementById("arena").classList.add("flash");
            document.getElementById("bigText").innerText = "DOKUN!";
            document.getElementById("subText").innerText = "HIZLI OL!";
        }

        // 4. SONUÃ‡
        if (d.state === "result") {
            document.getElementById("arena").classList.remove("flash");
            document.getElementById("bigText").innerText = d.reaction || "WIN";
            document.getElementById("subText").innerText = d.lastWinner + " KAZANDI";
            
            if (uid === d.host) {
                setTimeout(() => {
                    if (d.score1 >= 4 || d.score2 >= 4) {
                        updateDoc(doc(db, "rooms", currentRoomId), { state: "finished" });
                    } else {
                        updateDoc(doc(db, "rooms", currentRoomId), { 
                            state: "countdown", 
                            startAt: Date.now() + 4000, 
                            round: d.round + 1 
                        });
                    }
                }, 2500);
            }
        }

        if (d.state === "finished") {
            document.getElementById("bigText").innerText = "GG";
            document.getElementById("subText").innerText = "OYUN BÄ°TTÄ°";
            setTimeout(quitGame, 5000);
        }
    });
}

// DOKUNMA MANTIÄžI
document.getElementById("arena").onpointerdown = async () => {
    if (tapLock || !currentRoomId) return;
    const roomRef = doc(db, "rooms", currentRoomId);
    const snap = await getDoc(roomRef);
    const d = snap.data();
    
    // Sadece 'active' durumunda ve roundStart varsa Ã§alÄ±ÅŸÄ±r
    if (d.state !== "active" || !d.roundStart) return;

    tapLock = true;
    const now = Date.now();
    const start = d.roundStart.toMillis();
    const diffMs = now - start;
    const isP1 = uid === d.player1;

    await updateDoc(roomRef, {
        [isP1 ? "score1" : "score2"]: (isP1 ? d.score1 : d.score2) + 1,
        state: "result",
        lastWinner: username,
        reaction: diffMs + "ms"
    });
    
    setTimeout(() => tapLock = false, 1500);
};

async function quitGame() {
    if (currentRoomId) {
        const ref = doc(db, "rooms", currentRoomId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const d = snap.data();
            if (!d.player2 || d.state === "finished") await deleteDoc(ref);
            else {
                const field = d.player1 === uid ? "player1" : "player2";
                await updateDoc(ref, { [field]: null, state: "finished" });
            }
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b);
background-size:400% 400%;
animation:bg 6s infinite alternate ease-in-out;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
touch-action:manipulation;
}
@keyframes bg{
0%{background-position:0% 50%}
100%{background-position:100% 50%}
}

/* TOP */
.top-bar{
position:fixed;top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);z-index:1000;
}
.brand{font-weight:800}
.nav-box{background:#273c8f;padding:6px 14px;border-radius:14px;font-weight:700}
.logout-btn{background:#ff3b3b;color:white;border:none;padding:6px 12px;border-radius:12px;font-weight:700}

/* SCOREBOARD */
.scoreboard{
display:none;
margin-top:55px;
width:100%;
background:rgba(0,0,0,0.5);
display:flex;
justify-content:space-between;
align-items:center;
padding:8px 14px;
font-weight:bold;
}

/* GAME */
#game{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
button{padding:10px 18px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;background:linear-gradient(90deg,#ffb300,#ff8c00);margin-top:10px}
#bigText{font-size:60px;margin-top:20px;font-weight:800}
.neon{
color:#ff2b2b;
text-shadow:0 0 5px red,0 0 10px red,0 0 20px red;
font-size:22px;margin-top:10px
}
.winEffect{animation:win 0.6s infinite alternate}
@keyframes win{from{transform:scale(1)}to{transform:scale(1.2)}}
canvas{position:fixed;top:0;left:0;pointer-events:none}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div style="display:flex;gap:10px;align-items:center">
<div class="nav-box" id="userBox">...</div>
<button class="logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div id="p1"></div>
<div id="roundInfo"></div>
<div id="p2"></div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>
<button id="createRoomBtn">Oda Kur</button>
<div id="bigText"></div>
<div id="subText"></div>
</div>

<canvas id="confetti"></canvas>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, getDocs, serverTimestamp, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* GLOBAL */
let uid=null, username=null, roomId=null, unsubscribe=null;
let tapLock=false, audioUnlocked=false;

/* AUDIO (iOS uyumlu) */
const ctx=new (window.AudioContext||window.webkitAudioContext)();
function unlockAudio(){if(!audioUnlocked){ctx.resume();audioUnlocked=true}}
document.addEventListener("pointerdown",unlockAudio,{once:true});

function beep(freq,duration){
const osc=ctx.createOscillator();
const gain=ctx.createGain();
osc.connect(gain);gain.connect(ctx.destination);
osc.frequency.value=freq;
osc.start();
gain.gain.setValueAtTime(0.3,ctx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+duration);
osc.stop(ctx.currentTime+duration);
}

/* CONFETTI */
const canvas=document.getElementById("confetti");
const c=canvas.getContext("2d");
canvas.width=innerWidth;canvas.height=innerHeight;
let pieces=[];
function fireConfetti(){
for(let i=0;i<150;i++){
pieces.push({x:innerWidth/2,y:innerHeight/2,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,size:Math.random()*6});
}
}
function animate(){
c.clearRect(0,0,canvas.width,canvas.height);
pieces.forEach(p=>{
p.x+=p.vx;p.y+=p.vy;p.vy+=0.2;
c.fillStyle="hsl("+Math.random()*360+",100%,50%)";
c.fillRect(p.x,p.y,p.size,p.size);
});
requestAnimationFrame(animate);
}
animate();

/* UI */
const scoreboard=document.getElementById("scoreboard");
const bigText=document.getElementById("bigText");
const subText=document.getElementById("subText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
document.getElementById("userBox").innerText=username;
});
document.getElementById("logoutBtn").onclick=()=>signOut(auth);

/* ODA KUR */
document.getElementById("createRoomBtn").onclick=async()=>{
const roomRef=doc(collection(db,"rooms"));
await setDoc(roomRef,{
player1:uid,
player1Name:username,
player2:null,
player2Name:null,
score1:0,score2:0,
round:1,
state:"waiting",
createdAt:serverTimestamp()
});
roomId=roomRef.id;
listenRoom();
bigText.innerText="Rakip Bekleniyor...";
};

/* MAÇ BUL */
document.getElementById("findBtn").onclick=async()=>{
const snap=await getDocs(collection(db,"rooms"));
let found=null;
snap.forEach(r=>{
const d=r.data();
if(d.state==="waiting" && d.player1!==uid && !found) found=r;
});
if(found){
await updateDoc(found.ref,{
player2:uid,
player2Name:username,
state:"countdown",
startAt:Date.now()+10000
});
roomId=found.id;
listenRoom();
}else alert("Açık oda yok.");
};

/* ROOM LISTENER */
function listenRoom(){
if(unsubscribe) unsubscribe();
unsubscribe=onSnapshot(doc(db,"rooms",roomId),async snap=>{
if(!snap.exists()) return;
const d=snap.data();

if(d.player2){
scoreboard.style.display="flex";
p1.innerText=d.player1Name+" ("+d.score1+")";
p2.innerText=d.player2Name+" ("+d.score2+")";
roundInfo.innerText="Round "+d.round+" / 7";
}

if(d.state==="countdown"){
let int=setInterval(()=>{
let diff=d.startAt-Date.now();
if(diff<=0){
clearInterval(int);
bigText.innerText="HAZIR OL";
setTimeout(()=>updateDoc(doc(db,"rooms",roomId),{
state:"active",
roundStart:Date.now()
}),3000);
}else{
bigText.innerText=Math.ceil(diff/1000);
beep(800,0.1);
}
},1000);
}

if(d.state==="active"){
bigText.innerText="TAP!";
subText.innerText="";
}

if(d.state==="result"){
bigText.classList.add("winEffect");
bigText.innerText=d.lastWinner+" Kazandı!";
subText.className="neon";
subText.innerText=d.reaction+" ms";
beep(200,0.2);
fireConfetti();

setTimeout(()=>{
bigText.classList.remove("winEffect");
if(d.score1===4||d.score2===4){
beep(600,0.5);
deleteDoc(doc(db,"rooms",roomId));
scoreboard.style.display="none";
bigText.innerText="Maç Bitti!";
}else{
updateDoc(doc(db,"rooms",roomId),{
round:d.round+1,
state:"countdown",
startAt:Date.now()+10000
});
}
},5000);
}
});
}

/* TAP */
document.addEventListener("pointerdown",async()=>{
if(tapLock||!roomId) return;
tapLock=true;
await runTransaction(db,async t=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;
const d=snap.data();
if(d.state!=="active") return;

let reaction=Date.now()-d.roundStart;

if(uid===d.player1){
t.update(ref,{score1:d.score1+1,state:"result",lastWinner:d.player1Name,reaction});
}else{
t.update(ref,{score2:d.score2+1,state:"result",lastWinner:d.player2Name,reaction});
}
});
tapLock=false;
});

</script>
</body>
</html>

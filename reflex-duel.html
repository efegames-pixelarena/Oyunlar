<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflex Duel V2</title>
<style>
body{
margin:0;
background:#0f172a;
color:white;
font-family:Arial;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
flex-direction:column;
}
button{
padding:15px 30px;
margin:10px;
border:none;
border-radius:8px;
font-size:16px;
font-weight:bold;
cursor:pointer;
}
#status{margin-top:15px;font-weight:bold}
#bigText{font-size:60px;margin-top:40px}
.hidden{display:none}
</style>
</head>
<body>

<button id="findBtn">Maç Bul</button>
<div id="status"></div>
<div id="bigText" class="hidden"></div>

<script type="module">

/* FIREBASE IMPORTS */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc,
deleteDoc, onSnapshot,
collection, getDocs,
serverTimestamp, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE CONFIG (SENİN PROJE) */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* ELEMENTS */
const findBtn=document.getElementById("findBtn");
const status=document.getElementById("status");
const bigText=document.getElementById("bigText");

/* GLOBALS */
let uid=null;
let roomId=null;
let isHost=false;
let roomUnsub=null;
let queueUnsub=null;
let audioCtx=null;
let tapLock=false;

/* AUDIO (iOS UYUMLU) */
function unlockAudio(){
if(!audioCtx){
audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
}
function beep(freq){
if(!audioCtx)return;
const o=audioCtx.createOscillator();
const g=audioCtx.createGain();
o.connect(g); g.connect(audioCtx.destination);
o.frequency.value=freq;
o.start();
g.gain.setValueAtTime(.3,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.2);
o.stop(audioCtx.currentTime+.2);
}

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){
await signInAnonymously(auth);
return;
}
uid=user.uid;

/* Eski queue temizle */
await deleteDoc(doc(db,"matchQueue",uid)).catch(()=>{});
});

/* FIND MATCH */
findBtn.onclick=async()=>{
if(!uid)return;
unlockAudio();
status.innerText="Rakip aranıyor...";
await cleanUp();

/* Kuyrukta biri var mı */
const snap=await getDocs(collection(db,"matchQueue"));
let opponent=null;

snap.forEach(d=>{
if(d.id!==uid && !opponent){
opponent=d;
}
});

if(opponent){

await runTransaction(db,async(t)=>{
const fresh=await t.get(opponent.ref);
if(!fresh.exists())return;

roomId=crypto.randomUUID();
isHost=true;

t.set(doc(db,"rooms",roomId),{
player1:uid,
player2:fresh.id,
round:1,
score1:0,
score2:0,
state:"countdown",
count:3,
winner:null,
createdAt:serverTimestamp()
});

t.delete(opponent.ref);
});

startGame();
listenRoom();

}else{

await setDoc(doc(db,"matchQueue",uid),{
createdAt:serverTimestamp()
});

listenQueue();
}
};

/* QUEUE LISTENER */
function listenQueue(){
queueUnsub=onSnapshot(doc(db,"matchQueue",uid),async(snap)=>{
if(!snap.exists())return;

const rooms=await getDocs(collection(db,"rooms"));
rooms.forEach(r=>{
if(r.data().player2===uid){
roomId=r.id;
isHost=false;
startGame();
listenRoom();
}
});
});
}

/* ROOM LISTENER */
function listenRoom(){
roomUnsub=onSnapshot(doc(db,"rooms",roomId),(snap)=>{
if(!snap.exists()){
resetUI();
return;
}
updateUI(snap.data());
});
}

/* COUNTDOWN */
async function startCountdown(){
if(!isHost)return;
let c=3;

const int=setInterval(async()=>{
await updateDoc(doc(db,"rooms",roomId),{count:c});
beep(600);
c--;

if(c<0){
clearInterval(int);
await updateDoc(doc(db,"rooms",roomId),{state:"active"});
beep(1200);
}
},1000);
}

/* TAP */
async function tap(){
if(tapLock||!roomId)return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists())return;

const d=snap.data();
if(d.state!=="active"||d.winner)return;

t.update(ref,{winner:uid,state:"result"});
});

setTimeout(()=>tapLock=false,200);
}

/* UI */
function updateUI(d){
bigText.classList.remove("hidden");

if(d.state==="countdown"){
if(isHost)startCountdown();
bigText.innerText=d.count>0?d.count:"GO!";
}
else if(d.state==="active"){
bigText.innerText="TAP!";
}
else if(d.state==="result"){
bigText.innerText=d.winner===uid?"Kazandın":"Kaybettin";
}
}

function startGame(){
findBtn.classList.add("hidden");
status.innerText="";
}

function resetUI(){
findBtn.classList.remove("hidden");
bigText.classList.add("hidden");
bigText.innerText="";
roomId=null;
}

/* CLEANUP */
async function cleanUp(){
if(roomUnsub)roomUnsub();
if(queueUnsub)queueUnsub();
if(roomId && isHost){
await deleteDoc(doc(db,"rooms",roomId)).catch(()=>{});
}
roomId=null;
}

/* Sayfa kapanınca temizle */
window.addEventListener("beforeunload",async()=>{
if(roomId && isHost){
await deleteDoc(doc(db,"rooms",roomId)).catch(()=>{});
}
});

/* TAP EVENTS */
document.addEventListener("touchstart",tap);
document.addEventListener("mousedown",tap);
document.addEventListener("keydown",e=>{if(e.code==="Space")tap();});

</script>
</body>
</html>

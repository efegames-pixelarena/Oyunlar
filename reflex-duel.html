<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(180deg,#0b1023,#0d1333,#0a0f1f);
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
}

/* ===== TOP BAR (INDEX İLE BİREBİR) ===== */
.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}
.brand{
font-size:18px;
font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{
padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;
background:#273c8f;min-width:95px;text-align:center;
}
.btn{
padding:6px 12px;border-radius:12px;border:none;
cursor:pointer;font-weight:700;font-size:13px;
}
.logout-btn{background:#ff3b3b;color:white;}

/* SCOREBOARD */
.scoreboard{
margin-top:55px;
width:100%;
background:rgba(0,0,0,0.6);
display:none;
justify-content:space-between;
align-items:center;
padding:8px 14px;
font-weight:bold;
}

/* GAME */
#game{
flex:1;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
padding:10px;
}

button{
padding:12px 20px;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
background:linear-gradient(90deg,#ffb300,#ff8c00);
margin-top:10px;
}

#bigText{
font-size:clamp(30px,9vw,60px);
min-height:90px;
margin-top:20px;
font-weight:800;
}

.neon{
color:#ff2b2b;
text-shadow:0 0 10px red,0 0 20px red;
font-size:22px;
margin-top:10px;
}

.winEffect{
animation:winAnim 0.8s ease-in-out infinite alternate;
}
@keyframes winAnim{
0%{transform:scale(1);}
100%{transform:scale(1.15);}
}

.lobby{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
input{padding:10px;border-radius:8px;border:none;}

</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="btn logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div id="p1"></div>
<div id="roundInfo"></div>
<div id="p2"></div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>

<div class="lobby" id="lobbyBox">
<input id="roomCodeInput" placeholder="Oda Kodu">
<button id="createRoomBtn">Oda Kur</button>
<button id="joinCodeBtn">Katıl</button>
</div>

<div id="bigText"></div>
<div id="subText"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, updateDoc, deleteDoc,
onSnapshot, collection, getDocs,
serverTimestamp, runTransaction, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* ===== AUDIO SİSTEMİ (PROFESYONEL, IOS UYUMLU) ===== */
let audioCtx=null;
function initAudio(){
if(!audioCtx){
audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
}
document.addEventListener("pointerdown",initAudio,{once:true});

function playTone(freq,duration){
const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.frequency.value=freq;
osc.type="triangle";
osc.start();
gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+duration/1000);
osc.stop(audioCtx.currentTime+duration/1000);
}

/* ===== OYUN ===== */
let uid,username,roomId=null,unsubscribe=null,tapLock=false;
const scoreboard=document.getElementById("scoreboard");
const bigText=document.getElementById("bigText");
const subText=document.getElementById("subText");

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
document.getElementById("userBox").innerText=username;
});

document.getElementById("logoutBtn").onclick=async()=>{
await signOut(auth);
location.href="index.html";
};

/* ===== MAÇ BUL ===== */
document.getElementById("findBtn").onclick=async()=>{
hideButtons();
bigText.innerText="Rakip Aranıyor...";
playTone(400,200);

const queueRef=collection(db,"queue");
const snap=await getDocs(queueRef);

let opponent=null;
snap.forEach(d=>{
if(d.data().uid!==uid && !opponent){
opponent=d;
}
});

if(opponent){
const roomRef=doc(collection(db,"rooms"));
await setDoc(roomRef,{
player1:opponent.data().uid,
player1Name:opponent.data().username,
player2:uid,
player2Name:username,
score1:0,score2:0,
round:1,
state:"prestart",
createdAt:serverTimestamp()
});
await deleteDoc(opponent.ref);
roomId=roomRef.id;
bigText.innerText="Eşleşme Bulundu!";
setTimeout(()=>startMatchCountdown(),1000);
}else{
await setDoc(doc(collection(db,"queue")),{
uid,username,createdAt:serverTimestamp()
});
listenForMatch();
}
};

function listenForMatch(){
onSnapshot(collection(db,"rooms"),snap=>{
snap.forEach(docu=>{
const d=docu.data();
if(d.player1===uid||d.player2===uid){
roomId=docu.id;
bigText.innerText="Eşleşme Bulundu!";
setTimeout(()=>startMatchCountdown(),1000);
}
});
});
}

function startMatchCountdown(){
let count=5;
bigText.innerText="Maç "+count;
let interval=setInterval(async()=>{
playTone(600,100);
count--;
if(count<=0){
clearInterval(interval);
await updateDoc(doc(db,"rooms",roomId),{
state:"active",
roundStart:Date.now()
});
}else{
bigText.innerText="Maç "+count;
}
},1000);
}

/* ===== ROOM LISTENER ===== */
function listenRoom(){
if(unsubscribe)unsubscribe();
unsubscribe=onSnapshot(doc(db,"rooms",roomId),snap=>{
if(!snap.exists())return;
const d=snap.data();

if(d.state==="active"){
scoreboard.style.display="flex";
bigText.innerText="TAP!";
}

if(d.state==="result"){
bigText.classList.add("winEffect");
bigText.innerText=d.lastWinner+" Kazandı!";
subText.className="neon";
subText.innerText=d.reaction+" ms";
playTone(900,300);

setTimeout(()=>subText.innerText="",3000);

if(d.score1===4||d.score2===4){
bigText.innerText="MAÇ BİTTİ!";
return;
}
}
});
}

/* ===== ANTI CHEAT ===== */
document.addEventListener("pointerdown",async()=>{
if(!roomId||tapLock)return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists())return;
const d=snap.data();
if(d.state!=="active")return;

let reaction=Date.now()-d.roundStart;

/* 100ms altı insanlık dışı → iptal */
if(reaction<100){
alert("Hile algılandı.");
return;
}

if(uid===d.player1){
t.update(ref,{score1:d.score1+1,state:"result",lastWinner:d.player1Name,reaction});
}else{
t.update(ref,{score2:d.score2+1,state:"result",lastWinner:d.player2Name,reaction});
}
});

tapLock=false;
});

function hideButtons(){
document.getElementById("findBtn").style.display="none";
document.getElementById("lobbyBox").style.display="none";
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
background-size:600% 600%;
animation:bg 4s infinite alternate ease-in-out;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
touch-action:manipulation;
}
@keyframes bg{0%{background-position:0% 50%}100%{background-position:100% 50%}}

/* TOP BAR */
.top-bar{
position:fixed;top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);z-index:1000;
}
.brand{font-size:18px;font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;min-width:95px;text-align:center;background:#273c8f;}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}

/* SCOREBOARD */
.scoreboard{
margin-top:55px;width:100%;display:none;flex-direction:column;font-weight:bold;overflow:hidden;
}
.score-top{
display:flex;justify-content:space-between;padding:10px 14px;flex-wrap:wrap;
}
.player1Box,.player2Box,.roundBox{flex:1 1 auto;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.player1Box{background:#0d47a1;padding:6px 12px;border-radius:8px;animation:blueAnim 1.2s infinite alternate;}
.player2Box{background:#8b0000;padding:6px 12px;border-radius:8px;animation:redAnim 1.2s infinite alternate;}
.roundBox{background:#000;padding:6px 12px;border-radius:8px;animation:blackAnim 1.2s infinite alternate;}
@keyframes blueAnim{0%{box-shadow:0 0 5px #007bff;}100%{box-shadow:0 0 20px #00c3ff;}}
@keyframes redAnim{0%{box-shadow:0 0 5px #ff0000;}100%{box-shadow:0 0 20px #ff4d4d;}}
@keyframes blackAnim{0%{box-shadow:0 0 5px #000;}100%{box-shadow:0 0 20px #222;}}
.round-bar{display:flex;height:6px;width:100%;overflow:hidden;border-radius:3px;}
.round-blue{flex:1;background:#0066ff;}
.round-red{flex:1;background:#ff0000;}

#game{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:10px;}
button{padding:12px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;background:linear-gradient(90deg,#ffb300,#ff5500);margin-top:10px;}
#bigText{font-size:clamp(32px,10vw,70px);min-height:90px;margin-top:20px;font-weight:800;}
#subText{margin-top:10px;font-size:18px;}
.lobby{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
input{padding:8px;border-radius:8px;border:none;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="btn logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div class="score-top">
<div id="p1" class="player1Box"></div>
<div id="roundInfo" class="roundBox"></div>
<div id="p2" class="player2Box"></div>
</div>
<div class="round-bar">
<div class="round-blue"></div>
<div class="round-red"></div>
</div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>
<div class="lobby" id="lobbyBox">
<input id="roomCodeInput" placeholder="Oda Kodu">
<button id="createRoomBtn">Oda Kur</button>
<button id="joinCodeBtn">Katıl</button>
</div>
<div id="bigText"></div>
<div id="subText"></div>
<div id="afterMatch"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, runTransaction, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,username,roomId,unsubscribe,tapLock=false,countdownInterval=null;

/* DOM */
const scoreboard=document.getElementById("scoreboard");
const bigText=document.getElementById("bigText");
const subText=document.getElementById("subText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");
const findBtn=document.getElementById("findBtn");
const lobbyBox=document.getElementById("lobbyBox");
const afterMatch=document.getElementById("afterMatch");

/* Ses efektleri */
const tickAudio=new Audio("https://www.soundjay.com/button/sounds/button-16.mp3");
const goAudio=new Audio("https://www.soundjay.com/button/sounds/button-09.mp3");

/* Auth kontrol */
onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
document.getElementById("userBox").innerText=username;
});

/* Logout */
document.getElementById("logoutBtn").onclick=async()=>{
if(roomId) await deleteDoc(doc(db,"rooms",roomId));
await signOut(auth);
location.href="index.html";
};

window.addEventListener("beforeunload",async()=>{
if(roomId) await deleteDoc(doc(db,"rooms",roomId));
});

/* Maç Bul */
findBtn.onclick=async()=>{
findBtn.style.display="none"; lobbyBox.style.display="none"; bigText.innerText="Rakip Aranıyor...";

const q=query(collection(db,"rooms"),where("state","==","waiting"));
const snap=await getDocs(q); let joined=false;
for(const r of snap.docs){
const d=r.data();
if(d.player1!==uid && !d.player2){roomId=r.id;
await updateDoc(doc(db,"rooms",roomId),{player2:uid,player2Name:username,state:"matched",matchedAt:Date.now()});joined=true; break;}
}
if(!joined){
const newRoom=doc(collection(db,"rooms")); roomId=newRoom.id;
await setDoc(newRoom,{player1:uid,player1Name:username,player2:null,player2Name:null,score1:0,score2:0,round:1,state:"waiting",rematchRequest:null,createdAt:serverTimestamp()});
}
listenRoom();
};

/* Oda dinleme */
function listenRoom(){
if(unsubscribe)unsubscribe();
unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()){location.reload();return;}
const d=snap.data();
scoreboard.style.display="flex";

/* Player & Score */
if(uid===d.player1){p1.innerText=d.player1Name+" ("+d.score1+")"; p2.innerText=(d.player2Name||"...")+" ("+d.score2+")";}
else{p1.innerText=d.player2Name+" ("+d.score2+")"; p2.innerText=d.player1Name+" ("+d.score1+")";}

/* Round senkronizasyon */
roundInfo.innerText="Round "+d.round+" / 7";

/* Oyuncu düşerse diğer oyuncu kazanır */
if((d.state==="waiting" || d.state==="matched") && ((d.player1 && !d.player2) || (!d.player1 && d.player2))){
await updateDoc(doc(db,"rooms",roomId),{state:"result",lastWinner:uid===d.player1?d.player1Name:d.player2Name});
}

/* Countdown */
if(d.state==="countdown"){
if(countdownInterval) clearInterval(countdownInterval);
countdownInterval=setInterval(()=>{
let diff=d.startAt-Date.now();
if(diff<=0){clearInterval(countdownInterval);bigText.innerText="TAP!";subText.innerText="";goAudio.play();updateDoc(doc(db,"rooms",roomId),{state:"active",roundStart:Date.now()});}
else{bigText.innerText=Math.ceil(diff/1000);tickAudio.play();}
},250);
}

/* Active */
if(d.state==="active"){bigText.innerText="TAP!"; subText.innerText=""; afterMatch.innerHTML="";}

/* Result */
if(d.state==="result"){
bigText.innerText=d.lastWinner+" Kazandı!"; subText.innerText=d.reaction?"Reaksiyon: "+d.reaction+" ms":"";
afterMatch.innerHTML=`<button id="newMatchBtn">⚽️ Yeni Maç Bul</button>`;
document.getElementById("newMatchBtn").onclick=async()=>{await deleteDoc(doc(db,"rooms",roomId));location.reload();}
if(d.score1===4||d.score2===4) return;
setTimeout(async()=>{await updateDoc(doc(db,"rooms",roomId),{round:d.round+1,state:"countdown",startAt:Date.now()+5000});},3000);
}
});
}

/* Tap işlemi */
document.addEventListener("pointerdown",async()=>{
if(tapLock||!roomId)return; tapLock=false;
await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId); const snap=await t.get(ref); if(!snap.exists())return;
const d=snap.data(); if(d.state!=="active")return;
let reaction=Date.now()-d.roundStart; if(reaction<80)return;
if(uid===d.player1){t.update(ref,{score1:d.score1+1,state:"result",lastWinner:d.player1Name,reaction});}
if(uid===d.player2){t.update(ref,{score2:d.score2+1,state:"result",lastWinner:d.player2Name,reaction});}
}); tapLock=false;
});
</script>
</body>
</html>

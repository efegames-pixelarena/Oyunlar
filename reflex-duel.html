<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
background-size:600% 600%;
animation:bg 4s infinite alternate ease-in-out;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
touch-action:manipulation;
}
@keyframes bg{
0%{background-position:0% 50%}
100%{background-position:100% 50%}
}

/* TOP BAR */
.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}
.brand{
font-size:18px;
font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{
padding:6px 14px;
border-radius:14px;
font-weight:700;
font-size:13px;
min-width:95px;
text-align:center;
background:#273c8f;
}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}

/* SCOREBOARD */
.scoreboard{
margin-top:55px;
width:100%;
display:none;
font-weight:bold;
}

.score-wrap{
display:flex;
width:100%;
}

#p1{
flex:1;
padding:10px;
background:linear-gradient(90deg,#0066ff,#003399);
text-align:left;
}

#roundInfo{
padding:10px 15px;
background:#111;
white-space:nowrap;
}

#p2{
flex:1;
padding:10px;
background:linear-gradient(90deg,#990000,#ff0000);
text-align:right;
}

/* GAME */
#game{
flex:1;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
padding:10px;
}
button{
padding:12px 20px;
border:none;
border-radius:10px;
font-weight:bold;
cursor:pointer;
background:linear-gradient(90deg,#ffb300,#ff5500);
margin-top:10px;
}
#bigText{
font-size:clamp(32px,10vw,70px);
min-height:90px;
margin-top:20px;
font-weight:800;
transition:0.2s;
}
#subText{margin-top:10px;font-size:18px;}
.winEffect{animation:winAnim 0.6s infinite alternate;}
@keyframes winAnim{from{transform:scale(1);}to{transform:scale(1.15);}}
.lobby{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
input{padding:8px;border-radius:8px;border:none;}

.rematchPopup{
position:fixed;
bottom:20px;
background:#000;
padding:15px;
border-radius:10px;
text-align:center;
box-shadow:0 0 20px rgba(0,0,0,0.5);
z-index:2000;
}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="btn logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div class="score-wrap">
<div id="p1"></div>
<div id="roundInfo"></div>
<div id="p2"></div>
</div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>

<div class="lobby" id="lobbyBox">
<input id="roomCodeInput" placeholder="Oda Kodu">
<button id="createRoomBtn">Oda Kur</button>
<button id="joinCodeBtn">Katıl</button>
</div>

<div id="bigText"></div>
<div id="subText"></div>
<div id="afterMatch"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, updateDoc, deleteDoc,
onSnapshot, collection, query, where, getDocs,
serverTimestamp, runTransaction, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,username,roomId,unsubscribe,tapLock=false;
let localDrift=0;

/* ODA OTOMATİK KAPANMA */
async function closeRoomIfExists(){
if(roomId){
try{ await deleteDoc(doc(db,"rooms",roomId)); }catch(e){}
}
}

window.addEventListener("beforeunload",closeRoomIfExists);

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
document.getElementById("userBox").innerText=username;
});

document.getElementById("logoutBtn").onclick=async()=>{
await closeRoomIfExists();
await signOut(auth);
location.href="index.html";
};

/* REMATCH */
function showAfterMatch(){
afterMatch.innerHTML=`
<button id="rematchBtn">⌛️ Rakiple Yeniden Oyna</button>
<button id="newMatchBtn">⚽️ Yeni Maç Bul</button>
`;

document.getElementById("rematchBtn").onclick=async()=>{
await updateDoc(doc(db,"rooms",roomId),{
rematchRequest:uid
});
};

document.getElementById("newMatchBtn").onclick=async()=>{
await closeRoomIfExists();
findBtn.click();
};
}

function listenRoom(){
if(unsubscribe)unsubscribe();
unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()){
location.reload();
return;
}
const d=snap.data();

/* Rakip her zaman Player2 */
const isPlayer1=d.player1===uid;
const myScore=isPlayer1?d.score1:d.score2;
const oppScore=isPlayer1?d.score2:d.score1;
const oppName=isPlayer1?d.player2Name:d.player1Name;

p1.innerText=username+" ("+myScore+")";
p2.innerText=(oppName||"...")+" ("+oppScore+")";
roundInfo.innerText="Round "+d.round+" / 7";

/* Rematch isteği popup */
if(d.rematchRequest && d.rematchRequest!==uid){
let pop=document.createElement("div");
pop.className="rematchPopup";
pop.innerHTML=`
Rakip senle tekrar oynamak istiyor<br><br>
<button id="acceptRematch">Oyna</button>
<button id="declineRematch">Yeni Maç Bul</button>
`;
document.body.appendChild(pop);

document.getElementById("acceptRematch").onclick=async()=>{
await updateDoc(doc(db,"rooms",roomId),{
score1:0,score2:0,round:1,
state:"countdown",
startAt:Date.now()+5000,
rematchRequest:null
});
pop.remove();
};

document.getElementById("declineRematch").onclick=async()=>{
await closeRoomIfExists();
findBtn.click();
pop.remove();
};
}

if(d.score1===4||d.score2===4){
showAfterMatch();
}
});
}

</script>
</body>
</html>

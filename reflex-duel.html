<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Reflex Duel | Elite Arena</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;800&display=swap" rel="stylesheet">
<style>
:root { 
    --p: #00d2ff; --a: #ff8a00; --bg: #020408; --b: #2a345a; 
    --danger: #ff003c; --win: #00ff88; 
    --glass: rgba(10, 15, 30, 0.7); 
}

* { 
    margin:0; padding:0; box-sizing:border-box; 
    font-family: 'Inter', sans-serif; 
    -webkit-tap-highlight-color:transparent; 
    touch-action: manipulation; 
    user-select: none; 
}

body { 
    background: var(--bg); 
    color: white; height: 100vh; overflow: hidden; 
    display: flex; flex-direction: column; 
    position: fixed; width: 100%;
}

/* 6- SAVAŞÇI ARKA PLAN (GRID & GLOW) */
body::before {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: 
        radial-gradient(circle at 50% 50%, rgba(0, 210, 255, 0.05), transparent),
        linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
        repeating-linear-gradient(0deg, transparent 0, transparent 40px, rgba(255,255,255,0.02) 40px, rgba(255,255,255,0.02) 41px),
        repeating-linear-gradient(90deg, transparent 0, transparent 40px, rgba(255,255,255,0.02) 40px, rgba(255,255,255,0.02) 41px);
    z-index: -1;
}

/* NAVBAR */
.top-bar { 
    height: 70px; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); 
    border-bottom: 2px solid var(--b); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 25px; z-index: 1000;
}
.brand { 
    font-family: 'Orbitron', sans-serif; font-weight: 900; 
    background: linear-gradient(180deg, #fff, var(--p)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
    letter-spacing: 2px; font-size: 22px; 
}

/* 3- PROFESYONEL LOBBY */
#lobby { flex: 1; padding: 30px 20px; overflow-y: auto; }
.lobby-header h3 { font-family: 'Orbitron'; font-size: 18px; color: var(--p); text-transform: uppercase; }
.create-btn { 
    padding: 15px 30px; background: linear-gradient(45deg, var(--a), #ff5e00); 
    color: white; border: none; border-radius: 50px; font-weight: 900; 
    font-family: 'Orbitron'; cursor: pointer; box-shadow: 0 0 20px rgba(255, 138, 0, 0.4);
}

.room-card { 
    background: var(--glass); border: 1px solid var(--b); padding: 22px; 
    border-radius: 20px; margin-bottom: 20px; display: flex; 
    justify-content: space-between; align-items: center;
    transition: 0.3s;
}
.room-card:active { transform: scale(0.98); border-color: var(--p); }

/* 5- "ODA KUR" MODAL POPUP */
.modal-content { 
    background: linear-gradient(135deg, #0f172a, #020408); 
    padding: 40px; border-radius: 35px; border: 2px solid var(--p); 
    width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(0, 210, 255, 0.3);
}
.modal-content input {
    width: 100%; padding: 18px; margin: 25px 0; border-radius: 15px;
    border: 1px solid var(--b); background: rgba(255,255,255,0.05);
    color: white; text-align: center; font-size: 18px; font-weight: bold;
}

/* 4- PROFESYONEL ARENA */
#game-view { display: none; flex: 1; flex-direction: column; }
.scoreboard { 
    background: rgba(0,0,0,0.8); padding: 20px; border-bottom: 3px solid var(--b);
    display: flex; justify-content: space-between; align-items: center;
}
.score-box { text-align: center; flex: 1; }
.score-box .name { font-size: 12px; opacity: 0.7; margin-bottom: 5px; text-transform: uppercase; }
.score-box .val { font-family: 'Orbitron'; font-size: 24px; font-weight: 900; color: var(--p); }

.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
#bigText { font-family: 'Orbitron'; font-size: 120px; font-weight: 900; transition: 0.1s; z-index: 5; }
#subText { font-family: 'Orbitron'; font-size: 22px; font-weight: 700; letter-spacing: 4px; margin-top: 20px; }

.flash { background: white !important; }
.flash #bigText { color: black !important; }
.flash #subText { color: #333 !important; }

/* 7- ŞAMPİYON EKRANI */
.winner-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95);
    display: none; flex-direction: column; justify-content: center;
    align-items: center; z-index: 3000; animation: fadeIn 0.5s;
}
.winner-card {
    padding: 50px; border-radius: 40px; border: 4px solid var(--a);
    text-align: center; background: radial-gradient(circle, #1e293b, #020408);
    box-shadow: 0 0 100px rgba(255, 138, 0, 0.5);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.penalty { color: var(--danger) !important; animation: shake 0.3s infinite; }
@keyframes shake { 0%, 100% { transform: translate(0); } 25% { transform: translate(-10px); } 75% { transform: translate(10px); } }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">ELITE ARENA</div>
    <div class="right-menu" style="display:flex; gap:12px;">
        <div class="nav-box" id="userBox" style="font-family:'Orbitron'">...</div>
        <button id="leaveBtn" style="display:none; background:var(--danger); border:none; color:white; padding:10px 18px; border-radius:12px; font-weight:900; cursor:pointer; font-size:12px;">EXIT</button>
    </div>
</div>

<div id="lobby">
    <div class="lobby-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h3>Global Duel List</h3>
        <button class="create-btn" onclick="openModal()">+ NEW ROOM</button>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div class="score-box">
            <div class="name" id="p1Name">PLAYER 1</div>
            <div class="val" id="p1Score">0</div>
        </div>
        <div style="font-family:'Orbitron'; color:var(--a); font-weight:900; font-size:14px; padding:10px; border:1px solid var(--a); border-radius:8px;" id="roundNum">RD 1</div>
        <div class="score-box">
            <div class="name" id="p2Name">PLAYER 2</div>
            <div class="val" id="p2Score">0</div>
        </div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText"></div>
        <div id="subText">READY?</div>
    </div>
</div>

<div id="winnerOverlay" class="winner-overlay">
    <div class="winner-card">
        <div style="font-family:'Orbitron'; color:var(--a); font-size:20px; margin-bottom:10px;">ARENA CHAMPION</div>
        <div id="championName" style="font-family:'Orbitron'; font-size:45px; font-weight:900; color:white; text-shadow: 0 0 20px var(--a);">PLAYER</div>
        <div style="margin-top:30px; color:rgba(255,255,255,0.5); font-size:14px;">Redirecting to lobby...</div>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:'Orbitron'; color:var(--p); letter-spacing:2px;">SECURE ARENA</h2>
        <input type="text" id="roomPassInput" placeholder="ENCRYPT CODE (OPTIONAL)" maxlength="8">
        <div style="display:flex; gap:15px;">
            <button onclick="closeModal()" style="flex:1; padding:18px; border-radius:15px; background:#111; border:none; color:white; font-weight:800; cursor:pointer;">CANCEL</button>
            <button id="confirmCreateBtn" style="flex:1; padding:18px; border-radius:15px; background:var(--p); border:none; color:black; font-weight:900; font-family:'Orbitron'; cursor:pointer;">INITIALIZE</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, tapLock = false;
let countdownInterval = null;
let lastTapTime = 0;

// 1 & 2 - SES EFEKTLERİ (AUDIO SYNTH)
const playSound = (freq, type, duration) => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + duration);
};

const sounds = {
    tick: () => playSound(440, 'sine', 0.1),
    go: () => playSound(880, 'square', 0.3),
    win: () => {
        playSound(523, 'sine', 0.2);
        setTimeout(() => playSound(659, 'sine', 0.2), 150);
        setTimeout(() => playSound(783, 'sine', 0.4), 300);
    }
};

window.openModal = () => document.getElementById("createModal").style.display = "flex";
window.closeModal = () => document.getElementById("createModal").style.display = "none";

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid));
    username = snap.exists() ? snap.data().username : "Elite_Player";
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

function listenLobby() {
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.forEach(d => {
            const data = d.data();
            const isFull = data.player1 && data.player2;
            const div = document.createElement("div");
            div.className = "room-card";
            div.innerHTML = `
                <div class="room-info">
                    <div style="font-weight:800; font-size:16px;">${data.player1Name.toUpperCase()}</div>
                    <div style="font-size:10px; color:var(--p); margin-top:4px;">${data.password ? 'LOCKED ARENA' : 'OPEN DUEL'}</div>
                </div>
                <button style="padding:12px 25px; border-radius:12px; border:none; background:${isFull ? '#111' : 'var(--p)'}; color:${isFull ? '#444' : '#000'}; font-weight:900; font-family:'Orbitron';" 
                ${isFull ? 'disabled' : ''} onclick="joinRoom('${d.id}', ${data.password ? 'true' : 'false'})">JOIN</button>
            `;
            list.appendChild(div);
        });
    });
}

document.getElementById("confirmCreateBtn").onclick = async () => {
    const pass = document.getElementById("roomPassInput").value;
    const newRoomRef = doc(collection(db, "rooms"));
    currentRoomId = newRoomRef.id;
    await setDoc(newRoomRef, {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, 
        password: pass, createdAt: serverTimestamp(), spammer: null
    });
    closeModal();
    enterRoom();
};

window.joinRoom = async (id, isLocked) => {
    if (isLocked) {
        const pass = prompt("ENTER ACCESS CODE:");
        const snap = await getDoc(doc(db, "rooms", id));
        if (snap.data().password !== pass) { alert("ACCESS DENIED!"); return; }
    }
    currentRoomId = id;
    await updateDoc(doc(db, "rooms", id), { player2: uid, player2Name: username, state: "matched" });
    enterRoom();
};

function enterRoom() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    if (unsubRoom) unsubRoom();
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if (!snap.exists()) { quitGame(); return; }
        const d = snap.data();
        
        document.getElementById("p1Name").innerText = d.player1Name;
        document.getElementById("p1Score").innerText = d.score1;
        document.getElementById("p2Name").innerText = d.player2Name || "WAITING...";
        document.getElementById("p2Score").innerText = d.score2;
        document.getElementById("roundNum").innerText = `RD ${d.round}`;

        if (d.state === "matched" && uid === d.host) {
            setTimeout(() => {
                updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startTime: Date.now() + 4000 });
            }, 1000);
        }

        if (d.state === "countdown") {
            let lastVal = -1;
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((d.startTime - now) / 1000);
                if (diff > 0) {
                    if(lastVal !== diff) { sounds.tick(); lastVal = diff; }
                    document.getElementById("bigText").innerText = diff;
                    document.getElementById("subText").innerText = "GET READY";
                    document.getElementById("bigText").style.color = "white";
                } else {
                    clearInterval(countdownInterval);
                    if (uid === d.host) {
                        updateDoc(doc(db, "rooms", currentRoomId), { state: "active", roundStart: serverTimestamp(), spammer: null });
                    }
                }
            }, 100);
        }

        if (d.state === "active") {
            if (countdownInterval) clearInterval(countdownInterval);
            if(document.getElementById("bigText").innerText !== "GO!") sounds.go();
            document.getElementById("arena").classList.add("flash");
            document.getElementById("bigText").innerText = "GO!";
            document.getElementById("bigText").style.color = "black";
            document.getElementById("subText").innerText = "STRIKE NOW!";
        } else {
            document.getElementById("arena").classList.remove("flash");
        }

        if (d.state === "result") {
            document.getElementById("bigText").innerText = d.reaction || "WIN";
            document.getElementById("bigText").style.color = var(--win);
            document.getElementById("subText").innerText = d.lastWinner + " SCORED!";
            if (uid === d.host) {
                setTimeout(async () => {
                    if (d.score1 >= 5 || d.score2 >= 5) {
                        updateDoc(doc(db, "rooms", currentRoomId), { state: "finished" });
                    } else {
                        updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startTime: Date.now() + 3000, round: d.round + 1, spammer: null });
                    }
                }, 2000);
            }
        }

        if (d.state === "finished") {
            const winner = d.score1 >= 5 ? d.player1Name : d.player2Name;
            document.getElementById("championName").innerText = winner.toUpperCase();
            document.getElementById("winnerOverlay").style.display = "flex";
            sounds.win();
            setTimeout(quitGame, 5000);
        }
    });
}

document.getElementById("arena").addEventListener('pointerdown', async (e) => {
    e.preventDefault();
    if (tapLock || !currentRoomId) return;
    const now = Date.now();
    if (now - lastTapTime < 200) return;
    lastTapTime = now;

    const roomRef = doc(db, "rooms", currentRoomId);
    const snap = await getDoc(roomRef);
    const d = snap.data();

    if (d.state === "countdown") {
        await updateDoc(roomRef, { spammer: uid });
        return;
    }
    
    if (d.state !== "active" || d.spammer === uid) return;

    tapLock = true;
    const reaction = now - d.roundStart.toMillis();

    try {
        await runTransaction(db, async (transaction) => {
            const freshSnap = await transaction.get(roomRef);
            const freshData = freshSnap.data();
            if (freshData.state !== "active") return;
            const isP1 = uid === freshData.player1;
            transaction.update(roomRef, {
                state: "result",
                [isP1 ? "score1" : "score2"]: (isP1 ? freshData.score1 : freshData.score2) + 1,
                lastWinner: username,
                reaction: reaction + "ms"
            });
        });
    } catch (e) {}
    setTimeout(() => { tapLock = false; }, 1000);
}, { passive: false });

async function quitGame() {
    if (currentRoomId) {
        const ref = doc(db, "rooms", currentRoomId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const d = snap.data();
            if (!d.player2 || d.state === "finished") await deleteDoc(ref);
            else {
                const f = d.player1 === uid ? "player1" : "player2";
                await updateDoc(ref, { [f]: null, state: "finished" });
            }
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflex Duel Pro</title>

<style>
body{
margin:0;
font-family:Arial;
display:flex;
flex-direction:column;
height:100vh;
overflow:hidden;
color:white;
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b);
background-size:400% 400%;
animation:bg 6s infinite alternate ease-in-out;
touch-action:manipulation;
}
@keyframes bg{
0%{background-position:0% 50%}
100%{background-position:100% 50%}
}
.topbar{
width:100%;
padding:12px;
background:#000000aa;
display:flex;
justify-content:space-between;
font-weight:bold;
box-sizing:border-box;
}
#game{
flex:1;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
}
button{
padding:15px 30px;
border:none;
border-radius:8px;
font-weight:bold;
cursor:pointer;
font-size:16px;
}
#bigText{
font-size:90px;
margin-top:20px;
}
canvas{
position:fixed;
pointer-events:none;
top:0;
left:0;
}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="topbar">
<div id="p1">...</div>
<div id="roundInfo">Round 1 / 7</div>
<div id="p2">...</div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>
<div id="status"></div>
<div id="bigText"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc,
deleteDoc, onSnapshot,
collection, query, where, getDocs,
serverTimestamp, runTransaction, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, onAuthStateChanged, signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* AUDIO */
let audioCtx=null;
function unlockAudio(){
if(!audioCtx){
audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
if(audioCtx.state==="suspended") audioCtx.resume();
}
function beep(f,d){
unlockAudio();
const o=audioCtx.createOscillator();
const g=audioCtx.createGain();
o.type="square";
o.frequency.value=f;
g.gain.value=0.2;
o.connect(g);
g.connect(audioCtx.destination);
o.start();
o.stop(audioCtx.currentTime+d);
}
const countdownSound=()=>beep(700,0.12);
const goSound=()=>beep(1200,0.25);
const winSound=()=>beep(200,0.4);

/* GLOBALS */
let uid=null;
let username="Player";
let roomId=null;
let isHost=false;
let unsubscribe=null;
let tapLock=false;
let matchingLock=false;
let countdownInterval=null;

/* ELEMENTS */
const findBtn=document.getElementById("findBtn");
const bigText=document.getElementById("bigText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){ await signInAnonymously(auth); return; }
uid=user.uid;

const ref=doc(db,"users",uid);
const snap=await getDoc(ref);

if(snap.exists()){
username=snap.data().username;
}else{
username="Player_"+uid.substring(0,4);
await setDoc(ref,{username});
}
});

/* CLEAN OLD ROOMS */
async function cleanOldRooms(){
const q=query(collection(db,"rooms"),where("players","array-contains",uid));
const snap=await getDocs(q);
for(const r of snap.docs){
await deleteDoc(doc(db,"rooms",r.id));
}
}

/* MATCHMAKING */
findBtn.onclick=async()=>{
if(matchingLock) return;
matchingLock=true;

unlockAudio();
findBtn.style.display="none";

await cleanOldRooms();

const waitingQ=query(collection(db,"rooms"),where("state","==","waiting"));
const snap=await getDocs(waitingQ);

let joined=false;

for(const r of snap.docs){
const d=r.data();
if(d.player1===uid) continue;
if(d.player2) continue;

roomId=r.id;
isHost=false;

await updateDoc(doc(db,"rooms",roomId),{
player2:uid,
player2Name:username,
players:[d.player1,uid],
state:"countdown"
});

joined=true;
break;
}

if(!joined){
const newRoom=doc(collection(db,"rooms"));
roomId=newRoom.id;
isHost=true;

await setDoc(newRoom,{
player1:uid,
player1Name:username,
player2:null,
player2Name:null,
players:[uid],
score1:0,
score2:0,
round:1,
state:"waiting",
createdAt:serverTimestamp()
});
}

listenRoom();
matchingLock=false;
};

/* ROOM LISTENER */
function listenRoom(){

if(!roomId) return;

if(unsubscribe){
unsubscribe();
unsubscribe=null;
}

unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{

if(!snap.exists()){
reset();
return;
}

const d=snap.data();

// Eğer oyuncu odada değilse reset
if(!d.players || !d.players.includes(uid)){
await deleteDoc(doc(db,"rooms",roomId));
reset();
return;
}

p1.innerText=d.player1Name+" ("+d.score1+")";
p2.innerText=(d.player2Name||"...")+" ("+d.score2+")";
roundInfo.innerText="Round "+d.round+" / 7";

if(d.state==="waiting"){
bigText.innerText="Rakip Bekleniyor...";
}

else if(d.state==="countdown"){

if(isHost && d.player2 && !d.startAt){
await updateDoc(doc(db,"rooms",roomId),{
startAt:Date.now()+3000
});
return;
}

if(d.startAt){
clearInterval(countdownInterval);

countdownInterval=setInterval(()=>{
const diff=d.startAt-Date.now();
const sec=Math.ceil(diff/1000);

if(sec>0){
bigText.innerText=sec;
countdownSound();
}else{
bigText.innerText="GO!";
goSound();
}

if(diff<=0){
clearInterval(countdownInterval);
if(isHost){
updateDoc(doc(db,"rooms",roomId),{state:"active"});
}
}
},1000);
}
}

else if(d.state==="active"){
bigText.innerText="TAP!";
}

else if(d.state==="result"){

if(d.score1===4 || d.score2===4){

const winner=d.score1===4?d.player1Name:d.player2Name;
bigText.innerText="Kazanan: "+winner;
winSound();
launchConfetti();

setTimeout(async()=>{
await deleteDoc(doc(db,"rooms",roomId));
reset();
},4000);

}else{

setTimeout(async()=>{
if(isHost){
await updateDoc(doc(db,"rooms",roomId),{
round:d.round+1,
state:"countdown",
startAt:null
});
}
},1500);
}
}
});
}

/* TAP */
async function tap(e){
e.preventDefault();
if(tapLock || !roomId) return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;
const d=snap.data();
if(d.state!=="active") return;

if(uid===d.player1){
t.update(ref,{score1:d.score1+1,state:"result"});
}else if(uid===d.player2){
t.update(ref,{score2:d.score2+1,state:"result"});
}
});

tapLock=false;
}

document.addEventListener("pointerdown",tap,{passive:false});

/* CONFETTI */
const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
let pieces=[];

function launchConfetti(){
for(let i=0;i<200;i++){
pieces.push({
x:Math.random()*canvas.width,
y:-20,
r:Math.random()*6+4,
d:Math.random()*5+2
});
}
animate();
}

function animate(){
ctx.clearRect(0,0,canvas.width,canvas.height);
pieces.forEach(p=>{
p.y+=p.d;
ctx.beginPath();
ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
ctx.fillStyle="hsl("+Math.random()*360+",100%,50%)";
ctx.fill();
});
pieces=pieces.filter(p=>p.y<canvas.height);
if(pieces.length>0)requestAnimationFrame(animate);
}

/* RESET */
function reset(){
if(unsubscribe){
unsubscribe();
unsubscribe=null;
}
roomId=null;
bigText.innerText="";
findBtn.style.display="block";
clearInterval(countdownInterval);
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{
background:#0b0f1a;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
}

body::before{
content:"";
position:fixed;
left:0;top:0;height:100%;width:25%;
background:linear-gradient(to right,rgba(255,0,0,0.25),transparent);
pointer-events:none;
}
body::after{
content:"";
position:fixed;
right:0;top:0;height:100%;width:25%;
background:linear-gradient(to left,rgba(0,120,255,0.25),transparent);
pointer-events:none;
}

.topbar{
position:fixed;
top:0;
left:0;
width:100%;
height:70px;
background:rgba(0,0,0,0.6);
display:flex;
align-items:center;
justify-content:space-between;
padding:0 20px;
z-index:20;
}

.player{
display:flex;
flex-direction:column;
font-weight:bold;
}

.red{color:#ff4b4b;}
.blue{color:#3fa9ff;}

.middle{
font-size:18px;
font-weight:bold;
}

.menu{
position:fixed;
top:20%;
left:50%;
transform:translateX(-50%);
z-index:10;
}

.menu button{
padding:15px 30px;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
font-size:16px;
background:#ff4b4b;
color:white;
}

.hidden{display:none}

.center{
flex:1;
display:flex;
align-items:center;
justify-content:center;
flex-direction:column;
position:relative;
pointer-events:none;
margin-top:70px;
}

.tap-text{
font-size:70px;
font-weight:900;
}

#countdown{
position:absolute;
font-size:120px;
font-weight:900;
opacity:0;
}

@keyframes pop {
0%{transform:scale(.5);opacity:0}
50%{transform:scale(1.3);opacity:1}
100%{transform:scale(1);opacity:1}
}

.countAnim{
animation:pop .4s ease;
}
</style>
</head>
<body>

<div class="menu" id="menu">
<button id="findMatch">Maç Bul</button>
</div>

<div class="topbar hidden" id="topbar">
<div class="player red">
<div id="myName">You</div>
<div>Skor: <span id="myScore">0</span></div>
</div>

<div class="middle">
<div id="roundInfo">Round 1 / 7</div>
</div>

<div class="player blue">
<div id="oppName">Opponent</div>
<div>Skor: <span id="oppScore">0</span></div>
</div>
</div>

<div class="center hidden" id="arena">
<div id="countdown"></div>
<div class="tap-text" id="mainText">Bekleniyor...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc, onSnapshot,
serverTimestamp, collection, query, limit,
getDocs, deleteDoc, where, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, onAuthStateChanged, signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid=null;
let username=null;
let roomId=null;
let isHost=false;
let localTapped=false;

/* AUTH + USERS COLLECTION */
onAuthStateChanged(auth, async(user)=>{
if(!user){
await signInAnonymously(auth);
}else{
uid=user.uid;

const userRef=doc(db,"users",uid);
const snap=await getDoc(userRef);

if(!snap.exists()){
username="Player_"+uid.slice(0,4);
await setDoc(userRef,{
username,
createdAt:serverTimestamp()
});
}else{
username=snap.data().username;
}
}
});

/* MATCHMAKING */
document.getElementById("findMatch").onclick = async ()=>{

const queueRef = collection(db,"matchmakingQueue");
const snap = await getDocs(query(queueRef, where("uid","!=",uid), limit(1)));

if(!snap.empty){

const opp=snap.docs[0];
const oppUser=await getDoc(doc(db,"users",opp.data().uid));

roomId=crypto.randomUUID();
isHost=true;

await setDoc(doc(db,"rooms",roomId),{
player1:uid,
player2:opp.data().uid,
p1Name:username,
p2Name:oppUser.data().username,
round:1,
p1:0,
p2:0,
state:"countdown",
tapWinner:null,
count:3,
createdAt:serverTimestamp()
});

await deleteDoc(doc(db,"matchmakingQueue",opp.id));
await deleteDoc(doc(db,"matchmakingQueue",uid));

startGame();
listenRoom();
startCountdown();

}else{
await setDoc(doc(db,"matchmakingQueue",uid),{uid});
listenForMatch();
alert("Rakip bekleniyor...");
}
};

function listenForMatch(){
onSnapshot(query(collection(db,"rooms"), where("player2","==",uid)),
(s)=>{
if(!s.empty){
roomId=s.docs[0].id;
startGame();
listenRoom();
}
});
}

function listenRoom(){
onSnapshot(doc(db,"rooms",roomId),(snap)=>{
if(!snap.exists()) return;
updateUI(snap.data());
});
}

async function startCountdown(){
if(!isHost) return;

let count=3;
const interval=setInterval(async()=>{
await updateDoc(doc(db,"rooms",roomId),{count});
count--;

if(count<0){
clearInterval(interval);
await updateDoc(doc(db,"rooms",roomId),{state:"delay"});

const delay=1000+Math.random()*2000;

setTimeout(async()=>{
await updateDoc(doc(db,"rooms",roomId),{
state:"active",
tapWinner:null
});
},delay);
}

},1000);
}

async function tap(){
if(localTapped) return;
localTapped=true;

const ref=doc(db,"rooms",roomId);
const snap=await getDoc(ref);
const data=snap.data();
if(!data) return;

if(data.state!=="active"){
document.getElementById("mainText").innerText="ERKEN!";
localTapped=false;
return;
}

if(!data.tapWinner){
await updateDoc(ref,{tapWinner:uid});
}
}

function updateUI(data){

document.getElementById("myName").innerText =
uid===data.player1?data.p1Name:data.p2Name;

document.getElementById("oppName").innerText =
uid===data.player1?data.p2Name:data.p1Name;

document.getElementById("myScore").innerText =
uid===data.player1?data.p1:data.p2;

document.getElementById("oppScore").innerText =
uid===data.player1?data.p2:data.p1;

document.getElementById("roundInfo").innerText =
"Round "+data.round+" / 7";

if(data.count!==undefined){
const el=document.getElementById("countdown");
el.innerText=data.count>0?data.count:"GO!";
el.style.opacity=1;
el.classList.remove("countAnim");
void el.offsetWidth;
el.classList.add("countAnim");
setTimeout(()=>{el.style.opacity=0},600);
}

if(data.state==="delay"){
document.getElementById("mainText").innerText="Hazır Ol...";
localTapped=false;
}

if(data.state==="active"){
document.getElementById("mainText").innerText="TAP!";
}

if(data.tapWinner){
const win=data.tapWinner===uid;
document.getElementById("mainText").innerText=win?"Kazandın!":"Kaybettin!";

setTimeout(async()=>{
if(isHost){
let p1=data.p1;
let p2=data.p2;
if(data.tapWinner===data.player1) p1++;
else p2++;

if(p1===4||p2===4){
await updateDoc(doc(db,"rooms",roomId),{state:"finished"});
}else{
await updateDoc(doc(db,"rooms",roomId),{
p1,p2,
round:data.round+1,
state:"countdown",
tapWinner:null,
count:3
});
startCountdown();
}
}
localTapped=false;
},1500);
}

if(data.state==="finished"){
document.getElementById("mainText").innerText="MAÇ BİTTİ!";
}
}

function startGame(){
document.getElementById("menu").style.display="none";
document.getElementById("arena").classList.remove("hidden");
document.getElementById("topbar").classList.remove("hidden");
}

document.addEventListener("touchstart",tap);
document.addEventListener("mousedown",tap);
document.addEventListener("keydown",(e)=>{
if(e.code==="Space") tap();
});
</script>
</body>
</html>

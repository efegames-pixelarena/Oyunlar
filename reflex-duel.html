<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{
background:#0b0f1a;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
}
body::before{
content:"";
position:fixed;
left:0;top:0;height:100%;width:25%;
background:linear-gradient(to right,rgba(255,0,0,0.25),transparent);
pointer-events:none;
}
body::after{
content:"";
position:fixed;
right:0;top:0;height:100%;width:25%;
background:linear-gradient(to left,rgba(0,120,255,0.25),transparent);
pointer-events:none;
}
.menu{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
text-align:center;
}
.menu button{
padding:15px 25px;
margin:10px;
border:none;
border-radius:12px;
font-weight:bold;
cursor:pointer;
font-size:15px;
}
.btn-red{background:#ff4b4b;color:white}
.hidden{display:none}
.center{
flex:1;
display:flex;
align-items:center;
justify-content:center;
flex-direction:column;
}
.tap-text{
font-size:70px;
font-weight:900;
}
</style>
</head>
<body>

<div class="menu" id="menu">
<button class="btn-red" id="findMatch">Ma√ß Bul</button>
</div>

<div class="center hidden" id="arena">
<div class="tap-text" id="mainText">Bekleniyor...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,
doc,
setDoc,
onSnapshot,
serverTimestamp,
collection,
query,
limit,
getDocs,
deleteDoc,
where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getAuth,
onAuthStateChanged,
signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* CONFIG */
const firebaseConfig = {
  apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
  authDomain:"emirhan-site.firebaseapp.com",
  projectId:"emirhan-site",
  storageBucket:"emirhan-site.firebasestorage.app",
  messagingSenderId:"668871888390",
  appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let unsubscribeRoom = null;

/* AUTH */
onAuthStateChanged(auth, async (user)=>{
if(!user){
await signInAnonymously(auth);
}
});

/* MATCHMAKING */
document.getElementById("findMatch").onclick = async ()=>{

if(!auth.currentUser){
alert("Auth y√ºkleniyor, tekrar dene.");
return;
}

const uid = auth.currentUser.uid;
const queueRef = collection(db,"matchmakingQueue");

/* üî• KENDƒ∞Nƒ∞ HARƒ∞√á TUT */
const snap = await getDocs(
query(queueRef, where("uid","!=",uid), limit(1))
);

if(!snap.empty){

const opponentData = snap.docs[0];
const opponentId = opponentData.data().uid;
const roomId = crypto.randomUUID();

/* ROOM OLU≈ûTUR */
await setDoc(doc(db,"rooms",roomId),{
player1:uid,
player2:opponentId,
status:"active",
createdAt:serverTimestamp()
});

/* ƒ∞Kƒ∞Sƒ∞Nƒ∞ DE QUEUE'DAN Sƒ∞L */
await deleteDoc(doc(db,"matchmakingQueue",uid));
await deleteDoc(doc(db,"matchmakingQueue",opponentData.id));

listenRoom(roomId);
startGame();

}else{

/* QUEUE'YA EKLE */
await setDoc(doc(db,"matchmakingQueue",uid),{
uid:uid,
createdAt:serverTimestamp()
});

/* ODA Dƒ∞NLER */
listenForMatch(uid);

alert("Rakip bekleniyor...");
}
};

/* RAKƒ∞P GELƒ∞NCE OTOMATƒ∞K BA≈ûLAT */
function listenForMatch(uid){

const roomsRef = collection(db,"rooms");

unsubscribeRoom = onSnapshot(
query(roomsRef, where("player2","==",uid)),
(snapshot)=>{
if(!snapshot.empty){
const roomId = snapshot.docs[0].id;
listenRoom(roomId);
startGame();
}
});
}

function listenRoom(roomId){

unsubscribeRoom = onSnapshot(doc(db,"rooms",roomId),(docSnap)=>{
if(docSnap.exists()){
console.log("Oda g√ºncellendi:",docSnap.data());
}
});
}

/* UI */
function startGame(){
document.getElementById("menu").classList.add("hidden");
document.getElementById("arena").classList.remove("hidden");
document.getElementById("mainText").innerText="E≈üle≈üme Ba≈üladƒ±!";
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}

body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b);
background-size:400% 400%;
animation:bg 6s infinite alternate ease-in-out;
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
touch-action:manipulation;
}

@keyframes bg{
0%{background-position:0% 50%}
100%{background-position:100% 50%}
}

/* TOP BAR */
.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}

.brand{font-size:clamp(14px,2vw,18px);font-weight:800;}

.right-menu{display:flex;gap:10px;align-items:center;}

.nav-box{
padding:6px 14px;
border-radius:14px;
font-weight:700;
font-size:clamp(11px,2vw,13px);
background:#273c8f;
min-width:70px;
text-align:center;
}

.btn{
padding:6px 12px;
border-radius:12px;
border:none;
cursor:pointer;
font-weight:700;
font-size:clamp(11px,2vw,13px);
}

.logout-btn{background:#ff3b3b;color:white;}

/* SCOREBOARD */
.scoreboard{
margin-top:55px;
width:100%;
background:rgba(0,0,0,0.5);
display:flex;
justify-content:space-between;
align-items:center;
padding:8px 14px;
font-weight:bold;
font-size:clamp(12px,2.5vw,14px);
}

/* GAME */
#game{
flex:1;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
padding:10px;
}

button{
padding:10px 18px;
border:none;
border-radius:8px;
font-weight:bold;
cursor:pointer;
font-size:clamp(12px,2.5vw,15px);
background:linear-gradient(90deg,#ffb300,#ff8c00);
margin-top:10px;
}

#bigText{
font-size:clamp(32px,10vw,70px);
min-height:90px;
margin-top:20px;
font-weight:800;
transition:0.3s;
}

.neonRed{
color:#ff0000;
text-shadow:0 0 5px #ff0000,0 0 15px #ff0000,0 0 30px #ff0000;
animation:pulse 1s infinite;
}

@keyframes pulse{
0%{opacity:1}
50%{opacity:0.6}
100%{opacity:1}
}

.reaction{
font-size:18px;
margin-top:10px;
opacity:0.9;
}

canvas{
position:fixed;
pointer-events:none;
top:0;
left:0;
}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="btn logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard">
<div id="p1">Player1 (0)</div>
<div id="roundInfo">Round 1 / 7</div>
<div id="p2">Player2 (0)</div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>
<div id="bigText"></div>
<div id="reactionText" class="reaction"></div>
</div>

<canvas id="fx"></canvas>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, updateDoc, deleteDoc,
onSnapshot, collection, query, where, getDocs,
serverTimestamp, runTransaction, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* GLOBAL */
let uid=null;
let username=null;
let roomId=null;
let unsubscribe=null;
let tapLock=false;
let startMs=0;

/* ELEMENTS */
const bigText=document.getElementById("bigText");
const reactionText=document.getElementById("reactionText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");
const findBtn=document.getElementById("findBtn");

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){ location.href="index.html"; return; }
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
document.getElementById("userBox").innerText=username;
});

/* MATCH */
findBtn.onclick=async()=>{
bigText.innerText="Eşleşme aranıyor...";
await runTransaction(db,async(t)=>{
const qRef=collection(db,"queue");
const qSnap=await getDocs(qRef);
let opponent=null;
qSnap.forEach(d=>{ if(d.data().uid!==uid&&!opponent) opponent=d; });
if(opponent){
const roomRef=doc(collection(db,"rooms"));
t.set(roomRef,{
player1:opponent.data().uid,
player1Name:opponent.data().username,
player2:uid,
player2Name:username,
players:[opponent.data().uid,uid],
score1:0,score2:0,
round:1,
state:"countdown",
startAt:Date.now()+10000,
lastWinner:null
});
t.delete(opponent.ref);
roomId=roomRef.id;
}else{
const myQ=doc(collection(db,"queue"));
t.set(myQ,{uid,username,createdAt:serverTimestamp()});
}
});
listenRooms();
};

function listenRooms(){
onSnapshot(collection(db,"rooms"),snap=>{
snap.forEach(docu=>{
if(docu.data().players.includes(uid)){
roomId=docu.id;
listenRoom();
}
});
});
}

function listenRoom(){
if(unsubscribe) unsubscribe();
unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()) return;
const d=snap.data();

p1.innerText=d.player1Name+" ("+d.score1+")";
p2.innerText=d.player2Name+" ("+d.score2+")";
roundInfo.innerText="Round "+d.round+" / 7";

/* 10 Saniye Countdown */
if(d.state==="countdown"){
const diff=d.startAt-Date.now();
if(diff>0){
bigText.innerText=Math.ceil(diff/1000);
}else{
bigText.innerText="HAZIR OL";
setTimeout(()=>{
updateDoc(doc(db,"rooms",roomId),{
state:"active",
activeStart:Date.now()
});
},3000);
}
}

/* ACTIVE */
if(d.state==="active"){
bigText.innerText="TAP!";
startMs=d.activeStart;
}

/* RESULT */
if(d.state==="result"){
bigText.classList.add("neonRed");
bigText.innerText=d.lastWinner;
reactionText.innerHTML="Raund "+(d.round+1)+" kalan süre 5 saniye";

confettiEffect();

setTimeout(async()=>{
bigText.classList.remove("neonRed");
reactionText.innerHTML="";
if(d.score1===4||d.score2===4){
await deleteDoc(doc(db,"rooms",roomId));
}else{
await updateDoc(doc(db,"rooms",roomId),{
round:d.round+1,
state:"countdown",
startAt:Date.now()+10000
});
}
},5000);
}

});
}

/* TAP */
document.addEventListener("pointerdown",async()=>{
if(tapLock||!roomId) return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;
const d=snap.data();
if(d.state!=="active") return;

const reaction=Date.now()-d.activeStart;

if(uid===d.player1){
t.update(ref,{
score1:d.score1+1,
state:"result",
lastWinner:d.player1Name+" ("+reaction+"ms)"
});
}else{
t.update(ref,{
score2:d.score2+1,
state:"result",
lastWinner:d.player2Name+" ("+reaction+"ms)"
});
}
});

tapLock=false;
});

/* CONFETTI */
const canvas=document.getElementById("fx");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

function confettiEffect(){
for(let i=0;i<120;i++){
const x=Math.random()*canvas.width;
const y=Math.random()*canvas.height;
ctx.fillStyle="hsl("+Math.random()*360+",100%,50%)";
ctx.fillRect(x,y,5,5);
}
setTimeout(()=>ctx.clearRect(0,0,canvas.width,canvas.height),800);
}

</script>
</body>
</html>

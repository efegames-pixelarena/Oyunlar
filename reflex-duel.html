<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel | Lobby</title>

<style>
:root { --p: #4fd1ff; --a: #ff8a00; --bg: #03050a; --b: #1e2642; }
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color:transparent; }
body { background: var(--bg); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

/* SKYCRASH BAR */
.top-bar { height: 60px; background: rgba(10,15,30,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid var(--b); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
.brand { font-weight: 900; background: linear-gradient(90deg, var(--p), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.nav-box { padding: 6px 12px; border-radius: 10px; background: #1a2248; border: 1px solid rgba(79,209,255,0.2); color: var(--p); font-size: 12px; font-weight: 800; }

/* LOBBY VIEW */
#lobby { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
.lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.create-btn { padding: 12px 24px; background: var(--a); color: #000; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; }

.room-card { 
    background: #0f172a; border: 1px solid var(--b); padding: 15px; border-radius: 15px; 
    margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
    transition: 0.3s;
}
.room-card:hover { border-color: var(--p); transform: translateY(-2px); }
.room-info h4 { font-size: 14px; margin-bottom: 4px; }
.room-info span { font-size: 11px; opacity: 0.6; }
.join-btn { padding: 8px 16px; background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: 800; font-size: 12px; cursor: pointer; }
.join-btn:disabled { background: #333; color: #777; }

/* GAME VIEW */
#game-view { display: none; flex: 1; flex-direction: column; position: relative; }
.scoreboard { background: rgba(0,0,0,0.5); padding: 15px; border-bottom: 1px solid var(--b); display: flex; justify-content: space-between; font-weight: 900; font-size: 14px; }
.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
#bigText { font-size: 80px; font-weight: 900; margin-bottom: 10px; }
#subText { font-size: 18px; color: var(--p); }

.flash { background: white !important; }
.flash #bigText { color: black; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">REFLEX DUEL</div>
    <div class="right-menu" style="display:flex; gap:10px;">
        <div class="nav-box" id="userBox">...</div>
        <button id="leaveBtn" style="display:none; background:#ff2a4d; border:none; color:white; padding:5px 10px; border-radius:8px; font-weight:800; cursor:pointer;">AYRIL</button>
    </div>
</div>

<div id="lobby">
    <div class="lobby-header">
        <h3>Aktif Odalar</h3>
        <button class="create-btn" id="createRoomBtn">ODA KUR</button>
    </div>
    <div id="roomList">
        </div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div id="p1Name">OYUNCU 1 (0)</div>
        <div id="roundNum" style="color:var(--a)">ROUND 1</div>
        <div id="p2Name">OYUNCU 2 (0)</div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText"></div>
        <div id="subText"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, tapLock = false;

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid));
    username = snap.exists() ? snap.data().username : "Player";
    document.getElementById("userBox").innerText = username;
    listenLobby();
});

// LOBİ DİNLEME
function listenLobby() {
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        if (snap.empty) list.innerHTML = "<p style='opacity:0.5; text-align:center; margin-top:50px;'>Aktif oda bulunamadı. İlk odayı sen kur!</p>";
        
        snap.forEach(d => {
            const data = d.data();
            // Otomatik Silme: Eğer odada kimse yoksa (Bu mantık server-side olmalı ama client-side temizlik ekliyoruz)
            if(!data.player1 && !data.player2) {
                deleteDoc(doc(db, "rooms", d.id));
                return;
            }

            const isFull = data.player1 && data.player2;
            const div = document.createElement("div");
            div.className = "room-card";
            div.innerHTML = `
                <div class="room-info">
                    <h4>${data.player1Name}'in Odası</h4>
                    <span>Durum: ${isFull ? 'Dolu' : 'Bekleniyor'} (${isFull ? '2/2' : '1/2'})</span>
                </div>
                <button class="join-btn" ${isFull ? 'disabled' : ''} onclick="joinRoom('${d.id}')">KATIL</button>
            `;
            list.appendChild(div);
        });
    });
}

// ODA KURMA
document.getElementById("createRoomBtn").onclick = async () => {
    const newRoomRef = doc(collection(db, "rooms"));
    currentRoomId = newRoomRef.id;
    await setDoc(newRoomRef, {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, createdAt: serverTimestamp()
    });
    enterRoom();
};

// ODAYA KATILMA
window.joinRoom = async (id) => {
    currentRoomId = id;
    await updateDoc(doc(db, "rooms", id), {
        player2: uid, player2Name: username, state: "matched"
    });
    enterRoom();
};

function enterRoom() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    if (unsubRoom) unsubRoom();
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if (!snap.exists()) { quitGame(); return; }
        const d = snap.data();
        
        document.getElementById("p1Name").innerText = `${d.player1Name} (${d.score1})`;
        document.getElementById("p2Name").innerText = `${d.player2Name || '...'} (${d.score2})`;
        document.getElementById("roundNum").innerText = `ROUND ${d.round}`;

        if (d.state === "matched" && uid === d.host) {
            setTimeout(() => updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startAt: Date.now() + 3000 }), 1000);
        }

        if (d.state === "countdown") {
            const diff = Math.ceil((d.startAt - Date.now()) / 1000);
            document.getElementById("bigText").innerText = diff > 0 ? diff : "!!!";
        }

        if (d.state === "active") {
            document.getElementById("arena").classList.add("flash");
            document.getElementById("bigText").innerText = "DOKUN!";
        } else {
            document.getElementById("arena").classList.remove("flash");
        }

        if (d.state === "result") {
            document.getElementById("bigText").innerText = d.reaction;
            document.getElementById("subText").innerText = d.lastWinner + " kazandı!";
            if (uid === d.host) {
                setTimeout(() => {
                    if (d.score1 >= 4 || d.score2 >= 4) updateDoc(doc(db, "rooms", currentRoomId), { state: "finished" });
                    else updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startAt: Date.now() + 3000, round: d.round + 1 });
                }, 2000);
            }
        }

        if (d.state === "finished") {
            document.getElementById("bigText").innerText = "GG!";
            document.getElementById("subText").innerText = "Kazanan: " + (d.score1 >= 4 ? d.player1Name : d.player2Name);
            setTimeout(quitGame, 4000);
        }
    });
}

// TAP SİSTEMİ
document.getElementById("arena").onpointerdown = async () => {
    if (tapLock || !currentRoomId) return;
    const snap = await getDoc(doc(db, "rooms", currentRoomId));
    const d = snap.data();
    if (d.state !== "active") return;

    tapLock = true;
    const reaction = Date.now() - d.roundStart?.toMillis() || 0;
    const isP1 = uid === d.player1;

    await updateDoc(doc(db, "rooms", currentRoomId), {
        [isP1 ? "score1" : "score2"]: (isP1 ? d.score1 : d.score2) + 1,
        state: "result", lastWinner: username, reaction: reaction + "ms"
    });
    setTimeout(() => tapLock = false, 1000);
};

// AYRILMA VE OTOMATİK SİLME
async function quitGame() {
    if (currentRoomId) {
        const ref = doc(db, "rooms", currentRoomId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const d = snap.data();
            // Eğer odada sadece ben varsam veya oda zaten bittiyse sil
            if ((d.player1 === uid && !d.player2) || d.state === "finished") {
                await deleteDoc(ref);
            } else {
                // Rakip hala içerideyse oyuncu bilgisini temizle
                const update = d.player1 === uid ? { player1: null, player1Name: "Ayrıldı" } : { player2: null, player2Name: "Ayrıldı" };
                await updateDoc(ref, update);
            }
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;

</script>
</body>
</html>

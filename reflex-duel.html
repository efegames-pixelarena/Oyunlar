<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}

body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
background-size:600% 600%;
animation:bg 4s infinite alternate ease-in-out;
color:white;overflow:hidden;display:flex;flex-direction:column;height:100vh;
}
@keyframes bg{0%{background-position:0% 50%}100%{background-position:100% 50%}}

.top-bar{
position:fixed;top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;background:linear-gradient(135deg,#1a2a6c,#16245c);
z-index:1000;
}

.brand{font-weight:800;font-size:18px;}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;background:#273c8f;}
.logout-btn{background:#ff3b3b;color:white;border:none;padding:6px 12px;border-radius:12px;}

/* PREMIUM SCOREBOARD */

.scoreboard{
margin-top:55px;
display:none;
flex-direction:column;
font-weight:bold;
}

.score-top{
display:flex;
justify-content:space-between;
padding:10px 14px;
}

.p1Box{
background:linear-gradient(90deg,#001eff,#00c3ff);
padding:8px 14px;
border-radius:12px;
box-shadow:0 0 20px #001eff;
animation:bluePulse 2s infinite alternate;
}

.p2Box{
background:linear-gradient(90deg,#ff0000,#ff4d4d);
padding:8px 14px;
border-radius:12px;
box-shadow:0 0 20px #ff0000;
animation:redPulse 2s infinite alternate;
}

.roundBox{
background:#000;
padding:8px 14px;
border-radius:12px;
box-shadow:0 0 20px #000;
animation:darkPulse 1.5s infinite alternate;
}

@keyframes bluePulse{from{box-shadow:0 0 10px #001eff}to{box-shadow:0 0 30px #00c3ff}}
@keyframes redPulse{from{box-shadow:0 0 10px #ff0000}to{box-shadow:0 0 30px #ff4d4d}}
@keyframes darkPulse{from{box-shadow:0 0 5px #222}to{box-shadow:0 0 25px #000}}

#game{
flex:1;display:flex;flex-direction:column;
justify-content:center;align-items:center;text-align:center;padding:10px;
}

button{
padding:12px 20px;border:none;border-radius:10px;
font-weight:bold;cursor:pointer;
background:linear-gradient(90deg,#ffb300,#ff5500);
margin-top:10px;
}

#bigText{font-size:clamp(32px,10vw,70px);min-height:90px;margin-top:20px;font-weight:800;}
#subText{margin-top:10px;font-size:18px;}

</style>
</head>
<body>

<div class="top-bar">
<div class="brand">Reflex Duel</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div class="score-top">
<div id="p1" class="p1Box"></div>
<div id="roundInfo" class="roundBox"></div>
<div id="p2" class="p2Box"></div>
</div>
</div>

<div id="game">
<button id="findBtn">Maç Bul</button>
<div id="bigText"></div>
<div id="subText"></div>
<div id="afterMatch"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, updateDoc, deleteDoc,
onSnapshot, getDoc, setDoc,
runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={ apiKey:"...", authDomain:"...", projectId:"..." };
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,username,elo=1000,premium=false;
let roomId=null;
let ping=0;

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;

const ref=doc(db,"users",uid);
const snap=await getDoc(ref);

if(!snap.exists()){
await setDoc(ref,{username:"Player",elo:1000,premium:false});
username="Player";
}else{
const d=snap.data();
username=d.username||"Player";
elo=d.elo||1000;
premium=d.premium||false;
}

document.getElementById("userBox").innerText=username+" ("+elo+")";
});

/* GLOBAL QUEUE */
document.getElementById("findBtn").onclick=async()=>{
document.getElementById("bigText").innerText="Global Queue...";

await runTransaction(db,async(t)=>{
const qRef=doc(db,"queue","global");
const snap=await t.get(qRef);

if(!snap.exists()){
t.set(qRef,{waiting:uid,premiumWaiting:premium});
return;
}

const d=snap.data();

if(d.waiting && d.waiting!==uid){
roomId=crypto.randomUUID();
t.set(doc(db,"rooms",roomId),{
p1:d.waiting,
p2:uid,
score1:0,
score2:0,
round:1,
state:"countdown",
startAt:Date.now()+3000,
elo1:elo,
elo2:elo
});
t.delete(qRef);
}else{
t.set(qRef,{waiting:uid,premiumWaiting:premium});
}
});

listenRoom();
};

/* ROOM LISTENER */
function listenRoom(){
if(!roomId) return;

onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()) return;
const d=snap.data();

document.getElementById("scoreboard").style.display="flex";
document.getElementById("p1").innerText="P1: "+d.score1;
document.getElementById("p2").innerText="P2: "+d.score2;
document.getElementById("roundInfo").innerText="Round "+d.round;

if(d.state==="countdown"){
let diff=d.startAt-Date.now();
if(diff<=0){
await updateDoc(doc(db,"rooms",roomId),{
state:"active",
roundStart:serverTimestamp()
});
}else{
document.getElementById("bigText").innerText=Math.ceil(diff/1000);
}
}

if(d.state==="active"){
document.getElementById("bigText").innerText="TAP!";
}

if(d.state==="result"){
document.getElementById("bigText").innerText=d.lastWinner+" Kazandı!";
}

});
}

/* TAP */
document.addEventListener("pointerdown",async()=>{
if(!roomId) return;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;

const d=snap.data();
if(d.state!=="active") return;

const reaction=Date.now()-d.roundStart.toMillis()-ping/2;

let winnerField=uid===d.p1?"score1":"score2";
let loserField=uid===d.p1?"score2":"score1";

t.update(ref,{
[winnerField]:d[winnerField]+1,
state:"result",
lastWinner:username,
reaction:reaction+" ms"
});
});
});
</script>

</body>
</html>

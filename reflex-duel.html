<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel | Elite Lobby</title>

<style>
:root { --p: #4fd1ff; --a: #ff8a00; --bg: #03050a; --b: #1e2642; --danger: #ff2a4d; --glass: rgba(15, 23, 42, 0.8); }
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color:transparent; }
body { background: radial-gradient(circle at top, #0f172a, #03050a); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

/* SKYCRASH BAR */
.top-bar { height: 60px; background: rgba(10,15,30,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid var(--b); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
.brand { font-weight: 900; background: linear-gradient(90deg, var(--p), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; }
.nav-box { padding: 6px 12px; border-radius: 10px; background: #1a2248; border: 1px solid rgba(79,209,255,0.2); color: var(--p); font-size: 11px; font-weight: 800; }

/* LOBBY VIEW */
#lobby { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
.lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.create-btn { padding: 12px 24px; background: var(--a); color: #000; border: none; border-radius: 14px; font-weight: 900; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(255, 138, 0, 0.3); }
.create-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 138, 0, 0.5); }

.room-card { 
    background: var(--glass); border: 1px solid var(--b); padding: 20px; border-radius: 20px; 
    margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
    backdrop-filter: blur(10px); transition: 0.3s;
}
.room-card:hover { border-color: var(--p); transform: scale(1.02); }
.room-info h4 { font-size: 16px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
.room-info span { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.05); }

/* MODAL DESIGN */
.modal { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content { 
    background: #0f172a; padding: 30px; border-radius: 24px; border: 1px solid var(--b);
    width: 90%; max-width: 350px; text-align: center;
}
.modal input { 
    width: 100%; padding: 12px; background: #1e2642; border: 1px solid var(--b); 
    border-radius: 12px; color: white; margin: 15px 0; text-align: center; outline: none;
}
.modal input:focus { border-color: var(--p); }

/* GAME VIEW */
#game-view { display: none; flex: 1; flex-direction: column; }
.scoreboard { background: rgba(0,0,0,0.4); padding: 20px; border-bottom: 1px solid var(--b); display: flex; justify-content: space-between; font-weight: 900; }
.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
#bigText { font-size: 80px; font-weight: 900; text-shadow: 0 0 20px rgba(79, 209, 255, 0.4); }
.flash { background: white !important; }
.flash #bigText { color: black !important; text-shadow: none; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">REFLEX DUEL</div>
    <div class="right-menu" style="display:flex; gap:10px;">
        <div class="nav-box" id="userBox">...</div>
        <button id="leaveBtn" style="display:none; background:var(--danger); border:none; color:white; padding:7px 14px; border-radius:8px; font-weight:800; cursor:pointer;">AYRIL</button>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--p)">Oda OluÅŸtur</h3>
        <p style="font-size:12px; margin-top:10px; opacity:0.7;">Åžifresiz bÄ±rakmak iÃ§in boÅŸ geÃ§in.</p>
        <input type="text" id="roomPassInput" placeholder="Oda Åžifresi (Opsiyonel)" maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#1e2642; color:white; font-weight:800;">Ä°PTAL</button>
            <button id="confirmCreateBtn" style="flex:1; padding:12px; border-radius:12px; border:none; background:var(--p); color:black; font-weight:900;">KUR</button>
        </div>
    </div>
</div>

<div id="lobby">
    <div class="lobby-header">
        <h3>SavaÅŸ AlanÄ±</h3>
        <button class="create-btn" onclick="openModal()">ODA KUR</button>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div id="p1Name">...</div>
        <div id="roundNum" style="color:var(--a)">RD 1</div>
        <div id="p2Name">...</div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText"></div>
        <div id="subText"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, tapLock = false;

// Modal FonksiyonlarÄ±
window.openModal = () => document.getElementById("createModal").style.display = "flex";
window.closeModal = () => document.getElementById("createModal").style.display = "none";

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid));
    username = snap.exists() ? snap.data().username : "Player";
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

function listenLobby() {
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.forEach(d => {
            const data = d.data();
            if (!data.player1) { deleteDoc(doc(db, "rooms", d.id)); return; }

            const isLocked = data.password && data.password !== "";
            const isFull = data.player1 && data.player2;
            
            const div = document.createElement("div");
            div.className = "room-card";
            div.innerHTML = `
                <div class="room-info">
                    <h4>${isLocked ? 'ðŸ”’ ' : ''}${data.player1Name}'s Duel</h4>
                    <span style="color:${isFull ? 'var(--p)' : 'var(--a)'}">${isFull ? 'MAÃ‡ BAÅžLADI' : 'BEKLENÄ°YOR'}</span>
                </div>
                <button class="join-btn" style="padding:10px 20px; border-radius:12px; border:none; background:${isFull ? '#1e2642':'var(--p)'}; color:${isFull ? '#555':'#000'}; font-weight:900;" 
                ${isFull ? 'disabled' : ''} onclick="joinRoom('${d.id}', ${isLocked})">KATIL</button>
            `;
            list.appendChild(div);
        });
    });
}

document.getElementById("confirmCreateBtn").onclick = async () => {
    const pass = document.getElementById("roomPassInput").value;
    const newRoomRef = doc(collection(db, "rooms"));
    currentRoomId = newRoomRef.id;
    await setDoc(newRoomRef, {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, 
        password: pass, createdAt: serverTimestamp()
    });
    closeModal();
    enterRoom();
};

window.joinRoom = async (id, isLocked) => {
    if (isLocked) {
        const userPass = prompt("Bu oda ÅŸifrelidir. Åžifreyi girin:");
        const snap = await getDoc(doc(db, "rooms", id));
        if (snap.data().password !== userPass) { alert("HatalÄ± ÅŸifre!"); return; }
    }
    currentRoomId = id;
    await updateDoc(doc(db, "rooms", id), { player2: uid, player2Name: username, state: "matched" });
    enterRoom();
};

function enterRoom() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    if (unsubRoom) unsubRoom();
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if (!snap.exists()) { quitGame(); return; }
        const d = snap.data();
        
        document.getElementById("p1Name").innerText = `${d.player1Name} (${d.score1})`;
        document.getElementById("p2Name").innerText = `${d.player2Name || '...'} (${d.score2})`;
        document.getElementById("roundNum").innerText = `RD ${d.round}`;

        if (d.state === "matched" && uid === d.host) {
            setTimeout(() => updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startAt: Date.now() + 3500 }), 1000);
        }

        if (d.state === "countdown") {
            const diff = Math.ceil((d.startAt - Date.now()) / 1000);
            document.getElementById("bigText").innerText = diff > 0 ? diff : "!!!";
            document.getElementById("subText").innerText = "HAZIR OL";
        }

        if (d.state === "active") {
            document.getElementById("arena").classList.add("flash");
            document.getElementById("bigText").innerText = "TAP!";
        } else {
            document.getElementById("arena").classList.remove("flash");
        }

        if (d.state === "result") {
            document.getElementById("bigText").innerText = d.reaction || "0ms";
            document.getElementById("subText").innerText = d.lastWinner + " KAZANDI";
            if (uid === d.host) {
                setTimeout(async () => {
                    if (d.score1 >= 4 || d.score2 >= 4) updateDoc(doc(db, "rooms", currentRoomId), { state: "finished" });
                    else updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startAt: Date.now() + 3000, round: d.round + 1 });
                }, 2000);
            }
        }

        if (d.state === "finished") {
            document.getElementById("bigText").innerText = "BÄ°TTÄ°";
            document.getElementById("subText").innerText = (d.score1 >= 4 ? d.player1Name : d.player2Name) + " ÅžAMPÄ°YON!";
            setTimeout(quitGame, 4000);
        }
    });
}

document.getElementById("arena").onpointerdown = async () => {
    if (tapLock || !currentRoomId) return;
    const snap = await getDoc(doc(db, "rooms", currentRoomId));
    const d = snap.data();
    if (d.state !== "active" || !d.roundStart) return;

    tapLock = true;
    const reaction = Date.now() - d.roundStart.toMillis();
    const isP1 = uid === d.player1;

    await updateDoc(doc(db, "rooms", currentRoomId), {
        [isP1 ? "score1" : "score2"]: (isP1 ? d.score1 : d.score2) + 1,
        state: "result", lastWinner: username, reaction: reaction + "ms"
    });
    setTimeout(() => tapLock = false, 1000);
};

async function quitGame() {
    if (currentRoomId) {
        const ref = doc(db, "rooms", currentRoomId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
            const d = snap.data();
            if (!d.player2 || d.state === "finished") await deleteDoc(ref);
            else {
                const update = d.player1 === uid ? { player1: null, player1Name: "AYRILDI" } : { player2: null, player2Name: "AYRILDI" };
                await updateDoc(ref, update);
            }
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;

</script>
</body>
</html>

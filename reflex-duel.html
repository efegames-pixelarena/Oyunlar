<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reflex Duel Ranked</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}

body{
background:linear-gradient(-45deg,#ff0000,#001eff,#8b0000,#00008b,#ff1a1a,#0015ff);
background-size:600% 600%;
animation:bg 4s infinite alternate ease-in-out;
color:white;overflow:hidden;display:flex;flex-direction:column;height:100vh;
}
@keyframes bg{0%{background-position:0% 50%}100%{background-position:100% 50%}}

.top-bar{
position:fixed;top:0;width:100%;height:55px;
display:flex;align-items:center;justify-content:space-between;
padding:0 16px;background:#111;z-index:1000;
}

.brand{font-weight:800;font-size:18px;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;background:#222;}
.logout-btn{background:#ff3b3b;color:white;border:none;padding:6px 12px;border-radius:12px;}

.scoreboard{
margin-top:55px;width:100%;display:none;flex-direction:column;
}

.score-top{
display:flex;justify-content:space-between;
padding:10px 14px;background:#000;
}

#p1{
color:#00bfff;font-weight:800;
animation:blueGlow 1.5s infinite alternate;
}

#roundInfo{
color:white;background:black;padding:4px 14px;border-radius:10px;
animation:roundPulse 1.2s infinite alternate;
}

#p2{
color:#ff1a1a;font-weight:800;
animation:redGlow 1.5s infinite alternate;
}

@keyframes blueGlow{
0%{text-shadow:0 0 5px #00bfff;}
100%{text-shadow:0 0 20px #00bfff;}
}

@keyframes redGlow{
0%{text-shadow:0 0 5px #ff0000;}
100%{text-shadow:0 0 20px #ff0000;}
}

@keyframes roundPulse{
0%{box-shadow:0 0 5px white;}
100%{box-shadow:0 0 20px white;}
}

#game{
flex:1;display:flex;flex-direction:column;
justify-content:center;align-items:center;text-align:center;
}

button{
padding:12px 22px;border:none;border-radius:12px;
font-weight:bold;cursor:pointer;
background:linear-gradient(90deg,#ffb300,#ff5500);
margin-top:12px;
}

#bigText{font-size:clamp(32px,10vw,70px);min-height:90px;margin-top:20px;font-weight:800;}
#subText{margin-top:10px;font-size:18px;}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">Reflex Duel Ranked</div>
<div>
<span class="nav-box" id="userBox">...</span>
<button class="logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<div class="scoreboard" id="scoreboard">
<div class="score-top">
<div id="p1"></div>
<div id="roundInfo"></div>
<div id="p2"></div>
</div>
</div>

<div id="game">
<button id="findBtn">Ranked Maç Bul</button>
<div id="bigText"></div>
<div id="subText"></div>
<div id="afterMatch"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, updateDoc, deleteDoc,
onSnapshot, collection, serverTimestamp,
runTransaction, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

let uid,username,elo=1000,roomId=null;
let unsubscribe=null,countdownInterval=null,tapLock=false;

const scoreboard=document.getElementById("scoreboard");
const bigText=document.getElementById("bigText");
const subText=document.getElementById("subText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");
const findBtn=document.getElementById("findBtn");
const afterMatch=document.getElementById("afterMatch");

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}
uid=user.uid;

const ref=doc(db,"users",uid);
const snap=await getDoc(ref);

if(!snap.exists()){
await setDoc(ref,{username:"Player",elo:1000,premium:false});
username="Player";
elo=1000;
}else{
username=snap.data().username||"Player";
elo=snap.data().elo||1000;
}

document.getElementById("userBox").innerText=username+" | "+elo+" ELO";
});

/* LOGOUT */
document.getElementById("logoutBtn").onclick=async()=>{
await signOut(auth);
location.href="index.html";
};

/* GLOBAL QUEUE */
findBtn.onclick=async()=>{
findBtn.style.display="none";
bigText.innerText="Rakip Aranıyor...";

const queueRef=doc(db,"system","queue");

await runTransaction(db,async(t)=>{
const qSnap=await t.get(queueRef);

if(!qSnap.exists()){
t.set(queueRef,{
waitingPlayer:uid,
waitingName:username,
waitingElo:elo
});
}else{
const data=qSnap.data();

if(data.waitingPlayer===uid) return;

const newRoom=doc(collection(db,"rooms"));
roomId=newRoom.id;

t.set(newRoom,{
player1:data.waitingPlayer,
player1Name:data.waitingName,
player1Elo:data.waitingElo,
player2:uid,
player2Name:username,
player2Elo:elo,
score1:0,
score2:0,
round:1,
state:"countdown",
host:data.waitingPlayer,
startAt:Date.now()+4000
});

t.delete(queueRef);
}
});

if(roomId) listenRoom();
};

/* LISTENER */
function listenRoom(){
unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()) return;
const d=snap.data();

scoreboard.style.display="flex";

p1.innerText=d.player1Name+" ("+d.score1+")";
p2.innerText=d.player2Name+" ("+d.score2+")";
roundInfo.innerText="Round "+d.round+" / 7";

if(d.state==="countdown"){
if(countdownInterval) return;

countdownInterval=setInterval(async()=>{
const diff=d.startAt-Date.now();
if(diff<=0){
clearInterval(countdownInterval);
countdownInterval=null;

await updateDoc(doc(db,"rooms",roomId),{
state:"active",
roundStart:serverTimestamp()
});
}else{
bigText.innerText=Math.ceil(diff/1000);
}
},200);
}

if(d.state==="active"){
bigText.innerText="TAP!";
}

if(d.state==="result"){
bigText.innerText=d.lastWinner+" Kazandı!";
subText.innerText=d.reaction;

setTimeout(async()=>{
if(d.score1===4||d.score2===4){
await updateDoc(doc(db,"rooms",roomId),{state:"finished"});
}else{
await updateDoc(doc(db,"rooms",roomId),{
round:d.round+1,
state:"countdown",
startAt:Date.now()+4000
});
}
},2500);
}

if(d.state==="finished"){
bigText.innerText="Maç Bitti!";
calculateElo(d);
}
});
}

/* TAP */
document.addEventListener("pointerdown",async()=>{
if(tapLock||!roomId)return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists())return;
const d=snap.data();
if(d.state!=="active")return;

const reaction=Date.now()-d.roundStart.toMillis();

if(reaction<50){
if(uid===d.player1){
t.update(ref,{score2:d.score2+1,state:"result",lastWinner:d.player2Name,reaction:"False Start"});
}else{
t.update(ref,{score1:d.score1+1,state:"result",lastWinner:d.player1Name,reaction:"False Start"});
}
return;
}

if(uid===d.player1){
t.update(ref,{score1:d.score1+1,state:"result",lastWinner:d.player1Name,reaction:reaction+" ms"});
}else{
t.update(ref,{score2:d.score2+1,state:"result",lastWinner:d.player2Name,reaction:reaction+" ms"});
}
});

tapLock=false;
});

/* ELO */
async function calculateElo(d){
const winner=d.score1>d.score2?d.player1:d.player2;
const loser=d.score1>d.score2?d.player2:d.player1;

const wRef=doc(db,"users",winner);
const lRef=doc(db,"users",loser);

await runTransaction(db,async(t)=>{
const wSnap=await t.get(wRef);
const lSnap=await t.get(lRef);

const wE=wSnap.data().elo||1000;
const lE=lSnap.data().elo||1000;

const k=32;
const expected=1/(1+Math.pow(10,(lE-wE)/400));
const newW=Math.round(wE+k*(1-expected));
const newL=Math.round(lE+k*(0-(1-expected)));

t.update(wRef,{elo:newW});
t.update(lRef,{elo:newL});
});
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Reflex Duel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:linear-gradient(180deg,#0b1023,#0d1333,#0a0f1f);
color:white;
overflow:hidden;
display:flex;
flex-direction:column;
height:100vh;
}

/* ===== TOP BAR (INDEX'TEN ENTEGRE) ===== */
.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}
.brand{
font-size:18px;
font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}
.right-menu{display:flex;gap:10px;align-items:center;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;background:#273c8f;}
.btn{padding:6px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.logout-btn{background:#ff3b3b;color:white;}

/* ===== GAME AREA ===== */
#game{
flex:1;
margin-top:55px;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
padding:20px;
}

button{
padding:14px 28px;
border:none;
border-radius:10px;
font-weight:bold;
cursor:pointer;
font-size:15px;
background:linear-gradient(90deg,#ffb300,#ff8c00);
}

#bigText{
font-size:70px;
margin-top:20px;
min-height:80px;
}

.scoreboard{
display:flex;
justify-content:space-between;
width:100%;
max-width:500px;
margin-bottom:20px;
font-weight:bold;
}

.lobby-box{
margin-top:15px;
display:flex;
gap:10px;
}

input{
padding:10px;
border-radius:8px;
border:none;
outline:none;
}

canvas{
position:fixed;
pointer-events:none;
top:0;
left:0;
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box" id="userBox">...</div>
<button class="btn logout-btn" id="logoutBtn">Çıkış</button>
</div>
</div>

<canvas id="confetti"></canvas>

<div id="game">

<div class="scoreboard">
<div id="p1">...</div>
<div id="roundInfo">Round 1 / 7</div>
<div id="p2">...</div>
</div>

<button id="findBtn">Maç Bul</button>

<div class="lobby-box">
<input id="roomCodeInput" placeholder="Oda Kodu">
<button id="joinCodeBtn">Katıl</button>
</div>

<div id="bigText"></div>

</div>

<script type="module">

/* FIREBASE IMPORT */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore, doc, setDoc, updateDoc,
deleteDoc, onSnapshot,
collection, query, where, getDocs,
serverTimestamp, runTransaction, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* CONFIG */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* GLOBALS */
let uid=null;
let username=null;
let roomId=null;
let isHost=false;
let unsubscribe=null;
let tapLock=false;
let matchingLock=false;

/* ELEMENTS */
const findBtn=document.getElementById("findBtn");
const joinCodeBtn=document.getElementById("joinCodeBtn");
const roomCodeInput=document.getElementById("roomCodeInput");
const bigText=document.getElementById("bigText");
const p1=document.getElementById("p1");
const p2=document.getElementById("p2");
const roundInfo=document.getElementById("roundInfo");
const logoutBtn=document.getElementById("logoutBtn");
const userBox=document.getElementById("userBox");

/* AUTH */
onAuthStateChanged(auth,async(user)=>{
if(!user){ window.location.href="index.html"; return; }
uid=user.uid;
const snap=await getDoc(doc(db,"users",uid));
username=snap.data().username;
userBox.innerText=username;
});

/* LOGOUT */
logoutBtn.onclick=async()=>{ await signOut(auth); location.href="index.html"; };

/* OLD ROOM CLEAN */
async function cleanOld(){
const q=query(collection(db,"rooms"),where("players","array-contains",uid));
const snap=await getDocs(q);
for(const r of snap.docs){ await deleteDoc(doc(db,"rooms",r.id)); }
}

/* ===== PRODUCTION QUEUE ===== */
findBtn.onclick=async()=>{
if(matchingLock) return;
matchingLock=true;
await cleanOld();
bigText.innerText="Eşleşme aranıyor...";

const queueRef=doc(collection(db,"queue"));
await setDoc(queueRef,{
uid,username,createdAt:serverTimestamp()
});

const q=query(collection(db,"queue"));
const snap=await getDocs(q);

if(snap.size>=2){
const players=snap.docs.slice(0,2);
const roomRef=doc(collection(db,"rooms"));
await setDoc(roomRef,{
player1:players[0].data().uid,
player1Name:players[0].data().username,
player2:players[1].data().uid,
player2Name:players[1].data().username,
players:[players[0].data().uid,players[1].data().uid],
score1:0,score2:0,round:1,state:"countdown"
});
await deleteDoc(players[0].ref);
await deleteDoc(players[1].ref);
roomId=roomRef.id;
isHost=true;
listenRoom();
}
matchingLock=false;
};

/* ===== ROOM CODE SYSTEM ===== */
joinCodeBtn.onclick=async()=>{
const code=roomCodeInput.value.trim();
if(!code) return;

const ref=doc(db,"rooms",code);
const snap=await getDoc(ref);
if(!snap.exists()) return alert("Oda yok");

const d=snap.data();
if(d.player2) return alert("Oda dolu");

await updateDoc(ref,{
player2:uid,
player2Name:username,
players:[d.player1,uid],
state:"countdown"
});
roomId=code;
listenRoom();
};

/* ===== LISTENER ===== */
function listenRoom(){
if(unsubscribe) unsubscribe();

unsubscribe=onSnapshot(doc(db,"rooms",roomId),async(snap)=>{
if(!snap.exists()) return reset();
const d=snap.data();

if(!d.players.includes(uid)) return reset();

p1.innerText=d.player1Name+" ("+d.score1+")";
p2.innerText=d.player2Name+" ("+d.score2+")";
roundInfo.innerText="Round "+d.round+" / 7";

if(d.state==="countdown"){
bigText.innerText="3";
setTimeout(()=>bigText.innerText="2",1000);
setTimeout(()=>bigText.innerText="1",2000);
setTimeout(()=>{
bigText.innerText="TAP!";
updateDoc(doc(db,"rooms",roomId),{state:"active"});
},3000);
}

if(d.state==="active"){
bigText.innerText="TAP!";
}

if(d.state==="result"){
bigText.innerText="Kazanan: "+d.lastWinner;
if(d.score1===4||d.score2===4){
setTimeout(async()=>{
await deleteDoc(doc(db,"rooms",roomId));
reset();
},3000);
}else{
setTimeout(async()=>{
await updateDoc(doc(db,"rooms",roomId),{
round:d.round+1,
state:"countdown"
});
},1000);
}
}
});
}

/* ===== TAP ===== */
document.addEventListener("pointerdown",async(e)=>{
if(tapLock||!roomId) return;
tapLock=true;

await runTransaction(db,async(t)=>{
const ref=doc(db,"rooms",roomId);
const snap=await t.get(ref);
if(!snap.exists()) return;
const d=snap.data();
if(d.state!=="active") return;

let winnerName=username;

if(uid===d.player1){
t.update(ref,{
score1:d.score1+1,
state:"result",
lastWinner:winnerName
});
}else{
t.update(ref,{
score2:d.score2+1,
state:"result",
lastWinner:winnerName
});
}
});

tapLock=false;
});

/* RESET */
function reset(){
if(unsubscribe) unsubscribe();
roomId=null;
bigText.innerText="";
findBtn.style.display="block";
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Reflex Duel</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
:root { 
    --p: #00f2ff; --a: #ff0055; --bg: #05070a; --b: #161b22; 
    --gold: #ffcc00; --glass: rgba(10, 15, 25, 0.85); --success: #00ff88;
}

* { 
    margin:0; padding:0; box-sizing:border-box; 
    font-family: 'Rajdhani', sans-serif; 
    -webkit-tap-highlight-color:transparent; 
    touch-action: manipulation; 
    user-select: none; 
}

body { 
    background: var(--bg); color: white; height: 100vh; overflow: hidden; 
    display: flex; flex-direction: column; position: fixed; width: 100%;
}

body::before {
    content: ""; position: absolute; inset: 0;
    background-image: 
        linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
    background-size: 30px 30px;
    mask-image: radial-gradient(circle at center, black, transparent 80%);
    z-index: -1;
}

/* ÃœST BAR */
.top-bar { 
    height: 70px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); 
    border-bottom: 2px solid var(--p); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 15px; z-index: 1000;
}
.brand { 
    font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.1rem;
    background: linear-gradient(to bottom, #fff, var(--p)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

#userBox {
    font-weight: 700; color: var(--p); font-size: 0.8rem;
    max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* LOBÄ° */
#lobby { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

.lobby-header { 
    display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px;
}

.search-container {
    display: flex; gap: 8px; width: 100%;
}

.search-input {
    flex: 1; background: var(--b); border: 1px solid #333; padding: 12px; 
    border-radius: 10px; color: var(--p); font-family: 'Orbitron'; font-size: 0.7rem;
}

.lobby-actions { display: flex; gap: 10px; }

.action-btn { 
    flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 900; 
    font-family: 'Orbitron'; font-size: 0.7rem; cursor: pointer; transition: 0.3s;
}
.create-btn { background: var(--p); color: #000; box-shadow: 0 0 15px rgba(0,242,255,0.3); }
.quick-btn { background: var(--success); color: #000; }

/* ODA KARTLARI */
.room-card { 
    background: var(--glass); border: 1px solid var(--b); padding: 15px; border-radius: 15px;
    display: flex; justify-content: space-between; align-items: center;
    border-left: 4px solid var(--p); animation: slideIn 0.3s ease-out; margin-bottom: 10px;
}

.badge { 
    padding: 3px 8px; border-radius: 5px; font-size: 0.55rem; font-weight: 900; margin-bottom: 5px; display: inline-block;
}
.badge-waiting { background: var(--success); color: #000; }
.badge-ingame { background: var(--a); color: #fff; animation: blink 1s infinite; }

.room-id { font-size: 0.6rem; color: #555; font-family: 'Orbitron'; }
.live-stats { font-family: 'Orbitron'; color: var(--gold); font-size: 0.8rem; margin-right: 15px; font-weight: 900; }

@keyframes blink { 50% { opacity: 0.5; } }
@keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* MODALLAR */
.modal { position: fixed; inset:0; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:2000; padding: 20px; backdrop-filter: blur(5px); }
.modal-content { 
    background: var(--b); padding: 30px; border-radius: 20px; border: 1px solid var(--p);
    width: 100%; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,242,255,0.2);
}
.modal-content h2 { font-family: 'Orbitron'; color: var(--p); margin-bottom: 10px; font-size: 1.2rem; }
.modal-content p { color: #888; font-size: 0.8rem; margin-bottom: 20px; }
.modal-content input { 
    width: 100%; padding: 15px; background: #000; border: 1px solid #333; 
    color: var(--p); border-radius: 10px; margin-bottom: 20px; text-align: center; font-size: 16px; outline: none;
}
.modal-content input:focus { border-color: var(--p); box-shadow: 0 0 10px rgba(0,242,255,0.2); }

/* OYUN ALANI */
#game-view { display: none; flex: 1; flex-direction: column; }
.scoreboard { 
    padding: 20px; display: grid; grid-template-columns: 1fr auto 1fr; 
    align-items: center; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--b);
}
.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; touch-action: none; }
#bigText { font-family: 'Orbitron'; font-size: 70px; font-weight: 900; text-align: center;}
#subText { font-family: 'Orbitron'; font-size: 0.9rem; letter-spacing: 3px; color: #555; margin-top: 15px; text-align: center;}
.flash { background: #fff !important; }
.flash #bigText, .flash #subText { color: #000 !important; }
.winner-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; }
.back-btn { background: var(--a); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: 800; font-size: 0.7rem; font-family: 'Orbitron'; }
.exit-btn { background: #333; color: #ff4444; border: 1px solid #444; padding: 6px 10px; border-radius: 6px; font-weight: 800; font-size: 0.65rem; font-family: 'Orbitron'; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PIXEL ARENA</div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="userBox">...</div>
        <button id="lobbyExitBtn" class="exit-btn" onclick="window.location.href='index.html'">Ã‡IKIÅž</button>
        <button id="leaveBtn" class="back-btn" style="display:none;">LOBBY'E DÃ–N</button>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <h2>ARENA OLUÅžTUR</h2>
        <p>Yeni bir kapÄ±ÅŸma baÅŸlatmak iÃ§in oda kur.</p>
        <input type="text" id="roomPassInput" placeholder="ÅžÄ°FRE (BOÅž BIRAKABÄ°LÄ°RSÄ°N)" maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal('createModal')" style="flex:1; padding:15px; border-radius:10px; background:#222; border:none; color:white;">Ä°PTAL</button>
            <button id="confirmCreateBtn" style="flex:1; padding:15px; border-radius:10px; background:var(--p); border:none; color:black; font-weight:900;">BAÅžLAT</button>
        </div>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--gold)">KÄ°LÄ°TLÄ° ARENA</h2>
        <p>Bu arenaya girmek iÃ§in ÅŸifre gereklidir.</p>
        <input type="password" id="joinPassInput" placeholder="ÅžÄ°FREYÄ° GÄ°RÄ°N" maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal('passwordModal')" style="flex:1; padding:15px; border-radius:10px; background:#222; border:none; color:white;">Ä°PTAL</button>
            <button id="confirmPassBtn" style="flex:1; padding:15px; border-radius:10px; background:var(--gold); border:none; color:black; font-weight:900;">DOÄžRULA</button>
        </div>
    </div>
</div>

<div id="quickJoinModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--success)">HIZLI KATIL</h2>
        <p id="quickJoinStatus">Uygun arenalar taranÄ±yor...</p>
        <div id="quickJoinLoader" style="margin:20px 0; color:var(--success); font-family:'Orbitron';">SÄ°NYAL ARANIYOR...</div>
        <button onclick="closeModal('quickJoinModal')" style="width:100%; padding:15px; border-radius:10px; background:#222; border:none; color:white;">Ä°PTAL</button>
    </div>
</div>

<div id="lobby">
    <div class="lobby-header">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="ODA KODU VEYA OYUNCU ARA...">
        </div>
        <div class="lobby-actions">
            <button class="action-btn create-btn" onclick="openModal('createModal')">ODA KUR</button>
            <button class="action-btn quick-btn" onclick="openQuickJoin()">HIZLI KATIL</button>
        </div>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div class="p-info" style="text-align:center;">
            <div class="name" id="p1Name" style="font-size:0.7rem; color:#aaa;">---</div>
            <div class="score" id="p1Score">0</div>
        </div>
        <div id="roundNum" style="padding: 10px; font-weight: 900; color: var(--gold); font-size:0.8rem;">RD 1</div>
        <div class="p-info" style="text-align:center;">
            <div class="name" id="p2Name" style="font-size:0.7rem; color:#aaa;">---</div>
            <div class="score" id="p2Score">0</div>
        </div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText">READY</div>
        <div id="subText">BEKLE...</div>
    </div>
</div>

<div id="winnerScreen" class="winner-screen">
    <p style="font-family:'Orbitron'; color:var(--p);">ARENA ÅžAMPÄ°YONU</p>
    <h1 id="championName" style="font-family:'Orbitron'; font-size:2.5rem; color:var(--gold); margin:15px 0;">PLAYER</h1>
    <div style="color:#555">Lobiye dÃ¶nÃ¼lÃ¼yor...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, unsubLobby = null, tapLock = false;
let countdownInterval = null, lastTapTime = 0, lastState = "", allRooms = [];
let serverOffset = 0;

const getServerTime = () => Date.now() + serverOffset;

// SES VE MODAL FONKSÄ°YONLARI
let audioCtx = null;
const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
function playBeep(freq, type, duration) { if(!audioCtx) return; initAudio(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); }
const sounds = { tick: () => playBeep(400, 'sine', 0.1), go: () => playBeep(800, 'square', 0.3), win: () => { playBeep(523, 'sine', 0.2); setTimeout(()=>playBeep(659, 'sine', 0.2), 150); setTimeout(()=>playBeep(783, 'sine', 0.5), 300); } };

window.openModal = (id) => { initAudio(); document.getElementById(id).style.display = "flex"; };
window.closeModal = (id) => { document.getElementById(id).style.display = "none"; };

// HIZLI KATIL MANTIÄžI
window.openQuickJoin = () => {
    openModal('quickJoinModal');
    const status = document.getElementById("quickJoinStatus");
    const loader = document.getElementById("quickJoinLoader");
    
    setTimeout(() => {
        const available = allRooms.find(r => !r.player2 && !r.password && r.player1 !== uid);
        if (available) {
            status.innerText = "Arena Bulundu! BaÄŸlanÄ±lÄ±yor...";
            setTimeout(() => {
                closeModal('quickJoinModal');
                joinRoom(available.id, false);
            }, 1000);
        } else {
            status.innerText = "Åžu an uygun boÅŸ arena yok.";
            loader.innerText = "YENÄ° ODA KURMAN Ã–NERÄ°LÄ°R";
        }
    }, 1500);
};

// KÄ°MLÄ°K DOÄžRULAMA
onAuthStateChanged(auth, async (user) => {
    if (!user) { signInAnonymously(auth); return; }
    uid = user.uid;
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()) {
        username = "Warrior_" + uid.slice(0,4);
        await setDoc(userRef, { username: username });
    } else {
        username = snap.data().username || "Warrior";
    }
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

// LOBÄ° VE ARAMA
function listenLobby() {
    if(unsubLobby) unsubLobby(); 
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    unsubLobby = onSnapshot(q, (snap) => {
        allRooms = [];
        snap.forEach(d => allRooms.push({id: d.id, ...d.data()}));
        renderRooms();
    });
}

function renderRooms() {
    const list = document.getElementById("roomList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    list.innerHTML = "";

    const filtered = allRooms.filter(r => 
        (r.player1Name || "").toLowerCase().includes(search) || 
        r.id.toLowerCase().includes(search)
    );

    if (filtered.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; color:#444; font-family:'Orbitron'; font-size:0.7rem;">ARENA BULUNAMADI</div>`;
        return;
    }

    filtered.forEach(data => {
        const isFull = data.player1 && data.player2;
        const isInGame = ["countdown", "active", "result"].includes(data.state);
        const isMyRoom = data.player1 === uid;
        
        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
            <div>
                <span class="badge ${isInGame ? 'badge-ingame' : 'badge-waiting'}">${isInGame ? 'MAÃ‡TA' : 'BEKLENÄ°YOR'}</span>
                <div style="font-weight:900; font-size:1rem; color:#fff">${(data.player1Name || "ADSÄ°Z").toUpperCase()}</div>
                <div class="room-id">ID: ${data.id.slice(0,6).toUpperCase()} â€¢ ${data.password ? 'ðŸ”’' : 'ðŸ”“'}</div>
            </div>
            <div style="display:flex; align-items:center;">
                ${isInGame ? `<div class="live-stats">${data.score1} - ${data.score2}</div>` : ''}
                <button style="padding:10px 18px; border-radius:8px; border:none; background:${(isFull || isMyRoom) ? '#222' : 'var(--p)'}; color:${(isFull || isMyRoom) ? '#555' : '#000'}; font-weight:900; font-size:0.7rem;" 
                ${(isFull || isMyRoom) ? 'disabled' : ''} onclick="joinRoom('${data.id}', ${data.password ? 'true' : 'false'})">
                    ${isFull ? 'DOLU' : (isMyRoom ? 'SAHÄ°BÄ°' : 'KATIL')}
                </button>
            </div>
        `;
        list.appendChild(div);
    });
}

document.getElementById("searchInput").oninput = renderRooms;

// ODA KURMA
document.getElementById("confirmCreateBtn").onclick = async () => {
    const pass = document.getElementById("roomPassInput").value;
    const newRoomRef = doc(collection(db, "rooms"));
    currentRoomId = newRoomRef.id;
    await setDoc(newRoomRef, {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, 
        password: pass, createdAt: serverTimestamp(), penalty: false
    });
    closeModal('createModal'); enterRoom();
};

// ODAYA KATILMA VE ÅžÄ°FRE KONTROLÃœ
let pendingRoomId = null;

window.joinRoom = async (id, isLocked) => {
    initAudio();
    if (isLocked) {
        pendingRoomId = id;
        document.getElementById("joinPassInput").value = "";
        openModal('passwordModal');
        return;
    }
    processJoin(id);
};

document.getElementById("confirmPassBtn").onclick = async () => {
    const enteredPass = document.getElementById("joinPassInput").value;
    const roomRef = doc(db, "rooms", pendingRoomId);
    const snap = await getDoc(roomRef);
    
    if (snap.exists() && snap.data().password === enteredPass) {
        const id = pendingRoomId;
        closeModal('passwordModal');
        processJoin(id);
    } else {
        alert("HatalÄ± Åžifre!");
    }
};

async function processJoin(id) {
    const roomRef = doc(db, "rooms", id);
    try {
        await runTransaction(db, async (transaction) => {
            const snap = await transaction.get(roomRef);
            const data = snap.data();
            if (data.player2) throw "Arena Dolu!";
            transaction.update(roomRef, { player2: uid, player2Name: username, state: "matched" });
            currentRoomId = id;
        });
        enterRoom();
    } catch (e) { alert(e); }
}

// OYUN Ä°Ã‡Ä° FONKSÄ°YONLAR
function enterRoom() {
    if(unsubLobby) { unsubLobby(); unsubLobby = null; } 
    document.getElementById("lobby").style.display = "none";
    document.getElementById("lobbyExitBtn").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if (!snap.exists()) { quitGame(); return; }
        const d = snap.data();
        if (d.createdAt && serverOffset === 0) serverOffset = d.createdAt.toMillis() - Date.now();
        
        document.getElementById("p1Name").innerText = (d.player1Name || "---").toUpperCase();
        document.getElementById("p1Score").innerText = d.score1;
        document.getElementById("p2Name").innerText = (d.player2Name || "BEKLENÄ°YOR").toUpperCase();
        document.getElementById("p2Score").innerText = d.score2;
        document.getElementById("roundNum").innerText = `RD ${d.round}`;

        if (d.state !== lastState) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (d.state === "matched" && uid === d.host) updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startTime: getServerTime() + 3000 });
            if (d.state === "countdown") {
                document.getElementById("arena").classList.remove("flash");
                countdownInterval = setInterval(() => {
                    const diff = Math.ceil((d.startTime - getServerTime()) / 1000);
                    if (diff > 0) {
                        document.getElementById("bigText").innerText = diff;
                        document.getElementById("subText").innerText = "HAZIRLAN";
                    } else {
                        clearInterval(countdownInterval);
                        if (uid === d.host) updateDoc(doc(db, "rooms", currentRoomId), { state: "active", roundStart: getServerTime() });
                    }
                }, 50);
            }
            if (d.state === "active") { sounds.go(); document.getElementById("arena").classList.add("flash"); document.getElementById("bigText").innerText = "GO!"; document.getElementById("subText").innerText = "VUR!"; }
            if (d.state === "result") {
                document.getElementById("arena").classList.remove("flash");
                document.getElementById("bigText").innerText = d.reaction || "WIN";
                document.getElementById("subText").innerText = d.penalty ? "HATA!" : (d.lastWinner || "").toUpperCase() + " KAZANDI";
                if (uid === d.host) setTimeout(() => {
                    const finalWin = (d.score1 >= 11 || d.score2 >= 11);
                    if(currentRoomId) updateDoc(doc(db, "rooms", currentRoomId), { state: finalWin ? "finished" : "countdown", startTime: getServerTime() + 2500, round: finalWin ? d.round : d.round + 1, penalty: false });
                }, 2000);
            }
            if (d.state === "finished") {
                document.getElementById("championName").innerText = (d.score1 >= 11 ? d.player1Name : d.player2Name).toUpperCase();
                document.getElementById("winnerScreen").style.display = "flex";
                sounds.win();
                setTimeout(quitGame, 5000);
            }
            lastState = d.state;
        }
    });
}

document.getElementById("arena").addEventListener('pointerdown', async (e) => {
    e.preventDefault();
    if (tapLock || !currentRoomId) return;
    const now = getServerTime();
    tapLock = true;
    const roomRef = doc(db, "rooms", currentRoomId);
    const snap = await getDoc(roomRef);
    if(!snap.exists()) return;
    const d = snap.data();

    if (d.state === "countdown" || (d.state === "waiting" && d.player2)) {
        const isP1 = uid === d.player1;
        await updateDoc(roomRef, { state: "result", penalty: true, penaltyUser: uid, [isP1 ? "score2" : "score1"]: (isP1 ? d.score2 : d.score1) + 1, lastWinner: isP1 ? (d.player2Name || "Rakip") : (d.player1Name || "Host"), reaction: "ERKEN!" });
    } else if (d.state === "active") {
        const reactionTime = now - d.roundStart;
        await runTransaction(db, async (transaction) => {
            const fSnap = await transaction.get(roomRef);
            if (fSnap.data().state !== "active") return;
            const isP1 = uid === d.player1;
            transaction.update(roomRef, { state: "result", [isP1 ? "score1" : "score2"]: (isP1 ? d.score1 : d.score2) + 1, lastWinner: username, reaction: reactionTime + "ms" });
        });
    }
    setTimeout(() => { tapLock = false; }, 500);
});

async function quitGame() {
    if (currentRoomId) {
        const ref = doc(db, "rooms", currentRoomId);
        const snap = await getDoc(ref);
        if (snap.exists() && (snap.data().host === uid || !snap.data().player2)) await deleteDoc(ref);
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;
</script>
</body>
</html>

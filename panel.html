<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena | Bonus Hub</title>

<style>
:root { --neon-blue: #00f5ff; --neon-purple: #9333ea; --gold: #ffb300; }
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Roboto,sans-serif;}

body {
    background: radial-gradient(circle at center, #1a2a6c, #0a0f1f);
    color: white; min-height: 100vh; overflow-x: hidden;
}

/* KAR EFEKTƒ∞ */
.snowflake { position: fixed; top: -10px; color: white; pointer-events: none; z-index: 999; }
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

/* TOP BAR */
.top-bar {
    position: fixed; top: 0; width: 100%; height: 65px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: rgba(13, 19, 51, 0.9);
    backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,245,255,0.2); z-index: 1000;
}
.brand { font-size: 20px; font-weight: 900; color: #fff; text-shadow: 0 0 10px var(--neon-blue); }
.balance-box {
    background: rgba(0, 245, 255, 0.1); border: 1px solid var(--neon-blue);
    padding: 8px 15px; border-radius: 12px; font-weight: bold; color: var(--neon-blue);
    box-shadow: 0 0 10px rgba(0,245,255,0.2);
}

/* PANEL */
.panel-container { margin-top: 100px; padding: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }

.animated-btn {
    position: relative; padding: 25px; text-align: center; border-radius: 20px;
    cursor: pointer; font-size: 16px; font-weight: bold; margin-bottom: 20px;
    background: #111936; overflow: hidden; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1);
}
.animated-btn:active { transform: scale(0.95); }
.animated-btn::before {
    content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: conic-gradient(transparent, var(--neon-blue), transparent, var(--neon-purple), transparent);
    animation: rotate 4s linear infinite; z-index: -1;
}
.animated-btn::after { content: ""; position: absolute; inset: 3px; background: #0d1333; border-radius: 17px; z-index: -1; }
@keyframes rotate { 100% { transform: rotate(360deg); } }

/* MODAL */
.modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    display: none; justify-content: center; align-items: center; z-index: 5000;
}
.modal-content {
    background: #12183c; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px;
    text-align: center; border: 1px solid var(--neon-blue); position: relative;
}
.close { position: absolute; right: 20px; top: 15px; font-size: 20px; cursor: pointer; color: #666; }

input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: none; background: #1f285c; color: white; text-align: center; font-weight: bold; }
.action-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; background: linear-gradient(90deg, var(--gold), #ff8c00); font-weight: 900; cursor: pointer; color: #000; }

/* WHEEL UI */
.wheel-wrapper { position: relative; width: 300px; height: 300px; margin: 20px auto; }
#wheel { 
    width: 100%; height: 100%; border-radius: 50%; border: 8px solid #333;
    box-shadow: 0 0 30px rgba(0,245,255,0.3); transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
}
.pointer {
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
    width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
    border-top: 30px solid var(--gold); z-index: 10; filter: drop-shadow(0 0 5px black);
}
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PixelArena</div>
    <div class="balance-box" id="balanceBox">BAKƒ∞YE: <span id="balance">...</span></div>
</div>

<div class="panel-container">
    <div class="animated-btn" onclick="openModal('codeModal')">üéÅ BONUS KOD Gƒ∞R</div>
    <div class="animated-btn" onclick="openModal('wheelModal')">üé° G√úNL√úK √áARK</div>
    <div class="animated-btn" onclick="location.href='index.html'">üè† ANA SAYFA</div>
</div>

<div class="modal" id="codeModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('codeModal')">‚úñ</span>
        <h3>PROMOSYON KODU</h3>
        <input id="codeInput" placeholder="KODU BURAYA YAZ">
        <button class="action-btn" onclick="useCode()">ONAYLA</button>
    </div>
</div>

<div class="modal" id="wheelModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('wheelModal')">‚úñ</span>
        <h3 style="margin-bottom:10px">G√úNL√úK ≈ûANS</h3>
        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheel" width="300" height="300"></canvas>
        </div>
        <button class="action-btn" id="spinBtn" onclick="spinWheel()">√áEVƒ∞R</button>
    </div>
</div>

<audio id="spinSound" playsinline><source src="https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-wheel-1934.mp3" type="audio/mpeg"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
const spinSound = document.getElementById("spinSound");

onAuthStateChanged(auth, async (user) => {
    if(!user) { location.href="index.html"; return; }
    currentUser = user;
    await syncUser();
});

async function syncUser() {
    const ref = doc(db, "users", currentUser.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()) {
        await setDoc(ref, { balance: 0, lastSpin: 0 });
        document.getElementById("balance").innerText = "0‚Ç∫";
    } else {
        document.getElementById("balance").innerText = snap.data().balance + "‚Ç∫";
    }
}

// √áark √áizimi (Ok yukarƒ±da olduƒüu i√ßin 90 derece ofsetle √ßiziyoruz)
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const rewards = [50, 100, 500, 1000, 250, 750]; // Daha fazla dilim
const colors = ["#00f5ff", "#9333ea", "#00f5ff", "#9333ea", "#00f5ff", "#9333ea"];

function drawWheel() {
    const angle = (2 * Math.PI) / rewards.length;
    for(let i=0; i<rewards.length; i++) {
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 150, i * angle, (i + 1) * angle);
        ctx.fillStyle = colors[i];
        ctx.fill();
        ctx.save();
        ctx.translate(150, 150);
        ctx.rotate(i * angle + angle / 2);
        ctx.fillStyle = "white";
        ctx.font = "bold 18px Arial";
        ctx.textAlign = "right";
        ctx.fillText(rewards[i] + "‚Ç∫", 130, 10);
        ctx.restore();
    }
}
drawWheel();

let currentRotation = 0;

window.spinWheel = async () => {
    const btn = document.getElementById("spinBtn");
    const userRef = doc(db, "users", currentUser.uid);
    const snap = await getDoc(userRef);
    
    // Zaman kontrol√º
    const lastSpin = snap.data().lastSpin || 0;
    const waitTime = 24 * 60 * 60 * 1000;
    if(Date.now() - lastSpin < waitTime) {
        const remaining = Math.ceil((waitTime - (Date.now() - lastSpin)) / (1000 * 60 * 60));
        alert(`G√ºnde 1 kez √ßevirebilirsin! Kalan: ${remaining} saat`);
        return;
    }

    btn.disabled = true;
    spinSound.currentTime = 0;
    spinSound.play().catch(() => {});

    const segmentAngle = 360 / rewards.length;
    const randomIndex = Math.floor(Math.random() * rewards.length);
    
    // Ok yukarƒ±da (270 derece) olduƒüu i√ßin d√ºzg√ºn duru≈ü hesabƒ±
    const stopAt = (randomIndex * segmentAngle);
    currentRotation += (360 * 5) + (360 - stopAt) - (segmentAngle/2); 
    
    canvas.style.transform = `rotate(${currentRotation}deg)`;

    setTimeout(async () => {
        const prize = rewards[randomIndex];
        await updateDoc(userRef, {
            balance: increment(prize),
            lastSpin: Date.now()
        });
        alert(`Tebrikler! ${prize}‚Ç∫ hesabƒ±na eklendi.`);
        await syncUser();
        btn.disabled = false;
        closeModal('wheelModal');
    }, 4100);
};

window.useCode = async () => {
    const input = document.getElementById("codeInput");
    const code = input.value.trim().toUpperCase();
    if(!code) return;
    
    const codeRef = doc(db, "codes", code);
    const codeSnap = await getDoc(codeRef);
    
    if(!codeSnap.exists()) {
        alert("Ge√ßersiz veya kullanƒ±lmƒ±≈ü kod!");
        return;
    }

    const reward = codeSnap.data().reward;
    await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(reward) });
    // Kodu silmek veya i≈üaretlemek istersen buraya deleteDoc ekleyebilirsin
    alert(`${reward}‚Ç∫ bakiye eklendi!`);
    input.value = "";
    await syncUser();
    closeModal('codeModal');
};

window.openModal = id => document.getElementById(id).style.display = "flex";
window.closeModal = id => document.getElementById(id).style.display = "none";

// Optimize Kar Efekti
setInterval(() => {
    if(document.visibilityState !== 'visible') return;
    const snow = document.createElement("div");
    snow.className = "snowflake";
    snow.innerHTML = "‚ùÑ";
    snow.style.left = Math.random() * 100 + "vw";
    snow.style.fontSize = Math.random() * 15 + 10 + "px";
    snow.style.animation = `fall ${Math.random() * 4 + 4}s linear forwards`;
    document.body.appendChild(snow);
    setTimeout(() => snow.remove(), 7000);
}, 400);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena - Mines</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{background:linear-gradient(180deg,#0b1023,#0d1333,#0a0f1f);color:white;}

.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}

.brand{
font-size:18px;
font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.balance-box{
background:#273c8f;
padding:6px 14px;
border-radius:14px;
font-weight:700;
font-size:13px;
}

.container{
max-width:520px;
margin:auto;
padding:90px 20px 20px;
text-align:center;
}

#grid{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:8px;
margin-top:20px;
}

.tile{
background:#141b3f;
height:65px;
border-radius:12px;
display:flex;
align-items:center;
justify-content:center;
font-size:22px;
cursor:pointer;
border:1px solid #2a3577;
transition:0.2s;
}

.tile.open{background:#2ecc71}
.tile.mine{background:#e74c3c;animation:explode 0.4s ease;}

@keyframes explode{
0%{transform:scale(1)}
50%{transform:scale(1.4)}
100%{transform:scale(1)}
}

button{
padding:10px;
border-radius:10px;
border:none;
margin:5px;
font-weight:bold;
cursor:pointer;
}

.start{background:#3498db;color:white}
.cashout{background:#f1c40f;color:black}
</style>
</head>
<body>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="balance-box">Bakiye: <span id="userBalance">0â‚º</span></div>
</div>

<div class="container">

<h2>ðŸ’£ Mines</h2>

<input type="number" id="bet" placeholder="Bahis" min="1">
<select id="mineCount">
<option value="3">3 MayÄ±n</option>
<option value="5">5 MayÄ±n</option>
<option value="7">7 MayÄ±n</option>
<option value="10">10 MayÄ±n</option>
</select>
<br>
<button id="startBtn" class="start">BaÅŸlat</button>
<button id="cashoutBtn" class="cashout">Cashout</button>

<h3>Ã‡arpan: <span id="multiplier">1x</span></h3>

<div id="grid"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot,runTransaction,getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let mines=[];
let opened=0;
let betAmount=0;
let mineTotal=3;
let gameActive=false;
let multiplier=1;
const houseEdge=0.97;

const grid=document.getElementById("grid");
const multiplierText=document.getElementById("multiplier");
const balanceText=document.getElementById("userBalance");
const startBtn=document.getElementById("startBtn");
const cashoutBtn=document.getElementById("cashoutBtn");

/* GRID */
function createGrid(){
grid.innerHTML="";
for(let i=0;i<25;i++){
const tile=document.createElement("div");
tile.classList.add("tile");
tile.addEventListener("click",()=>reveal(i,tile));
grid.appendChild(tile);
}
}

/* MAYIN ÃœRET */
function generateMines(){
mines=[];
while(mines.length<mineTotal){
let r=Math.floor(Math.random()*25);
if(!mines.includes(r)) mines.push(r);
}
}

/* RTP HESAP */
function calculateMultiplier(){
const safe=25-mineTotal;
let prob=1;
for(let i=0;i<opened;i++){
prob*=(safe-i)/(25-i);
}
multiplier=Math.floor((1/prob)*houseEdge);
multiplierText.innerText=multiplier+"x";
}

/* OYUN BAÅžLAT */
startBtn.addEventListener("click", async ()=>{

if(!auth.currentUser) return alert("GiriÅŸ yap.");

betAmount=parseInt(document.getElementById("bet").value);
mineTotal=parseInt(document.getElementById("mineCount").value);

if(!betAmount||betAmount<=0) return alert("GeÃ§erli bahis gir.");

const userRef=doc(db,"users",auth.currentUser.uid);

try{
await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
if(!snap.exists()) throw "KullanÄ±cÄ± yok";
if(snap.data().balance<betAmount) throw "Yetersiz bakiye";
transaction.update(userRef,{balance:snap.data().balance-betAmount});
});
}catch(e){
alert(e);
return;
}

opened=0;
multiplier=1;
multiplierText.innerText="1x";
generateMines();
createGrid();
gameActive=true;

});

/* KARE AÃ‡ */
function reveal(index,tile){

if(!gameActive||tile.classList.contains("open")) return;

if(mines.includes(index)){
tile.classList.add("mine");
tile.innerHTML="ðŸ’£";
gameActive=false;
return;
}

opened++;
tile.classList.add("open");
tile.innerHTML="ðŸ’Ž";
calculateMultiplier();
}

/* CASHOUT */
cashoutBtn.addEventListener("click", async ()=>{

if(!gameActive||opened===0) return;

gameActive=false;

const win=betAmount*multiplier;

const userRef=doc(db,"users",auth.currentUser.uid);

await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
transaction.update(userRef,{balance:snap.data().balance+win});
});

alert("KazandÄ±n: "+win+"â‚º");

});

/* CANLI BAKÄ°YE */
onAuthStateChanged(auth,(user)=>{
if(user){
const userRef=doc(db,"users",user.uid);
onSnapshot(userRef,(snap)=>{
if(snap.exists()){
balanceText.innerText=parseInt(snap.data().balance)+"â‚º";
}
});
}
});

createGrid();

</script>
</body>
</html>

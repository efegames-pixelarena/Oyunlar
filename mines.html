<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PixelArena - Mines</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;}
body{
background:
radial-gradient(circle at 20% 20%,#1f2b63 0%,transparent 40%),
radial-gradient(circle at 80% 80%,#16245c 0%,transparent 40%),
linear-gradient(180deg,#0b1023,#0d1333,#0a0f1f);
color:white;
min-height:100vh;
}

/* ===== TOP BAR ===== */
.top-bar{
position:fixed;
top:0;
width:100%;
height:55px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 16px;
background:linear-gradient(135deg,#1a2a6c,#16245c);
box-shadow:0 4px 15px rgba(0,0,0,0.45);
z-index:1000;
}

.brand{
font-size:18px;
font-weight:800;
background:linear-gradient(90deg,#4fd1ff,#fff,#4fd1ff);
background-size:200% auto;
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
animation:shine 3s linear infinite;
}
@keyframes shine{to{background-position:200% center;}}

.right-menu{display:flex;gap:10px;}
.nav-box{padding:6px 14px;border-radius:14px;font-weight:700;font-size:13px;text-align:center;}
.balance-box{background:#273c8f;}
.bet-box{background:linear-gradient(90deg,#ff8a00,#ff5f00);color:#000;}

.container{
max-width:520px;
margin:auto;
padding:90px 20px 20px;
text-align:center;
}

#grid{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:8px;
margin-top:20px;
}

.tile{
background:#141b3f;
height:65px;
border-radius:12px;
display:flex;
align-items:center;
justify-content:center;
font-size:22px;
cursor:pointer;
border:1px solid #2a3577;
transition:0.25s;
transform:scale(1);
}

.tile.open{
background:#2ecc71;
animation:pop 0.25s ease;
box-shadow:0 0 15px #2ecc71;
}

@keyframes pop{
0%{transform:scale(0.7)}
70%{transform:scale(1.1)}
100%{transform:scale(1)}
}

.tile.mine{
background:#e74c3c;
animation:explode 0.4s ease;
}

@keyframes explode{
0%{transform:scale(1)}
50%{transform:scale(1.4)}
100%{transform:scale(1)}
}

button{
padding:10px;
border-radius:10px;
border:none;
margin:5px;
font-weight:bold;
cursor:pointer;
}

.start{background:#3498db;color:white;}
.start:disabled{background:#555;cursor:not-allowed;}

.cashout{background:#f1c40f;color:black;}
.cashout:disabled{background:#555;cursor:not-allowed;}

input,select{
padding:10px;
border-radius:10px;
border:none;
margin:5px;
font-size:15px;
}
</style>
</head>
<body>

<div class="top-bar">
  <div class="brand">PixelArena Mines</div>
  <div class="right-menu">
    <div class="nav-box balance-box">Bakiye: <span id="userBalance">0</span>â‚º</div>
    <div class="nav-box bet-box">Bahis: <span id="currentBet">0</span></div>
  </div>
</div>

<div class="container">

<h2>ðŸ’£ Mines</h2>

<input type="number" id="bet" placeholder="Bahis (Max 5000)" min="1" max="5000">
<select id="mineCount"></select>

<br>
<button id="startBtn" class="start">BaÅŸlat</button>
<button id="cashoutBtn" class="cashout" disabled>Cashout</button>

<h3>Ã‡arpan: <span id="multiplier">1x</span></h3>

<div id="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot,runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* AUDIO (iOS UYUMLU) */
let audioCtx=null;
function initAudio(){
if(!audioCtx){
audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
}
function playExplosion(){
initAudio();
const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();
osc.type="sawtooth";
osc.frequency.setValueAtTime(120,audioCtx.currentTime);
gain.gain.setValueAtTime(0.4,audioCtx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.4);
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.start();
osc.stop(audioCtx.currentTime+0.4);
}
function playWin(){
initAudio();
const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();
osc.type="triangle";
osc.frequency.setValueAtTime(300,audioCtx.currentTime);
osc.frequency.linearRampToValueAtTime(700,audioCtx.currentTime+0.4);
gain.gain.setValueAtTime(0.5,audioCtx.currentTime);
gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.5);
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.start();
osc.stop(audioCtx.currentTime+0.5);
}

/* OYUN DEÄžÄ°ÅžKEN */
let mines=[],opened=0,betAmount=0,mineTotal=1,multiplier=1,gameActive=false;

const grid=document.getElementById("grid");
const multiplierText=document.getElementById("multiplier");
const balanceText=document.getElementById("userBalance");
const currentBetText=document.getElementById("currentBet");
const startBtn=document.getElementById("startBtn");
const cashoutBtn=document.getElementById("cashoutBtn");
const mineSelect=document.getElementById("mineCount");
const betInput=document.getElementById("bet");

/* 1-24 */
for(let i=1;i<=24;i++){
let opt=document.createElement("option");
opt.value=i;
opt.text=i+" MayÄ±n";
mineSelect.appendChild(opt);
}

function createGrid(){
grid.innerHTML="";
for(let i=0;i<25;i++){
let tile=document.createElement("div");
tile.classList.add("tile");
tile.addEventListener("click",()=>reveal(i,tile));
grid.appendChild(tile);
}
}

function generateMines(){
mines=[];
while(mines.length<mineTotal){
let r=Math.floor(Math.random()*25);
if(!mines.includes(r)) mines.push(r);
}
}

function updateMultiplier(){
const safeLeft=(25-mineTotal)-(opened-1);
const totalLeft=25-(opened-1);
multiplier*=totalLeft/safeLeft;
multiplier=Math.floor(multiplier*100)/100;
multiplierText.innerText=multiplier+"x";
cashoutBtn.innerText="Ã‡ek ("+Math.floor(betAmount*multiplier)+"â‚º)";
}

/* START */
startBtn.addEventListener("click",async()=>{
if(!auth.currentUser) return;

betAmount=parseInt(betInput.value);
mineTotal=parseInt(mineSelect.value);
if(!betAmount||betAmount<=0||betAmount>5000) return;

const userRef=doc(db,"users",auth.currentUser.uid);

try{
await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
if(snap.data().balance<betAmount) throw "";
transaction.update(userRef,{balance:snap.data().balance-betAmount});
});
}catch{ return;}

opened=0; multiplier=1;
generateMines();
createGrid();

gameActive=true;

betInput.disabled=true;
mineSelect.disabled=true;
startBtn.disabled=true;
cashoutBtn.disabled=false;

currentBetText.innerText=betAmount;
});

/* REVEAL */
function reveal(i,tile){
if(!gameActive||tile.classList.contains("open")) return;

if(mines.includes(i)){
tile.classList.add("mine");
tile.innerHTML="ðŸ’£";
playExplosion();
endGame();
return;
}

opened++;
tile.classList.add("open");
tile.innerHTML="ðŸ’Ž";
updateMultiplier();
}

/* CASHOUT */
cashoutBtn.addEventListener("click",async()=>{
if(!gameActive||opened===0) return;

const win=Math.floor(betAmount*multiplier);
const userRef=doc(db,"users",auth.currentUser.uid);

await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
transaction.update(userRef,{balance:snap.data().balance+win});
});

playWin();
endGame();
});

/* END */
function endGame(){
gameActive=false;
betInput.disabled=false;
mineSelect.disabled=false;
startBtn.disabled=false;
cashoutBtn.disabled=true;
multiplierText.innerText="1x";
currentBetText.innerText="0";
}

/* LIVE BALANCE */
onAuthStateChanged(auth,user=>{
if(!user) return;
const userRef=doc(db,"users",user.uid);
onSnapshot(userRef,snap=>{
if(snap.exists()){
balanceText.innerText=parseInt(snap.data().balance);
}
});
});

createGrid();
</script>

</body>
</html>

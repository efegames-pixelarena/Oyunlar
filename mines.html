<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena - Mines Pro</title>

<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;width:100%;background:#0c111d;color:#fff;overflow:hidden;padding-bottom:env(safe-area-inset-bottom);}

    .top-bar{position:fixed;top:0;left:0;right:0;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 15px;background:#141923;box-shadow:0 4px 20px rgba(0,0,0,0.6);z-index:1000;}
    .brand{font-size:18px;font-weight:700;color:#fff;}
    .right-menu{display:flex;gap:8px;}
    .nav-box{background:#1e2533;padding:6px 12px;border-radius:12px;font-weight:600;font-size:13px;}
    .balance-box{color:#00d4ff;}
    .bet-box{color:#ffcc00;}

    .container{position:fixed;top:60px;left:0;right:0;bottom:0;display:flex;flex-direction:column;padding:15px;overflow-y:auto;}
    .mines-header{display:flex;justify-content:space-between;align-items:center;background:#151b26;padding:12px 15px;border-radius:14px;margin-bottom:15px;}
    
    #grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
    .tile{background:#1b2232;height:68px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:0.25s;box-shadow:inset 0 0 8px rgba(0,0,0,0.6);position:relative;}
    .tile.open{background:#16c784;box-shadow:0 0 15px #16c784;}
    .tile.mine{background:#ff4d4f;box-shadow:0 0 18px red;animation:shake 0.3s;}

    @keyframes shake{0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)}}

    .bet-panel{background:#151b26;border-radius:16px;padding:15px;box-shadow:0 0 20px rgba(0,0,0,0.6);margin-top:auto;}
    input,select{width:100%;background:#1e2533;border:none;border-radius:12px;padding:12px;color:white;margin-bottom:10px;font-size:15px;outline:none;}
    button{width:100%;padding:14px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;font-size:15px;transition:0.2s;}
    .start{background:#00c853;color:black;}
    .start:active{transform:scale(0.98);}
    button:disabled{background:#444;color:#999;}
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PixelArena</div>
    <div class="right-menu">
        <div class="nav-box balance-box">â‚º <span id="userBalance">0</span></div>
        <div class="nav-box bet-box">Bet: <span id="currentBet">0</span></div>
    </div>
</div>

<div class="container">
    <div class="mines-header">
        <div>Mines</div>
        <div style="color:#aaa">MayÄ±n: <span id="mineDisplay" style="color:#ff4d4f; font-weight:bold;">1</span></div>
    </div>
    <div id="grid"></div>
    <div class="bet-panel">
        <input type="number" id="bet" placeholder="Bahis (250 - 3000)" value="250">
        <select id="mineCount"></select>
        <button id="startBtn" class="start">YÃœKLENÄ°YOR...</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// --- iOS UYUMLU PROFESYONEL SES MOTORU ---
const sfxUrls = {
    bet: "https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.wav",
    open: "https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.wav",
    explode: "https://assets.mixkit.co/sfx/preview/mixkit-8-bit-bomb-explosion-2811.wav",
    win: "https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.wav"
};

let audioCtx = null;
const soundBuffers = {};

async function initAudioEngine() {
    if (audioCtx) return;
    
    // iOS iÃ§in AudioContext oluÅŸturma
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Ses dosyalarÄ±nÄ± Ã¶nbelleÄŸe al
    for (const [key, url] of Object.entries(sfxUrls)) {
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
        } catch (err) {
            console.error("Ses yÃ¼klenemedi:", key, err);
        }
    }
}

function playSound(name) {
    if (!audioCtx || !soundBuffers[name]) return;
    
    // iOS'ta sesin kesilmesini Ã¶nlemek iÃ§in durumu kontrol et
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    
    const source = audioCtx.createBufferSource();
    source.buffer = soundBuffers[name];
    source.connect(audioCtx.destination);
    source.start(0);
}

// iOS EtkileÅŸim Kilidini AÃ§ma
const unlockAudio = async () => {
    await initAudioEngine();
    if (audioCtx && audioCtx.state === 'suspended') {
        await audioCtx.resume();
    }
    // Kilidi bir kez aÃ§mak yeterli
    document.removeEventListener('touchstart', unlockAudio);
    document.removeEventListener('click', unlockAudio);
};

document.addEventListener('touchstart', unlockAudio);
document.addEventListener('click', unlockAudio);

// --- FIREBASE KONFÄ°GÃœRASYONU ---
const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let mines = [], opened = 0, betAmount = 0, mineTotal = 1, multiplier = 1, gameActive = false;
let tileElements = [];

const gridEl = document.getElementById("grid");
const balanceText = document.getElementById("userBalance");
const currentBetText = document.getElementById("currentBet");
const startBtn = document.getElementById("startBtn");
const mineSelect = document.getElementById("mineCount");
const betInput = document.getElementById("bet");
const mineDisplay = document.getElementById("mineDisplay");

// MayÄ±n SeÃ§enekleri
for(let i=1; i<=24; i++){
    let opt = document.createElement("option");
    opt.value = i; opt.text = i + " MayÄ±n";
    mineSelect.appendChild(opt);
}
mineSelect.addEventListener("change", () => mineDisplay.innerText = mineSelect.value);

function createGrid() {
    gridEl.innerHTML = "";
    tileElements = [];
    for(let i=0; i<25; i++){
        let tile = document.createElement("div");
        tile.classList.add("tile");
        tile.addEventListener("click", () => reveal(i, tile));
        gridEl.appendChild(tile);
        tileElements.push(tile);
    }
}

function getMultiplier(nMines, nOpened) {
    let prob = 1;
    for (let i = 0; i < nOpened; i++) {
        prob *= (25 - nMines - i) / (25 - i);
    }
    return (1 / prob) * 0.97;
}

startBtn.addEventListener("click", async () => {
    if (!auth.currentUser || startBtn.innerText === "YÃœKLENÄ°YOR...") return;
    
    // Ses motorunu her ihtimale karÅŸÄ± tetikle
    if (audioCtx) audioCtx.resume();

    const userRef = doc(db, "users", auth.currentUser.uid);

    if (gameActive) {
        if (opened === 0) return;
        gameActive = false;
        const win = Math.floor(betAmount * multiplier);
        
        try {
            await runTransaction(db, async (t) => {
                const snap = await t.get(userRef);
                t.update(userRef, { balance: snap.data().balance + win });
            });
            playSound("win"); // Para Ã‡ekme Sesi
        } catch (e) { console.error(e); }
        
        resetGame();
        return;
    }

    betAmount = parseInt(betInput.value);
    if(isNaN(betAmount) || betAmount < 250 || betAmount > 3000) {
        alert("Bahis 250â‚º - 3000â‚º arasÄ± olmalÄ±dÄ±r.");
        return;
    }

    mineTotal = parseInt(mineSelect.value);

    try {
        await runTransaction(db, async (t) => {
            const snap = await t.get(userRef);
            if (!snap.exists()) throw "KullanÄ±cÄ± yok!";
            if (snap.data().balance < betAmount) throw "Yetersiz Bakiye!";
            t.update(userRef, { balance: snap.data().balance - betAmount });
        });
        
        playSound("bet"); // Bahis Yapma Sesi
        opened = 0; multiplier = 1;
        mines = [];
        while(mines.length < mineTotal){
            let r = Math.floor(Math.random() * 25);
            if(!mines.includes(r)) mines.push(r);
        }
        
        createGrid();
        gameActive = true;
        betInput.disabled = true;
        mineSelect.disabled = true;
        currentBetText.innerText = betAmount;
        startBtn.innerText = "SEÃ‡Ä°M YAPIN";
    } catch (e) { alert(e); }
});

function reveal(i, tile) {
    if (!gameActive || tile.classList.contains("open")) return;

    if (mines.includes(i)) {
        gameActive = false;
        playSound("explode"); // Bomba Patlama Sesi
        mines.forEach(mIdx => {
            tileElements[mIdx].classList.add("mine");
            tileElements[mIdx].innerHTML = "ðŸ’£";
        });
        startBtn.innerText = "PATLADI!";
        setTimeout(resetGame, 2000);
    } else {
        opened++;
        tile.classList.add("open");
        tile.innerHTML = "ðŸ’Ž";
        playSound("open"); // Kutu AÃ§Ä±lÄ±ÅŸ Sesi
        multiplier = getMultiplier(mineTotal, opened);
        startBtn.innerText = `Ã‡ek (â‚º${Math.floor(betAmount * multiplier)})`;
    }
}

function resetGame() {
    gameActive = false;
    betInput.disabled = false;
    mineSelect.disabled = false;
    startBtn.innerText = "BET";
    currentBetText.innerText = "0";
    createGrid();
}

onAuthStateChanged(auth, user => {
    if (!user) return;
    const userRef = doc(db, "users", user.uid);
    onSnapshot(userRef, snap => {
        if (snap.exists()) {
            balanceText.innerText = Math.floor(snap.data().balance).toLocaleString('tr-TR');
            if(startBtn.innerText === "YÃœKLENÄ°YOR...") startBtn.innerText = "BET";
        }
    });
});

createGrid();
</script>

</body>
</html>

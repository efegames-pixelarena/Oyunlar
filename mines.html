<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Mines PRO</title>

<style>
    /* RESET & TEMEL STƒ∞LLER */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
    html,body{
        height:100%; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background: #05080f; color:white;
    }

    /* TOP BAR */
    .top-bar{
        position:fixed;top:0;width:100%;height:60px;
        display:flex;align-items:center;justify-content:space-between;
        padding:0 12px; background: rgba(10, 15, 30, 0.95);
        backdrop-filter: blur(15px); border-bottom: 1px solid #1e2642; z-index:1000;
    }

    .brand{
        font-size:16px;font-weight:900; background:linear-gradient(90deg,#4fd1ff,#fff);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        letter-spacing: 1px;
    }

    .right-menu{display:flex;gap:6px;align-items: center;}
    .nav-box{
        padding:6px 10px; border-radius:10px; font-weight:700; font-size:11px; 
        min-width:90px; text-align:center; display: flex; align-items: center; justify-content: center; height: 32px;
    }
    .balance-box{background:#1a2248; border: 1px solid #4fd1ff44; color: #4fd1ff;}
    .bet-box{background:linear-gradient(90deg,#ff8a00,#ff5f00); color:#000;}
    
    .back-btn {
        background: #e74c3c; color: white; text-decoration: none; padding: 6px 12px;
        border-radius: 10px; font-size: 11px; font-weight: 800; border-bottom: 2px solid #c0392b;
        height: 32px; display: flex; align-items: center;
    }

    /* OYUN ALANI */
    .container{
        position:absolute;top:60px;bottom:0;width:100%;
        display:flex;flex-direction:column;padding:15px;overflow-y:auto;
        background: radial-gradient(circle at center, #161d36 0%, #05080f 100%);
    }

    .mines-header{
        display:flex;justify-content:space-between;align-items:center;
        background:rgba(26, 34, 72, 0.4); padding:12px 15px; border-radius:14px; 
        margin-bottom:15px; border: 1px solid #1e2642;
    }
    
    #grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
    
    .tile{
        background:#161d36; height:65px; border-radius:12px; 
        display:flex; align-items:center; justify-content:center; 
        font-size:24px; cursor:pointer; transition: 0.1s;
        border: 1px solid #273c8f;
    }
    .tile.open{ background: linear-gradient(145deg, #00b894, #00d2ad); border-color: #55efc4; animation: flip 0.4s; }
    .tile.mine{ background: #d63031; border-color: #ff7675; animation: shake 0.3s; }

    @keyframes flip { 0% {transform: rotateY(90deg);} 100% {transform: rotateY(0deg);} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)}}

    /* ALT PANEL - Takƒ±lma √ñnleyici Focus D√ºzenlemesi */
    .bet-panel{
        background:rgba(10, 15, 30, 0.9); border-top: 1px solid #1e2642;
        padding:20px 15px; margin: auto -15px 0 -15px;
        display: flex; flex-direction: column; gap: 10px;
    }

    input, select{
        width:100%; background:#050811; border:1px solid #273c8f; 
        border-radius:12px; padding:12px; color:white; 
        font-weight: bold; font-size:16px; outline:none; text-align: center;
        -webkit-appearance: none;
    }

    button{
        width:100%; padding:15px; border-radius:12px; border:none; 
        font-weight:900; cursor:pointer; font-size:16px; 
        background:#5743d6; color:white; transition: 0.2s;
    }
    .start-active{ background:#00b894 !important; }
    .is-lose{ background:#d63031 !important; }

    /* MODERN MODAL TASARIMI */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .modal-content {
        background: #161d36; border: 2px solid #273c8f; border-radius: 20px;
        width: 85%; max-width: 320px; padding: 25px; text-align: center;
        box-shadow: 0 0 30px rgba(0,0,0,0.5); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes pop { from {transform: scale(0.7); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    .modal-icon { font-size: 40px; margin-bottom: 15px; color: #ff2a4d; }
    .modal-text { font-weight: 700; font-size: 16px; line-height: 1.5; margin-bottom: 20px; }
    .modal-btn {
        background: #4fd1ff; color: #000; padding: 10px 25px; border-radius: 10px;
        font-weight: 900; border: none; cursor: pointer; width: auto !important;
    }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PIXEL ARENA</div>
    <div class="right-menu">
        <div class="nav-box balance-box">‚Ç∫<span id="userBalance">0</span></div>
        <div class="nav-box bet-box">B: ‚Ç∫<span id="currentBet">0</span></div>
        <a href="index.html" class="back-btn">GERƒ∞</a>
    </div>
</div>

<div class="container">
    <div class="mines-header">
        <div style="font-weight: 800; color: #4fd1ff; font-size: 14px;">MINES PRO</div>
        <div style="color:#aaa; font-size: 12px; font-weight: 700;">MAYIN: <span id="mineDisplay" style="color:#ff2a4d;">1</span></div>
    </div>
    <div id="grid"></div>
    <div class="bet-panel">
        <input type="number" id="bet" placeholder="Bahis Miktarƒ±" value="250" inputmode="numeric">
        <select id="mineCount"></select>
        <button id="startBtn">BAHƒ∞S YAP</button>
    </div>
</div>

<div id="alertModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <div class="modal-text" id="modalMsg">Hata olu≈ütu.</div>
        <button class="modal-btn" onclick="closeModal()">TAMAM</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// MODAL FONKSƒ∞YONLARI
window.showModal = (msg) => {
    document.getElementById("modalMsg").innerText = msg;
    document.getElementById("alertModal").style.display = "flex";
}
window.closeModal = () => {
    document.getElementById("alertModal").style.display = "none";
}

// SES Sƒ∞STEMƒ∞
let audioCtx = null;
const sounds = {};
async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const urls = {
        bet: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
        open: 'https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3',
        explode: 'https://assets.mixkit.co/active_storage/sfx/2802/2802-preview.mp3',
        win: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'
    };
    for (const [name, url] of Object.entries(urls)) {
        try {
            const res = await fetch(url);
            const buf = await res.arrayBuffer();
            sounds[name] = await audioCtx.decodeAudioData(buf);
        } catch (e) {}
    }
}

function playSound(name) {
    if (!audioCtx || !sounds[name]) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const source = audioCtx.createBufferSource();
    source.buffer = sounds[name];
    source.connect(audioCtx.destination);
    source.start(0);
}

document.addEventListener('touchstart', initAudio, { once: true });

let mines = [], opened = 0, betAmount = 0, mineTotal = 1, multiplier = 1, gameActive = false;
let tileElements = [];

const gridEl = document.getElementById("grid");
const balanceText = document.getElementById("userBalance");
const currentBetText = document.getElementById("currentBet");
const startBtn = document.getElementById("startBtn");
const mineSelect = document.getElementById("mineCount");
const betInput = document.getElementById("bet");
const mineDisplay = document.getElementById("mineDisplay");

// SE√áENEKLERƒ∞ DOLDUR
for(let i=1; i<=24; i++){
    let opt = document.createElement("option");
    opt.value = i; opt.text = i + " MAYIN";
    mineSelect.appendChild(opt);
}
mineSelect.addEventListener("change", () => mineDisplay.innerText = mineSelect.value);

function createGrid() {
    gridEl.innerHTML = "";
    tileElements = [];
    for(let i=0; i<25; i++){
        let tile = document.createElement("div");
        tile.classList.add("tile");
        tile.addEventListener("click", (e) => { e.preventDefault(); reveal(i, tile); });
        gridEl.appendChild(tile);
        tileElements.push(tile);
    }
}

function getMultiplier(nMines, nOpened) {
    let prob = 1;
    for (let i = 0; i < nOpened; i++) {
        prob *= (25 - nMines - i) / (25 - i);
    }
    return (1 / prob) * 0.98;
}

startBtn.addEventListener("click", async () => {
    if (!audioCtx) await initAudio();
    if (!auth.currentUser) return;
    const userRef = doc(db, "users", auth.currentUser.uid);

    if (gameActive) {
        if (opened === 0) return;
        gameActive = false;
        const win = Math.floor(betAmount * multiplier);
        try {
            await runTransaction(db, async (t) => {
                const snap = await t.get(userRef);
                t.update(userRef, { balance: snap.data().balance + win });
            });
            playSound("win");
        } catch (e) {}
        resetGame();
        return;
    }

    betAmount = parseInt(betInput.value);
    
    // MODAL KONTROL√ú
    if(isNaN(betAmount) || betAmount < 100) {
        showModal("Minimum bahis 100‚Ç∫ olmalƒ±dƒ±r!");
        return;
    }
    if(betAmount > 10000) {
        showModal("Maksimum bahis 10.000‚Ç∫ olabilir!");
        return;
    }

    try {
        await runTransaction(db, async (t) => {
            const snap = await t.get(userRef);
            if (snap.data().balance < betAmount) throw "BAKƒ∞YE YETERSƒ∞Z!";
            t.update(userRef, { balance: snap.data().balance - betAmount });
        });
        
        playSound("bet");
        opened = 0; multiplier = 1; mines = [];
        mineTotal = parseInt(mineSelect.value);
        while(mines.length < mineTotal){
            let r = Math.floor(Math.random() * 25);
            if(!mines.includes(r)) mines.push(r);
        }
        createGrid();
        gameActive = true;
        betInput.disabled = true; mineSelect.disabled = true;
        currentBetText.innerText = betAmount.toLocaleString('tr-TR');
        startBtn.innerText = "KAZANCI √áEK";
        startBtn.classList.add("start-active");
    } catch (e) { showModal(e); }
});

function reveal(i, tile) {
    if (!gameActive || tile.classList.contains("open")) return;
    if (mines.includes(i)) {
        gameActive = false;
        playSound("explode");
        mines.forEach(mIdx => {
            tileElements[mIdx].classList.add("mine");
            tileElements[mIdx].innerHTML = "üí£";
        });
        startBtn.innerText = "KAYBETTƒ∞N!";
        startBtn.classList.remove("start-active");
        startBtn.classList.add("is-lose");
        setTimeout(resetGame, 2000);
    } else {
        opened++;
        tile.classList.add("open");
        tile.innerHTML = "üíé";
        playSound("open");
        multiplier = getMultiplier(mineTotal, opened);
        startBtn.innerText = `√áEK (‚Ç∫${Math.floor(betAmount * multiplier).toLocaleString('tr-TR')})`;
    }
}

function resetGame() {
    gameActive = false;
    betInput.disabled = false;
    mineSelect.disabled = false;
    startBtn.innerText = "BAHƒ∞S YAP";
    startBtn.classList.remove("start-active", "is-lose");
    currentBetText.innerText = "0";
    createGrid();
}

onAuthStateChanged(auth, user => {
    if (!user) return;
    onSnapshot(doc(db, "users", user.uid), snap => {
        if (snap.exists()) balanceText.innerText = Math.floor(snap.data().balance).toLocaleString('tr-TR');
    });
});

createGrid();
</script>
</body>
</html>

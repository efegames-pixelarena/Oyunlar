<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PixelArena - Mines Pro</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; -webkit-tap-highlight-color:transparent; }
        body { background:#0c111d; color:#fff; overflow:hidden; padding-bottom:env(safe-area-inset-bottom); }
        
        .top-bar { position:fixed; top:0; width:100%; height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 15px; background:#141923; box-shadow:0 4px 20px rgba(0,0,0,0.6); z-index:1000; }
        .brand { font-size:18px; font-weight:700; color:#00d4ff; }
        .right-menu { display:flex; gap:8px; }
        .nav-box { background:#1e2533; padding:6px 12px; border-radius:12px; font-weight:600; font-size:13px; border:1px solid #ffffff11; }
        .balance-box { color:#00d4ff; }
        .bet-box { color:#ffcc00; }

        .container { position:fixed; top:60px; bottom:0; width:100%; display:flex; flex-direction:column; padding:15px; }
        .mines-header { display:flex; justify-content:space-between; align-items:center; background:#151b26; padding:12px 15px; border-radius:14px; margin-bottom:15px; }
        
        #grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; flex:1; max-height:400px; }
        .tile { background:#1b2232; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; transition:0.2s; box-shadow:inset 0 0 10px rgba(0,0,0,0.5); border:1px solid #2a3447; position: relative; }
        .tile.open { background:linear-gradient(135deg, #16c784, #0b8a5b); border:none; box-shadow:0 0 15px rgba(22,199,132,0.4); }
        .tile.mine { background:linear-gradient(135deg, #ff4d4f, #cf1322); border:none; box-shadow:0 0 15px rgba(255,77,79,0.4); animation: shake 0.3s; }

        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

        .bet-panel { background:#151b26; border-radius:16px; padding:15px; margin-top:15px; border:1px solid #1e2533; }
        input, select { width:100%; background:#1e2533; border:1px solid #2a3447; border-radius:12px; padding:12px; color:white; margin-bottom:10px; font-size:16px; outline:none; }
        button { width:100%; padding:15px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; font-size:16px; transition:0.2s; }
        .start-btn { background:#00c853; color:#000; }
        .start-btn:active { transform:scale(0.98); }
        button:disabled { background:#2a3447; color:#555; cursor:not-allowed; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PIXELARENA</div>
    <div class="right-menu">
        <div class="nav-box balance-box">â‚º <span id="userBalance">---</span></div>
        <div class="nav-box bet-box">Bet: <span id="currentBet">0</span></div>
    </div>
</div>

<div class="container">
    <div class="mines-header">
        <div>Mines Game</div>
        <div style="color:#aaa">MayÄ±n: <span id="mineDisplay" style="color:#ff4d4f; font-weight:bold;">1</span></div>
    </div>

    <div id="grid"></div>

    <div class="bet-panel">
        <input type="number" id="betInput" placeholder="Bahis TutarÄ± (250 - 3000)" value="250">
        <select id="mineCountSelect"></select>
        <button id="mainBtn" class="start-btn">BAÄžLANILIYOR...</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let mines = [], openedCount = 0, betAmount = 0, mineTotal = 1, multiplier = 1, gameActive = false;
let tileElements = [];

const gridEl = document.getElementById("grid");
const balanceEl = document.getElementById("userBalance");
const currentBetEl = document.getElementById("currentBet");
const mainBtn = document.getElementById("mainBtn");
const mineSelect = document.getElementById("mineCountSelect");
const betInput = document.getElementById("betInput");
const mineDisplay = document.getElementById("mineDisplay");

for(let i=1; i<=24; i++) {
    let opt = document.createElement("option");
    opt.value = i; opt.text = i + " MayÄ±n";
    mineSelect.appendChild(opt);
}
mineSelect.addEventListener("change", () => mineDisplay.innerText = mineSelect.value);

function initGrid() {
    gridEl.innerHTML = "";
    tileElements = [];
    for(let i=0; i<25; i++) {
        let tile = document.createElement("div");
        tile.className = "tile";
        tile.addEventListener("click", () => handleTileClick(i, tile));
        gridEl.appendChild(tile);
        tileElements.push(tile);
    }
}

function getMultiplier(nMines, nOpened) {
    let prob = 1;
    for (let i = 0; i < nOpened; i++) {
        prob *= (25 - nMines - i) / (25 - i);
    }
    return (1 / prob) * 0.96; 
}

mainBtn.addEventListener("click", async () => {
    if (!auth.currentUser || mainBtn.innerText === "BAÄžLANILIYOR...") return;
    const userRef = doc(db, "users", auth.currentUser.uid);

    if (gameActive) {
        if (openedCount === 0) return;
        gameActive = false;
        const winAmount = Math.floor(betAmount * multiplier);

        try {
            await runTransaction(db, async (transaction) => {
                const snap = await transaction.get(userRef);
                transaction.update(userRef, { balance: (snap.data().balance || 0) + winAmount });
            });
        } catch (e) { console.error(e); }
        resetGame();
        return;
    }

    betAmount = parseInt(betInput.value);
    mineTotal = parseInt(mineSelect.value);

    if (isNaN(betAmount) || betAmount < 250 || betAmount > 3000) {
        alert("Bahis 250â‚º - 3000â‚º arasÄ±nda olmalÄ±dÄ±r!");
        return;
    }

    try {
        await runTransaction(db, async (t) => {
            const snap = await t.get(userRef);
            if (!snap.exists()) throw "KullanÄ±cÄ± kaydÄ± bulunamadÄ±!";
            const bal = snap.data().balance || 0;
            if (bal < betAmount) throw "Yetersiz Bakiye!";
            t.update(userRef, { balance: bal - betAmount });
        });
    } catch (e) { alert(e); return; }

    mines = [];
    while(mines.length < mineTotal) {
        let r = Math.floor(Math.random() * 25);
        if(!mines.includes(r)) mines.push(r);
    }

    openedCount = 0; multiplier = 1; gameActive = true;
    initGrid();
    betInput.disabled = true; mineSelect.disabled = true;
    currentBetEl.innerText = betAmount;
    mainBtn.innerText = "ELMAS SEÃ‡Ä°N";
    mainBtn.style.background = "#555";
});

function handleTileClick(index, tile) {
    if (!gameActive || tile.classList.contains("open") || tile.classList.contains("mine")) return;

    if (mines.includes(index)) {
        gameActive = false;
        mines.forEach(mIdx => {
            tileElements[mIdx].classList.add("mine");
            tileElements[mIdx].innerHTML = "ðŸ’£";
        });
        mainBtn.innerText = "KAYBETTÄ°N!";
        mainBtn.style.background = "#ff4d4f";
        setTimeout(resetGame, 2500);
    } else {
        openedCount++;
        tile.classList.add("open");
        tile.innerHTML = "ðŸ’Ž";
        multiplier = getMultiplier(mineTotal, openedCount);
        mainBtn.style.background = "#00c853";
        mainBtn.innerText = `Ã‡EK (â‚º${Math.floor(betAmount * multiplier)})`;
    }
}

function resetGame() {
    gameActive = false; betInput.disabled = false; mineSelect.disabled = false;
    mainBtn.innerText = "OYUNU BAÅžLAT";
    mainBtn.style.background = "#00c853";
    currentBetEl.innerText = "0";
    initGrid();
}

// OTOMATÄ°K BAKÄ°YE TANIMLAMASI KALDIRILDI
signInAnonymously(auth).catch(e => console.error("GiriÅŸ HatasÄ±"));

onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    const userRef = doc(db, "users", user.uid);
    
    // Sadece mevcut veriyi dinle, yeni veri oluÅŸturma (setDoc kaldÄ±rÄ±ldÄ±)
    onSnapshot(userRef, (s) => {
        if (s.exists()) {
            const data = s.data();
            balanceEl.innerText = Math.floor(data.balance || 0).toLocaleString('tr-TR');
        } else {
            balanceEl.innerText = "0"; // VeritabanÄ±nda yoksa 0 gÃ¶ster
        }
        if(mainBtn.innerText === "BAÄžLANILIYOR...") mainBtn.innerText = "OYUNU BAÅžLAT";
    });
});

initGrid();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena - Mines</title>

<style>
*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
-webkit-tap-highlight-color:transparent;
}

html,body{
height:100%;
width:100%;
}

body{
background:#0c111d;
color:#fff;
overflow:hidden;
}

/* TAM EKRAN FIX */
.container{
position:fixed;
top:60px;
bottom:0;
left:0;
right:0;
display:flex;
flex-direction:column;
padding:15px;
overflow:auto;
}

/* TOP BAR */
.top-bar{
position:fixed;
top:0;
width:100%;
height:60px;
display:flex;
align-items:center;
justify-content:space-between;
padding:0 15px;
background:#141923;
box-shadow:0 4px 20px rgba(0,0,0,0.6);
z-index:1000;
}

.brand{
font-size:18px;
font-weight:700;
color:#fff;
}

.right-menu{
display:flex;
gap:8px;
}

.nav-box{
background:#1e2533;
padding:6px 12px;
border-radius:12px;
font-weight:600;
font-size:13px;
}

.balance-box{ color:#00d4ff; }
.bet-box{ color:#ffcc00; }

/* MINES HEADER */
.mines-header{
display:flex;
justify-content:space-between;
align-items:center;
background:#151b26;
padding:12px 15px;
border-radius:14px;
margin-bottom:15px;
box-shadow:0 0 20px rgba(0,0,0,0.5);
}

/* GRID */
#grid{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:10px;
margin-bottom:20px;
}

.tile{
background:#1b2232;
height:68px;
border-radius:14px;
display:flex;
align-items:center;
justify-content:center;
font-size:22px;
cursor:pointer;
transition:0.25s;
box-shadow:inset 0 0 8px rgba(0,0,0,0.6);
position:relative;
overflow:hidden;
}

.tile.open{
background:#16c784;
box-shadow:0 0 15px #16c784;
}

.tile.mine{
background:#ff4d4f;
box-shadow:0 0 25px red;
}

/* GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž PATLAMA */
.explosion{
position:absolute;
width:30px;
height:30px;
background:radial-gradient(circle,rgba(255,255,255,1) 0%,rgba(255,0,0,0.9) 40%,rgba(255,0,0,0.2) 60%,rgba(255,0,0,0) 80%);
border-radius:50%;
animation:explode 0.7s ease-out forwards;
pointer-events:none;
}

@keyframes explode{
0%{transform:scale(0.2);opacity:1;}
50%{transform:scale(2.5);opacity:1;}
100%{transform:scale(5);opacity:0;}
}

/* BET PANEL */
.bet-panel{
background:#151b26;
border-radius:16px;
padding:15px;
box-shadow:0 0 20px rgba(0,0,0,0.6);
margin-top:auto;
}

input,select{
width:100%;
background:#1e2533;
border:none;
border-radius:12px;
padding:12px;
color:white;
margin-bottom:10px;
font-size:15px;
}

button{
width:100%;
padding:14px;
border-radius:12px;
border:none;
font-weight:bold;
cursor:pointer;
margin-top:5px;
font-size:15px;
}

.start{ background:#00c853; color:black; }
.cashout{ background:#ffcc00; color:black; }

button:disabled{
background:#444;
color:#999;
}
</style>
</head>
<body>

<!-- SESLER (iOS UYUMLU) -->
<audio id="explodeSound" preload="auto" playsinline src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.wav"></audio>
<audio id="winSound" preload="auto" playsinline src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.wav"></audio>
<audio id="cashSound" preload="auto" playsinline src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.wav"></audio>

<div class="top-bar">
<div class="brand">PixelArena</div>
<div class="right-menu">
<div class="nav-box balance-box">â‚º <span id="userBalance">0</span></div>
<div class="nav-box bet-box">Bet: <span id="currentBet">0</span></div>
</div>
</div>

<div class="container">

<div class="mines-header">
<div>Mines</div>
<div>MayÄ±n: <span id="mineDisplay">1</span></div>
</div>

<div id="grid"></div>

<div class="bet-panel">
<input type="number" id="bet" placeholder="Bahis (250 - 3000)">
<select id="mineCount"></select>
<button id="startBtn" class="start">BET</button>
<button id="cashoutBtn" class="cashout" disabled>Ã‡ek</button>
<h3 style="text-align:center;margin-top:10px;">Ã‡arpan: <span id="multiplier">1x</span></h3>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot,runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* GELÄ°ÅžMÄ°Åž iOS SES UNLOCK */
let audioUnlocked=false;
function unlockAudio(){
if(audioUnlocked) return;
document.querySelectorAll("audio").forEach(a=>{
a.muted=true;
a.play().then(()=>{
a.pause();
a.currentTime=0;
a.muted=false;
}).catch(()=>{});
});
audioUnlocked=true;
}
document.addEventListener("touchstart",unlockAudio,{once:true});
document.addEventListener("click",unlockAudio,{once:true});

function playSound(id){
const s=document.getElementById(id);
if(!s) return;
s.currentTime=0;
s.play().catch(()=>{});
}

const firebaseConfig={
apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
authDomain:"emirhan-site.firebaseapp.com",
projectId:"emirhan-site",
storageBucket:"emirhan-site.firebasestorage.app",
messagingSenderId:"668871888390",
appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let mines=[],opened=0,betAmount=0,mineTotal=1,multiplier=1,gameActive=false;

const grid=document.getElementById("grid");
const multiplierText=document.getElementById("multiplier");
const balanceText=document.getElementById("userBalance");
const currentBetText=document.getElementById("currentBet");
const startBtn=document.getElementById("startBtn");
const cashoutBtn=document.getElementById("cashoutBtn");
const mineSelect=document.getElementById("mineCount");
const betInput=document.getElementById("bet");
const mineDisplay=document.getElementById("mineDisplay");

for(let i=1;i<=24;i++){
let opt=document.createElement("option");
opt.value=i;
opt.text=i+" MayÄ±n";
mineSelect.appendChild(opt);
}

mineSelect.addEventListener("change",()=>{
mineDisplay.innerText=mineSelect.value;
});

function createGrid(){
grid.innerHTML="";
for(let i=0;i<25;i++){
let tile=document.createElement("div");
tile.classList.add("tile");
tile.addEventListener("click",()=>reveal(i,tile));
grid.appendChild(tile);
}
}

function generateMines(){
mines=[];
while(mines.length<mineTotal){
let r=Math.floor(Math.random()*25);
if(!mines.includes(r)) mines.push(r);
}
}

function updateMultiplier(){
const safeLeft=(25-mineTotal)-(opened-1);
const totalLeft=25-(opened-1);
multiplier*=totalLeft/safeLeft;
multiplier=Math.floor(multiplier*100)/100;
multiplierText.innerText=multiplier+"x";
cashoutBtn.innerText="Ã‡ek ("+Math.floor(betAmount*multiplier)+"â‚º)";
}

startBtn.addEventListener("click",async()=>{
playSound("cashSound");

if(!auth.currentUser) return;

betAmount=parseInt(betInput.value);
if(betAmount<250){ alert("Minimum Bahis 250â‚º"); return; }
if(betAmount>3000){ alert("Maksimum Bahis 3000â‚º"); return; }

mineTotal=parseInt(mineSelect.value);

const userRef=doc(db,"users",auth.currentUser.uid);
try{
await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
if(snap.data().balance<betAmount) throw "";
transaction.update(userRef,{balance:snap.data().balance-betAmount});
});
}catch{ return;}

opened=0; multiplier=1;
generateMines();
createGrid();

gameActive=true;
betInput.disabled=true;
mineSelect.disabled=true;
startBtn.disabled=true;
cashoutBtn.disabled=false;

currentBetText.innerText=betAmount;
});

cashoutBtn.addEventListener("click",async()=>{
if(!gameActive||opened===0) return;

playSound("cashSound");

const win=Math.floor(betAmount*multiplier);
const userRef=doc(db,"users",auth.currentUser.uid);

await runTransaction(db,async(transaction)=>{
const snap=await transaction.get(userRef);
transaction.update(userRef,{balance:snap.data().balance+win});
});

playSound("winSound");

gameActive=false;
betInput.disabled=false;
mineSelect.disabled=false;
startBtn.disabled=false;
cashoutBtn.disabled=true;
multiplierText.innerText="1x";
currentBetText.innerText="0";
});

function reveal(i,tile){
if(!gameActive||tile.classList.contains("open")) return;

if(mines.includes(i)){
tile.classList.add("mine");
tile.innerHTML="ðŸ’£";

const boom=document.createElement("div");
boom.classList.add("explosion");
tile.appendChild(boom);

playSound("explodeSound");

gameActive=false;
betInput.disabled=false;
mineSelect.disabled=false;
startBtn.disabled=false;
cashoutBtn.disabled=true;
return;
}

opened++;
tile.classList.add("open");
tile.innerHTML="ðŸ’Ž";
playSound("winSound");
updateMultiplier();
}

onAuthStateChanged(auth,user=>{
if(!user) return;
const userRef=doc(db,"users",user.uid);
onSnapshot(userRef,snap=>{
if(snap.exists()){
balanceText.innerText=parseInt(snap.data().balance);
}
});
});

createGrid();
</script>

</body>
</html>

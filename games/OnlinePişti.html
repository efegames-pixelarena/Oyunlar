<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Pişti Online</title>

<style>
    * { 
        margin:0; padding:0; box-sizing:border-box; 
        -webkit-tap-highlight-color:transparent; 
        user-select:none; touch-action: manipulation; 
    }
    
    body {
        height:100vh; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background:#03050a; color:white;
    }

    /* --- LOBİ TASARIMI --- */
    #lobbyScreen {
        position: fixed; inset: 0; background: radial-gradient(circle at top, #0b1437, #03050a);
        z-index: 9000; display: flex; flex-direction: column; align-items: center; padding: 20px;
        overflow-y: auto;
    }

    .lobby-header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { background: rgba(79, 209, 255, 0.1); padding: 10px 20px; border-radius: 15px; border: 1px solid #4fd1ff44; }

    .lobby-actions { width: 100%; max-width: 500px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .lobby-btn { 
        padding: 15px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; 
        transition: 0.2s; font-size: 14px; text-transform: uppercase;
    }
    .btn-create { background: #4fd1ff; color: #03050a; }
    .btn-quick { background: #ffcc00; color: #03050a; }

    .search-bar { width: 100%; max-width: 500px; margin-bottom: 20px; position: relative; }
    .search-bar input { 
        width: 100%; padding: 12px 45px; border-radius: 10px; background: rgba(255,255,255,0.05); 
        border: 1px solid #1e2642; color: white; outline: none;
    }

    .rooms-container { width: 100%; max-width: 500px; flex: 1; }
    .room-card { 
        background: rgba(30, 38, 66, 0.5); border: 1px solid #1e2642; border-radius: 15px; 
        padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    
    .room-info h4 { color: #4fd1ff; margin-bottom: 4px; }
    .room-info p { font-size: 12px; opacity: 0.7; }
    .bet-tag { background: #ff5f00; color: white; padding: 4px 8px; border-radius: 6px; font-weight: 900; font-size: 12px; }

    /* --- OYUN ALANI --- */
    .game-ui { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }

    .top-bar{
        position:fixed;top:0;width:100%;height:60px;
        display:flex;align-items:center;justify-content:space-between;
        padding:0 12px; background: rgba(10, 15, 30, 0.9);
        backdrop-filter: blur(10px); border-bottom: 1px solid #1e2642; z-index:1000;
    }

    .brand{ font-size:16px;font-weight:900; background:linear-gradient(90deg,#4fd1ff,#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .score-board { margin-top: 80px; font-weight: bold; color: #ffcc00; font-size: 14px; background: rgba(0,0,0,0.3); padding: 4px 15px; border-radius: 20px; }

    .table {
        width:92%; max-width:500px; height:380px; border-radius:180px; position:relative;
        background:radial-gradient(circle at center,#1a8a4d,#0a4d23 80%);
        box-shadow:inset 0 0 100px #000, 0 10px 40px rgba(0,0,0,0.5);
        margin-top: 20px; border: 10px solid #2d1f14;
    }

    .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75px; height:105px; }
    .stack-card { width:75px; position:absolute; left:0; top:0; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); background:white;}

    .hand, .opponent { position:absolute; left:50%; transform:translateX(-50%); display:flex; gap:6px; width: max-content; padding: 10px; min-height: 100px;}
    .hand { bottom:-55px; }
    .opponent { top:-55px; }

    .card { width:65px; border-radius: 6px; cursor:pointer; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background:white;}
    .hand .card:hover { transform: translateY(-15px); }

    .deal-anim-card {
        position: fixed; width: 65px; height: 91px; border-radius: 6px;
        background-image: url('https://deckofcardsapi.com/static/img/back.png');
        background-size: cover; z-index: 5000;
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .card-throw { position:absolute; width:65px; z-index:2000; transition:all 0.4s cubic-bezier(.25,.8,.25,1); border-radius: 6px; }

    #pistiDisplay {
        position: fixed; top: 45%; left: 50%; transform: translate(-50%,-50%);
        font-size: 80px; font-weight: 900; color: #fff; text-align: center;
        background: linear-gradient(to bottom, #fff, #ffcc00, #ff6600);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 15px rgba(255, 102, 0, 0.8));
        display: none; z-index: 9999; pointer-events: none; animation: pistiIn 1s ease-out;
    }
    @keyframes pistiIn { 0% { scale: 0; opacity: 0; } 40% { scale: 1.3; rotate: -5deg; } 100% { scale: 1; opacity: 1; } }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(11, 16, 35, 0.9); display: none; align-items: center; justify-content: center; z-index: 10000;
        backdrop-filter: blur(8px);
    }
    .modal-content {
        background: linear-gradient(135deg, #1a2a6c, #0b1023); color: white; padding: 30px; border-radius: 25px; width: 85%; max-width: 320px;
        text-align: center; border: 2px solid #4fd1ff; box-shadow: 0 0 30px rgba(79, 209, 255, 0.3);
    }
</style>
</head>
<body>

<div id="lobbyScreen">
    <div class="lobby-header">
        <div class="brand" style="font-size: 24px;">PixelArena Pişti</div>
        <div class="user-info">
            <div id="lobbyName" style="font-weight: 900; font-size: 12px; color: #4fd1ff;">Yükleniyor...</div>
            <div id="lobbyBalance" style="font-weight: 700; font-size: 14px;">₺0</div>
        </div>
    </div>

    <div class="lobby-actions">
        <button class="lobby-btn btn-create" onclick="openCreateModal()">Oda Kur</button>
        <button class="lobby-btn btn-quick" onclick="quickJoin()">Hızlı Katıl</button>
    </div>

    <div class="search-bar">
        <input type="text" id="roomSearch" placeholder="Oda kodu veya kullanıcı adı ile ara..." oninput="filterRooms()">
    </div>

    <div class="rooms-container" id="roomsList">
        </div>
</div>

<div class="game-ui" id="gameScreen">
    <div class="top-bar">
        <div class="brand">Oyun Odası: <span id="currentRoomCode" style="color:#fff">#---</span></div>
        <div class="right-menu">
            <div class="nav-box balance-box" id="gameBalanceDisplay">₺0</div>
            <div class="nav-box bet-box" id="gameBetDisplay">B: ₺0</div>
        </div>
    </div>

    <div class="score-board">RAKİP: <span id="cs">0</span> — SİZ: <span id="ps">0</span></div>

    <div class="table" id="tableArea">
        <div class="opponent" id="opponentHand"></div>
        <div class="table-cards" id="tableCards"></div>
        <div class="hand" id="playerHand"></div>
    </div>
</div>

<div id="pistiDisplay">PİŞTİ!</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
        <div class="modal-msg" id="modalMsg">-</div>
        <div id="modalInputs" style="margin-bottom: 20px; display: none;">
            <input type="number" id="betAmount" placeholder="Bahis Miktarı" style="width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:10px;">
        </div>
        <button class="modal-btn" id="modalMainBtn" onclick="closeModal()" style="background: #4fd1ff; color: #0b1023; border: none; padding: 12px 30px; border-radius: 15px; width: 100%; font-weight: 800; cursor: pointer;">TAMAM</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87",
    databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com" // Realtime Database URL
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rdb = getDatabase(app);

// SES MOTORU (Zarar verilmedi)
const sfx = {
    cardThrow: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3"),
    cardCollect: new Audio("https://cdn.freesound.org/previews/202/202029_3325145-lq.mp3"),
    win: new Audio("https://cdn.freesound.org/previews/391/391539_5235550-lq.mp3"),
    lose: new Audio("https://cdn.freesound.org/previews/174/174499_1079313-lq.mp3"),
    pisti: new Audio("https://cdn.freesound.org/previews/253/253177_4404552-lq.mp3"),
    deal: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3")
};

let userData = null;
let currentRoom = null;
let isMyTurn = false;
let allRooms = {};

// USER AUTH VE DATA
onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = "login.html"; return; }
    onSnapshot(doc(db, "users", user.uid), snap => {
        userData = { id: user.uid, ...snap.data() };
        document.getElementById("lobbyName").innerText = userData.username;
        document.getElementById("lobbyBalance").innerText = "₺" + userData.balance.toLocaleString();
        document.getElementById("gameBalanceDisplay").innerText = "₺" + userData.balance.toLocaleString();
    });
    listenRooms();
});

// LOBİ SİSTEMİ
function listenRooms() {
    onValue(ref(rdb, 'rooms'), (snapshot) => {
        allRooms = snapshot.val() || {};
        renderRooms(allRooms);
    });
}

function renderRooms(rooms) {
    const list = document.getElementById("roomsList");
    list.innerHTML = "";
    Object.entries(rooms).forEach(([id, room]) => {
        if (room.status === "waiting") {
            const card = document.createElement("div");
            card.className = "room-card";
            card.innerHTML = `
                <div class="room-info">
                    <h4>${room.ownerName}'in Odası</h4>
                    <p>Kod: #${id.substring(0,6)}</p>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="bet-tag">₺${room.bet}</div>
                    <button class="lobby-btn btn-create" style="padding:8px 15px;" onclick="joinRoom('${id}')">KATIL</button>
                </div>
            `;
            list.appendChild(card);
        }
    });
}

window.filterRooms = function() {
    const term = document.getElementById("roomSearch").value.toLowerCase();
    const filtered = {};
    Object.entries(allRooms).forEach(([id, room]) => {
        if (id.toLowerCase().includes(term) || room.ownerName.toLowerCase().includes(term)) {
            filtered[id] = room;
        }
    });
    renderRooms(filtered);
};

// ODA KURMA & KATILMA
window.openCreateModal = function() {
    document.getElementById("modalMsg").innerText = "Bahis Miktarını Belirle";
    document.getElementById("modalInputs").style.display = "block";
    const btn = document.getElementById("modalMainBtn");
    btn.innerText = "KUR";
    btn.onclick = async () => {
        const bet = parseInt(document.getElementById("betAmount").value);
        if (bet < 100 || isNaN(bet)) return alert("Min bahis 100₺");
        if (userData.balance < bet) return alert("Bakiye yetersiz!");
        createRoom(bet);
    };
    document.getElementById("modalOverlay").style.display = "flex";
};

async function createRoom(bet) {
    const roomRef = push(ref(rdb, 'rooms'));
    const roomId = roomRef.key;
    const initialData = {
        owner: userData.id,
        ownerName: userData.username,
        bet: bet,
        status: "waiting",
        turn: userData.id,
        table: [],
        deck: createDeck(),
        players: {
            [userData.id]: { name: userData.username, score: 0, hand: [] }
        }
    };
    await set(roomRef, initialData);
    onDisconnect(roomRef).remove();
    enterRoom(roomId);
}

window.joinRoom = async function(roomId) {
    const room = allRooms[roomId];
    if (userData.balance < room.bet) return alert("Bakiyeniz bu oda için yetersiz!");
    
    const updates = {};
    updates[`rooms/${roomId}/players/${userData.id}`] = { name: userData.username, score: 0, hand: [] };
    updates[`rooms/${roomId}/status`] = "playing";
    
    await update(ref(rdb), updates);
    enterRoom(roomId);
};

window.quickJoin = function() {
    const available = Object.entries(allRooms).find(([id, r]) => r.status === "waiting" && r.bet <= userData.balance);
    if (available) joinRoom(available[0]);
    else alert("Uygun oda bulunamadı.");
};

// OYUN DÖNGÜSÜ
function enterRoom(roomId) {
    currentRoom = roomId;
    document.getElementById("lobbyScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "flex";
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("currentRoomCode").innerText = "#" + roomId.substring(0, 6);
    
    onValue(ref(rdb, `rooms/${roomId}`), (snapshot) => {
        const data = snapshot.val();
        if (!data) return backToLobby();
        syncGame(data);
    });
}

function syncGame(data) {
    const me = data.players[userData.id];
    const opponentId = Object.keys(data.players).find(id => id !== userData.id);
    const opponent = opponentId ? data.players[opponentId] : { name: "Bekleniyor...", score: 0, handCount: 0 };

    document.getElementById("ps").innerText = me.score;
    document.getElementById("cs").innerText = opponent.score;
    document.getElementById("gameBetDisplay").innerText = "B: ₺" + data.bet;

    isMyTurn = data.turn === userData.id;

    // Masayı Çiz
    const tCards = document.getElementById("tableCards");
    tCards.innerHTML = "";
    (data.table || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = i === (data.table.length -1) ? `https://deckofcardsapi.com/static/img/${c}.png` : `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "stack-card";
        img.style.transform = `rotate(${i * 2}deg)`;
        tCards.appendChild(img);
    });

    // Kendi Elini Çiz
    const pHand = document.getElementById("playerHand");
    pHand.innerHTML = "";
    (me.hand || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/${c}.png`;
        img.className = "card";
        img.onclick = () => playCard(c, i, data);
        pHand.appendChild(img);
    });

    // Rakip Elini Çiz (Sadece arkalık)
    const oHand = document.getElementById("opponentHand");
    oHand.innerHTML = "";
    const oppHandCount = opponent.hand ? (Array.isArray(opponent.hand) ? opponent.hand.length : Object.keys(opponent.hand).length) : 0;
    for(let i=0; i < oppHandCount; i++) {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "card";
        oHand.appendChild(img);
    }

    // Oyun başı kart dağıtma (Sadece oda sahibi yapar)
    if (data.owner === userData.id && data.status === "playing" && (me.hand || []).length === 0 && (opponent.hand || []).length === 0) {
        if (data.deck && data.deck.length > 0) dealRound(data);
        else finalizeGame(data);
    }
}

async function playCard(card, index, data) {
    if (!isMyTurn) return;
    
    const newHand = data.players[userData.id].hand.filter((_, i) => i !== index);
    const newTable = [...(data.table || []), card];
    const opponentId = Object.keys(data.players).find(id => id !== userData.id);

    let scoreGain = 0;
    let isPisti = false;
    
    if (newTable.length >= 2) {
        const top = newTable[newTable.length - 1];
        const prev = newTable[newTable.length - 2];
        if (top[0] === prev[0] || top[0] === 'J') {
            scoreGain = newTable.length;
            if (newTable.length === 2 && top[0] === prev[0]) { scoreGain = 10; isPisti = true; }
            sfx.cardCollect.play();
            if(isPisti) showPisti();
            
            const updates = {};
            updates[`rooms/${currentRoom}/table`] = [];
            updates[`rooms/${currentRoom}/players/${userData.id}/score`] = data.players[userData.id].score + scoreGain;
            updates[`rooms/${currentRoom}/players/${userData.id}/hand`] = newHand;
            updates[`rooms/${currentRoom}/turn`] = opponentId;
            await update(ref(rdb), updates);
            return;
        }
    }

    sfx.cardThrow.play();
    const updates = {};
    updates[`rooms/${currentRoom}/table`] = newTable;
    updates[`rooms/${currentRoom}/players/${userData.id}/hand`] = newHand;
    updates[`rooms/${currentRoom}/turn`] = opponentId;
    await update(ref(rdb), updates);
}

async function dealRound(data) {
    const deck = [...data.deck];
    const p1Hand = deck.splice(0, 4);
    const p2Hand = deck.splice(0, 4);
    const opponentId = Object.keys(data.players).find(id => id !== userData.id);

    const updates = {};
    updates[`rooms/${currentRoom}/deck`] = deck;
    updates[`rooms/${currentRoom}/players/${userData.id}/hand`] = p1Hand;
    updates[`rooms/${currentRoom}/players/${opponentId}/hand`] = p2Hand;
    
    // İlk turda masaya 4 kart
    if ((data.table || []).length === 0) {
        updates[`rooms/${currentRoom}/table`] = deck.splice(0, 4);
        updates[`rooms/${currentRoom}/deck`] = deck;
    }

    await update(ref(rdb), updates);
}

async function finalizeGame(data) {
    const me = data.players[userData.id];
    const opponentId = Object.keys(data.players).find(id => id !== userData.id);
    const opponent = data.players[opponentId];
    
    let msg = "";
    let finalBalance = userData.balance;

    if (me.score > opponent.score) {
        msg = "TEBRİKLER! KAZANDINIZ\n+ ₺" + (data.bet * 2);
        finalBalance += data.bet;
        sfx.win.play();
    } else if (me.score < opponent.score) {
        msg = "MAALESEF KAYBETTİNİZ!";
        finalBalance -= data.bet;
        sfx.lose.play();
    } else {
        msg = "BERABERE!";
    }

    await updateDoc(doc(db, "users", userData.id), { balance: finalBalance });
    await remove(ref(rdb, `rooms/${currentRoom}`));
    
    showModal(msg, true);
}

function showPisti() {
    const el = document.getElementById("pistiDisplay");
    el.style.display = "block";
    sfx.pisti.play();
    setTimeout(() => el.style.display = "none", 1500);
}

function createDeck() {
    const suits = ["H", "D", "C", "S"], vals = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "0", "J", "Q", "K"];
    let d = [];
    suits.forEach(s => vals.forEach(v => d.push(v + s)));
    return d.sort(() => Math.random() - 0.5);
}

function showModal(msg, reload = false) {
    document.getElementById("modalMsg").innerText = msg;
    document.getElementById("modalInputs").style.display = "none";
    const btn = document.getElementById("modalMainBtn");
    btn.innerText = "LOBİYE DÖN";
    btn.onclick = () => {
        if(reload) location.reload();
        else closeModal();
    };
    document.getElementById("modalOverlay").style.display = "flex";
}

window.closeModal = () => document.getElementById("modalOverlay").style.display = "none";
function backToLobby() { location.reload(); }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PixelArena Online Pişti</title>
    <style>
        /* Orijinal CSS buraya... */
        /* Ek: Sıra Kimde Göstergesi */
        .turn-indicator {
            position: fixed; top: 110px; font-size: 12px; font-weight: bold;
            padding: 5px 15px; border-radius: 10px; background: rgba(0,0,0,0.5);
            color: #4fd1ff; border: 1px solid #4fd1ff; z-index: 100;
        }
        .my-turn { background: #1a8a4d; color: white; border-color: #2ecc71; }
        #waitingScreen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20000;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="brand">Multiplayer Pişti</div>
    <div class="right-menu">
        <div class="nav-box balance-box">₺<span id="balance">0</span></div>
        <div class="nav-box bet-box">B: ₺<span id="bet">0</span></div>
        <a href="index.html" class="back-btn">GERİ</a>
    </div>
</div>

<div id="turnStatus" class="turn-indicator">BAĞLANILIYOR...</div>

<div class="score-board">SİZ: <span id="ps">0</span> — RAKİP: <span id="cs">0</span></div>

<div class="table" id="tableArea">
    <div class="computer" id="opponentHand"></div> <div class="table-cards" id="tableCards"></div>
    <div class="hand" id="playerHand"></div>
</div>

<div id="pistiDisplay">PİŞTİ!</div>

<div id="waitingScreen">
    <div class="modal-msg">Rakip Bekleniyor...</div>
    <div style="margin-top:20px;" class="nav-box balance-box">Oda ID: <span id="roomIdDisplay"></span></div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <div class="modal-msg" id="modalMsg">-</div>
        <button class="modal-btn" onclick="closeModal()">TAMAM</button>
    </div>
</div>

<div class="chips" id="chipsArea">
    <div class="chip c-cancel" onclick="cancelBet()">İPTAL</div>
    <div class="chip c100" id="chip100" onclick="addBet(100)">100</div>
    <div class="chip c500" id="chip500" onclick="addBet(500)">500</div>
    <div class="chip c2000" id="chip2000" onclick="addBet(2000)">2K</div>
    <div class="chip c10000" id="chip10000" onclick="addBet(10000)">10K</div>
</div>

<button class="start-btn" id="startBtn" onclick="findGame()">OYUN ARA</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, setDoc, collection, query, where, getDocs, limit, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Değişkenler
let uid, userRef, roomRef, roomId;
let myBalance = 0, currentBet = 0, myRole = null; // 'p1' veya 'p2'
let gameState = null;

// Sesler (Orijinal kodunuzdaki sfx nesnesi buraya gelmeli)

onAuthStateChanged(auth, user => {
    if (!user) return;
    uid = user.uid;
    userRef = doc(db, "users", uid);
    onSnapshot(userRef, snap => {
        myBalance = snap.data().balance || 0;
        document.getElementById("balance").innerText = myBalance.toLocaleString('tr-TR');
    });
});

// 1. LOBİ SİSTEMİ: ODA BUL VEYA KUR
window.findGame = async function() {
    if (currentBet < 100) { showModal("Min bahis 100₺!"); return; }
    
    document.getElementById("waitingScreen").style.display = "flex";
    
    // Boş oda ara (p2'si olmayan ve aynı bahis tutarına sahip)
    const q = query(collection(db, "rooms"), where("status", "==", "waiting"), where("bet", "==", currentBet), limit(1));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        // Odaya Katıl (P2 ol)
        const roomDoc = querySnapshot.docs[0];
        roomId = roomDoc.id;
        myRole = 'p2';
        roomRef = doc(db, "rooms", roomId);
        await updateDoc(roomRef, {
            p2: uid,
            status: "playing",
            turn: roomDoc.data().p1 // İlk oyuncu başlar
        });
    } else {
        // Yeni Oda Kur (P1 ol)
        roomId = "room_" + Math.random().toString(36).substr(2, 9);
        myRole = 'p1';
        roomRef = doc(db, "rooms", roomId);
        const deck = createDeck();
        await setDoc(roomRef, {
            p1: uid,
            p2: null,
            bet: currentBet,
            status: "waiting",
            deck: deck,
            table: [],
            p1_hand: [],
            p2_hand: [],
            p1_score: 0,
            p2_score: 0,
            turn: null,
            createdAt: serverTimestamp()
        });
    }
    
    listenRoom();
};

// 2. REAL-TIME OYUN TAKİBİ
function listenRoom() {
    onSnapshot(roomRef, async (snap) => {
        const data = snap.data();
        if (!data) return;
        gameState = data;

        if (data.status === "playing") {
            document.getElementById("waitingScreen").style.display = "none";
            document.getElementById("chipsArea").style.display = "none";
            document.getElementById("startBtn").style.display = "none";
            
            // Kartlar dağıtılmamışsa ve P1 isem dağıt
            if (myRole === 'p1' && data.p1_hand.length === 0 && data.deck.length === 52) {
                dealInitialCards(data);
            }
            
            renderOnline();
        }

        if (data.status === "finished") {
            handleGameOver(data);
        }
    });
}

async function dealInitialCards(data) {
    let currentDeck = [...data.deck];
    const p1_hand = currentDeck.splice(0, 4);
    const p2_hand = currentDeck.splice(0, 4);
    const table = ["BACK", "BACK", "BACK", currentDeck.shift()];
    
    await updateDoc(roomRef, {
        deck: currentDeck,
        p1_hand: p1_hand,
        p2_hand: p2_hand,
        table: table
    });
}

// 3. OYUN MANTIĞI VE HAMLELER
window.play = async function(cardIndex) {
    if (gameState.turn !== uid) return;
    
    const myHandKey = myRole + "_hand";
    const myHand = [...gameState[myHandKey]];
    const card = myHand.splice(cardIndex, 1)[0];
    
    // Hamle analizi (Pişti/Puan)
    let newTable = [...gameState.table];
    let myNewScore = gameState[myRole + "_score"];
    let isPisti = false;

    if (newTable.length > 0) {
        const topCard = newTable[newTable.length - 1];
        if (topCard !== "BACK" && (card[0] === topCard[0] || card[0] === 'J')) {
            // Puan toplama
            let points = newTable.length + 1;
            if (newTable.length === 1 && card[0] === topCard[0]) {
                points = 10;
                isPisti = true;
            }
            myNewScore += points;
            newTable = [];
        } else {
            newTable.push(card);
        }
    } else {
        newTable.push(card);
    }

    // Sırayı değiştir
    const nextTurn = myRole === 'p1' ? gameState.p2 : gameState.p1;
    
    const updates = {
        table: newTable,
        [myHandKey]: myHand,
        [myRole + "_score"]: myNewScore,
        turn: nextTurn
    };

    // Eller bittiyse yeni tur dağıt
    if (myHand.length === 0 && gameState[ (myRole === 'p1' ? 'p2' : 'p1') + "_hand" ].length === 0) {
        if (gameState.deck.length > 0) {
            let d = [...gameState.deck];
            updates.p1_hand = d.splice(0, 4);
            updates.p2_hand = d.splice(0, 4);
            updates.deck = d;
        } else {
            updates.status = "finished";
        }
    }

    await updateDoc(roomRef, updates);
};

function renderOnline() {
    if (!gameState) return;
    
    const isMyTurn = gameState.turn === uid;
    const statusEl = document.getElementById("turnStatus");
    statusEl.innerText = isMyTurn ? "SIRA SİZDE!" : "RAKİP DÜŞÜNÜYOR...";
    statusEl.className = "turn-indicator " + (isMyTurn ? "my-turn" : "");

    const myHand = gameState[myRole + "_hand"];
    const opponentHandCount = gameState[(myRole === 'p1' ? 'p2' : 'p1') + "_hand"].length;
    
    // HTML render (Orijinal render mantığınızın aynısı, değişkenler güncellendi)
    // playerHand -> myHand
    // opponentHand -> opponentHandCount kadar BACK resmi
    // ps -> gameState.p1_score / cs -> gameState.p2_score (role göre)
}

function createDeck() {
    const suits = ["H", "D", "C", "S"], vals = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "0", "J", "Q", "K"];
    let deck = [];
    suits.forEach(s => vals.forEach(v => deck.push(v + s)));
    return deck.sort(() => Math.random() - 0.5);
}

// Bahis ve UI işlemleri orijinal kodunuzdaki gibi kalabilir.
</script>
</body>
</html>

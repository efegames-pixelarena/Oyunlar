<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Pişti Pro Online</title>

<style>
    :root {
        --primary: #4fd1ff;
        --secondary: #1a2248;
        --accent: #ffcc00;
        --danger: #ff3b30;
        --bg: #03050a;
        --card-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }

    * { 
        margin:0; padding:0; box-sizing:border-box; 
        -webkit-tap-highlight-color:transparent; 
        user-select:none; touch-action: manipulation; 
    }
    
    body {
        height:100vh; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background: var(--bg); color:white;
    }

    /* --- PROFESYONEL ÜST BAR (LOBİ & OYUN) --- */
    .top-bar {
        position:fixed; top:0; width:100%; height:70px;
        display:grid; grid-template-columns: 1fr 1fr 1fr; align-items:center;
        padding:0 20px; background: rgba(10, 15, 30, 0.98);
        backdrop-filter: blur(20px); border-bottom: 2px solid #1e2642; z-index:3000;
    }
    .user-info { font-size:13px; font-weight:900; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }
    .brand-center { text-align: center; font-size: 24px; font-weight: 900; letter-spacing: 4px; color: #fff; text-shadow: 0 0 15px var(--primary); }
    .wallet-info { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
    .badge { padding:4px 10px; border-radius:8px; font-weight:800; font-size:11px; }
    .balance-badge { background: var(--secondary); color: var(--primary); border: 1px solid var(--primary); }
    .bet-badge { background: linear-gradient(90deg, #ff8a00, #ff5f00); color: #000; }

    /* --- LOBİ TASARIMI --- */
    #lobby {
        position: fixed; inset: 0; padding-top: 90px;
        background: radial-gradient(circle at top, #111827, #03050a);
        z-index: 2000; display: flex; flex-direction: column; align-items: center;
    }
    .lobby-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 90%; margin-bottom: 20px; }
    .action-btn { 
        background: var(--secondary); border: 1px solid #ffffff11; padding: 15px 5px; 
        border-radius: 15px; color: white; font-weight: 800; font-size: 11px; cursor: pointer;
        transition: 0.2s; text-align: center;
    }
    .action-btn:active { transform: scale(0.95); background: var(--primary); color: #000; }

    .search-wrapper { width: 90%; margin-bottom: 15px; }
    .search-input { 
        width: 100%; background: #0c1221; border: 1px solid #4fd1ff33; 
        border-radius: 12px; padding: 12px 15px; color: white; outline: none;
    }

    .room-list { width: 90%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 150px; }
    .room-card {
        background: rgba(26, 34, 72, 0.4); border: 1px solid #1e2642; 
        padding: 15px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center;
    }
    .room-name { font-weight: 800; color: var(--primary); }
    .room-meta { font-size: 11px; color: #9ca3af; margin-top: 4px; }
    .join-btn { background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-weight: 900; }

    /* --- OYUN ALANI --- */
    #gameArea { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; background: #050a0f; }
    .table {
        width:92%; max-width:550px; height:400px; border-radius:200px; position:relative;
        background: radial-gradient(circle at center, #1a8a4d, #0a4d23 80%);
        border: 12px solid #3d2b1f; box-shadow: inset 0 0 100px #000, 0 20px 50px rgba(0,0,0,0.6);
    }
    .score-ui { position: absolute; top: 100px; background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 20px; border: 1px solid var(--accent); color: var(--accent); font-weight: 900; }
    
    .card { 
        width:75px; height:105px; border-radius: 8px; background:white; 
        box-shadow: var(--card-shadow); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background-size: cover; border: 1px solid #ddd;
    }
    .hand { position:absolute; bottom: -50px; left: 50%; transform: translateX(-50%); display:flex; gap:8px; }
    .computer-visual { position:absolute; top: -50px; left: 50%; transform: translateX(-50%); display:flex; gap:8px; }
    .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:80px; height:110px; }
    .stack-card { position:absolute; width:80px; height:110px; border-radius: 6px; background:white; background-size: cover; border: 1px solid #ccc; }

    /* --- KARAR SÜRESİ (TIMER) --- */
    .timer-ring { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; border: 3px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; background: rgba(0,0,0,0.5); }

    /* --- ÇİPLER & BUTONLAR --- */
    .chips-area { 
        position:fixed; bottom:100px; display:flex; gap:12px; background: rgba(0,0,0,0.5); 
        padding: 15px; border-radius: 50px; backdrop-filter: blur(15px); z-index: 2100; border: 1px solid #ffffff11;
    }
    .chip { 
        width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; 
        font-weight:900; cursor:pointer; font-size: 11px; border: 3px dashed rgba(255,255,255,0.4); transition: 0.2s; 
    }
    .chip:active { transform: scale(0.8); }
    .c-cancel { background: var(--danger); border-style: solid; }
    .c100 { background: #eee; color:#000; } .c500 { background: #2ecc71; } .c2000 { background: #3498db; } .c10000 { background: #f1c40f; color:#000; }

    .main-action-btn {
        position:fixed; bottom:25px; width: 80%; max-width: 300px; padding:18px; 
        background:linear-gradient(to bottom, var(--primary), #007aff);
        border:none; border-radius:35px; font-weight:900; color:white; cursor:pointer; z-index: 2100;
        box-shadow: 0 10px 20px rgba(0,122,255,0.4); text-transform: uppercase;
    }

    #pistiDisplay {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
        font-size: 80px; font-weight: 900; color: var(--accent); display: none; z-index: 9999;
        text-shadow: 0 0 30px rgba(0,0,0,0.8); animation: bounce 0.5s infinite;
    }
    @keyframes bounce { 0%, 100% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.1); } }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 10000; }
    .modal-content { background: #111827; padding: 30px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; border: 2px solid var(--primary); }
    .modal-btn { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 800; margin-top: 20px; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="user-info" id="userNameLabel">Yükleniyor...</div>
    <div class="brand-center">PİŞTİ</div>
    <div class="wallet-info">
        <div class="badge balance-badge">₺<span id="balanceDisplay">0</span></div>
        <div class="badge bet-badge">BAHİS: ₺<span id="betDisplay">0</span></div>
    </div>
</div>

<div id="lobby">
    <div class="lobby-actions">
        <button class="action-btn" onclick="createRoom()">ODA KUR</button>
        <button class="action-btn" onclick="quickJoin()">HIZLI KATIL</button>
        <button class="action-btn" onclick="showRules()">NASIL OYNANIR?</button>
    </div>
    
    <div class="search-wrapper">
        <input type="text" class="search-input" placeholder="Oda Ara..." id="roomSearch">
    </div>

    <div class="room-list" id="roomList">
        <div style="text-align: center; color: #4b5563; margin-top: 20px;">Odalar taranıyor...</div>
    </div>
</div>

<div id="gameArea">
    <div class="timer-ring" id="turnTimer">15</div>
    <div class="score-ui">SİZ: <span id="ps">0</span> — KRUPİYE: <span id="cs">0</span></div>
    
    <div class="table">
        <div class="computer-visual" id="compHand"></div>
        <div class="table-cards" id="tableCards"></div>
        <div class="hand" id="playerHand"></div>
    </div>

    <button onclick="secureLeave()" style="margin-top: 100px; background: transparent; color: #ff3b30; border: none; font-weight: 900; cursor: pointer;">MASADAN AYRIL</button>
</div>

<div id="pistiDisplay">PİŞTİ!</div>

<div class="chips-area" id="chipsArea">
    <div class="chip c-cancel" onclick="cancelBet()">İPTAL</div>
    <div class="chip c100" onclick="addBet(100)">100</div>
    <div class="chip c500" onclick="addBet(500)">500</div>
    <div class="chip c2000" onclick="addBet(2000)">2K</div>
    <div class="chip c10000" onclick="addBet(10000)">10K</div>
</div>

<button class="main-action-btn" id="startBtn" onclick="initGame()">OYUNA BAŞLA</button>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <div id="modalMsg" style="line-height: 1.5;">Mesaj...</div>
        <button class="modal-btn" onclick="closeModal()">TAMAM</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// SES MOTORU
const sfx = {
    chip: new Audio("https://cdn.freesound.org/previews/201/201491_3325145-lq.mp3"),
    card: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3"),
    pisti: new Audio("https://cdn.freesound.org/previews/253/253177_4404552-lq.mp3"),
    win: new Audio("https://cdn.freesound.org/previews/391/391539_5235550-lq.mp3")
};

let userRef, myName, balance = 0, currentBet = 0, gameActive = false;
let deck = [], player = [], computer = [], table = [], ps = 0, cs = 0;
let timerInterval;

// 1. KULLANICI ADI FİREBASEDEN ÇEKİLSİN
onAuthStateChanged(auth, async user => {
    if (!user) { await signInAnonymously(auth); return; }
    userRef = doc(db, "users", user.uid);
    onSnapshot(userRef, snap => {
        if(!snap.exists()) {
            setDoc(userRef, { name: "OYUNCU_" + user.uid.slice(0,4), balance: 10000 });
            return;
        }
        const data = snap.data();
        balance = data.balance;
        myName = data.name;
        document.getElementById("userNameLabel").innerText = myName;
        document.getElementById("balanceDisplay").innerText = balance.toLocaleString();
    });
    loadRooms();
});

// LOBİ FONKSİYONLARI
function loadRooms() {
    const list = document.getElementById("roomList");
    list.innerHTML = `<div class="room-card">
        <div><div class="room-name">PIXEL ARENA PRO #1</div><div class="room-meta">Bahis: 100 - 50.000 ₺</div></div>
        <button class="join-btn" onclick="showModal('Bu masaya oturdunuz. Bahis yapıp başlayın.')">OTUR</button>
    </div>`;
}

window.addBet = (amt) => {
    if(gameActive) return;
    if(balance >= amt) {
        currentBet += amt;
        balance -= amt;
        playSfx('chip');
        updateBetUI();
    }
};

window.cancelBet = () => {
    if(gameActive) return;
    balance += currentBet;
    currentBet = 0;
    playSfx('chip');
    updateBetUI();
};

function updateBetUI() {
    document.getElementById("betDisplay").innerText = currentBet.toLocaleString();
    document.getElementById("balanceDisplay").innerText = balance.toLocaleString();
}

// 2 & 15. OYUN MANTIĞI VE KART DAĞITIMI
window.initGame = async () => {
    if(currentBet < 100) { showModal("Minimum 100 ₺ bahis yapmalısınız!"); return; }
    gameActive = true;
    await updateDoc(userRef, { balance }); // Bakiyeyi kesin düş (Hile Koruması)
    
    document.getElementById("lobby").style.display = "none";
    document.getElementById("chipsArea").style.display = "none";
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("gameArea").style.display = "flex";

    startNewGame();
};

function startNewGame() {
    ps = 0; cs = 0;
    deck = createDeck();
    table = [deck.shift(), deck.shift(), deck.shift(), deck.shift()];
    dealRound();
}

async function dealRound() {
    // 15. 2Sn ile Kart Dağıtım Animasyonu
    for(let i=0; i<4; i++) {
        computer.push(deck.shift());
        player.push(deck.shift());
        playSfx('card');
        render();
        await new Promise(r => setTimeout(r, 300)); 
    }
    startTurn();
}

function startTurn() {
    let timeLeft = 15;
    document.getElementById("turnTimer").innerText = timeLeft;
    clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("turnTimer").innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(timerInterval);
            autoPlay(); // 16. Süre bitince otomatik oyna
        }
    }, 1000);
}

function playCard(idx) {
    if(!gameActive) return;
    clearInterval(timerInterval);
    const card = player.splice(idx, 1)[0];
    processMove(card, 'player');
    
    if(gameActive) {
        setTimeout(computerMove, 800);
    }
}

function computerMove() {
    const idx = Math.floor(Math.random() * computer.length);
    const card = computer.splice(idx, 1)[0];
    processMove(card, 'computer');
    
    if(player.length === 0 && deck.length > 0) dealRound();
    else if(player.length === 0 && deck.length === 0) finishGame();
    else startTurn();
}

function autoPlay() {
    if(player.length > 0) playCard(0);
}

function processMove(card, owner) {
    playSfx('card');
    const topCard = table[table.length - 1];
    table.push(card);
    
    if(table.length > 1) {
        if(card[0] === topCard[0] || card[0] === 'J') {
            let pts = table.length;
            if(table.length === 2 && card[0] === topCard[0]) {
                pts = 10;
                showPisti();
            }
            if(owner === 'player') ps += pts; else cs += pts;
            table = [];
        }
    }
    render();
}

// PROFESYONEL RENDER
function render() {
    const ph = document.getElementById("playerHand");
    const ch = document.getElementById("compHand");
    const tc = document.getElementById("tableCards");
    
    ph.innerHTML = ""; ch.innerHTML = ""; tc.innerHTML = "";
    
    player.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.backgroundImage = `url(https://deckofcardsapi.com/static/img/${c}.png)`;
        div.onclick = () => playCard(i);
        ph.appendChild(div);
    });

    computer.forEach(() => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.backgroundImage = `url(https://deckofcardsapi.com/static/img/back.png)`;
        ch.appendChild(div);
    });

    table.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = "stack-card";
        div.style.backgroundImage = (i === table.length -1) ? `url(https://deckofcardsapi.com/static/img/${c}.png)` : `url(https://deckofcardsapi.com/static/img/back.png)`;
        div.style.transform = `rotate(${i * 2}deg)`;
        tc.appendChild(div);
    });

    document.getElementById("ps").innerText = ps;
    document.getElementById("cs").innerText = cs;
}

async function finishGame() {
    gameActive = false;
    let winAmt = 0;
    let msg = "";

    if(ps > cs) {
        winAmt = currentBet * 2;
        msg = `TEBRİKLER! KAZANDINIZ \n ₺${winAmt.toLocaleString()}`;
        playSfx('win');
        await updateDoc(userRef, { balance: balance + winAmt });
    } else if(ps < cs) {
        msg = "KAYBETTİNİZ! \n Tekrar deneyin.";
    } else {
        msg = "BERABERE! \n Bahis iade edildi.";
        await updateDoc(userRef, { balance: balance + currentBet });
    }

    showModal(msg);
    setTimeout(() => location.reload(), 3000);
}

// YARDIMCILAR
function createDeck() {
    const s = ["H","D","C","S"], v = ["A","2","3","4","5","6","7","8","9","0","J","Q","K"];
    let d = []; s.forEach(x => v.forEach(y => d.push(y+x)));
    return d.sort(() => Math.random() - 0.5);
}

function playSfx(n) { sfx[n].currentTime = 0; sfx[n].play().catch(()=>{}); }
function showPisti() { 
    const p = document.getElementById("pistiDisplay");
    p.style.display = "block"; playSfx('pisti');
    setTimeout(() => p.style.display = "none", 1500);
}
window.showModal = (m) => { document.getElementById("modalMsg").innerText = m; document.getElementById("modalOverlay").style.display = "flex"; };
window.closeModal = () => { document.getElementById("modalOverlay").style.display = "none"; };
window.showRules = () => showModal("Pişti Kuralları: \n1. Yerdeki kartın aynısını atarsan yerdekileri alırsın.\n2. Vale (J) her zaman yerdekileri alır.\n3. Yerde tek kart varken aynısını atarsan PİŞTİ (10 Puan) olur.");
window.secureLeave = () => { if(confirm("Masadan kalkarsanız bahsiniz yanar. Emin misiniz?")) location.reload(); };

</script>
</body>
</html>

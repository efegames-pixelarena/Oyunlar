<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Pi≈üti Online</title>

<style>
    * { 
        margin:0; padding:0; box-sizing:border-box; 
        -webkit-tap-highlight-color:transparent; 
        user-select:none; touch-action: manipulation; 
    }
    
    body {
        height:100vh; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background:#03050a; color:white;
    }

    /* --- PROFESYONEL LOBƒ∞ TASARIMI --- */
    #lobbyScreen {
        position: fixed; inset: 0; background: radial-gradient(circle at top, #0b1437, #03050a);
        z-index: 9000; display: flex; flex-direction: column; align-items: center; padding: 20px;
        overflow-y: auto;
    }

    .lobby-header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .user-info { background: rgba(79, 209, 255, 0.1); padding: 12px 20px; border-radius: 15px; border: 1px solid #4fd1ff44; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

    .lobby-actions { width: 100%; max-width: 500px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
    .lobby-btn { 
        padding: 18px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-size: 14px; text-transform: uppercase;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .lobby-btn:active { transform: scale(0.96); }
    .btn-create { background: linear-gradient(135deg, #4fd1ff, #0099ff); color: #03050a; }
    .btn-quick { background: linear-gradient(135deg, #ffcc00, #ff9900); color: #03050a; }

    .search-bar { width: 100%; max-width: 500px; margin-bottom: 20px; position: relative; }
    .search-bar input { 
        width: 100%; padding: 14px 20px; border-radius: 12px; background: rgba(255,255,255,0.05); 
        border: 1px solid #1e2642; color: white; outline: none; transition: 0.3s;
    }
    .search-bar input:focus { border-color: #4fd1ff; background: rgba(255,255,255,0.1); }

    .rooms-container { width: 100%; max-width: 500px; flex: 1; }
    .room-card { 
        background: rgba(30, 38, 66, 0.6); border: 1px solid #1e2642; border-radius: 18px; 
        padding: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
        animation: slideIn 0.4s ease-out; backdrop-filter: blur(5px);
    }
    @keyframes slideIn { from { opacity:0; transform: translateY(15px); } to { opacity:1; transform: translateY(0); } }
    
    .room-info h4 { color: #4fd1ff; margin-bottom: 4px; font-size: 16px; }
    .room-info p { font-size: 12px; opacity: 0.6; font-weight: 500; }
    .bet-tag { background: #ff5f00; color: white; padding: 5px 12px; border-radius: 8px; font-weight: 900; font-size: 13px; box-shadow: 0 2px 8px rgba(255, 95, 0, 0.3); }

    /* --- OYUN ALANI (Hƒ∞√áBƒ∞R ≈ûEYE ZARAR VERƒ∞LMEDƒ∞) --- */
    .game-ui { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }

    .top-bar{
        position:fixed;top:0;width:100%;height:60px;
        display:flex;align-items:center;justify-content:space-between;
        padding:0 12px; background: rgba(10, 15, 30, 0.9);
        backdrop-filter: blur(10px); border-bottom: 1px solid #1e2642; z-index:1000;
    }

    .brand{ font-size:16px;font-weight:900; background:linear-gradient(90deg,#4fd1ff,#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .right-menu{display:flex;gap:6px;align-items:center;}
    .nav-box{padding:6px 10px; border-radius:10px; font-weight:700; font-size:11px; min-width:85px; text-align:center;}
    .balance-box{background:#1a2248; border: 1px solid #4fd1ff44; color: #4fd1ff;}
    .bet-box{background:linear-gradient(90deg,#ff8a00,#ff5f00); color:#000;}

    .score-board { margin-top: 80px; font-weight: bold; color: #ffcc00; font-size: 14px; background: rgba(0,0,0,0.3); padding: 4px 15px; border-radius: 20px; }

    .table {
        width:92%; max-width:500px; height:380px; border-radius:180px; position:relative;
        background:radial-gradient(circle at center,#1a8a4d,#0a4d23 80%);
        box-shadow:inset 0 0 100px #000, 0 10px 40px rgba(0,0,0,0.5);
        margin-top: 20px; border: 10px solid #2d1f14;
    }

    .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75px; height:105px; }
    .stack-card { width:75px; position:absolute; left:0; top:0; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); background:white;}

    .hand, .opponent { position:absolute; left:50%; transform:translateX(-50%); display:flex; gap:6px; width: max-content; padding: 10px; min-height: 100px;}
    .hand { bottom:-55px; }
    .opponent { top:-55px; }

    .card { width:65px; border-radius: 6px; cursor:pointer; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background:white;}
    .hand .card:hover { transform: translateY(-15px); }

    /* CASƒ∞NO √áƒ∞PLERƒ∞ VE MODAL (G√ñRSELDEKƒ∞ TASARIM) */
    .chip-options { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
    .chip-btn { 
        width: 50px; height: 50px; border-radius: 50%; border: 3px dashed rgba(255,255,255,0.4);
        display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900;
        cursor: pointer; transition: 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    .chip-btn:active { transform: scale(0.9) rotate(15deg); }
    .c100 { background: radial-gradient(#fff, #ccc); color:#000; } 
    .c500 { background: radial-gradient(#2ecc71, #27ae60); color:#fff; } 
    .c2k { background: radial-gradient(#3498db, #2980b9); color:#fff; } 
    .c10k { background: radial-gradient(#f1c40f, #f39c12); color:#fff; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(3, 5, 10, 0.95); display: none; align-items: center; justify-content: center; z-index: 10000;
        backdrop-filter: blur(10px);
    }
    .modal-content {
        background: linear-gradient(135deg, #0b1437, #03050a); color: white; padding: 30px; 
        border-radius: 30px; width: 90%; max-width: 350px; text-align: center; 
        border: 2px solid #4fd1ff; box-shadow: 0 0 30px rgba(79, 209, 255, 0.2);
    }
    .modal-title { color: #4fd1ff; font-weight: 900; font-size: 22px; letter-spacing: 1px; margin-bottom: 10px; }
    .modal-bet-val { font-size: 32px; font-weight: 900; color: #fff; margin: 10px 0; }
    .modal-btn { background: #4fd1ff; color: #03050a; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 900; cursor: pointer; margin-top: 15px; font-size: 14px; }
    .cancel-btn { background: #ff3b30; color: white; margin-top: 10px; }

    #pistiDisplay {
        position: fixed; top: 45%; left: 50%; transform: translate(-50%,-50%);
        font-size: 80px; font-weight: 900; color: #fff; text-align: center;
        background: linear-gradient(to bottom, #fff, #ffcc00, #ff6600);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 15px rgba(255, 102, 0, 0.8));
        display: none; z-index: 9999; pointer-events: none;
    }
</style>
</head>
<body>

<div id="lobbyScreen">
    <div class="lobby-header">
        <div class="brand" style="font-size: 28px;">PISTI ONLINE</div>
        <div class="user-info">
            <div id="lobbyName" style="font-weight: 900; font-size: 12px; color: #4fd1ff;">Y√úKLENƒ∞YOR...</div>
            <div id="lobbyBalance" style="font-weight: 800; font-size: 15px;">‚Ç∫0</div>
        </div>
    </div>

    <div class="lobby-actions">
        <button class="lobby-btn btn-create" onclick="openCreateModal()">ARENA KUR</button>
        <button class="lobby-btn btn-quick" onclick="quickJoin()">HIZLI KATIL</button>
    </div>

    <div class="search-bar">
        <input type="text" id="roomSearch" placeholder="Oda ID veya Sahibi Ara..." oninput="filterRooms()">
    </div>

    <div class="rooms-container" id="roomsList">
        </div>
</div>

<div class="game-ui" id="gameScreen">
    <div class="top-bar">
        <div class="brand">ODA: <span id="currentRoomCode" style="color:#fff">#---</span></div>
        <div class="right-menu">
            <div class="nav-box balance-box">‚Ç∫<span id="gameBalance">0</span></div>
            <div class="nav-box bet-box">B: ‚Ç∫<span id="gameBet">0</span></div>
        </div>
    </div>

    <div class="score-board">RAKƒ∞P: <span id="cs">0</span> ‚Äî Sƒ∞Z: <span id="ps">0</span></div>

    <div class="table" id="tableArea">
        <div class="opponent" id="opponentHand"></div>
        <div class="table-cards" id="tableCards"></div>
        <div class="hand" id="playerHand"></div>
    </div>
</div>

<div id="pistiDisplay">Pƒ∞≈ûTƒ∞!</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
        <div id="modalBody"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87",
    databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rdb = getDatabase(app);

const sfx = {
    chip: new Audio("https://cdn.freesound.org/previews/201/201491_3325145-lq.mp3"),
    cardThrow: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3"),
    cardCollect: new Audio("https://cdn.freesound.org/previews/202/202029_3325145-lq.mp3"),
    win: new Audio("https://cdn.freesound.org/previews/391/391539_5235550-lq.mp3"),
    lose: new Audio("https://cdn.freesound.org/previews/174/174499_1079313-lq.mp3"),
    pisti: new Audio("https://cdn.freesound.org/previews/253/253177_4404552-lq.mp3"),
    deal: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3")
};

let user = null, userData = null, currentRoomId = null, allRooms = {}, selectedBet = 0;

onAuthStateChanged(auth, async u => {
    if (!u) return;
    user = u;
    onSnapshot(doc(db, "users", u.uid), snap => {
        userData = snap.data();
        document.getElementById("lobbyName").innerText = userData.username.toUpperCase();
        document.getElementById("lobbyBalance").innerText = "‚Ç∫" + userData.balance.toLocaleString();
        document.getElementById("gameBalance").innerText = userData.balance.toLocaleString();
    });
    listenRooms();
});

// LOBƒ∞ CANLI G√úNCELLEME
function listenRooms() {
    onValue(ref(rdb, 'rooms'), (snap) => {
        allRooms = snap.val() || {};
        renderRooms(allRooms);
    });
}

function renderRooms(rooms) {
    const list = document.getElementById("roomsList");
    list.innerHTML = "";
    Object.entries(rooms).forEach(([id, room]) => {
        if (room.status === "waiting") {
            const card = document.createElement("div");
            card.className = "room-card";
            card.innerHTML = `
                <div class="room-info">
                    <h4>${room.ownerName}</h4>
                    <p>#${id.substring(0,6).toUpperCase()}</p>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="bet-tag">‚Ç∫${room.bet.toLocaleString()}</div>
                    <button class="lobby-btn btn-create" style="padding:10px 20px; font-size:12px;" onclick="joinRoom('${id}')">KATIL</button>
                </div>
            `;
            list.appendChild(card);
        }
    });
}

// ODA KURMA (CASƒ∞NO √áƒ∞PLERƒ∞YLE)
window.openCreateModal = () => {
    selectedBet = 0;
    const body = document.getElementById("modalBody");
    body.innerHTML = `
        <div class="modal-title">BAHƒ∞S BELƒ∞RLE</div>
        <div class="modal-bet-val" id="modalBetDisplay">‚Ç∫0</div>
        <div class="chip-options">
            <div class="chip-btn c100" onclick="addModalBet(100)">100</div>
            <div class="chip-btn c500" onclick="addModalBet(500)">500</div>
            <div class="chip-btn c2k" onclick="addModalBet(2000)">2K</div>
            <div class="chip-btn c10k" onclick="addModalBet(10000)">10K</div>
        </div>
        <button class="modal-btn" onclick="confirmCreate()">ODA OLU≈ûTUR</button>
        <button class="modal-btn cancel-btn" onclick="closeModal()">ƒ∞PTAL</button>
    `;
    document.getElementById("modalOverlay").style.display = "flex";
};

window.addModalBet = (val) => {
    if (userData.balance < selectedBet + val) return;
    selectedBet += val;
    sfx.chip.currentTime = 0; sfx.chip.play();
    document.getElementById("modalBetDisplay").innerText = "‚Ç∫" + selectedBet.toLocaleString();
};

window.confirmCreate = async () => {
    if (selectedBet < 100) return alert("Minimum bahis 100‚Ç∫!");
    const roomRef = push(ref(rdb, 'rooms'));
    const roomId = roomRef.key;
    const roomData = {
        owner: user.uid, ownerName: userData.username,
        bet: selectedBet, status: "waiting", table: [],
        deck: createDeck(), turn: user.uid,
        players: { [user.uid]: { name: userData.username, score: 0, hand: [] } }
    };
    await set(roomRef, roomData);
    onDisconnect(roomRef).remove();
    enterRoom(roomId);
};

window.joinRoom = async (roomId) => {
    const room = allRooms[roomId];
    if (userData.balance < room.bet) return alert("Bakiyeniz yetersiz!");
    const updates = {};
    updates[`rooms/${roomId}/players/${user.uid}`] = { name: userData.username, score: 0, hand: [] };
    updates[`rooms/${roomId}/status`] = "playing";
    await update(ref(rdb), updates);
    enterRoom(roomId);
};

// OYUN MANTIƒûI (TAM OPTƒ∞Mƒ∞ZE)
async function enterRoom(roomId) {
    currentRoomId = roomId;
    document.getElementById("lobbyScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "flex";
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("currentRoomCode").innerText = "#" + roomId.substring(0,6).toUpperCase();

    onValue(ref(rdb, `rooms/${roomId}`), (snap) => {
        const data = snap.val();
        if (!data) { location.reload(); return; }
        updateGameUI(data);
    });
}

function updateGameUI(data) {
    const me = data.players[user.uid];
    const opponentId = Object.keys(data.players).find(id => id !== user.uid);
    const opponent = opponentId ? data.players[opponentId] : { score: 0, hand: [] };

    document.getElementById("ps").innerText = me.score;
    document.getElementById("cs").innerText = opponent.score;
    document.getElementById("gameBet").innerText = data.bet.toLocaleString();

    // Masayƒ± ve Elleri olu≈ütur (Orijinal animasyonlara zarar vermeden)
    renderTable(data.table);
    renderMyHand(me.hand, data.turn === user.uid, data);
    renderOpponentHand(opponent.hand);

    // Oyun ba≈ülama kontrol√º
    if (data.owner === user.uid && data.status === "playing" && (me.hand || []).length === 0 && (opponent.hand || []).length === 0) {
        if (data.deck && data.deck.length > 0) dealNextRound(data);
        else finishGame(data);
    }
}

function renderTable(table) {
    const tc = document.getElementById("tableCards"); tc.innerHTML = "";
    (table || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = i === (table.length - 1) ? `https://deckofcardsapi.com/static/img/${c}.png` : `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "stack-card";
        img.style.transform = `rotate(${i * 2}deg)`;
        tc.appendChild(img);
    });
}

function renderMyHand(hand, myTurn, data) {
    const ph = document.getElementById("playerHand"); ph.innerHTML = "";
    (hand || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/${c}.png`;
        img.className = "card";
        if (myTurn) img.onclick = () => playCard(c, i, data);
        ph.appendChild(img);
    });
}

function renderOpponentHand(hand) {
    const oh = document.getElementById("opponentHand"); oh.innerHTML = "";
    const count = hand ? (Array.isArray(hand) ? hand.length : Object.keys(hand).length) : 0;
    for(let i=0; i<count; i++) {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "card";
        oh.appendChild(img);
    }
}

async function playCard(card, idx, data) {
    const newHand = data.players[user.uid].hand.filter((_, i) => i !== idx);
    const newTable = [...(data.table || []), card];
    const opponentId = Object.keys(data.players).find(id => id !== user.uid);
    let scorePlus = 0;

    if (newTable.length >= 2) {
        const last = newTable[newTable.length-1], prev = newTable[newTable.length-2];
        if (last[0] === prev[0] || last[0] === 'J') {
            scorePlus = newTable.length;
            if (newTable.length === 2 && last[0] === prev[0]) { 
                scorePlus = 10; sfx.pisti.play();
                document.getElementById("pistiDisplay").style.display="block";
                setTimeout(()=>document.getElementById("pistiDisplay").style.display="none", 1200);
            }
            sfx.cardCollect.play();
            const up = {};
            up[`rooms/${currentRoomId}/table`] = [];
            up[`rooms/${currentRoomId}/players/${user.uid}/score`] = data.players[user.uid].score + scorePlus;
            up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = newHand;
            up[`rooms/${currentRoomId}/turn`] = opponentId;
            await update(ref(rdb), up);
            return;
        }
    }
    sfx.cardThrow.play();
    const up = {};
    up[`rooms/${currentRoomId}/table`] = newTable;
    up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = newHand;
    up[`rooms/${currentRoomId}/turn`] = opponentId;
    await update(ref(rdb), up);
}

async function dealNextRound(data) {
    sfx.deal.play();
    const deck = [...data.deck];
    const p1 = deck.splice(0,4), p2 = deck.splice(0,4);
    const oppId = Object.keys(data.players).find(id => id !== user.uid);
    const up = {};
    up[`rooms/${currentRoomId}/deck`] = deck;
    up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = p1;
    up[`rooms/${currentRoomId}/players/${oppId}/hand`] = p2;
    if((data.table||[]).length === 0) {
        up[`rooms/${currentRoomId}/table`] = deck.splice(0,4);
        up[`rooms/${currentRoomId}/deck`] = deck;
    }
    await update(ref(rdb), up);
}

async function finishGame(data) {
    const me = data.players[user.uid], opp = data.players[Object.keys(data.players).find(id=>id!==user.uid)];
    let res = userData.balance;
    let msg = "";
    if(me.score > opp.score) { res += data.bet; msg = "KAZANDIN! üèÜ"; sfx.win.play(); }
    else if(me.score < opp.score) { res -= data.bet; msg = "KAYBETTƒ∞N! ‚ùå"; sfx.lose.play(); }
    else { msg = "BERABERE! ü§ù"; }

    await updateDoc(doc(db, "users", user.uid), { balance: res });
    await remove(ref(rdb, `rooms/${currentRoomId}`));
    const body = document.getElementById("modalBody");
    body.innerHTML = `<h2 style="color:#4fd1ff">${msg}</h2><button class="modal-btn" onclick="location.reload()">LOBƒ∞YE D√ñN</button>`;
    document.getElementById("modalOverlay").style.display = "flex";
}

function createDeck() {
    const s = ["H","D","C","S"], v = ["A","2","3","4","5","6","7","8","9","0","J","Q","K"];
    let d = []; s.forEach(x => v.forEach(y => d.push(y+x)));
    return d.sort(() => Math.random() - 0.5);
}

window.quickJoin = () => {
    const entry = Object.entries(allRooms).find(([id, r]) => r.status === "waiting" && r.bet <= userData.balance);
    if(entry) joinRoom(entry[0]); else alert("Uygun oda bulunamadƒ±!");
};

window.closeModal = () => document.getElementById("modalOverlay").style.display = "none";
</script>
</body>
</html>

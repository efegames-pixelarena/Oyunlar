<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Pişti Online</title>

<style>
    * { 
        margin:0; padding:0; box-sizing:border-box; 
        -webkit-tap-highlight-color:transparent; 
        user-select:none; touch-action: manipulation; 
    }
    
    body {
        height:100vh; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
        background:#03050a; color:white;
    }

    /* --- LOBİ TASARIMI --- */
    #lobbyScreen {
        position: fixed; inset: 0; background: radial-gradient(circle at top, #0b1437, #03050a);
        z-index: 9000; display: flex; flex-direction: column; align-items: center; padding: 20px;
        overflow-y: auto;
    }

    .lobby-header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { background: rgba(79, 209, 255, 0.1); padding: 10px 20px; border-radius: 15px; border: 1px solid #4fd1ff44; }

    .lobby-actions { width: 100%; max-width: 500px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .lobby-btn { 
        padding: 15px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; 
        transition: 0.2s; font-size: 14px; text-transform: uppercase;
    }
    .btn-create { background: #4fd1ff; color: #03050a; }
    .btn-quick { background: #ffcc00; color: #03050a; }

    .search-bar { width: 100%; max-width: 500px; margin-bottom: 20px; position: relative; }
    .search-bar input { 
        width: 100%; padding: 12px 15px; border-radius: 10px; background: rgba(255,255,255,0.05); 
        border: 1px solid #1e2642; color: white; outline: none;
    }

    .rooms-container { width: 100%; max-width: 500px; flex: 1; }
    .room-card { 
        background: rgba(30, 38, 66, 0.5); border: 1px solid #1e2642; border-radius: 15px; 
        padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    
    .room-info h4 { color: #4fd1ff; margin-bottom: 4px; }
    .room-info p { font-size: 12px; opacity: 0.7; }
    .bet-tag { background: #ff5f00; color: white; padding: 4px 8px; border-radius: 6px; font-weight: 900; font-size: 12px; }

    /* --- OYUN ALANI --- */
    .game-ui { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }

    .top-bar{
        position:fixed;top:0;width:100%;height:60px;
        display:flex;align-items:center;justify-content:space-between;
        padding:0 12px; background: rgba(10, 15, 30, 0.9);
        backdrop-filter: blur(10px); border-bottom: 1px solid #1e2642; z-index:1000;
    }

    .brand{ font-size:16px;font-weight:900; background:linear-gradient(90deg,#4fd1ff,#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .right-menu{display:flex;gap:6px;align-items:center;}
    .nav-box{padding:6px 10px; border-radius:10px; font-weight:700; font-size:11px; min-width:85px; text-align:center;}
    .balance-box{background:#1a2248; border: 1px solid #4fd1ff44; color: #4fd1ff;}
    .bet-box{background:linear-gradient(90deg,#ff8a00,#ff5f00); color:#000;}

    .score-board { margin-top: 80px; font-weight: bold; color: #ffcc00; font-size: 14px; background: rgba(0,0,0,0.3); padding: 4px 15px; border-radius: 20px; }

    .table {
        width:92%; max-width:500px; height:380px; border-radius:180px; position:relative;
        background:radial-gradient(circle at center,#1a8a4d,#0a4d23 80%);
        box-shadow:inset 0 0 100px #000, 0 10px 40px rgba(0,0,0,0.5);
        margin-top: 20px; border: 10px solid #2d1f14;
    }

    .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:75px; height:105px; }
    .stack-card { width:75px; position:absolute; left:0; top:0; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); background:white;}

    .hand, .opponent { position:absolute; left:50%; transform:translateX(-50%); display:flex; gap:6px; width: max-content; padding: 10px; min-height: 100px;}
    .hand { bottom:-55px; }
    .opponent { top:-55px; }

    .card { width:65px; border-radius: 6px; cursor:pointer; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); background:white;}
    .hand .card:hover { transform: translateY(-15px); }

    .deal-anim-card {
        position: fixed; width: 65px; height: 91px; border-radius: 6px;
        background-image: url('https://deckofcardsapi.com/static/img/back.png');
        background-size: cover; z-index: 5000;
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .card-throw { position:absolute; width:65px; z-index:2000; transition:all 0.4s cubic-bezier(.25,.8,.25,1); border-radius: 6px; }

    /* CHIP TASARIMI */
    .chip-options { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
    .chip-btn { 
        width: 45px; height: 45px; border-radius: 50%; border: 3px dashed rgba(255,255,255,0.4);
        display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900;
        cursor: pointer; transition: 0.2s;
    }
    .chip-btn:active { transform: scale(0.9); }
    .c100 { background: radial-gradient(#fff, #ccc); color:#000; } 
    .c500 { background: radial-gradient(#2ecc71, #27ae60); color:#fff; } 
    .c2000 { background: radial-gradient(#3498db, #2980b9); color:#fff; } 
    .c10000 { background: radial-gradient(#f1c40f, #f39c12); color:#fff; }

    #pistiDisplay {
        position: fixed; top: 45%; left: 50%; transform: translate(-50%,-50%);
        font-size: 80px; font-weight: 900; color: #fff; text-align: center;
        background: linear-gradient(to bottom, #fff, #ffcc00, #ff6600);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 15px rgba(255, 102, 0, 0.8));
        display: none; z-index: 9999; pointer-events: none;
    }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(11, 16, 35, 0.9); display: none; align-items: center; justify-content: center; z-index: 10000;
        backdrop-filter: blur(8px);
    }
    .modal-content {
        background: linear-gradient(135deg, #1a2a6c, #0b1023); color: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 320px;
        text-align: center; border: 2px solid #4fd1ff;
    }
    .modal-btn { background: #4fd1ff; color: #0b1023; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 800; cursor: pointer; margin-top: 10px;}
    .cancel-btn { background: #ff3b30; color: white; margin-top: 5px; }
</style>
</head>
<body>

<div id="lobbyScreen">
    <div class="lobby-header">
        <div class="brand" style="font-size: 24px;">PISTI ONLINE</div>
        <div class="user-info">
            <div id="lobbyName" style="font-weight: 900; font-size: 12px; color: #4fd1ff;">Giriş Yapılıyor...</div>
            <div id="lobbyBalance" style="font-weight: 700; font-size: 14px;">₺0</div>
        </div>
    </div>

    <div class="lobby-actions">
        <button class="lobby-btn btn-create" onclick="openCreateModal()">ARENA KUR</button>
        <button class="lobby-btn btn-quick" onclick="quickJoin()">HIZLI KATIL</button>
    </div>

    <div class="search-bar">
        <input type="text" id="roomSearch" placeholder="Oda sahibi veya kodu ile ara..." oninput="filterRooms()">
    </div>

    <div class="rooms-container" id="roomsList">
        </div>
</div>

<div class="game-ui" id="gameScreen">
    <div class="top-bar">
        <div class="brand">Oda: <span id="currentRoomCode" style="color:#fff">#---</span></div>
        <div class="right-menu">
            <div class="nav-box balance-box">₺<span id="gameBalance">0</span></div>
            <div class="nav-box bet-box">B: ₺<span id="gameBet">0</span></div>
        </div>
    </div>

    <div class="score-board">RAKİP: <span id="cs">0</span> — SİZ: <span id="ps">0</span></div>

    <div class="table" id="tableArea">
        <div class="opponent" id="opponentHand"></div>
        <div class="table-cards" id="tableCards"></div>
        <div class="hand" id="playerHand"></div>
    </div>
</div>

<div id="pistiDisplay">PİŞTİ!</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent">
        <div id="modalBody"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87",
    databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rdb = getDatabase(app);

const sfx = {
    chip: new Audio("https://cdn.freesound.org/previews/201/201491_3325145-lq.mp3"),
    cardThrow: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3"),
    cardCollect: new Audio("https://cdn.freesound.org/previews/202/202029_3325145-lq.mp3"),
    win: new Audio("https://cdn.freesound.org/previews/391/391539_5235550-lq.mp3"),
    lose: new Audio("https://cdn.freesound.org/previews/174/174499_1079313-lq.mp3"),
    pisti: new Audio("https://cdn.freesound.org/previews/253/253177_4404552-lq.mp3"),
    deal: new Audio("https://cdn.freesound.org/previews/240/240776_4107740-lq.mp3")
};

let user = null, userData = null, currentRoomId = null, allRooms = {}, selectedBet = 0;

onAuthStateChanged(auth, async u => {
    if (!u) return;
    user = u;
    onSnapshot(doc(db, "users", u.uid), snap => {
        userData = snap.data();
        document.getElementById("lobbyName").innerText = userData.username.toUpperCase();
        document.getElementById("lobbyBalance").innerText = "₺" + userData.balance.toLocaleString();
        document.getElementById("gameBalance").innerText = userData.balance.toLocaleString();
    });
    listenRooms();
});

// LOBİ MANTIĞI
function listenRooms() {
    const roomsRef = ref(rdb, 'rooms');
    onValue(roomsRef, (snapshot) => {
        allRooms = snapshot.val() || {};
        renderRooms(allRooms);
    });
}

function renderRooms(rooms) {
    const list = document.getElementById("roomsList");
    list.innerHTML = "";
    Object.entries(rooms).forEach(([id, room]) => {
        if (room.status === "waiting") {
            const card = document.createElement("div");
            card.className = "room-card";
            card.innerHTML = `
                <div class="room-info">
                    <h4>${room.ownerName} Arenası</h4>
                    <p>ID: #${id.substring(0,6)}</p>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="bet-tag">₺${room.bet.toLocaleString()}</div>
                    <button class="lobby-btn btn-create" style="padding:8px 15px; font-size:12px;" onclick="joinRoom('${id}')">KATIL</button>
                </div>
            `;
            list.appendChild(card);
        }
    });
}

window.filterRooms = () => {
    const term = document.getElementById("roomSearch").value.toLowerCase();
    const filtered = {};
    Object.entries(allRooms).forEach(([id, room]) => {
        if (id.includes(term) || room.ownerName.toLowerCase().includes(term)) filtered[id] = room;
    });
    renderRooms(filtered);
};

// ODA KURMA (CASİNO ÇİPLERİYLE)
window.openCreateModal = () => {
    selectedBet = 0;
    const body = document.getElementById("modalBody");
    body.innerHTML = `
        <h2 style="color:#4fd1ff">BAHİS BELİRLE</h2>
        <div id="modalBetDisplay" style="font-size:24px; font-weight:900; margin:15px 0;">₺0</div>
        <div class="chip-options">
            <div class="chip-btn c100" onclick="addModalBet(100)">100</div>
            <div class="chip-btn c500" onclick="addModalBet(500)">500</div>
            <div class="chip-btn c2000" onclick="addModalBet(2000)">2K</div>
            <div class="chip-btn c10000" onclick="addModalBet(10000)">10K</div>
        </div>
        <button class="modal-btn" onclick="confirmCreate()">ODA OLUŞTUR</button>
        <button class="modal-btn cancel-btn" onclick="closeModal()">İPTAL</button>
    `;
    document.getElementById("modalOverlay").style.display = "flex";
};

window.addModalBet = (val) => {
    if (userData.balance < selectedBet + val) return;
    selectedBet += val;
    sfx.chip.currentTime = 0; sfx.chip.play();
    document.getElementById("modalBetDisplay").innerText = "₺" + selectedBet.toLocaleString();
};

window.confirmCreate = async () => {
    if (selectedBet < 100) return alert("Min bahis 100₺!");
    const roomRef = push(ref(rdb, 'rooms'));
    const roomId = roomRef.key;
    const initialData = {
        owner: user.uid,
        ownerName: userData.username,
        bet: selectedBet,
        status: "waiting",
        table: [],
        deck: createDeck(),
        players: {
            [user.uid]: { name: userData.username, score: 0, hand: [] }
        },
        turn: user.uid
    };
    await set(roomRef, initialData);
    onDisconnect(roomRef).remove();
    enterRoom(roomId);
};

window.joinRoom = async (roomId) => {
    const room = allRooms[roomId];
    if (userData.balance < room.bet) return alert("Bakiye yetersiz!");
    
    const updates = {};
    updates[`rooms/${roomId}/players/${user.uid}`] = { name: userData.username, score: 0, hand: [] };
    updates[`rooms/${roomId}/status`] = "playing";
    await update(ref(rdb), updates);
    enterRoom(roomId);
};

window.quickJoin = () => {
    const entry = Object.entries(allRooms).find(([id, r]) => r.status === "waiting" && r.bet <= userData.balance);
    if (entry) joinRoom(entry[0]);
    else alert("Uygun oda bulunamadı.");
};

// OYUN DÖNGÜSÜ
async function enterRoom(roomId) {
    currentRoomId = roomId;
    document.getElementById("lobbyScreen").style.display = "none";
    document.getElementById("gameScreen").style.display = "flex";
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("currentRoomCode").innerText = "#" + roomId.substring(0,6);

    onValue(ref(rdb, `rooms/${roomId}`), (snapshot) => {
        const data = snapshot.val();
        if (!data) { location.reload(); return; }
        syncGame(data);
    });
}

function syncGame(data) {
    const me = data.players[user.uid];
    const opponentId = Object.keys(data.players).find(id => id !== user.uid);
    const opponent = opponentId ? data.players[opponentId] : { name: "Bekleniyor...", score: 0, hand: [] };

    document.getElementById("ps").innerText = me.score;
    document.getElementById("cs").innerText = opponent.score;
    document.getElementById("gameBet").innerText = data.bet.toLocaleString();

    // Masayı Çiz
    const tCards = document.getElementById("tableCards");
    tCards.innerHTML = "";
    (data.table || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = i === (data.table.length - 1) ? `https://deckofcardsapi.com/static/img/${c}.png` : `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "stack-card";
        img.style.transform = `rotate(${i * 3}deg)`;
        tCards.appendChild(img);
    });

    // Kendi Elini Çiz
    const pHand = document.getElementById("playerHand");
    pHand.innerHTML = "";
    (me.hand || []).forEach((c, i) => {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/${c}.png`;
        img.className = "card";
        if (data.turn === user.uid) img.onclick = () => playCard(c, i, data);
        pHand.appendChild(img);
    });

    // Rakip Elini Çiz (Arkalık)
    const oHand = document.getElementById("opponentHand");
    oHand.innerHTML = "";
    const oppHandCount = opponent.hand ? (Array.isArray(opponent.hand) ? opponent.hand.length : Object.keys(opponent.hand).length) : 0;
    for(let i=0; i < oppHandCount; i++) {
        const img = document.createElement("img");
        img.src = `https://deckofcardsapi.com/static/img/back.png`;
        img.className = "card";
        oHand.appendChild(img);
    }

    // Oyun Başlatma (Sadece oda sahibi ve rakip geldiğinde)
    if (data.owner === user.uid && data.status === "playing" && (me.hand || []).length === 0 && oppHandCount === 0) {
        if (data.deck && data.deck.length > 0) dealRound(data);
        else finalizeGame(data);
    }
}

async function playCard(card, index, data) {
    const newHand = data.players[user.uid].hand.filter((_, i) => i !== index);
    const newTable = [...(data.table || []), card];
    const opponentId = Object.keys(data.players).find(id => id !== user.uid);
    
    let scorePlus = 0;
    let isPisti = false;

    if (newTable.length >= 2) {
        const last = newTable[newTable.length - 1];
        const prev = newTable[newTable.length - 2];
        if (last[0] === prev[0] || last[0] === 'J') {
            scorePlus = newTable.length;
            if (newTable.length === 2 && last[0] === prev[0]) { scorePlus = 10; isPisti = true; }
            sfx.cardCollect.play();
            if(isPisti) {
                sfx.pisti.play();
                const pDisp = document.getElementById("pistiDisplay");
                pDisp.style.display = "block";
                setTimeout(() => pDisp.style.display = "none", 1500);
            }
            const up = {};
            up[`rooms/${currentRoomId}/table`] = [];
            up[`rooms/${currentRoomId}/players/${user.uid}/score`] = data.players[user.uid].score + scorePlus;
            up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = newHand;
            up[`rooms/${currentRoomId}/turn`] = opponentId;
            await update(ref(rdb), up);
            return;
        }
    }

    sfx.cardThrow.play();
    const up = {};
    up[`rooms/${currentRoomId}/table`] = newTable;
    up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = newHand;
    up[`rooms/${currentRoomId}/turn`] = opponentId;
    await update(ref(rdb), up);
}

async function dealRound(data) {
    sfx.deal.play();
    const deck = [...data.deck];
    const p1Hand = deck.splice(0, 4);
    const p2Hand = deck.splice(0, 4);
    const opponentId = Object.keys(data.players).find(id => id !== user.uid);

    const up = {};
    up[`rooms/${currentRoomId}/deck`] = deck;
    up[`rooms/${currentRoomId}/players/${user.uid}/hand`] = p1Hand;
    up[`rooms/${currentRoomId}/players/${opponentId}/hand`] = p2Hand;
    
    if ((data.table || []).length === 0) {
        up[`rooms/${currentRoomId}/table`] = deck.splice(0, 4);
        up[`rooms/${currentRoomId}/deck`] = deck;
    }
    await update(ref(rdb), up);
}

async function finalizeGame(data) {
    const me = data.players[user.uid];
    const opp = data.players[Object.keys(data.players).find(id => id !== user.uid)];
    
    let finalBalance = userData.balance;
    let statusMsg = "";

    if (me.score > opp.score) {
        finalBalance += data.bet;
        statusMsg = `TEBRİKLER!\n₺${(data.bet * 2).toLocaleString()} Kazandınız.`;
        sfx.win.play();
    } else if (me.score < opp.score) {
        finalBalance -= data.bet;
        statusMsg = "KAYBETTİNİZ!\nRakip kazandı.";
        sfx.lose.play();
    } else {
        statusMsg = "BERABERE!\nBahisler iade edildi.";
    }

    await updateDoc(doc(db, "users", user.uid), { balance: finalBalance });
    await remove(ref(rdb, `rooms/${currentRoomId}`));
    
    const body = document.getElementById("modalBody");
    body.innerHTML = `<h2>OYUN BİTTİ</h2><p style="margin:15px 0; font-weight:800;">${statusMsg}</p><button class="modal-btn" onclick="location.reload()">LOBİYE DÖN</button>`;
    document.getElementById("modalOverlay").style.display = "flex";
}

// YARDIMCI FONKSİYONLAR
function createDeck() {
    const suits = ["H", "D", "C", "S"], vals = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "0", "J", "Q", "K"];
    let d = [];
    suits.forEach(s => vals.forEach(v => d.push(v + s)));
    return d.sort(() => Math.random() - 0.5);
}

window.closeModal = () => document.getElementById("modalOverlay").style.display = "none";

</script>
</body>
</html>

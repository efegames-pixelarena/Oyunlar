<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PixelArena Pişti | Elite V21</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --p1: #ff0055; --p2: #00f2ff; --bg: #03050a;
            --glass: rgba(18, 22, 33, 0.98); --border: #ffcc00;
            --danger: #ff2d55; --warning: #ffb800; --accent: #7d00ff;
            --btn-main: #ffcc00; --btn-sec: #00f2ff;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { background: var(--bg); color: #e0e0e0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; position: relative; }

        .header { height: 70px; flex-shrink: 0; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--border); z-index: 1000; }
        .logo { font-family: 'Black Ops One'; font-size: 1.2rem; color: var(--border); letter-spacing: 2px; }
        .user-badge { font-weight: 700; color: var(--p2); font-size: 0.8rem; border-left: 2px solid var(--p2); padding-left: 8px; }

        #lobby { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; z-index: 10; }
        .search-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,204,0,0.3); padding: 12px 15px; color: #fff; border-radius: 4px; outline: none; }
        
        .btn-neon { background: var(--btn-main); color: #000; border: none; padding: 15px; font-family: 'Black Ops One'; font-size: 0.85rem; cursor: pointer; clip-path: polygon(4% 0, 100% 0, 96% 100%, 0 100%); transition: 0.3s; text-align: center; }
        .btn-sec { background: var(--btn-sec); }

        .room-card { background: var(--glass); border: 1px solid rgba(255, 204, 0, 0.2); border-left: 5px solid var(--border); padding: 18px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-radius: 0 8px 8px 0; }

        #game-view { display: none; flex: 1; flex-direction: column; z-index: 10; align-items: center; }
        .game-hud { width: 100%; height: 80px; display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        .score-num { font-family: 'Black Ops One'; font-size: 1.8rem; color: var(--btn-sec); }

        .table { width:92%; max-width:450px; height:320px; border-radius:150px; position:relative; background:radial-gradient(circle at center,#1a8a4d,#0a4d23 80%); box-shadow:inset 0 0 80px #000; margin-top: 40px; border: 8px solid #1a1a1a; }
        .table-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:70px; height:95px; }
        .stack-card { width:70px; position:absolute; left:0; top:0; border-radius: 6px; background:white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);}

        .hand, .opponent { position:absolute; left:50%; transform:translateX(-50%); display:flex; gap:6px; min-height: 80px;}
        .hand { bottom:-45px; } .opponent { top:-45px; }
        .card { width:60px; border-radius: 6px; cursor:pointer; transition: 0.2s; background:white; border: 1px solid #ccc;}
        .hand .card:hover { transform: translateY(-10px); z-index: 100; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 9000; padding: 20px; }
        .modal-box { background: #0d1117; border: 2px solid var(--border); padding: 30px; width: 100%; max-width: 360px; text-align: center; }
        .modal-input { width: 100%; background: #161b22; border: 1px solid #30363d; padding: 14px; color: #fff; margin-bottom: 15px; outline: none; }

        #pistiDisplay { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 60px; font-family: 'Black Ops One'; color: #fff; text-shadow: 0 0 20px var(--p1); display: none; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="user-badge" id="meName">GİRİŞ YAPILIYOR...</div>
        <div class="logo">PISTI ONLINE</div>
        <div id="meBalance" style="color:var(--border); font-weight:900;">₺0</div>
    </div>

    <div id="lobby">
        <input type="text" id="roomSearch" class="search-input" placeholder="ARENA ARA..." oninput="window.filterRooms()">
        <button class="btn-neon" onclick="window.toggleModal('createArenaModal', true)">ODA KUR (BAHİSLİ)</button>
        <button class="btn-neon btn-sec" onclick="window.quickJoin()">HIZLI SAVAŞ</button>
        <div id="roomList" style="margin-top:10px;"></div>
        <div id="emptyLobbyMsg" style="text-align: center; margin-top: 50px; opacity: 0.3; font-family: 'Black Ops One'; letter-spacing: 5px;">ARENA YOK</div>
    </div>

    <div id="game-view">
        <div class="game-hud">
            <div style="text-align:center;"><small id="oppName">RAKİP</small><div class="score-num" id="cs">0</div></div>
            <div style="border: 1px solid var(--border); padding: 5px 15px; border-radius: 20px; font-family:'Black Ops One';" id="roomBet">B: 0</div>
            <div style="text-align:center;"><small id="myName">SİZ</small><div class="score-num" id="ps">0</div></div>
        </div>
        <div class="table">
            <div class="opponent" id="opponentHand"></div>
            <div class="table-cards" id="tableCards"></div>
            <div class="hand" id="playerHand"></div>
        </div>
    </div>

    <div id="pistiDisplay">PİŞTİ!</div>

    <div id="createArenaModal" class="modal">
        <div class="modal-box">
            <h3>BAHİSLİ ODA KUR</h3>
            <input type="number" id="betAmount" class="modal-input" placeholder="BAHİS (ÇİP) MİKTARI">
            <button class="btn-neon" style="width:100%" onclick="window.createArena()">KUR VE BAŞLAT</button>
            <p onclick="window.toggleModal('createArenaModal', false)" style="margin-top:20px; cursor:pointer; color:#666;">KAPAT</p>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-box">
            <h3 id="resultTitle">SONUÇ</h3>
            <p id="resultMsg" style="margin:20px 0;"></p>
            <button class="btn-neon" style="width:100%" onclick="location.reload()">LOBİYE DÖN</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain: "emirhan-site.firebaseapp.com",
        projectId: "emirhan-site",
        storageBucket: "emirhan-site.firebasestorage.app",
        messagingSenderId: "668871888390",
        appId: "1:668871888390:web:76568bda84cb1641f7bd87",
        databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rdb = getDatabase(app);

    let uid, userData, curRoomId, allRooms = {}, isMyTurn = false;

    onAuthStateChanged(auth, async user => {
        if(!user) return;
        uid = user.uid;
        onSnapshot(doc(db, "users", uid), snap => {
            if(!snap.exists()) return;
            userData = { id: uid, ...snap.data() };
            document.getElementById('meName').innerText = userData.username.toUpperCase();
            document.getElementById('meBalance').innerText = "₺" + (userData.balance || 0).toLocaleString();
        });
        listenLobby();
    });

    window.toggleModal = (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none';

    function listenLobby() {
        onValue(ref(rdb, 'rooms'), snap => {
            allRooms = snap.val() || {};
            const list = document.getElementById('roomList');
            list.innerHTML = "";
            let count = 0;
            Object.entries(allRooms).forEach(([id, r]) => {
                if(r.status === 'waiting') {
                    count++;
                    const card = document.createElement('div');
                    card.className = "room-card";
                    card.innerHTML = `
                        <div><small>#${id.slice(-4)}</small><br><b>${r.ownerName}</b></div>
                        <div style="text-align:right">
                            <div style="color:var(--btn-sec); font-weight:900;">₺${r.bet}</div>
                            <button class="btn-neon" style="padding:5px 10px; font-size:0.6rem;" onclick="window.joinRoom('${id}')">KATIL</button>
                        </div>`;
                    list.appendChild(card);
                }
            });
            document.getElementById('emptyLobbyMsg').style.display = count === 0 ? 'block' : 'none';
        });
    }

    window.createArena = async () => {
        const bet = parseInt(document.getElementById('betAmount').value);
        if(isNaN(bet) || bet < 1) return alert("Geçerli bir bahis gir!");
        if(userData.balance < bet) return alert("Yetersiz çip!");

        const roomRef = push(ref(rdb, 'rooms'));
        const roomId = roomRef.key;
        const initialData = {
            owner: uid, ownerName: userData.username, bet, status: "waiting",
            turn: uid, table: [], deck: createDeck(),
            players: { [uid]: { name: userData.username, score: 0, hand: [] } }
        };
        await set(roomRef, initialData);
        onDisconnect(roomRef).remove();
        enterGame(roomId);
    };

    window.joinRoom = async (id) => {
        const r = allRooms[id];
        if(userData.balance < r.bet) return alert("Yetersiz çip!");
        const updates = {};
        updates[`rooms/${id}/players/${uid}`] = { name: userData.username, score: 0, hand: [] };
        updates[`rooms/${id}/status`] = "playing";
        await update(ref(rdb), updates);
        enterGame(id);
    };

    function enterGame(id) {
        curRoomId = id;
        window.toggleModal('createArenaModal', false);
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-view').style.display = 'flex';
        
        onValue(ref(rdb, `rooms/${id}`), snap => {
            const data = snap.val();
            if(!data) return;
            syncGame(data);
        });
    }

    function syncGame(data) {
        const me = data.players[uid];
        const oppId = Object.keys(data.players).find(i => i !== uid);
        const opp = oppId ? data.players[oppId] : { name: "BEKLENİYOR...", score: 0, hand: [] };

        document.getElementById('ps').innerText = me.score || 0;
        document.getElementById('cs').innerText = opp.score || 0;
        document.getElementById('oppName').innerText = opp.name.toUpperCase();
        document.getElementById('roomBet').innerText = "B: " + data.bet;
        isMyTurn = data.turn === uid;

        // Masa Kartları
        const tArea = document.getElementById('tableCards'); tArea.innerHTML = "";
        const table = data.table || [];
        table.forEach((c, i) => {
            const img = document.createElement('img');
            img.src = i === (table.length - 1) ? `https://deckofcardsapi.com/static/img/${c}.png` : `https://deckofcardsapi.com/static/img/back.png`;
            img.className = "stack-card";
            img.style.transform = `translate(${i*2}px, ${i*2}px)`;
            tArea.appendChild(img);
        });

        // Oyuncu Eli
        const pHand = document.getElementById('playerHand'); pHand.innerHTML = "";
        const myCards = me.hand || [];
        myCards.forEach((c, i) => {
            const img = document.createElement('img');
            img.src = `https://deckofcardsapi.com/static/img/${c}.png`;
            img.className = "card";
            img.onclick = () => playCard(c, i, data);
            pHand.appendChild(img);
        });

        // Rakip Kartları (Kapalı)
        const oHand = document.getElementById('opponentHand'); oHand.innerHTML = "";
        const oppCardsCount = opp.hand ? (Array.isArray(opp.hand) ? opp.hand.length : Object.keys(opp.hand).length) : 0;
        for(let i=0; i<oppCardsCount; i++) {
            const img = document.createElement('img');
            img.src = `https://deckofcardsapi.com/static/img/back.png`;
            img.className = "card";
            oHand.appendChild(img);
        }

        // Kart Dağıtma Kontrolü (Sadece oda sahibi ve oyun "playing" ise)
        if(data.owner === uid && data.status === "playing" && myCards.length === 0 && oppCardsCount === 0) {
            if(data.deck && data.deck.length > 0) dealRound(data);
            else finishGame(data);
        }
    }

    async function playCard(card, idx, data) {
        if(!isMyTurn) return;
        const newHand = data.players[uid].hand.filter((_, i) => i !== idx);
        const newTable = [...(data.table || []), card];
        const oppId = Object.keys(data.players).find(i => i !== uid);
        
        let scoreGain = 0;
        if(newTable.length >= 2) {
            const top = newTable[newTable.length - 1];
            const prev = newTable[newTable.length - 2];
            if(top[0] === prev[0] || top[0] === 'J') {
                scoreGain = newTable.length;
                if(newTable.length === 2 && top[0] === prev[0]) { scoreGain = 10; showPisti(); }
                const up = {};
                up[`rooms/${curRoomId}/table`] = [];
                up[`rooms/${curRoomId}/players/${uid}/score`] = (data.players[uid].score || 0) + scoreGain;
                up[`rooms/${curRoomId}/players/${uid}/hand`] = newHand;
                up[`rooms/${curRoomId}/turn`] = oppId;
                await update(ref(rdb), up);
                return;
            }
        }
        const up = {};
        up[`rooms/${curRoomId}/table`] = newTable;
        up[`rooms/${curRoomId}/players/${uid}/hand`] = newHand;
        up[`rooms/${curRoomId}/turn`] = oppId;
        await update(ref(rdb), up);
    }

    async function dealRound(data) {
        const deck = [...data.deck];
        const p1h = deck.splice(0, 4);
        const p2h = deck.splice(0, 4);
        const oppId = Object.keys(data.players).find(i => i !== uid);
        const up = {};
        up[`rooms/${curRoomId}/deck`] = deck;
        up[`rooms/${curRoomId}/players/${uid}/hand`] = p1h;
        up[`rooms/${curRoomId}/players/${oppId}/hand`] = p2h;
        // Eğer yer boşsa yere de 4 kart koy
        if((data.table || []).length === 0) {
            up[`rooms/${curRoomId}/table`] = deck.splice(0, 4);
            up[`rooms/${curRoomId}/deck`] = deck;
        }
        await update(ref(rdb), up);
    }

    async function finishGame(data) {
        const me = data.players[uid];
        const opp = data.players[Object.keys(data.players).find(i => i !== uid)];
        let finalBal = userData.balance || 0;
        let title = "BERABERE", msg = "Puanlar eşit, iade edildi.";

        if(me.score > opp.score) {
            finalBal += data.bet; title = "ZAFER"; msg = `+₺${data.bet} Kazandın!`;
        } else if(me.score < opp.score) {
            finalBal -= data.bet; title = "BOZGUN"; msg = `-₺${data.bet} Kaybettin.`;
        }

        await updateDoc(doc(db, "users", uid), { balance: finalBal });
        await remove(ref(rdb, `rooms/${curRoomId}`));
        document.getElementById('resultTitle').innerText = title;
        document.getElementById('resultMsg').innerText = msg;
        window.toggleModal('resultModal', true);
    }

    function showPisti() {
        const el = document.getElementById('pistiDisplay');
        el.style.display = "block";
        setTimeout(() => el.style.display = "none", 1500);
    }

    function createDeck() {
        const suits = ["H", "D", "C", "S"], vals = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "0", "J", "Q", "K"];
        let d = []; suits.forEach(s => vals.forEach(v => d.push(v + s)));
        return d.sort(() => Math.random() - 0.5);
    }
</script>
</body>
</html>

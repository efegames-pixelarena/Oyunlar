<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Duel Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
:root { 
    --p: #00f2ff; --a: #ff0055; --bg: #05070a; --b: #161b22; 
    --gold: #ffcc00; --glass: rgba(10, 15, 25, 0.90); --success: #00ff88;
}

* { 
    margin:0; padding:0; box-sizing:border-box; 
    font-family: 'Rajdhani', sans-serif; 
    -webkit-tap-highlight-color:transparent; 
    touch-action: none; /* Zoom ve kaydırma hatalarını engeller */
    user-select: none; 
}

body { 
    background: var(--bg); color: white; height: 100vh; overflow: hidden; 
    display: flex; flex-direction: column; position: fixed; width: 100%;
}

/* Arkaplan Grid Efekti */
body::before {
    content: ""; position: absolute; inset: 0;
    background-image: 
        linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
    background-size: 30px 30px;
    mask-image: radial-gradient(circle at center, black, transparent 80%);
    z-index: -1;
}

.top-bar { 
    height: 70px; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
    border-bottom: 2px solid var(--p); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 15px; z-index: 1000;
}
.brand { 
    font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.1rem;
    background: linear-gradient(to bottom, #fff, var(--p)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

#userBox { font-weight: 700; color: var(--p); font-size: 0.8rem; }

#lobby { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
.lobby-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }

.search-bar input {
    width: 100%; background: var(--b); border: 1px solid #333; border-radius: 8px;
    padding: 12px; color: white; font-family: 'Orbitron'; font-size: 0.75rem;
    outline: none; transition: 0.3s;
}
.search-bar input:focus { border-color: var(--p); box-shadow: 0 0 10px rgba(0,242,255,0.2); }

.action-buttons { display: flex; gap: 8px; }
.btn {
    border: none; border-radius: 8px; font-weight: 900; font-family: 'Orbitron'; 
    font-size: 0.65rem; cursor: pointer; transition: 0.2s; padding: 15px;
}
.create-btn { flex: 1; background: var(--p); color: #000; }
.quick-btn { flex: 1; background: var(--success); color: #000; }

.room-card { 
    background: var(--glass); border: 1px solid var(--b); padding: 15px; border-radius: 15px;
    display: flex; justify-content: space-between; align-items: center;
    border-left: 4px solid var(--p); animation: slideIn 0.3s ease-out;
}

.badge-live { background: var(--a); color: white; animation: pulse 1s infinite; padding: 3px 8px; border-radius: 4px; font-size: 0.6rem;}

/* Oyun Alanı */
#game-view { display: none; flex: 1; flex-direction: column; }
.scoreboard { 
    padding: 20px; display: grid; grid-template-columns: 1fr auto 1fr; 
    align-items: center; background: rgba(0,0,0,0.5);
}
.score { font-size: 2rem; font-family: 'Orbitron'; font-weight: 900; }
.arena { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: crosshair; }

#bigText { font-family: 'Orbitron'; font-size: 4rem; font-weight: 900; text-align: center; }
.flash { background: #fff !important; }
.flash #bigText, .flash #subText { color: #000 !important; }

.penalty { color: var(--a) !important; animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
    background: var(--b); width: 90%; max-width: 350px; padding: 25px; border-radius: 20px;
    border: 1px solid var(--p); display: flex; flex-direction: column; gap: 15px;
}
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PIXELARENA PRO</div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="userBox">YÜKLENİYOR...</div>
        <button id="leaveBtn" class="btn" style="display:none; background:var(--a); color:white; padding:8px 12px;">AYRIL</button>
    </div>
</div>

<div id="lobby">
    <div class="lobby-controls">
        <div class="search-bar"><input type="text" id="searchInput" placeholder="ARENA ARA..."></div>
        <div class="action-buttons">
            <button class="btn create-btn" id="createRoomBtn">ARENA KUR</button>
            <button class="btn quick-btn" id="quickJoinBtn">HIZLI KATIL</button>
        </div>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div style="text-align:center;">
            <div id="p1Name" style="font-size:0.7rem; color:var(--p);">...</div>
            <div class="score" id="p1Score">0</div>
        </div>
        <div id="roundNum" style="color:var(--gold); font-family:'Orbitron'; font-weight:900;">RD 1</div>
        <div style="text-align:center;">
            <div id="p2Name" style="font-size:0.7rem; color:var(--a);">...</div>
            <div class="score" id="p2Score">0</div>
        </div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText">READY</div>
        <div id="subText" style="letter-spacing:5px; margin-top:10px; color:#555;">BEKLE...</div>
    </div>
</div>

<div id="genericModal" class="modal">
    <div class="modal-content" id="modalBody"></div>
</div>

<div id="winnerScreen" style="display:none; position:fixed; inset:0; background:#000; z-index:5000; flex-direction:column; justify-content:center; align-items:center;">
    <h2 style="color:var(--gold); font-family:'Orbitron';">ŞAMPİYON</h2>
    <h1 id="championName" style="font-size:3rem; margin:20px 0;">...</h1>
    <p>Lobiye dönülüyor...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87",
    databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null;
let unsubRoom = null, unsubLobby = null;
let roomData = null, tapLock = false;
let serverOffset = 0;

// 1. Geliştirme: Hassas Zaman Senkronizasyonu (RTDB Offset)
const offsetRef = ref(rtdb, ".info/serverTimeOffset");
onValue(offsetRef, (snap) => {
    serverOffset = snap.val() || 0;
});
const getServerTime = () => Date.now() + serverOffset;

// Ses Sistemi
let audioCtx = null;
const playSound = (f, t, d) => {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = t; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + d);
};

// Auth
onAuthStateChanged(auth, async (user) => {
    if (!user) { signInAnonymously(auth); return; }
    uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid));
    username = snap.exists() ? snap.data().username : "Ace_" + uid.slice(0,4);
    if(!snap.exists()) await setDoc(doc(db, "users", uid), { username });
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

// Lobi Dinleme
function listenLobby() {
    if(unsubLobby) unsubLobby();
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active", "result"]));
    unsubLobby = onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const card = document.createElement("div");
            card.className = "room-card";
            card.innerHTML = `
                <div>
                    <div style="font-weight:900;">${d.player1Name.toUpperCase()}</div>
                    <div style="font-size:0.6rem; color:#888;">${d.state === 'waiting' ? 'BEKLİYOR' : '<span class="badge-live">CANLI</span>'}</div>
                </div>
                <button class="btn create-btn" onclick="joinRoom('${doc.id}')" ${d.player2 ? 'disabled' : ''}>KATIL</button>
            `;
            list.appendChild(card);
        });
    });
}

// 2. Geliştirme: Race Condition Engelleyici Transaction'lar
window.joinRoom = async (roomId) => {
    try {
        await runTransaction(db, async (transaction) => {
            const roomRef = doc(db, "rooms", roomId);
            const snap = await transaction.get(roomRef);
            if (!snap.exists()) throw "Arena kapandı!";
            if (snap.data().player2) throw "Arena dolu!";
            
            transaction.update(roomRef, {
                player2: uid,
                player2Name: username,
                state: "matched",
                p2Ready: true
            });
        });
        currentRoomId = roomId;
        initGameView();
    } catch (e) { alert(e); }
};

document.getElementById("createRoomBtn").onclick = async () => {
    const id = "room_" + Date.now();
    await setDoc(doc(db, "rooms", id), {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid,
        p1Ready: true, p2Ready: false, lastActionTime: serverTimestamp()
    });
    currentRoomId = id;
    initGameView();
};

function initGameView() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    
    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if(!snap.exists()) { quitGame(); return; }
        roomData = snap.data();
        updateUI();
        processState();
    });
}

function updateUI() {
    document.getElementById("p1Name").innerText = roomData.player1Name.toUpperCase();
    document.getElementById("p2Name").innerText = (roomData.player2Name || "BEKLENİYOR").toUpperCase();
    document.getElementById("p1Score").innerText = roomData.score1;
    document.getElementById("p2Score").innerText = roomData.score2;
    document.getElementById("roundNum").innerText = "RD " + roomData.round;
}

// 4. Geliştirme: Mantıksal State Yönetimi
function processState() {
    const arena = document.getElementById("arena");
    const big = document.getElementById("bigText");
    const sub = document.getElementById("subText");

    switch(roomData.state) {
        case "matched":
            big.innerText = "HAZIR OL";
            sub.innerText = "RAKİP GELDİ";
            if(uid === roomData.host) {
                setTimeout(() => updateDoc(doc(db, "rooms", currentRoomId), {
                    state: "countdown",
                    startTime: getServerTime() + 2000 + Math.random() * 3000
                }), 2000);
            }
            break;
        case "countdown":
            arena.classList.remove("flash");
            big.innerText = "BEKLE";
            big.style.color = "var(--gold)";
            sub.innerText = "SAKIN BASMA";
            break;
        case "active":
            arena.classList.add("flash");
            big.innerText = "VUR!";
            big.style.color = "#000";
            sub.innerText = "HIZLI OL!";
            break;
        case "result":
            arena.classList.remove("flash");
            big.innerText = roomData.lastReaction ? roomData.lastReaction + "ms" : "HATA!";
            sub.innerText = roomData.winnerName + " KAZANDI";
            if(uid === roomData.host) {
                setTimeout(nextRound, 2000);
            }
            break;
    }
}

async function nextRound() {
    if(roomData.score1 >= 11 || roomData.score2 >= 11) {
        await updateDoc(doc(db, "rooms", currentRoomId), { state: "finished" });
        return;
    }
    await updateDoc(doc(db, "rooms", currentRoomId), {
        state: "countdown",
        round: roomData.round + 1,
        startTime: getServerTime() + 2000 + Math.random() * 3000
    });
}

// 2. Geliştirme Devamı: Puanlama Transaction'ı
document.getElementById("arena").onpointerdown = async (e) => {
    if(tapLock || !roomData || currentRoomId === null) return;
    
    const now = getServerTime();
    const isP1 = uid === roomData.player1;
    
    // Erken Basma Cezası
    if(roomData.state === "countdown") {
        tapLock = true;
        await updateDoc(doc(db, "rooms", currentRoomId), {
            state: "result",
            winnerName: isP1 ? roomData.player2Name : roomData.player1Name,
            [isP1 ? 'score2' : 'score1']: (isP1 ? roomData.score2 : roomData.score1) + 1,
            lastReaction: null
        });
        setTimeout(() => tapLock = false, 1000);
        return;
    }

    if(roomData.state === "active") {
        tapLock = true;
        const reaction = now - roomData.startTime;
        
        try {
            await runTransaction(db, async (transaction) => {
                const roomRef = doc(db, "rooms", currentRoomId);
                const snap = await transaction.get(roomRef);
                if(snap.data().state !== "active") return; // Zaten biri basmış

                transaction.update(roomRef, {
                    state: "result",
                    winnerName: username,
                    [isP1 ? 'score1' : 'score2']: (isP1 ? snap.data().score1 : snap.data().score2) + 1,
                    lastReaction: reaction
                });
            });
        } catch(e) { console.error(e); }
        setTimeout(() => tapLock = false, 1000);
    }
};

// 3. Geliştirme: Bellek Sızıntılarını Önleyen Quit Fonksiyonu
async function quitGame() {
    if(unsubRoom) unsubRoom();
    const roomId = currentRoomId;
    currentRoomId = null;
    
    if(roomId) {
        const snap = await getDoc(doc(db, "rooms", roomId));
        if(snap.exists()) {
            if(snap.data().host === uid) await deleteDoc(doc(db, "rooms", roomId));
            else await updateDoc(doc(db, "rooms", roomId), { player2: null, state: "waiting" });
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;

// Host için periyodik kontrol (Aktif turu başlatma)
setInterval(() => {
    if(roomData && roomData.state === "countdown" && uid === roomData.host) {
        if(getServerTime() >= roomData.startTime) {
            updateDoc(doc(db, "rooms", currentRoomId), { state: "active" });
        }
    }
}, 50);

</script>
</body>
</html>

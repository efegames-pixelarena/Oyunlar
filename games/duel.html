<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PixelArena Duel | Cyber Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
:root { 
    --p: #00f2ff; --a: #ff0055; --bg: #030508; --b: #0d1117; 
    --gold: #ffcc00; --glass: rgba(13, 17, 23, 0.85); --success: #00ff88;
}

* { 
    margin:0; padding:0; box-sizing:border-box; 
    font-family: 'Rajdhani', sans-serif; 
    -webkit-tap-highlight-color:transparent; 
    touch-action: none; 
    user-select: none; 
}

body { 
    background: var(--bg); color: white; height: 100vh; overflow: hidden; 
    display: flex; flex-direction: column; position: fixed; width: 100%;
}

/* Animasyonlu Arka Plan */
body::before {
    content: ""; position: absolute; inset: 0;
    background: 
        linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px) 0 0 / 40px 40px,
        linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px) 0 0 / 40px 40px;
    z-index: -1;
    animation: gridMove 20s linear infinite;
}

@keyframes gridMove {
    from { background-position: 0 0; }
    to { background-position: 40px 40px; }
}

body::after {
    content: ""; position: absolute; inset: 0;
    background: radial-gradient(circle at center, transparent 0%, var(--bg) 90%);
    z-index: -1;
}

.top-bar { 
    height: 70px; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); 
    border-bottom: 2px solid var(--p); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 20px; z-index: 1000;
    box-shadow: 0 0 20px rgba(0,242,255,0.2);
}

.brand { 
    font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.2rem;
    background: linear-gradient(to right, #fff, var(--p)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: 2px;
}

#userBox {
    background: rgba(0, 242, 255, 0.1); padding: 5px 12px; border-radius: 20px;
    border: 1px solid var(--p); color: var(--p); font-weight: 700; font-size: 0.8rem;
}

#lobby { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
.lobby-controls { background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid #222; }

.search-bar input {
    width: 100%; background: #000; border: 1px solid #333; border-radius: 12px;
    padding: 15px; color: white; font-family: 'Orbitron'; font-size: 0.8rem;
    outline: none; transition: 0.3s; margin-bottom: 15px;
}
.search-bar input:focus { border-color: var(--p); box-shadow: 0 0 10px rgba(0,242,255,0.3); }

.action-buttons { display: flex; gap: 10px; }
.btn {
    border: none; border-radius: 12px; font-weight: 900; font-family: 'Orbitron'; 
    cursor: pointer; transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.btn:active { transform: scale(0.95); }
.create-btn { flex: 1; padding: 18px; background: var(--p); color: #000; box-shadow: 0 0 15px rgba(0,242,255,0.4); }
.quick-btn { flex: 1; padding: 18px; background: transparent; color: var(--success); border: 2px solid var(--success); }

.room-card { 
    background: linear-gradient(135deg, var(--b), #1a222c); border-radius: 20px; padding: 20px;
    display: flex; justify-content: space-between; align-items: center;
    border: 1px solid #333; transition: 0.3s;
}
.room-card:hover { border-color: var(--p); transform: translateY(-3px); }

.room-host { font-family: 'Orbitron'; font-weight: 700; font-size: 1rem; color: #fff; margin-bottom: 5px; }
.badge { padding: 4px 10px; border-radius: 6px; font-size: 0.6rem; font-weight: 900; }
.badge-live { background: rgba(255, 0, 85, 0.2); color: var(--a); border: 1px solid var(--a); }
.badge-wait { background: rgba(0, 255, 136, 0.1); color: var(--success); border: 1px solid var(--success); }

/* Oyun Tasarımı */
#game-view { display: none; flex: 1; flex-direction: column; background: radial-gradient(circle at center, #0a1018 0%, #030508 100%); }

.scoreboard { 
    padding: 30px 20px; display: grid; grid-template-columns: 1fr auto 1fr; 
    align-items: center; background: transparent; gap: 15px;
}
.p-info .name { font-family: 'Orbitron'; font-size: 0.75rem; color: #666; margin-bottom: 5px; text-transform: uppercase; }
.p-info .score { font-family: 'Orbitron'; font-size: 2.5rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); }
#roundNum { 
    background: var(--p); color: #000; padding: 5px 15px; border-radius: 20px;
    font-weight: 900; font-family: 'Orbitron'; font-size: 0.8rem; box-shadow: 0 0 15px var(--p);
}

.arena { 
    flex: 1; margin: 0 20px 40px 20px; border-radius: 30px;
    background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.1);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    cursor: pointer; position: relative; overflow: hidden;
}
.arena * { pointer-events: none; } /* Metinlerin tıklamayı bozmasını engeller */

#bigText { font-family: 'Orbitron'; font-size: 80px; font-weight: 900; transition: 0.05s; letter-spacing: -2px; }
#subText { font-family: 'Orbitron'; font-size: 1rem; letter-spacing: 5px; color: #444; margin-top: 20px; text-transform: uppercase;}

.flash { background: #fff !important; box-shadow: 0 0 100px #fff; }
.flash #bigText, .flash #subText { color: #000 !important; text-shadow: none; }

.modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
    display: none; justify-content: center; align-items: center; z-index: 2000; padding: 25px;
}
.modal-content {
    background: var(--b); width: 100%; max-width: 400px; padding: 35px; border-radius: 30px;
    border: 1px solid var(--p); box-shadow: 0 0 30px rgba(0,242,255,0.2);
}

.winner-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; }
.penalty { color: var(--a) !important; text-shadow: 0 0 15px var(--a); animation: shake 0.3s infinite; }
@keyframes shake { 0%,100%{transform: translateX(0);} 25%{transform: translateX(-5px);} 75%{transform: translateX(5px);} }
</style>
</head>
<body>

<div class="top-bar">
    <div class="brand">PIXEL ARENA</div>
    <div style="display:flex; gap:12px; align-items:center;">
        <div id="userBox">...</div>
        <button id="lobbyExitBtn" class="exit-btn" onclick="window.location.href='index.html'" style="background:#222; color:#fff; border:none; padding:8px 15px; border-radius:8px; font-weight:800; font-size:0.7rem;">ÇIKIŞ</button>
        <button id="leaveBtn" class="back-btn" style="display:none; background:var(--a); color:#fff; border:none; padding:8px 15px; border-radius:8px; font-weight:800; font-size:0.7rem;">AYRIL</button>
    </div>
</div>

<div id="errorModal" class="modal">
    <div class="modal-content" style="border-color: var(--a); text-align:center;">
        <h2 id="errorTitle" style="font-family:'Orbitron'; color:var(--a); margin-bottom:15px;">HATA</h2>
        <p id="errorDesc" style="color:#888; margin-bottom:25px;">Bağlantı sorunu oluştu.</p>
        <button onclick="closeModal('errorModal')" class="btn" style="width:100%; padding:15px; background:var(--a); color:#fff;">KAPAT</button>
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:'Orbitron'; color:var(--p); margin-bottom:25px; text-align:center;">ARENA KUR</h2>
        <input type="text" id="roomPassInput" placeholder="ŞİFRE (İSTEĞE BAĞLI)" maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal('createModal')" class="btn" style="flex:1; padding:15px; background:#222; color:#fff;">İPTAL</button>
            <button id="confirmCreateBtn" class="btn create-btn">OLUŞTUR</button>
        </div>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:'Orbitron'; color:var(--gold); margin-bottom:25px; text-align:center;">ŞİFRE GEREKLİ</h2>
        <input type="password" id="joinPassInput" placeholder="GİRİŞ ŞİFRESİ" maxlength="10">
        <div style="display:flex; gap:10px;">
            <button onclick="closeModal('passwordModal')" class="btn" style="flex:1; padding:15px; background:#222; color:#fff;">GERİ</button>
            <button id="confirmJoinPassBtn" class="btn" style="flex:1; padding:15px; background:var(--gold); color:#000;">KATIL</button>
        </div>
    </div>
</div>

<div id="lobby">
    <div class="lobby-controls">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="ARENA VEYA OYUNCU ARA...">
        </div>
        <div class="action-buttons">
            <button class="btn create-btn" id="createRoomBtn" onclick="openModal('createModal')">ODA OLUŞTUR</button>
            <button class="btn quick-btn" id="quickJoinBtn">HIZLI KATIL</button>
        </div>
    </div>
    <div id="roomList"></div>
</div>

<div id="game-view">
    <div class="scoreboard">
        <div class="p-info" style="text-align:left;">
            <div class="name" id="p1Name">---</div>
            <div class="score" id="p1Score">00</div>
        </div>
        <div id="roundNum">ROUND 1</div>
        <div class="p-info" style="text-align:right;">
            <div class="name" id="p2Name">---</div>
            <div class="score" id="p2Score">00</div>
        </div>
    </div>
    <div class="arena" id="arena">
        <div id="bigText">READY</div>
        <div id="subText">BEKLEMEDE</div>
    </div>
</div>

<div id="winnerScreen" class="winner-screen">
    <p style="font-family:'Orbitron'; color:var(--p); letter-spacing:10px;">ŞAMPİYON</p>
    <h1 id="championName" style="font-family:'Orbitron'; font-size:3.5rem; color:var(--gold); text-shadow: 0 0 30px var(--gold); margin:20px 0;">PLAYER</h1>
    <div style="color:#444">Lobiye yönlendiriliyorsunuz...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, onValue, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain: "emirhan-site.firebaseapp.com",
    projectId: "emirhan-site",
    storageBucket: "emirhan-site.firebasestorage.app",
    messagingSenderId: "668871888390",
    appId: "1:668871888390:web:76568bda84cb1641f7bd87",
    databaseURL: "https://emirhan-site-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rdb = getDatabase(app);
const auth = getAuth(app);

let uid, username, currentRoomId = null, unsubRoom = null, unsubLobby = null, unsubOtherPresence = null;
let roomData = null, tapLock = false, serverOffset = 0, pendingRoomId = null;

// Sunucu Saati Senkronizasyonu
onValue(ref(rdb, ".info/serverTimeOffset"), (snap) => {
    serverOffset = snap.val() || 0;
});
const getServerTime = () => Date.now() + serverOffset;

// Ses Sistemi
let audioCtx = null;
const initAudio = () => { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
function playBeep(f, t, d) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
}

window.openModal = (id) => { initAudio(); document.getElementById(id).style.display = "flex"; };
window.closeModal = (id) => { document.getElementById(id).style.display = "none"; };

onAuthStateChanged(auth, async (user) => {
    if (!user) { signInAnonymously(auth); return; }
    uid = user.uid;
    const uRef = doc(db, "users", uid);
    const snap = await getDoc(uRef);
    username = snap.exists() ? snap.data().username : "Warrior_" + uid.slice(0,4);
    if(!snap.exists()) await setDoc(uRef, { username });
    document.getElementById("userBox").innerText = username.toUpperCase();
    listenLobby();
});

function listenLobby() {
    if(unsubLobby) unsubLobby();
    const q = query(collection(db, "rooms"), where("state", "in", ["waiting", "matched", "countdown", "active"]));
    unsubLobby = onSnapshot(q, (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.docs.forEach(d => {
            const data = d.data();
            const isFull = data.player1 && data.player2;
            const div = document.createElement("div");
            div.className = "room-card";
            div.innerHTML = `
                <div>
                    <div class="room-host">${data.player1Name.toUpperCase()}</div>
                    <div class="room-meta">
                        <span class="badge ${isFull ? 'badge-live' : 'badge-wait'}">${isFull ? 'DOLU' : 'AÇIK'}</span>
                        <span>#${d.id.slice(0,5)}</span>
                    </div>
                </div>
                <button class="btn" style="padding:12px 20px; background:${isFull ? '#222' : 'var(--p)'}; color:${isFull ? '#555' : '#000'};" 
                ${isFull ? 'disabled' : ''} onclick="joinRoom('${d.id}', ${data.password ? 'true' : 'false'})">GİR</button>
            `;
            list.appendChild(div);
        });
    });
}

window.joinRoom = async (id, locked) => {
    if(locked) { pendingRoomId = id; openModal("passwordModal"); return; }
    await executeJoin(id);
};

document.getElementById("confirmJoinPassBtn").onclick = async () => {
    const pass = document.getElementById("joinPassInput").value;
    const snap = await getDoc(doc(db, "rooms", pendingRoomId));
    if(snap.exists() && snap.data().password === pass) {
        closeModal("passwordModal");
        await executeJoin(pendingRoomId);
    } else alert("Şifre Yanlış!");
};

async function executeJoin(id) {
    try {
        await runTransaction(db, async (t) => {
            const ref = doc(db, "rooms", id);
            const snap = await t.get(ref);
            if(snap.data().player2) throw "Oda Dolu";
            t.update(ref, { player2: uid, player2Name: username, state: "matched", p1Ready: false, p2Ready: false });
        });
        currentRoomId = id;
        enterRoom();
    } catch(e) { alert(e); }
}

document.getElementById("confirmCreateBtn").onclick = async () => {
    const id = doc(collection(db, "rooms")).id;
    const pass = document.getElementById("roomPassInput").value;
    await setDoc(doc(db, "rooms", id), {
        player1: uid, player1Name: username, player2: null, player2Name: null,
        score1: 0, score2: 0, round: 1, state: "waiting", host: uid, password: pass,
        p1Ready: false, p2Ready: false, startTime: 0, penalty: false
    });
    currentRoomId = id;
    closeModal("createModal");
    enterRoom();
};

function enterRoom() {
    if(unsubLobby) unsubLobby();
    document.getElementById("lobby").style.display = "none";
    document.getElementById("game-view").style.display = "flex";
    document.getElementById("leaveBtn").style.display = "block";
    document.getElementById("lobbyExitBtn").style.display = "none";

    // Presence (Bağlantı Takibi)
    const myPres = ref(rdb, `presence/${currentRoomId}/${uid}`);
    set(myPres, true);
    onDisconnect(myPres).remove();

    unsubRoom = onSnapshot(doc(db, "rooms", currentRoomId), (snap) => {
        if(!snap.exists()) { quitGame(); return; }
        roomData = snap.data();
        const d = roomData;

        // UI Güncelleme
        document.getElementById("p1Name").innerText = d.player1Name;
        document.getElementById("p2Name").innerText = d.player2Name || "BEKLENİYOR...";
        document.getElementById("p1Score").innerText = String(d.score1).padStart(2, '0');
        document.getElementById("p2Score").innerText = String(d.score2).padStart(2, '0');
        document.getElementById("roundNum").innerText = "ROUND " + d.round;

        // Rakip Bağlantı Kontrolü
        if(d.player2 && !unsubOtherPresence) {
            const other = uid === d.player1 ? d.player2 : d.player1;
            unsubOtherPresence = onValue(ref(rdb, `presence/${currentRoomId}/${other}`), (s) => {
                if(!s.exists() && d.state !== "finished") handleDisconnectWin(other);
            });
        }

        // Oyun Mantığı
        if(d.state === "matched") {
            updateDoc(doc(db, "rooms", currentRoomId), { [uid === d.player1 ? "p1Ready" : "p2Ready"]: true });
            if(d.p1Ready && d.p2Ready && uid === d.host) {
                updateDoc(doc(db, "rooms", currentRoomId), { state: "countdown", startTime: getServerTime() + 4000 });
            }
        }

        handleVisuals(d);
    });
}

function handleVisuals(d) {
    const arena = document.getElementById("arena");
    const bt = document.getElementById("bigText");
    const st = document.getElementById("subText");

    // Yerel loop ile görsel senkronu sağla (En kritik kısım)
    const syncLoop = () => {
        if(!currentRoomId || d.state !== "countdown") return;
        const now = getServerTime();
        const diff = d.startTime - now;

        if(diff > 2000) {
            bt.innerText = "READY"; bt.style.color = "var(--p)";
            st.innerText = "ODAKLAN"; st.classList.remove("penalty");
        } else if (diff > 0) {
            bt.innerText = "WAIT"; bt.style.color = "var(--gold)";
            st.innerText = "SAKIN BASMA!";
        } else {
            // GO anı sadece host tarafından tetiklenir ama her iki tarafta diff <= 0 olur
            if(uid === d.host) updateDoc(doc(db, "rooms", currentRoomId), { state: "active" });
            return;
        }
        requestAnimationFrame(syncLoop);
    };

    if(d.state === "countdown") {
        arena.classList.remove("flash");
        requestAnimationFrame(syncLoop);
    } else if(d.state === "active") {
        arena.classList.add("flash");
        bt.innerText = "GO!";
        st.innerText = "ŞİMDİ!";
        playBeep(800, 'square', 0.1);
    } else if(d.state === "result") {
        arena.classList.remove("flash");
        if(d.penalty) {
            bt.innerText = "FOUL!"; bt.style.color = "var(--a)";
            st.innerText = "ERKEN BASILDI!"; st.classList.add("penalty");
        } else {
            bt.innerText = d.lastReaction + "ms"; bt.style.color = "#fff";
            st.innerText = "HIZLIYDIN!";
        }
        
        if(uid === d.host && !tapLock) {
            tapLock = true;
            setTimeout(() => {
                const finished = d.score1 >= 11 || d.score2 >= 11;
                updateDoc(doc(db, "rooms", currentRoomId), {
                    state: finished ? "finished" : "countdown",
                    startTime: finished ? 0 : getServerTime() + 3000,
                    round: finished ? d.round : d.round + 1,
                    penalty: false
                });
                tapLock = false;
            }, 2500);
        }
    } else if(d.state === "finished") {
        document.getElementById("winnerScreen").style.display = "flex";
        document.getElementById("championName").innerText = (d.score1 >= 11 ? d.player1Name : d.player2Name).toUpperCase();
        setTimeout(quitGame, 5000);
    }
}

document.getElementById("arena").onpointerdown = async (e) => {
    e.preventDefault();
    if(!currentRoomId || !roomData || tapLock) return;
    const d = roomData;
    const now = getServerTime();

    if(d.state === "countdown") {
        tapLock = true;
        const isP1 = uid === d.player1;
        await runTransaction(db, async (t) => {
            const snap = await t.get(doc(db, "rooms", currentRoomId));
            if(snap.data().state !== "countdown") return;
            t.update(doc(db, "rooms", currentRoomId), {
                state: "result", penalty: true,
                score1: isP1 ? snap.data().score1 : snap.data().score1 + 1,
                score2: isP1 ? snap.data().score2 + 1 : snap.data().score2
            });
        });
        setTimeout(() => tapLock = false, 500);
    } else if(d.state === "active") {
        tapLock = true;
        const reaction = now - d.startTime;
        const isP1 = uid === d.player1;
        await runTransaction(db, async (t) => {
            const snap = await t.get(doc(db, "rooms", currentRoomId));
            if(snap.data().state !== "active") return;
            t.update(doc(db, "rooms", currentRoomId), {
                state: "result", penalty: false, lastReaction: Math.floor(reaction),
                score1: isP1 ? snap.data().score1 + 1 : snap.data().score1,
                score2: isP1 ? snap.data().score2 : snap.data().score2 + 1
            });
        });
        setTimeout(() => tapLock = false, 500);
    }
};

async function handleDisconnectWin(otherUid) {
    if(!currentRoomId) return;
    await updateDoc(doc(db, "rooms", currentRoomId), {
        state: "finished",
        score1: otherUid === roomData.player1 ? 0 : 11,
        score2: otherUid === roomData.player1 ? 11 : 0
    });
}

async function quitGame() {
    if(unsubRoom) unsubRoom();
    if(unsubOtherPresence) unsubOtherPresence();
    if(currentRoomId) {
        const rId = currentRoomId;
        remove(ref(rdb, `presence/${rId}/${uid}`));
        const snap = await getDoc(doc(db, "rooms", rId));
        if(snap.exists() && (snap.data().host === uid || snap.data().state === "finished")) {
            await deleteDoc(doc(db, "rooms", rId));
        }
    }
    location.reload();
}

document.getElementById("leaveBtn").onclick = quitGame;
document.getElementById("quickJoinBtn").onclick = async () => {
    initAudio();
    const available = (await getDoc(collection(db, "rooms"))).docs.find(d => d.data().state === "waiting" && !d.data().player2 && !d.data().password);
    if(available) executeJoin(available.id);
    else alert("Boş arena bulunamadı.");
};
</script>
</body>
</html>

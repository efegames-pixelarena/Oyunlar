<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Arena | Evolution</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Outfit:wght@200;500;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --accent: #00f2ff;
            --storm-blue: #0a1128;
            --deep-black: #020205;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(0, 242, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: var(--deep-black); color: white; overflow: hidden; height: 100vh; width: 100vw; }

        /* --- SİNEMATİK FIRTINA ARKA PLANI --- */
        #storm-canvas { position: fixed; inset: 0; z-index: 1; filter: blur(1px); }
        .lightning-bolt { position: fixed; inset: 0; background: white; opacity: 0; z-index: 2; pointer-events: none; }

        /* --- KONSOL TARZI ÜST BAR (HİÇBİR KOŞULDA TAŞMAZ) --- */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            padding: 0 40px; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .brand-nexus { font-family: 'Orbitron'; font-weight: 900; letter-spacing: 5px; font-size: 22px; color: var(--accent); text-shadow: 0 0 20px var(--accent); }

        .user-status-area {
            display: flex; align-items: center; gap: 20px; justify-self: end;
            background: rgba(255,255,255,0.05); padding: 5px 5px 5px 20px;
            border-radius: 100px; border: 1px solid var(--border); backdrop-filter: blur(10px);
            max-width: 350px; /* Bakiye ne olursa olsun alanı sınırlar */
        }
        .balance-wrap { display: flex; flex-direction: column; align-items: flex-end; min-width: 80px; }
        .balance-wrap small { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; }
        .balance-wrap b { font-size: 16px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        .avatar-box {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent);
            cursor: pointer; overflow: hidden; transition: 0.3s;
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        /* --- YATAY OYUN ŞERİDİ (KART DEĞİL, SİNEMATİK PANEL) --- */
        .nexus-viewport {
            position: relative; height: 100vh; width: 100vw;
            display: flex; align-items: center; padding-left: 10%;
            z-index: 10; overflow-x: auto; scroll-snap-type: x mandatory;
            gap: 40px; scrollbar-width: none;
        }
        .nexus-viewport::-webkit-scrollbar { display: none; }

        .game-panel {
            min-width: 450px; height: 60vh; border-radius: 40px;
            background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            position: relative; overflow: hidden; scroll-snap-align: center;
            transition: 0.5s cubic-bezier(0.2, 1, 0.2, 1);
            display: flex; flex-direction: column; justify-content: flex-end; padding: 40px;
        }
        .game-panel:hover { transform: scale(1.05); background: rgba(255,255,255,0.07); border-color: #fff; }
        
        .game-panel i { font-size: 120px; position: absolute; top: -20px; right: -20px; opacity: 0.1; transform: rotate(-15deg); transition: 0.5s; }
        .game-panel:hover i { opacity: 0.3; transform: rotate(0deg) scale(1.2); }

        .game-info h2 { font-family: 'Orbitron'; font-size: 32px; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 2px; }
        .game-info p { color: rgba(255,255,255,0.5); font-size: 14px; margin-bottom: 20px; }
        
        .play-btn {
            width: fit-content; padding: 12px 40px; border-radius: 100px;
            background: var(--accent); color: #000; font-weight: 800;
            text-decoration: none; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.4);
        }

        /* --- PROFİL MODAL (PROFESYONEL AYARLAR) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px); z-index: 1000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-box {
            width: 90%; max-width: 500px; background: #0a0a0f; 
            border: 1px solid var(--border); border-radius: 40px; padding: 40px;
        }

        .input-row { margin-bottom: 20px; }
        .input-row label { display: block; font-size: 11px; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; font-weight: 800; }
        .input-row input {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; border-radius: 15px; color: #fff; outline: none; transition: 0.3s;
        }
        .input-row input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); }
        .input-row input:disabled { opacity: 0.3; cursor: not-allowed; }

        /* --- GERÇEK ÇARK (SİNEMATİK) --- */
        .wheel-wrap { position: relative; width: 320px; height: 320px; margin: 0 auto 30px; }
        #wheel-svg { width: 100%; height: 100%; transition: 5s cubic-bezier(0.1, 0, 0.1, 1); filter: drop-shadow(0 0 30px var(--accent)); }

        /* --- PROMO KOD HATASI --- */
        #promo-err { color: #ff4d4d; font-size: 12px; margin-top: 5px; display: none; font-weight: 600; }

        /* --- AVATAR GRID --- */
        .av-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .av-opt { aspect-ratio: 1; border-radius: 12px; border: 2px solid transparent; cursor: pointer; overflow: hidden; }
        .av-opt.active { border-color: var(--accent); transform: scale(0.9); }
        .av-opt img { width: 100%; height: 100%; object-fit: cover; }

        @media (max-width: 768px) {
            .nexus-viewport { padding-left: 20px; }
            .game-panel { min-width: 85vw; height: 50vh; }
            .top-nav { padding: 0 20px; }
            .brand-nexus { font-size: 16px; }
        }
    </style>
</head>
<body>

<canvas id="storm-canvas"></canvas>
<div class="lightning-bolt" id="l-bolt"></div>

<nav class="top-nav">
    <div class="brand-nexus">NEXUS ARENA</div>
    <div></div> <div class="user-status-area" id="auth-ui" style="display:none;">
        <div class="balance-wrap">
            <small>Kredi Bakiyesi</small>
            <b id="u-bal">0.00 ₺</b>
        </div>
        <div class="avatar-box" onclick="toggleMenu()">
            <img src="" id="u-av">
        </div>
        
        <div id="drop-menu" style="display:none; position:absolute; top:85px; right:40px; background:#0a0a0f; border:1px solid var(--border); border-radius:20px; width:220px; flex-direction:column; overflow:hidden;">
            <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); font-weight:800; font-size:12px; color:var(--accent);" id="u-name-top">Kullanıcı</div>
            <a href="#" onclick="openModal('p-modal')" style="padding:15px; color:#fff; text-decoration:none; font-size:14px;"><i class="fa-solid fa-gear"></i> Ayarlar</a>
            <a href="#" onclick="openModal('w-modal')" style="padding:15px; color:#fff; text-decoration:none; font-size:14px;"><i class="fa-solid fa-star"></i> Günlük Şans</a>
            <a href="#" onclick="openModal('k-modal')" style="padding:15px; color:#fff; text-decoration:none; font-size:14px;"><i class="fa-solid fa-ticket"></i> Promo Kod</a>
            <a href="#" id="out-btn" style="padding:15px; color:#ff4d4d; text-decoration:none; font-size:14px; border-top:1px solid rgba(255,255,255,0.05);"><i class="fa-solid fa-power-off"></i> Çıkış</a>
        </div>
    </div>
    <div id="guest-ui">
        <button onclick="openAuth()" class="play-btn" style="padding:8px 25px; font-size:12px;">Sisteme Katıl</button>
    </div>
</nav>

<section class="nexus-viewport">
    <div class="game-panel" onclick="play('duel.html')">
        <i class="fa-solid fa-bolt-lightning"></i>
        <div class="game-info">
            <h2>Reflex Duel</h2>
            <p>Gerçek zamanlı rakiplerle hızını test et. İlk vuran kazanır.</p>
            <span class="play-btn">Savaşa Gir</span>
        </div>
    </div>

    <div class="game-panel" onclick="play('grid.html')">
        <i class="fa-solid fa-microchip"></i>
        <div class="game-info">
            <h2>Neon Grid</h2>
            <p>Stratejik alan fethi. Gridleri ele geçir, arenayı domine et.</p>
            <span class="play-btn">Fethet</span>
        </div>
    </div>

    <div class="game-panel" onclick="play('skycrash.html')">
        <i class="fa-solid fa-rocket"></i>
        <div class="game-info">
            <h2>SkyCrash</h2>
            <p>Yükseklik korkun var mı? Çarpan patlamadan paranı çek.</p>
            <span class="play-btn">Uçuşa Geç</span>
        </div>
    </div>

    <div class="game-panel" onclick="play('mines.html')">
        <i class="fa-solid fa-bomb"></i>
        <div class="game-info">
            <h2>Mines</h2>
            <p>Mayınsız tarlada hazineyi bul. Risk arttıkça kazanç katlanır.</p>
            <span class="play-btn">Keşfet</span>
        </div>
    </div>

    <div class="game-panel" onclick="location.href='snakepro.html'">
        <i class="fa-solid fa-snake"></i>
        <div class="game-info">
            <h2>Snake Pro</h2>
            <p>Klasik yılan oyunu, yeni nesil mekaniklerle geri döndü.</p>
            <span class="play-btn" style="background:#fff">Ücretsiz Oyna</span>
        </div>
    </div>
</section>

<div class="modal-overlay" id="p-modal">
    <div class="modal-box">
        <h3 style="font-family:'Orbitron'; margin-bottom:25px; color:var(--accent);">KİMLİK AYARLARI</h3>
        <div class="input-row">
            <label>E-Posta Adresi</label>
            <input type="text" id="m-email" disabled>
        </div>
        <div class="input-row">
            <label>Ad Soyad (Bir Kez Girilebilir)</label>
            <input type="text" id="m-fullname" placeholder="Adınızı girin...">
        </div>
        <div class="input-row">
            <label>Kullanıcı Adı (1 Değişim Hakkı)</label>
            <input type="text" id="m-nick">
        </div>
        <label style="font-size:11px; color:var(--accent); font-weight:800;">AVATAR SEÇİMİ (3 HAK)</label>
        <div class="av-grid" id="av-list"></div>
        <button class="play-btn" style="width:100%; margin-top:30px;" onclick="saveProfile()">VERİLERİ GÜNCELLE</button>
        <p onclick="closeModal('p-modal')" style="text-align:center; margin-top:20px; cursor:pointer; opacity:0.5; font-size:12px;">VAZGEÇ</p>
    </div>
</div>

<div class="modal-overlay" id="w-modal">
    <div class="modal-box" style="text-align:center;">
        <h3 style="font-family:'Orbitron'; margin-bottom:25px; color:var(--accent);">NEXUS SPIN</h3>
        <div class="wheel-wrap">
            <img src="https://i.ibb.co/mRT80Pz/wheel.png" id="wheel-svg">
            <div style="position:absolute; top:-15px; left:50%; transform:translateX(-50%); width:40px; height:40px; background:var(--accent); clip-path: polygon(100% 0, 0 0, 50% 100%);"></div>
        </div>
        <button class="play-btn" id="spin-go" onclick="runWheel()">ÇEVİREYİM</button>
        <p id="w-timer" style="margin-top:20px; color:var(--accent); font-weight:800;"></p>
        <p onclick="closeModal('w-modal')" style="margin-top:20px; cursor:pointer; opacity:0.5;">KAPAT</p>
    </div>
</div>

<div class="modal-overlay" id="k-modal">
    <div class="modal-box">
        <h3 style="font-family:'Orbitron'; margin-bottom:25px; color:var(--accent);">PROMO KOD AKTİVASYONU</h3>
        <div class="input-row">
            <input type="text" id="promo-in" placeholder="KODU BURAYA YAZIN" style="text-align:center; font-weight:900; letter-spacing:3px;">
            <p id="promo-err">Kod geçersiz veya kullanılmış!</p>
        </div>
        <button class="play-btn" style="width:100%;" onclick="checkPromo()">AKTİF ET</button>
        <p onclick="closeModal('k-modal')" style="text-align:center; margin-top:20px; cursor:pointer; opacity:0.5;">İPTAL</p>
    </div>
</div>

<div class="modal-overlay" id="a-modal">
    <div class="modal-box">
        <h3 id="a-title" style="font-family:'Orbitron'; margin-bottom:25px; color:var(--accent);">SİSTEME GİRİŞ</h3>
        <div class="input-row"><input type="email" id="a-email" placeholder="E-Posta"></div>
        <div class="input-row"><input type="password" id="a-pass" placeholder="Şifre"></div>
        <div class="input-row" id="a-nick-row" style="display:none;"><input type="text" id="a-nick" placeholder="Kullanıcı Adı"></div>
        <button class="play-btn" style="width:100%;" id="a-btn">BAĞLAN</button>
        <p onclick="swapAuth()" id="a-swap" style="text-align:center; margin-top:20px; cursor:pointer; font-size:13px;">Henüz hesabın yok mu? <b style="color:var(--accent)">Kayıt Ol</b></p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, increment, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
        apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
        authDomain:"emirhan-site.firebaseapp.com",
        projectId:"emirhan-site",
        storageBucket:"emirhan-site.firebasestorage.app",
        messagingSenderId:"668871888390",
        appId:"1:668871888390:web:76568bda84cb1641f7bd87"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userLocal = null;
    let selectedAvatarUrl = "";

    const AVATARS = [
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Aria",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Jack",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Luna",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Zane",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Nova",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Milo",
        "https://api.dicebear.com/7.x/avataaars/svg?seed=Kira"
    ];

    // --- STORM & SNOW EFFECT ---
    const canvas = document.getElementById('storm-canvas');
    const ctx = canvas.getContext('2d');
    let drops = [];

    function initStorm() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drops = [];
        for(let i=0; i<200; i++) drops.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, l: Math.random()*20+10, v: Math.random()*10+5});
    }

    function drawStorm() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = 'rgba(0, 242, 255, 0.15)';
        ctx.lineWidth = 1;
        drops.forEach(d => {
            ctx.beginPath();
            ctx.moveTo(d.x, d.y);
            ctx.lineTo(d.x + 2, d.y + d.l);
            ctx.stroke();
            d.y += d.v;
            if(d.y > canvas.height) d.y = -20;
        });

        if(Math.random() > 0.98) {
            document.getElementById('l-bolt').style.opacity = "0.4";
            setTimeout(() => document.getElementById('l-bolt').style.opacity = "0", 50);
        }
        requestAnimationFrame(drawStorm);
    }
    window.addEventListener('resize', initStorm);
    initStorm(); drawStorm();

    // --- NAVIGATION ---
    window.toggleMenu = () => {
        const m = document.getElementById('drop-menu');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    };
    window.openModal = (id) => { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        document.getElementById(id).style.display = 'flex';
        if(id === 'p-modal') loadAvatarOptions();
        if(id === 'w-modal') updateWheelUI();
    };
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // --- AUTH LOGIC ---
    let authIsReg = false;
    window.openAuth = () => { authIsReg = false; openModal('a-modal'); };
    window.swapAuth = () => {
        authIsReg = !authIsReg;
        document.getElementById('a-title').innerText = authIsReg ? "KAYIT OL" : "SİSTEME GİRİŞ";
        document.getElementById('a-nick-row').style.display = authIsReg ? "block" : "none";
        document.getElementById('a-swap').innerHTML = authIsReg ? "Zaten üye misin? <b style='color:var(--accent)'>Giriş Yap</b>" : "Henüz hesabın yok mu? <b style='color:var(--accent)'>Kayıt Ol</b>";
    };

    document.getElementById('a-btn').onclick = async () => {
        const e = document.getElementById('a-email').value;
        const p = document.getElementById('a-pass').value;
        try {
            if(authIsReg) {
                const n = document.getElementById('a-nick').value;
                const r = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", r.user.uid), {
                    username: n, fullName: "", balance: 1000, 
                    avatar: AVATARS[0], nickHak: 1, avHak: 3, lastSpin: 0
                });
            } else {
                await signInWithEmailAndPassword(auth, e, p);
            }
            closeModal('a-modal');
        } catch(err) { alert(err.message); }
    };

    onAuthStateChanged(auth, user => {
        if(user) {
            document.getElementById('guest-ui').style.display = 'none';
            document.getElementById('auth-ui').style.display = 'flex';
            onSnapshot(doc(db, "users", user.uid), s => {
                if(s.exists()){
                    userLocal = s.data();
                    document.getElementById('u-bal').innerText = userLocal.balance.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
                    document.getElementById('u-av').src = userLocal.avatar;
                    document.getElementById('u-name-top').innerText = userLocal.username;
                    // Modal alanlarını doldur
                    document.getElementById('m-email').value = user.email;
                    document.getElementById('m-fullname').value = userLocal.fullName;
                    document.getElementById('m-nick').value = userLocal.username;
                    if(userLocal.fullName) document.getElementById('m-fullname').disabled = true;
                    if(userLocal.nickHak <= 0) document.getElementById('m-nick').disabled = true;
                }
            });
        } else {
            document.getElementById('guest-ui').style.display = 'block';
            document.getElementById('auth-ui').style.display = 'none';
        }
    });

    document.getElementById('out-btn').onclick = () => signOut(auth);

    // --- PROFILE SYSTEM ---
    function loadAvatarOptions() {
        const container = document.getElementById('av-list');
        container.innerHTML = "";
        AVATARS.forEach(url => {
            const div = document.createElement('div');
            div.className = `av-opt ${url === userLocal.avatar ? 'active' : ''}`;
            div.innerHTML = `<img src="${url}">`;
            div.onclick = () => {
                if(userLocal.avHak > 0) {
                    document.querySelectorAll('.av-opt').forEach(x => x.classList.remove('active'));
                    div.classList.add('active');
                    selectedAvatarUrl = url;
                } else { alert("Avatar değiştirme hakkınız kalmadı."); }
            };
            container.appendChild(div);
        });
    }

    window.saveProfile = async () => {
        const updates = {};
        const nick = document.getElementById('m-nick').value;
        const fname = document.getElementById('m-fullname').value;

        if(nick !== userLocal.username && userLocal.nickHak > 0) {
            updates.username = nick;
            updates.nickHak = 0;
        }
        if(fname && !userLocal.fullName) {
            updates.fullName = fname;
        }
        if(selectedAvatarUrl && selectedAvatarUrl !== userLocal.avatar && userLocal.avHak > 0) {
            updates.avatar = selectedAvatarUrl;
            updates.avHak = increment(-1);
        }

        if(Object.keys(updates).length > 0) {
            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            alert("Profil başarıyla güncellendi.");
            closeModal('p-modal');
        }
    };

    // --- CINEMATIC WHEEL ---
    window.runWheel = async () => {
        if(Date.now() - (userLocal.lastSpin || 0) < 86400000) return;
        
        const btn = document.getElementById('spin-go');
        btn.disabled = true;
        const wheel = document.getElementById('wheel-svg');
        const deg = Math.floor(Math.random() * 360) + 7200; // 20 tur + random
        wheel.style.transform = `rotate(${deg}deg)`;

        setTimeout(async () => {
            const prizes = [5000, 1000, 2500, 100, 10000, 0, 500, 2000];
            const finalDeg = deg % 360;
            const idx = Math.floor(finalDeg / (360/8));
            const prize = prizes[idx];

            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                balance: increment(prize),
                lastSpin: Date.now()
            });
            alert(prize > 0 ? `TEBRİKLER! ${prize} ₺ kazandınız.` : "Bugün şansın yokmuş...");
            btn.disabled = false;
            updateWheelUI();
        }, 5100);
    };

    function updateWheelUI() {
        const timer = document.getElementById('w-timer');
        const diff = Date.now() - (userLocal.lastSpin || 0);
        if(diff < 86400000) {
            document.getElementById('spin-go').style.display = "none";
            timer.innerText = "YENİ HAK: " + new Date((userLocal.lastSpin + 86400000)).toLocaleTimeString();
        } else {
            document.getElementById('spin-go').style.display = "inline-block";
            timer.innerText = "ŞANSLISIN, ÇEVİRME HAKKIN VAR!";
        }
    }

    // --- PROMO CODE ---
    window.checkPromo = async () => {
        const code = document.getElementById('promo-in').value.trim().toUpperCase();
        const err = document.getElementById('promo-err');
        err.style.display = "none";

        const q = query(collection(db, "promos"), where("code", "==", code));
        const snap = await getDocs(q);

        if(!snap.empty) {
            const pDoc = snap.docs[0];
            const pData = pDoc.data();
            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(pData.amount) });
            await deleteDoc(doc(db, "promos", pDoc.id));
            alert(`${pData.amount} ₺ hesabına tanımlandı!`);
            closeModal('k-modal');
        } else {
            err.style.display = "block";
        }
    };

    window.play = (url) => {
        if(!auth.currentUser) openAuth();
        else location.href = url;
    };
</script>

</body>
</html>

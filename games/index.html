<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PixelArena | Profesyonel Oyun Platformu</title>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Syncopate:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary: #00e5ff;
            --primary-glow: rgba(0, 229, 255, 0.4);
            --accent: #bc13fe;
            --bg: #05070a;
            --card: #0f121a;
            --border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-dim: #8492a6;
            --success: #00ffa3;
            --danger: #ff4d4d;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; overflow-x: hidden; line-height: 1.6; }

        /* --- ÜST BAR (TAŞMAYA KARŞI GÜVENLİ) --- */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; background: rgba(5, 7, 10, 0.9);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 2000;
        }

        .brand {
            font-family: 'Syncopate', sans-serif; font-size: 1.4rem; font-weight: 700;
            letter-spacing: 2px; color: var(--primary); flex-shrink: 0;
        }

        .right-menu { display: flex; align-items: center; gap: 10px; min-width: 0; }

        .user-pill {
            display: none; align-items: center; gap: 12px;
            background: rgba(255, 255, 255, 0.03); padding: 5px 5px 5px 15px;
            border-radius: 50px; border: 1px solid var(--border);
            cursor: pointer; min-width: 0; /* İçeriğin sığmasını sağlar */
        }

        .balance-info { 
            display: flex; flex-direction: column; align-items: flex-end; 
            min-width: 80px; overflow: hidden; 
        }
        
        /* Bakiyenin taşmasını önleyen özel stil */
        #userBalance {
            color: var(--success); font-weight: 800; font-size: 0.95rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 120px;
        }

        .avatar-box { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--primary); overflow: hidden; flex-shrink: 0; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        /* --- OYUN KARTLARI --- */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 20px; padding: 0 5% 50px;
        }

        .card {
            background: var(--card); border-radius: 24px; padding: 30px;
            border: 1px solid var(--border); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        
        .card i.game-icon { font-size: 45px; margin-bottom: 20px; color: var(--primary); display: block; }
        .card h3 { font-size: 1.2rem; margin-bottom: 10px; font-weight: 800; }
        
        .badge { 
            font-size: 10px; font-weight: 800; padding: 6px 14px; 
            border-radius: 50px; background: rgba(255,255,255,0.05); color: var(--text-dim); 
            text-transform: uppercase; border: 1px solid var(--border);
        }

        /* --- GERÇEK ÇARK SİSTEMİ --- */
        .wheel-box { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        #wheelCanvas { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        .wheel-pin { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 10; font-size: 30px; color: var(--primary); }

        /* --- MODAL TASARIMI --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px;
        }
        .modal { width: 100%; max-width: 480px; background: #0f121a; border-radius: 30px; border: 1px solid var(--border); padding: 35px; text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal input { width: 100%; padding: 14px 20px; border-radius: 15px; background: #05070a; border: 1px solid var(--border); color: white; outline: none; margin-bottom: 15px; font-size: 0.9rem; }
        .modal input:disabled { opacity: 0.4; cursor: not-allowed; border-color: transparent; }
        .modal label { display: block; text-align: left; font-size: 12px; color: var(--text-dim); margin: 0 0 5px 5px; }

        .btn-p { width: 100%; padding: 16px; border-radius: 15px; border: none; background: var(--primary); color: #000; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-p:hover { opacity: 0.9; transform: scale(0.98); }

        /* --- DROPDOWN --- */
        .dropdown {
            position: absolute; top: 75px; right: 0; width: 240px;
            background: #0d1117; border: 1px solid var(--border);
            border-radius: 20px; display: none; flex-direction: column; padding: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }
        .dropdown.active { display: flex; animation: slideIn 0.3s ease; }
        .drop-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; color: var(--text-dim); text-decoration: none; border-radius: 12px; font-size: 14px; }
        .drop-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .drop-item i { color: var(--primary); width: 20px; }

        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .av-opt { aspect-ratio: 1/1; border-radius: 12px; cursor: pointer; border: 2px solid transparent; overflow: hidden; }
        .av-opt.active { border-color: var(--primary); }
        .av-opt img { width: 100%; height: 100%; object-fit: cover; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media(max-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); gap: 12px; } .brand { font-size: 1rem; } }
    </style>
</head>
<body>

<canvas id="snow" style="position:fixed; inset:0; z-index:1; pointer-events:none; opacity:0.3;"></canvas>

<div class="top-bar">
    <div class="brand">PIXELARENA</div>
    
    <div class="right-menu">
        <button class="btn-p" id="loginBtn" style="padding: 8px 15px; width: auto; font-size: 12px; background: transparent; color: white; border: 1px solid var(--border);">GİRİŞ</button>
        <button class="btn-p" id="regBtn" style="padding: 8px 15px; width: auto; font-size: 12px;">KAYIT OL</button>

        <div class="user-pill" id="userPill">
            <div class="balance-info">
                <span id="userBalance">0 ₺</span>
            </div>
            <div class="avatar-box" id="avatarTrigger">
                <img src="" id="userProfileImg">
            </div>
            <div class="dropdown" id="userDropdown">
                <div class="drop-item" onclick="openModal('profileModal')"><i class="fa-solid fa-id-card"></i> Profilim</div>
                <div class="drop-item" onclick="openModal('wheelModal')"><i class="fa-solid fa-spinner"></i> Şans Çarkı</div>
                <div class="drop-item" onclick="openModal('promoModal')"><i class="fa-solid fa-ticket"></i> Promo Kod</div>
                <div class="drop-item" id="logoutBtn" style="color:var(--danger); border-top:1px solid var(--border); margin-top:10px;"><i class="fa-solid fa-power-off"></i> Çıkış Yap</div>
            </div>
        </div>
    </div>
</div>

<div style="margin-top: 110px; padding: 0 5%; text-align: center;">
    <input type="text" id="searchInput" placeholder="Favori oyununu bul..." style="width: 100%; max-width: 600px; padding: 18px 30px; border-radius: 50px; background: var(--card); border: 1px solid var(--border); color: white; outline: none; font-size: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
</div>

<main id="games" style="position: relative; z-index: 10;">
    <h2 style="padding: 40px 5% 20px; font-family: 'Syncopate'; font-size: 0.8rem; letter-spacing: 4px; color: var(--text-dim);">MULTIPLAYER PVP</h2>
    <div class="grid">
        <div class="card" data-name="reflex duel" onclick="checkLogin('duel.html')">
            <i class="fa-solid fa-bolt game-icon"></i>
            <h3>Reflex Duel</h3>
            <div class="badge">Online Duel</div>
        </div>
        <div class="card" data-name="neon grid" onclick="checkLogin('neongrid.html')">
            <i class="fa-solid fa-border-none game-icon"></i>
            <h3>Neon Grid</h3>
            <div class="badge">Strateji PvP</div>
        </div>
    </div>

    <h2 style="padding: 20px 5%; font-family: 'Syncopate'; font-size: 0.8rem; letter-spacing: 4px; color: var(--text-dim);">PREMIUM CASINO</h2>
    <div class="grid">
        <div class="card" data-name="skycrash" onclick="checkLogin('skycrash.html')">
            <i class="fa-solid fa-jet-fighter-up game-icon"></i>
            <h3>SkyCrash</h3>
            <div class="badge">Yüksek Kazanç</div>
        </div>
        <div class="card" data-name="mines" onclick="checkLogin('mines.html')">
            <i class="fa-solid fa-bomb game-icon"></i>
            <h3>Mines</h3>
            <div class="badge">Mayın Tarlası</div>
        </div>
        <div class="card" data-name="blackjack" onclick="checkLogin('blackjack.html')">
            <i class="fa-solid fa-spade game-icon"></i>
            <h3>BlackJack</h3>
            <div class="badge">21 Masası</div>
        </div>
        <div class="card" data-name="pisti" onclick="checkLogin('pisti.html')">
            <i class="fa-solid fa-clone game-icon"></i>
            <h3>Pişti Online</h3>
            <div class="badge">Klasik Kart</div>
        </div>
    </div>
</main>

<div class="modal-overlay" id="profileModal">
    <div class="modal">
        <h2 style="margin-bottom: 20px; font-family:'Syncopate'; color: var(--primary);">PROFİL AYARLARI</h2>
        
        <label>E-posta (Pasif)</label>
        <input type="text" id="profEmail" disabled>

        <label>İsim Soyisim</label>
        <input type="text" id="profFullName" placeholder="Adınızı giriniz">

        <label>Kullanıcı Adı (1 Değişim Hakkı)</label>
        <input type="text" id="profUser" placeholder="Kullanıcı adı">

        <label>Avatar Seç (3 Değişim Hakkı: <span id="avRights">3</span>)</label>
        <div class="avatar-grid" id="avatarLib"></div>

        <button class="btn-p" onclick="saveProfile()">DEĞİŞİKLİKLERİ KAYDET</button>
        <p onclick="closeModal('profileModal')" style="margin-top:20px; cursor:pointer; color:var(--text-dim); font-size:13px;">Pencereyi Kapat</p>
    </div>
</div>

<div class="modal-overlay" id="wheelModal">
    <div class="modal">
        <h2 style="font-family:'Syncopate'; color: var(--primary);">ŞANS ÇARKINI ÇEVİR</h2>
        <div class="wheel-box">
            <div class="wheel-pin"><i class="fa-solid fa-caret-down"></i></div>
            <canvas id="wheelCanvas" width="400" height="400"></canvas>
        </div>
        <button class="btn-p" id="spinBtn" onclick="spinWheel()">ÇEVİR (GÜNLÜK 1 HAK)</button>
        <div id="wheelStatus" style="margin-top:15px; font-weight:800; color:var(--success);"></div>
        <p onclick="closeModal('wheelModal')" style="margin-top:15px; cursor:pointer; color:var(--text-dim);">Kapat</p>
    </div>
</div>

<div class="modal-overlay" id="promoModal">
    <div class="modal">
        <i class="fa-solid fa-gift" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
        <h2 style="font-family:'Syncopate';">PROMO KOD GİR</h2>
        <input type="text" id="promoInput" placeholder="Kodunuzu buraya yazın..." style="text-align: center; text-transform: uppercase; letter-spacing: 2px;">
        <button class="btn-p" onclick="redeemPromo()">KODU AKTİF ET</button>
        <p onclick="closeModal('promoModal')" style="margin-top:15px; cursor:pointer; color:var(--text-dim);">Kapat</p>
    </div>
</div>

<div class="modal-overlay" id="authModal">
    <div class="modal">
        <h2 id="authTitle" style="font-family:'Syncopate'; margin-bottom:25px;">GİRİŞ YAP</h2>
        <input type="email" id="authEmail" placeholder="E-posta">
        <input type="password" id="authPassword" placeholder="Şifre">
        <input type="text" id="authUsername" placeholder="Kullanıcı Adı" style="display:none;">
        <button class="btn-p" id="authAction">DEVAM ET</button>
        <p id="authSwitch" style="margin-top:20px; font-size:14px; cursor:pointer; color:var(--text-dim);">Hesabınız yok mu? <span style="color:var(--primary)">Kayıt Ol</span></p>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, increment, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- GLOBAL DEĞİŞKENLER ---
const avatarLinks = ["https://i.pravatar.cc/150?img=11", "https://i.pravatar.cc/150?img=12", "https://i.pravatar.cc/150?img=32", "https://i.pravatar.cc/150?img=44", "https://i.pravatar.cc/150?img=53", "https://i.pravatar.cc/150?img=65", "https://i.pravatar.cc/150?img=68", "https://i.pravatar.cc/150?img=69"];
let selectedAvatar = "";
let currentUserData = null;

// --- MODAL YÖNETİMİ ---
window.openModal = (id) => { 
    document.getElementById(id).style.display = 'flex';
    if(id === 'wheelModal') drawWheel();
};
window.closeModal = (id) => document.getElementById(id).style.display = 'none';

// --- AUTH İŞLEMLERİ ---
let isLoginMode = true;
document.getElementById('authSwitch').onclick = () => {
    isLoginMode = !isLoginMode;
    document.getElementById('authTitle').innerText = isLoginMode ? "GİRİŞ YAP" : "KAYIT OL";
    document.getElementById('authUsername').style.display = isLoginMode ? "none" : "block";
    document.getElementById('authSwitch').innerHTML = isLoginMode ? "Hesabınız yok mu? <span style='color:var(--primary)'>Kayıt Ol</span>" : "Zaten üye misiniz? <span style='color:var(--primary)'>Giriş Yap</span>";
};

document.getElementById('authAction').onclick = async () => {
    const email = document.getElementById('authEmail').value;
    const pass = document.getElementById('authPassword').value;
    const userN = document.getElementById('authUsername').value;

    try {
        if(isLoginMode) {
            await signInWithEmailAndPassword(auth, email, pass);
        } else {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), {
                username: userN, balance: 1000, avatar: avatarLinks[0],
                nameChanges: 0, avatarChanges: 3, fullName: "", lastSpin: 0
            });
        }
        closeModal('authModal');
    } catch(e) { alert("Hata: " + e.message); }
};

onAuthStateChanged(auth, user => {
    if(user) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('regBtn').style.display = 'none';
        document.getElementById('userPill').style.display = 'flex';
        
        onSnapshot(doc(db, "users", user.uid), s => {
            if(s.exists()) {
                const data = s.data();
                currentUserData = data;
                document.getElementById('userBalance').innerText = data.balance.toLocaleString() + " ₺";
                document.getElementById('userProfileImg').src = data.avatar;
                
                // Profil Modal Güncelleme
                document.getElementById('profEmail').value = user.email;
                document.getElementById('profFullName').value = data.fullName;
                if(data.fullName) document.getElementById('profFullName').disabled = true;
                
                document.getElementById('profUser').value = data.username;
                if(data.nameChanges >= 1) document.getElementById('profUser').disabled = true;
                
                document.getElementById('avRights').innerText = data.avatarChanges;
                loadAvatarLib(data.avatar);
            }
        });
    } else {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('regBtn').style.display = 'block';
        document.getElementById('userPill').style.display = 'none';
    }
});

document.getElementById('logoutBtn').onclick = () => signOut(auth);
document.getElementById('avatarTrigger').onclick = (e) => {
    e.stopPropagation();
    document.getElementById('userDropdown').classList.toggle('active');
};
window.onclick = () => document.getElementById('userDropdown').classList.remove('active');

// --- PROFİL SİSTEMİ ---
function loadAvatarLib(current) {
    const lib = document.getElementById('avatarLib');
    lib.innerHTML = "";
    avatarLinks.forEach(link => {
        const div = document.createElement('div');
        div.className = `av-opt ${link === current ? 'active' : ''}`;
        div.innerHTML = `<img src="${link}">`;
        div.onclick = () => {
            if(currentUserData.avatarChanges <= 0) return alert("Avatar değişim hakkınız bitti!");
            document.querySelectorAll('.av-opt').forEach(a => a.classList.remove('active'));
            div.classList.add('active');
            selectedAvatar = link;
        };
        lib.appendChild(div);
    });
}

window.saveProfile = async () => {
    const newFull = document.getElementById('profFullName').value;
    const newUser = document.getElementById('profUser').value;
    let updates = {};

    // İsim Soyisim (Bir kez girilebilir)
    if(!currentUserData.fullName && newFull) {
        updates.fullName = newFull;
    }
    
    // Kullanıcı Adı (1 Hak)
    if(newUser !== currentUserData.username && currentUserData.nameChanges < 1) {
        updates.username = newUser;
        updates.nameChanges = 1;
    }

    // Avatar (3 Hak)
    if(selectedAvatar && selectedAvatar !== currentUserData.avatar && currentUserData.avatarChanges > 0) {
        updates.avatar = selectedAvatar;
        updates.avatarChanges = increment(-1);
    }

    if(Object.keys(updates).length > 0) {
        await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
        alert("Profil başarıyla güncellendi!");
        closeModal('profileModal');
    }
};

// --- GERÇEK ÇARK SİSTEMİ ---
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const prizes = ["100", "500", "1000", "İFLAS", "2000", "5000", "100", "250"];
const colors = ["#00e5ff", "#0f121a", "#bc13fe", "#ff4d4d", "#00e5ff", "#0f121a", "#bc13fe", "#00ffa3"];

function drawWheel() {
    const arc = Math.PI / (prizes.length / 2);
    for (let i = 0; i < prizes.length; i++) {
        ctx.beginPath();
        ctx.fillStyle = colors[i];
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 190, i * arc, (i + 1) * arc);
        ctx.fill();
        ctx.save();
        ctx.translate(200, 200);
        ctx.rotate(i * arc + arc / 2);
        ctx.fillStyle = "white";
        ctx.font = "bold 16px Outfit";
        ctx.fillText(prizes[i], 100, 10);
        ctx.restore();
    }
}

window.spinWheel = async () => {
    const user = auth.currentUser;
    const now = Date.now();
    if(now - currentUserData.lastSpin < 86400000) return alert("Günde sadece 1 kez çevirebilirsiniz!");

    const btn = document.getElementById('spinBtn');
    btn.disabled = true;
    const extraDeg = Math.floor(Math.random() * 360) + 1440; // 4 tur + rastgele
    canvas.style.transform = `rotate(${extraDeg}deg)`;

    setTimeout(async () => {
        const actualDeg = extraDeg % 360;
        const prizeIndex = Math.floor(((360 - actualDeg) % 360) / (360 / prizes.length));
        const win = prizes[prizeIndex];

        if(win === "İFLAS") {
            await updateDoc(doc(db, "users", user.uid), { balance: 0, lastSpin: now });
            alert("Eyvah! İflas ettiniz ve bakiyeniz sıfırlandı!");
        } else {
            const amount = parseInt(win);
            await updateDoc(doc(db, "users", user.uid), { balance: increment(amount), lastSpin: now });
            alert(`Tebrikler! ${amount} ₺ kazandınız!`);
        }
        btn.disabled = false;
        closeModal('wheelModal');
    }, 4000);
};

// --- PROMO KOD SİSTEMİ (Firebase'den Çeker) ---
window.redeemPromo = async () => {
    const codeInput = document.getElementById('promoInput').value.trim().toUpperCase();
    if(!codeInput) return;

    // Firebase'de 'promos' koleksiyonunda bu kodu ara
    const q = query(collection(db, "promos"), where("code", "==", codeInput));
    const querySnapshot = await getDocs(q);

    if(!querySnapshot.empty) {
        const promoDoc = querySnapshot.docs[0];
        const promoData = promoDoc.data();
        
        await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(promoData.amount) });
        // Kodu sil (Tek kullanımlık olması için)
        await deleteDoc(doc(db, "promos", promoDoc.id));
        
        alert(`Başarılı! ${promoData.amount} ₺ hesabınıza eklendi.`);
        closeModal('promoModal');
    } else {
        alert("Geçersiz veya kullanılmış promo kod!");
    }
};

// --- DİĞER FONKSİYONLAR ---
window.checkLogin = (url) => { if(!auth.currentUser) openModal('authModal'); else location.href = url; };

document.getElementById('searchInput').oninput = (e) => {
    const t = e.target.value.toLowerCase();
    document.querySelectorAll('.card').forEach(c => {
        c.style.display = c.getAttribute('data-name').includes(t) ? 'block' : 'none';
    });
};

// Kar efekti başlat
const cSnow = document.getElementById("snow"); const ctxS = cSnow.getContext("2d"); let p = [];
function res() { cSnow.width = window.innerWidth; cSnow.height = window.innerHeight; }
window.onresize = res; res();
for(let i=0; i<80; i++) p.push({x:Math.random()*cSnow.width, y:Math.random()*cSnow.height, r:Math.random()*2+1, d:Math.random()*1+0.3});
function drawS() { ctxS.clearRect(0,0,cSnow.width, cSnow.height); ctxS.fillStyle = "white"; ctxS.beginPath(); p.forEach(p => { ctxS.moveTo(p.x, p.y); ctxS.arc(p.x, p.y, p.r, 0, Math.PI*2); p.y += p.d; if(p.y > cSnow.height) p.y = -5; }); ctxS.fill(); requestAnimationFrame(drawS); }
drawS();
</script>
</body>
</html>

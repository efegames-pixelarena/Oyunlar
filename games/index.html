<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PixelArena | Profesyonel Oyun Platformu</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Syncopate:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
    --primary: #00f2ff;
    --primary-glow: rgba(0, 242, 255, 0.4);
    --accent: #7000ff;
    --bg-deep: #05070a;
    --card-bg: #0d111a;
    --glass: rgba(13, 17, 26, 0.98);
    --border: rgba(255, 255, 255, 0.05);
    --text-main: #e2e8f0;
    --success: #00ff88;
    --danger: #ff3366;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family: 'Outfit', sans-serif; }
body { background: var(--bg-deep); color: var(--text-main); overflow-x: hidden; scroll-behavior: smooth; }

/* --- ÜST BAR (TAŞMAYA KARŞI GÜVENLİ) --- */
.header {
    position: fixed; top: 0; width: 100%; height: 75px;
    background: var(--glass); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); z-index: 2000;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 25px;
}

.brand-logo {
    font-family: 'Syncopate', sans-serif; font-size: 20px; font-weight: 700;
    letter-spacing: 2px; color: #fff; text-decoration: none;
    background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.nav-right { display: flex; align-items: center; gap: 12px; max-width: 60%; }

.wallet-badge {
    background: rgba(255,255,255,0.03); border: 1px solid var(--border);
    padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 10px;
    overflow: hidden; /* Taşmayı önler */
}
.wallet-badge b { color: var(--success); font-weight: 800; white-space: nowrap; font-size: 14px; }

.user-avatar {
    width: 44px; height: 44px; border-radius: 14px; border: 2px solid var(--primary);
    cursor: pointer; transition: 0.3s; object-fit: cover;
}
.user-avatar:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--primary-glow); }

/* --- OYUN KARTLARI --- */
.hero { padding: 120px 5% 40px; text-align: center; }
.section-label { 
    padding: 0 10%; margin: 40px 0 20px; font-size: 12px; font-weight: 800; 
    color: var(--primary); letter-spacing: 3px; text-transform: uppercase;
    display: flex; align-items: center; gap: 15px;
}
.section-label::after { content:''; flex:1; height:1px; background: linear-gradient(90deg, var(--border), transparent); }

.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 0 10%; }

.game-card {
    background: var(--card-bg); border: 1px solid var(--border); border-radius: 28px;
    padding: 35px 20px; text-align: center; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer; position: relative; overflow: hidden;
}
.game-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); }
.game-card i { font-size: 48px; margin-bottom: 20px; display: block; color: var(--primary); filter: drop-shadow(0 0 10px var(--primary-glow)); }
.game-card h3 { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: #fff; }
.game-card .status { font-size: 10px; font-weight: 900; color: var(--success); opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }

/* --- PROFİL & MODALLAR --- */
.overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95);
    backdrop-filter: blur(15px); z-index: 5000; display: none;
    align-items: center; justify-content: center; padding: 20px;
}
.modal {
    background: #0d111a; border: 1px solid var(--border); width: 100%;
    max-width: 450px; border-radius: 35px; padding: 40px; position: relative;
    max-height: 90vh; overflow-y: auto;
}
.modal h2 { font-weight: 900; font-size: 24px; margin-bottom: 25px; text-align: center; color: var(--primary); }

.input-box { margin-bottom: 20px; }
.input-box label { display: block; font-size: 11px; color: #64748b; margin-bottom: 8px; margin-left: 12px; font-weight: 600; }
.input-box input {
    width: 100%; background: #07090e; border: 1px solid var(--border);
    padding: 15px 20px; border-radius: 16px; color: #fff; outline: none; transition: 0.3s;
}
.input-box input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0,242,255,0.1); }
.input-box input:disabled { opacity: 0.4; cursor: not-allowed; background: transparent; }

.p-btn {
    width: 100%; padding: 18px; border-radius: 18px; border: none;
    background: var(--primary); color: #000; font-weight: 900; font-size: 15px;
    cursor: pointer; transition: 0.3s;
}
.p-btn:hover { transform: scale(1.02); filter: brightness(1.1); }

/* --- GERÇEK ÇARK --- */
.wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
#mainWheel { width: 100%; transition: transform 6s cubic-bezier(0.15, 0, 0.15, 1); }
.wheel-pointer { 
    position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
    width: 45px; z-index: 10; filter: drop-shadow(0 5px 10px #000);
}

/* --- AVATAR SEÇİMİ --- */
.av-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 15px 0; }
.av-item { 
    aspect-ratio: 1/1; border-radius: 15px; cursor: pointer; border: 3px solid transparent; 
    overflow: hidden; transition: 0.2s; 
}
.av-item img { width: 100%; height: 100%; object-fit: cover; }
.av-item.selected { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

/* --- PROMO HATA --- */
#promoError { color: var(--danger); font-size: 12px; margin-top: 10px; font-weight: 600; display: none; text-align: center; }

/* --- DROPDOWN --- */
.drop-menu {
    position: absolute; top: 85px; right: 25px; width: 260px;
    background: #121826; border: 1px solid var(--border); border-radius: 24px;
    display: none; flex-direction: column; overflow: hidden; padding: 10px;
}
.drop-menu.active { display: flex; animation: slideUp 0.3s ease; }
.drop-link {
    padding: 14px 18px; display: flex; align-items: center; gap: 15px;
    text-decoration: none; color: #94a3b8; font-weight: 600; border-radius: 16px;
}
.drop-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
.drop-link i { color: var(--primary); font-size: 18px; }

@keyframes slideUp { from { opacity:0; transform: translateY(15px); } to { opacity:1; transform: translateY(0); } }

@media (max-width: 768px) {
    .grid { padding: 0 20px; grid-template-columns: repeat(2, 1fr); }
    .header { padding: 0 15px; }
}
</style>
</head>
<body>

<header class="header">
    <a href="#" class="brand-logo">PIXELARENA</a>
    
    <div class="nav-right" id="guestMenu">
        <button class="p-btn" style="padding: 10px 20px; font-size: 12px;" onclick="openAuth('login')">GİRİŞ YAP</button>
    </div>

    <div class="nav-right" id="userMenu" style="display:none;">
        <div class="wallet-badge">
            <i class="fa-solid fa-coins" style="color: #ffd700;"></i>
            <b id="topBakiye">0 ₺</b>
        </div>
        <img src="" class="user-avatar" id="navAvatar">
        
        <div class="drop-menu" id="userDrop">
            <a href="javascript:void(0)" class="drop-link" onclick="openModal('profileMod')"><i class="fa-solid fa-circle-user"></i> Profil Ayarları</a>
            <a href="javascript:void(0)" class="drop-link" onclick="openModal('wheelMod')"><i class="fa-solid fa-dharmachakra"></i> Günlük Çark</a>
            <a href="javascript:void(0)" class="drop-link" onclick="openModal('promoMod')"><i class="fa-solid fa-ticket"></i> Promo Kod Kullan</a>
            <a href="javascript:void(0)" class="drop-link" id="logoutBtn" style="color: var(--danger); border-top: 1px solid var(--border); margin-top:5px;"><i class="fa-solid fa-power-off"></i> Çıkış Yap</a>
        </div>
    </div>
</header>

<main class="hero">
    <div class="section-label">Aksiyon & Rekabet</div>
    <div class="grid">
        <div class="game-card" onclick="checkPlay('duel.html')">
            <i class="fa-solid fa-gun"></i>
            <h3>Reflex Duel</h3>
            <span class="status">Çevrimiçi PVP</span>
        </div>
        <div class="game-card" onclick="checkPlay('neongrid.html')">
            <i class="fa-solid fa-microchip"></i>
            <h3>Grid Conquest</h3>
            <span class="status">Siber Strateji</span>
        </div>
    </div>

    <div class="section-label">Zeka & Şans</div>
    <div class="grid">
        <div class="game-card" onclick="checkPlay('skycrash.html')">
            <i class="fa-solid fa-rocket"></i>
            <h3>SkyCrash</h3>
            <span class="status">Yüksek Risk</span>
        </div>
        <div class="game-card" onclick="checkPlay('mines.html')">
            <i class="fa-solid fa-bomb"></i>
            <h3>Mines</h3>
            <span class="status">Premium</span>
        </div>
        <div class="game-card" onclick="checkPlay('blackjack.html')">
            <i class="fa-solid fa-layer-group"></i>
            <h3>BlackJack</h3>
            <span class="status">Kart Oyunu</span>
        </div>
    </div>

    <div class="section-label">Ücretsiz Oyunlar</div>
    <div class="grid">
        <div class="game-card" onclick="location.href='loops.html'">
            <i class="fa-solid fa-infinity"></i>
            <h3>Loops</h3>
            <span class="status">Eğlence</span>
        </div>
        <div class="game-card" onclick="location.href='snakepro.html'">
            <i class="fa-solid fa-worm"></i>
            <h3>Snake Pro</h3>
            <span class="status">Klasik</span>
        </div>
    </div>
</main>

<div class="overlay" id="profileMod">
    <div class="modal">
        <h2>PROFİL AYARLARI</h2>
        <div class="input-box">
            <label>E-posta (Değiştirilemez)</label>
            <input type="text" id="profEmail" disabled>
        </div>
        <div class="input-box">
            <label>Ad Soyad</label>
            <input type="text" id="profFullname" placeholder="Adınızı girin">
        </div>
        <div class="input-box">
            <label>Kullanıcı Adı (1 Değişim Hakkı)</label>
            <input type="text" id="profUsername">
        </div>
        <label style="font-size: 11px; color:#64748b; margin-left:12px;">Avatar Seç (3 Değişim Hakkı)</label>
        <div class="av-grid" id="avatarPicker"></div>
        <button class="p-btn" onclick="saveProfileChanges()">DEĞİŞİKLİKLERİ KAYDET</button>
        <p onclick="closeModal('profileMod')" style="text-align:center; margin-top:20px; cursor:pointer; opacity:0.5; font-size:13px;">Kapat</p>
    </div>
</div>

<div class="overlay" id="wheelMod">
    <div class="modal" style="text-align:center;">
        <h2>ŞANS ÇARKI</h2>
        <div class="wheel-container">
            <img src="https://i.ibb.co/9H6S4xy/pointer.png" class="wheel-pointer">
            <img src="https://i.ibb.co/mRT80Pz/wheel.png" id="mainWheel">
        </div>
        <button class="p-btn" id="spinButton" onclick="handleSpin()">ÇARKI ÇEVİR</button>
        <p onclick="closeModal('wheelMod')" style="margin-top:20px; cursor:pointer; opacity:0.5;">Geri Dön</p>
    </div>
</div>

<div class="overlay" id="promoMod">
    <div class="modal">
        <h2>PROMO KOD</h2>
        <div class="input-box">
            <input type="text" id="promoInput" placeholder="KODU BURAYA YAZIN" style="text-align:center; font-weight:900; letter-spacing:2px;">
            <div id="promoError">Bu kod geçersiz veya daha önce kullanılmış!</div>
        </div>
        <button class="p-btn" onclick="redeemPromo()">AKTİF ET</button>
        <p onclick="closeModal('promoMod')" style="text-align:center; margin-top:20px; cursor:pointer; opacity:0.5;">İptal</p>
    </div>
</div>

<div class="overlay" id="authMod">
    <div class="modal">
        <h2 id="authTitle">Giriş Yap</h2>
        <div class="input-box"><input type="email" id="authEmail" placeholder="E-posta"></div>
        <div class="input-box"><input type="password" id="authPass" placeholder="Şifre"></div>
        <div class="input-box" id="regExtra" style="display:none;"><input type="text" id="authName" placeholder="Kullanıcı Adı"></div>
        <button class="p-btn" id="authSubmit">DEVAM ET</button>
        <p id="authSwitch" style="text-align:center; margin-top:25px; font-size:14px; cursor:pointer;">Hesabın yok mu? <b style="color:var(--primary)">Kayıt Ol</b></p>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, increment, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:"AIzaSyBykwXCOJpX6rG0pUx93HmALjVcCQWVMYA",
    authDomain:"emirhan-site.firebaseapp.com",
    projectId:"emirhan-site",
    storageBucket:"emirhan-site.firebasestorage.app",
    messagingSenderId:"668871888390",
    appId:"1:668871888390:web:76568bda84cb1641f7bd87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// GLOBAL DEĞİŞKENLER
let currentUserData = null;
let chosenAvatar = "";
const AVATAR_LIST = [
    "https://i.pravatar.cc/150?img=11", "https://i.pravatar.cc/150?img=12", 
    "https://i.pravatar.cc/150?img=13", "https://i.pravatar.cc/150?img=14",
    "https://i.pravatar.cc/150?img=15", "https://i.pravatar.cc/150?img=16",
    "https://i.pravatar.cc/150?img=17", "https://i.pravatar.cc/150?img=20"
];

// MODAL YÖNETİMİ
window.openModal = (id) => { 
    document.getElementById(id).style.display = 'flex'; 
    if(id === 'profileMod') renderAvatars();
};
window.closeModal = (id) => document.getElementById(id).style.display = 'none';

document.getElementById('navAvatar').onclick = (e) => {
    e.stopPropagation();
    document.getElementById('userDrop').classList.toggle('active');
};
window.onclick = () => document.getElementById('userDrop').classList.remove('active');

// AUTH İŞLEMLERİ
let isLoginMode = true;
window.openAuth = (mode) => {
    isLoginMode = (mode === 'login');
    document.getElementById('authTitle').innerText = isLoginMode ? "Giriş Yap" : "Kayıt Ol";
    document.getElementById('regExtra').style.display = isLoginMode ? "none" : "block";
    document.getElementById('authMod').style.display = 'flex';
};
document.getElementById('authSwitch').onclick = () => openAuth(isLoginMode ? 'reg' : 'login');

document.getElementById('authSubmit').onclick = async () => {
    const email = document.getElementById('authEmail').value;
    const pass = document.getElementById('authPass').value;
    const uName = document.getElementById('authName').value;

    try {
        if(isLoginMode) {
            await signInWithEmailAndPassword(auth, email, pass);
        } else {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), {
                username: uName, balance: 500, avatar: AVATAR_LIST[0],
                nameChanges: 1, avChanges: 3, fullName: "", lastSpin: 0
            });
        }
        closeModal('authMod');
    } catch(e) { alert("Hata: " + e.message); }
};

onAuthStateChanged(auth, user => {
    if(user) {
        document.getElementById('guestMenu').style.display = 'none';
        document.getElementById('userMenu').style.display = 'flex';
        onSnapshot(doc(db, "users", user.uid), s => {
            if(s.exists()) {
                currentUserData = s.data();
                document.getElementById('topBakiye').innerText = currentUserData.balance.toLocaleString() + " ₺";
                document.getElementById('navAvatar').src = currentUserData.avatar;
                
                // Profil verilerini doldur
                document.getElementById('profEmail').value = user.email;
                document.getElementById('profFullname').value = currentUserData.fullName || "";
                document.getElementById('profUsername').value = currentUserData.username;
                
                // Pasiflik kontrolleri
                if(currentUserData.nameChanges <= 0) document.getElementById('profUsername').disabled = true;
                if(currentUserData.fullName && currentUserData.fullName !== "") document.getElementById('profFullname').disabled = true;
            }
        });
    } else {
        document.getElementById('guestMenu').style.display = 'flex';
        document.getElementById('userMenu').style.display = 'none';
    }
});

document.getElementById('logoutBtn').onclick = () => signOut(auth);

// PROFİL SİSTEMİ
function renderAvatars() {
    const container = document.getElementById('avatarPicker');
    container.innerHTML = "";
    AVATAR_LIST.forEach(url => {
        const div = document.createElement('div');
        div.className = `av-item ${url === currentUserData.avatar ? 'selected' : ''}`;
        div.innerHTML = `<img src="${url}">`;
        div.onclick = () => {
            if(currentUserData.avChanges <= 0) return alert("Avatar değiştirme hakkınız kalmadı!");
            document.querySelectorAll('.av-item').forEach(x => x.classList.remove('selected'));
            div.classList.add('selected');
            chosenAvatar = url;
        };
        container.appendChild(div);
    });
}

window.saveProfileChanges = async () => {
    const newUName = document.getElementById('profUsername').value;
    const newFName = document.getElementById('profFullname').value;
    let upData = {};

    // Kullanıcı adı hakkı (1 kere)
    if(newUName !== currentUserData.username && currentUserData.nameChanges > 0) {
        upData.username = newUName;
        upData.nameChanges = 0;
    }
    // İsim Soyisim hakkı (Boşken bir kere)
    if(newFName !== "" && (!currentUserData.fullName || currentUserData.fullName === "")) {
        upData.fullName = newFName;
    }
    // Avatar hakkı (3 kere)
    if(chosenAvatar !== "" && chosenAvatar !== currentUserData.avatar && currentUserData.avChanges > 0) {
        upData.avatar = chosenAvatar;
        upData.avChanges = increment(-1);
    }

    if(Object.keys(upData).length > 0) {
        await updateDoc(doc(db, "users", auth.currentUser.uid), upData);
        alert("Profil başarıyla güncellendi!");
        closeModal('profileMod');
    } else {
        alert("Herhangi bir değişiklik yapılmadı veya hakkınız doldu.");
    }
};

// ÇARK SİSTEMİ
window.handleSpin = async () => {
    const last = currentUserData.lastSpin || 0;
    const now = Date.now();
    if(now - last < 86400000) return alert("Günde sadece 1 kez çevirebilirsiniz!");

    const sBtn = document.getElementById('spinButton');
    sBtn.disabled = true;
    const randomDeg = Math.floor(Math.random() * 360) + 3600; // En az 10 tur
    document.getElementById('mainWheel').style.transform = `rotate(${randomDeg}deg)`;

    setTimeout(async () => {
        const prizes = [100, 500, 50, 250, 0, 1000];
        const win = prizes[Math.floor(Math.random() * prizes.length)];
        
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            balance: increment(win),
            lastSpin: now
        });

        alert(win > 0 ? `TEBRİKLER! ${win} ₺ Kazandınız.` : "Tüh! Bu sefer kazanamadınız.");
        sBtn.disabled = false;
        closeModal('wheelMod');
    }, 6500);
};

// PROMO KOD SİSTEMİ
window.redeemPromo = async () => {
    const code = document.getElementById('promoInput').value.trim().toUpperCase();
    const err = document.getElementById('promoError');
    err.style.display = "none";

    if(!code) return;

    try {
        // Firebase'de "promos" koleksiyonu olmalı: {code: "DENEME", value: 100}
        const q = query(collection(db, "promos"), where("code", "==", code));
        const snap = await getDocs(q);

        if(snap.empty) {
            err.innerText = "Bu kod geçersiz veya yanlış!";
            err.style.display = "block";
            return;
        }

        const pDoc = snap.docs[0];
        const pData = pDoc.data();

        // Kodu kullan ve bakiyeyi artır
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            balance: increment(pData.value)
        });

        // Kodu sil (Tek kullanımlık sistem)
        await deleteDoc(doc(db, "promos", pDoc.id));

        alert(`BAŞARILI! ${pData.value} ₺ hesabınıza eklendi.`);
        closeModal('promoMod');
    } catch(e) {
        err.innerText = "Bir hata oluştu veya kod zaten kullanılmış.";
        err.style.display = "block";
    }
};

window.checkPlay = (url) => {
    if(!auth.currentUser) openAuth('login');
    else location.href = url;
};
</script>
</body>
</html>
